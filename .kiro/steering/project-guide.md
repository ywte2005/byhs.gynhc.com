---
inclusion: always
---

# 商户互助平台 - 项目开发指南

## 项目概述

商户互助刷单平台，实现商户之间互助完成刷单任务，配套完整的推广分销、等级权益、佣金分润体系。

### 开发环境要求

**后端开发环境：**
- PHP ≥ 7.4
- MySQL ≥ 5.7
- Composer
- Web 服务器（Apache/Nginx）

**前端开发环境：**
- **HBuilderX ≥ 3.8.0**（必需，用于运行和编译项目）
- Node.js ≥ 16（用于安装基础依赖）
- 不支持命令行运行（npm run dev/build 无效）

**重要：** 前端项目必须在 HBuilderX 中打开、运行和编译，所有平台（H5/App/小程序）的开发调试都需要通过 HBuilderX 完成。

### 核心业务流程

**商户入驻流程：**
注册 → 实名认证 → 提交商户资料 → 后台风控审核 → 缴纳入驻费 → 入驻成功 → 触发奖励

**互助任务流程：**
发起任务 → 缴纳保证金 → 系统拆分子任务 → 派发给商户 → 线下支付 → 上传凭证 → 系统校验 → 自动完成 → 发放佣金

**推广流程：**
注册 → 认证 → 购买等级 → 分享邀请 → 获取收益 → 结算 → 团队分红

## 技术栈

| 层级 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 后端框架 | FastAdmin (ThinkPHP) | 5.x | - |
| 后端语言 | PHP | ≥7.4 | - |
| 数据库 | MySQL | ≥5.7 | - |
| 前端框架 | uni-app x | - | **必须使用 HBuilderX 运行** |
| 前端语言 | TypeScript/UTS | - | - |
| UI框架 | TailwindCSS | - | - |
| 开发工具 | HBuilderX | ≥3.8.0 | **前端项目必需** |
| 支持平台 | H5 / App / 微信小程序 | - | 通过 HBuilderX 编译 |

**重要提示：**
- 前端项目必须在 HBuilderX 中打开和运行
- 不支持通过命令行（npm run dev/build）运行
- 所有平台的编译和调试都需要通过 HBuilderX 完成

## 核心配置体系

所有等级、奖励、分红、分润均后台可配置，包括：

1. **等级配置** - 自定义等级体系与升级条件
2. **奖项配置** - 自定义奖励规则（直推奖、间推奖、代理奖）
3. **分红配置** - 自定义分红档位与条件
4. **分润配置** - 自定义分润规则（按等级差分润）

## 互助余额机制

**核心公式：**
```
互助余额 = 初始值(0) + 帮别人刷的总额 - 被别人刷的总额 - 自己的手续费 + 刷他人产生的佣金
```

**风控规则：**
- 互助余额 < -50,000 → 暂停新任务派发
- 互助余额 ≥ -20,000 → 自动恢复派发
- 核心原则：先刷别人，才能被别人刷

## 佣金触发场景

1. **进件入驻** - 商户缴纳入驻费后触发奖励（直推奖、间推奖、代理奖）
2. **刷单任务** - 三方推送交易数据后即时触发分红分润
3. **购买等级权益** - 用户购买升级后触发奖励

## 等级差分润

按等级差分润，等级差越大，分润比例越高。可配置多级分润规则，支持等级差要求、业绩增量条件组合配置。

## 分红体系

- **多档位分红** - 可配置多个分红档位，用户可同时达标多个档位
- **达标条件** - 团队业绩门槛、个人达标额度、达标人数、业绩增量
- **奖池分配** - 奖池 = 刷单总金额 × 奖池比例，达标用户平分奖池
- **发放周期** - 每月1号统计，3号前完成发放（后台自定义时间）

## 业绩统计

- **个人业绩** = 所有刷单交易累计金额
- **团队业绩** = 下级所有成员业绩总和
- **月度增量** = 本月业绩 - 上月业绩（用于控制奖励/分润发放条件）

## 后端目录结构

```
application/
├── api/                    # API模块(用户端接口)
│   ├── controller/
│   │   ├── Merchant.php   # 商户模块
│   │   ├── Task.php       # 互助任务
│   │   ├── Wallet.php     # 钱包模块
│   │   ├── Promo.php      # 推广模块
│   │   └── Settlement.php # 结算模块
│   └── library/
│
├── common/
│   ├── model/             # 数据模型
│   │   ├── merchant/      # 商户模块
│   │   ├── promo/         # 推广模块
│   │   ├── task/          # 任务模块
│   │   ├── wallet/        # 钱包模块
│   │   └── config/        # 配置模块
│   └── library/           # 业务服务层
│       ├── PromoService.php
│       ├── TaskService.php
│       ├── WalletService.php
│       ├── RewardService.php
│       └── SettlementService.php
│
└── admin/                 # 后台管理模块
    ├── controller/
    │   ├── merchant/      # 商户管理
    │   ├── promo/         # 推广管理
    │   ├── task/          # 任务管理
    │   ├── wallet/        # 钱包管理
    │   └── config/        # 配置管理
    └── view/
```

## 前端目录结构

```
cool-unix/
├── pages/
│   ├── promo/             # 推广模块
│   │   ├── index.uvue
│   │   ├── level.uvue
│   │   ├── invite.uvue
│   │   ├── team.uvue
│   │   ├── commission.uvue
│   │   ├── performance.uvue
│   │   ├── bonus.uvue
│   │   └── wallet.uvue
│   ├── merchant/          # 商户模块
│   │   ├── index.uvue
│   │   ├── register.uvue
│   │   ├── audit-status.uvue
│   │   └── info.uvue
│   ├── task/              # 互助任务
│   │   ├── index.uvue
│   │   ├── create.uvue
│   │   ├── detail.uvue
│   │   ├── my-tasks.uvue
│   │   ├── subtask/
│   │   │   ├── list.uvue
│   │   │   ├── my.uvue
│   │   │   ├── detail.uvue
│   │   │   └── upload.uvue
│   │   └── deposit.uvue
│   └── wallet/            # 钱包模块
│       ├── index.uvue
│       ├── recharge.uvue
│       ├── withdraw.uvue
│       └── logs.uvue
├── services/              # API服务层
│   ├── merchant.ts
│   ├── task.ts
│   └── wallet.ts
└── types/                 # 类型定义
    ├── merchant.ts
    ├── task.ts
    └── wallet.ts
```

## 核心数据表

| 表名 | 说明 |
|------|------|
| fa_promo_level | 等级配置表 |
| fa_promo_relation | 用户推广关系表 |
| fa_promo_commission | 佣金记录表 |
| fa_promo_bonus_config | 分红配置表 |
| fa_promo_bonus | 分红记录表 |
| fa_promo_performance | 业绩统计表(月度) |
| fa_merchant | 商户信息表 |
| fa_merchant_audit | 商户审核记录表 |
| fa_mutual_task | 互助主任务表 |
| fa_sub_task | 子任务表 |
| fa_wallet | 用户钱包表 |
| fa_wallet_log | 钱包流水表 |
| fa_reward_rule | 奖励规则配置表 |
| fa_profit_rule | 分润规则配置表 |

## 前端开发规范

### UTS 规范
- 强类型，所有变量必须声明类型
- 先定义后使用
- 不使用 `undefined`，使用 `null`
- 用 `type` 定义对象类型，不用 `interface`
- 可空类型使用 `| null` 或 `?`

### UVUE 规范
- 仅使用 Vue3 组合式 API
- 不使用 Pinia/Vuex
- 组件使用 easycom 规范
- 页面参数通过 props 接收

### 样式规范
- 仅使用 flex 布局
- 文字样式只能加在 `<text>` 上
- 单位仅使用 px/rpx/%
- 使用 TailwindCSS 类名

### 组件规范
- 页面使用 `<cl-page>` 包裹
- 底部操作区使用 `<cl-footer>`
- 参考 `/pages/demo` 示例
- 参考 `/pages/template` 模板

## API 返回格式

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {}
}
```

**常用状态码：**
- 0: 成功
- 1001: 参数缺失
- 1002: 参数格式错误
- 2001: 未登录
- 2002: 无权限
- 3001: 当前状态不允许该操作
- 3002: 余额不足
- 3003: 保证金不足
- 5001: 系统异常

## 安全设计

- 所有接口需 Token 校验
- 敏感操作需二次验证
- 请求频率限制
- 金额使用 decimal 类型
- 所有资金操作记录流水
- 关键操作使用数据库事务
- 防并发：乐观锁/悲观锁

### 推广体系架构

1. 平台采用多层级推广关系，推广层级、发放对象与规则均支持后台配置（可新增/修改/启用/停用）。
2. 推广权益与收益与用户等级绑定：用户需购买/升级到对应等级；等级名称、数量、排序、升级方式与条件均可配置。
3. 各层级可分别配置升级条件与收益结构：直推、间推、团队分红/分润等，并可叠加等级门槛、月度业绩增量门槛。
4. 邀请/绑定支持二维码邀请与小程序转发。

### 奖励类型架构
1. 直推奖：关系树第1层触发发放。
2. 间推奖：关系树第2层触发发放；可配置发放条件（如等级门槛、增量门槛等）。
3. 级差奖（等级差分润）：订单/交易产生后，若上级等级高于下级，则按等级差匹配分润档位，获得对应差额/比例收益。
4. 平级奖：面向同等级（省级）设置平级奖励规则，同等级查找仅发放第一个平级。
5. 团队业绩分红：按月基于个人/团队业绩与增量达标情况进行分红，档位与奖池比例可配置。

### 分佣来源架构
1. 代理等级付费/升级费（购买升级可触发升级奖励）。
2. 互助任务手续费（交易数据推送后结算，并计入个人/团队业绩用于分红统计）。
3. 第三方支付分润（按等级差规则配置档位与比例后发放）。

### 推广权益与收益

- 推广权益与收益与用户等级绑定
- 用户需购买/升级到对应等级
- 等级名称、数量、排序、升级方式与条件均可配置
- 各层级可分别配置升级条件与收益结构

### 升级方式

1. **购买升级** - 支付升级费立即升级
2. **业绩升级** - 达到配置的业绩要求自动升级

### 升级条件（可组合配置）

- 个人业绩门槛
- 团队业绩门槛
- 直推人数要求
- 月度业绩增量要求

### 邀请与绑定

- 支持二维码邀请
- 支持小程序转发
- 支持邀请码绑定

## 奖励类型详解

### 1. 直推奖
- **触发条件** - 关系树第1层触发发放
- **发放对象** - 直接推荐人
- **配置项** - 固定金额或比例、等级要求、增量门槛

### 2. 间推奖
- **触发条件** - 关系树第2层触发发放
- **发放对象** - 间接推荐人（推荐人的推荐人）
- **配置条件** - 等级门槛、增量门槛等
- **灵活性** - 可配置是否发放、发放比例

### 3. 级差奖（等级差分润）
- **触发条件** - 订单/交易产生后
- **发放规则** - 若上级等级高于下级，按等级差匹配分润档位
- **收益方式** - 获得对应差额/比例收益
- **多档位配置** - 1级差→0.5%，2级差→1.0%，以此类推
- **条件限制** - 可配置等级差要求、业绩增量条件

### 4. 平级奖
- **适用场景** - 面向同等级（省级）设置
- **发放规则** - 同等级查找仅发放第一个平级
- **配置灵活性** - 支持自定义平级奖励规则

### 5. 团队业绩分红
- **统计周期** - 按月基于个人/团队业绩与增量达标情况
- **档位配置** - 基础/进阶/高级等多档位
- **达标条件** - 团队业绩 + 个人业绩 + 达标人数 + 增量
- **奖池分配** - 平台总交易额 × 档位比例，达标者平分

## 分佣来源

### 1. 代理等级付费/升级费
- 用户购买升级可触发升级奖励
- 直推人获得直推奖
- 间推人获得间推奖（如配置）
- 上级按等级差获得分润

### 2. 互助任务手续费
- 交易数据推送后结算
- 计入个人/团队业绩用于分红统计
- 按等级差规则分润

### 3. 第三方支付分润
- 按等级差规则配置档位与比例后发放
- 实时触发分润计算
- 支持多层级分润

## 业绩体系

### 业绩计算

- **个人业绩** = 所有刷单交易累计金额
- **团队业绩** = 下级所有成员业绩总和
- **月度增量** = 本月业绩 - 上月业绩

### 业绩应用

1. **触发即时奖励** - 刷单完成立即发放佣金
2. **累计为分红基数** - 用于月度分红统计
3. **计算增量条件** - 作为奖励/分润发放条件

### 增量门槛应用

所有奖励和分润均可将增量作为配置条件，如：
- 月度增量 ≥ 0 才能获得分红
- 月度增量 ≥ 10万 才能获得高级分润

## 推广关系链

### 关系树结构

- **直推** - 第1层推荐人
- **间推** - 第2层推荐人
- **团队** - 所有下级成员（无限层级）

### 关系链应用

1. **直推奖** - 沿关系链第1层发放
2. **间推奖** - 沿关系链第2层发放
3. **等级差分润** - 沿关系链向上遍历，计算等级差后发放
4. **团队业绩** - 统计整个关系树下级业绩

## 推广流程完整示例

```
用户A注册
  ↓
用户A认证
  ↓
用户A购买等级（如：代理等级，支付1000元）
  ↓
触发奖励：
  - 推荐人B获得直推奖（如：100元）
  - 推荐人B的推荐人C获得间推奖（如：50元，如配置）
  - 推荐人B按等级差获得分润（如：等级差2级，获得10元）
  ↓
用户A分享邀请码/二维码给用户D
  ↓
用户D通过邀请码注册并绑定用户A
  ↓
用户D完成刷单任务（交易金额5000元）
  ↓
触发奖励：
  - 用户A获得直推奖（如：50元）
  - 用户B获得间推奖（如：25元，如配置）
  - 用户B按等级差获得分润（如：等级差2级，获得50元）
  - 用户A业绩 += 5000元
  - 用户B团队业绩 += 5000元
  ↓
月度1号统计分红
  ↓
用户A达标分红档位（如：团队业绩50万+个人业绩10万）
  ↓
3号前发放分红（如：1000元）
```

## 定时任务

```bash
# 月度分红计算(每月1号凌晨执行)
0 0 1 * * php /path/to/think bonus:calculate

# 子任务超时检查(每5分钟)
*/5 * * * * php /path/to/think task:checkTimeout

# 业绩统计快照(每天凌晨)
0 0 * * * php /path/to/think performance:snapshot
```
