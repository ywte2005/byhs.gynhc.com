# 后端开发指南

## 项目概述

商户互助刷单平台后端项目，基于 FastAdmin (ThinkPHP 5.x) 框架开发，使用 PHP ≥7.4 和 MySQL ≥5.7。

## 技术栈

| 层级 | 技术 | 版本 |
|------|------|------|
| 后端框架 | FastAdmin (ThinkPHP) | 5.x |
| 后端语言 | PHP | ≥7.4 |
| 数据库 | MySQL | ≥5.7 |

## 项目结构

```
backend/
├── application/
│   ├── api/                    # API模块(用户端接口)
│   │   ├── controller/
│   │   │   ├── Merchant.php   # 商户模块
│   │   │   ├── Task.php       # 互助任务
│   │   │   ├── Wallet.php     # 钱包模块
│   │   │   ├── Promo.php      # 推广模块
│   │   │   └── Settlement.php # 结算模块
│   │   └── library/
│   │
│   ├── common/
│   │   ├── model/             # 数据模型
│   │   │   ├── merchant/      # 商户模块
│   │   │   ├── promo/         # 推广模块
│   │   │   ├── task/          # 任务模块
│   │   │   ├── wallet/        # 钱包模块
│   │   │   └── config/        # 配置模块
│   │   └── library/           # 业务服务层
│   │       ├── PromoService.php
│   │       ├── TaskService.php
│   │       ├── WalletService.php
│   │       ├── RewardService.php
│   │       └── SettlementService.php
│   │
│   └── admin/                 # 后台管理模块
│       ├── controller/
│       │   ├── merchant/      # 商户管理
│       │   ├── promo/         # 推广管理
│       │   ├── task/          # 任务管理
│       │   ├── wallet/        # 钱包管理
│       │   └── config/        # 配置管理
│       └── view/
```

## 核心数据表

| 表名 | 说明 |
|------|------|
| fa_promo_level | 等级配置表 |
| fa_promo_relation | 用户推广关系表 |
| fa_promo_commission | 佣金记录表 |
| fa_promo_bonus_config | 分红配置表 |
| fa_promo_bonus | 分红记录表 |
| fa_promo_performance | 业绩统计表(月度) |
| fa_merchant | 商户信息表 |
| fa_merchant_audit | 商户审核记录表 |
| fa_mutual_task | 互助主任务表 |
| fa_sub_task | 子任务表 |
| fa_wallet | 用户钱包表 |
| fa_wallet_log | 钱包流水表 |
| fa_reward_rule | 奖励规则配置表 |
| fa_profit_rule | 分润规则配置表 |

## API 返回格式

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {}
}
```

**常用状态码：**
- 0: 成功
- 1001: 参数缺失
- 1002: 参数格式错误
- 2001: 未登录
- 2002: 无权限
- 3001: 当前状态不允许该操作
- 3002: 余额不足
- 3003: 保证金不足
- 5001: 系统异常

## 安全设计

- 所有接口需 Token 校验
- 敏感操作需二次验证
- 请求频率限制
- 金额使用 decimal 类型
- 所有资金操作记录流水
- 关键操作使用数据库事务
- 防并发：乐观锁/悲观锁

## 定时任务

```bash
# 月度分红计算(每月1号凌晨执行)
0 0 1 * * php /path/to/think bonus:calculate

# 子任务超时检查(每5分钟)
*/5 * * * * php /path/to/think task:checkTimeout

# 业绩统计快照(每天凌晨)
0 0 * * * php /path/to/think performance:snapshot
```

## 核心业务流程

### 商户入驻流程
注册 → 实名认证 → 提交商户资料 → 后台风控审核 → 缴纳入驻费 → 入驻成功 → 触发奖励

### 互助任务流程
发起任务 → 缴纳保证金 → 系统拆分子任务 → 派发给商户 → 线下支付 → 上传凭证 → 系统校验 → 自动完成 → 发放佣金

### 推广流程
注册 → 认证 → 购买等级 → 分享邀请 → 获取收益 → 结算 → 团队分红

## 互助余额机制

**核心公式：**
```
互助余额 = 初始值(0) + 帮别人刷的总额 - 被别人刷的总额 - 自己的手续费 + 刷他人产生的佣金
```

**风控规则：**
- 互助余额 < -50,000 → 暂停新任务派发
- 互助余额 ≥ -20,000 → 自动恢复派发
- 核心原则：先刷别人，才能被别人刷

## 佣金触发场景

1. **进件入驻** - 商户缴纳入驻费后触发奖励（直推奖、间推奖、代理奖）
2. **刷单任务** - 三方推送交易数据后即时触发分红分润
3. **购买等级权益** - 用户购买升级后触发奖励

## 等级差分润

按等级差分润，等级差越大，分润比例越高。可配置多级分润规则，支持等级差要求、业绩增量条件组合配置。

## 分红体系

- **多档位分红** - 可配置多个分红档位，用户可同时达标多个档位
- **达标条件** - 团队业绩门槛、个人达标额度、达标人数、业绩增量
- **奖池分配** - 奖池 = 刷单总金额 × 奖池比例，达标用户平分奖池
- **发放周期** - 每月1号统计，3号前完成发放（后台自定义时间）

## 业绩统计

- **个人业绩** = 所有刷单交易累计金额
- **团队业绩** = 下级所有成员业绩总和
- **月度增量** = 本月业绩 - 上月业绩（用于控制奖励/分润发放条件）

## 推广体系架构

### 1. 多层级推广关系
平台采用多层级推广关系，推广层级、发放对象与规则均支持后台配置（可新增/修改/启用/停用）。

### 2. 等级体系
推广权益与收益与用户等级绑定：用户需购买/升级到对应等级；等级名称、数量、排序、升级方式与条件均可配置。

### 3. 升级方式
- **购买升级** - 支付升级费立即升级
- **业绩升级** - 达到配置的业绩要求自动升级

### 4. 升级条件（可组合配置）
- 个人业绩门槛
- 团队业绩门槛
- 直推人数要求
- 月度业绩增量要求

### 5. 邀请与绑定
- 支持二维码邀请
- 支持小程序转发
- 支持邀请码绑定

## 奖励类型详解

### 1. 直推奖
- **触发条件** - 关系树第1层触发发放
- **发放对象** - 直接推荐人
- **配置项** - 固定金额或比例、等级要求、增量门槛

### 2. 间推奖
- **触发条件** - 关系树第2层触发发放
- **发放对象** - 间接推荐人（推荐人的推荐人）
- **配置条件** - 等级门槛、增量门槛等
- **灵活性** - 可配置是否发放、发放比例

### 3. 级差奖（等级差分润）
- **触发条件** - 订单/交易产生后
- **发放规则** - 若上级等级高于下级，按等级差匹配分润档位
- **收益方式** - 获得对应差额/比例收益
- **多档位配置** - 1级差→0.5%，2级差→1.0%，以此类推
- **条件限制** - 可配置等级差要求、业绩增量条件

### 4. 平级奖
- **适用场景** - 面向同等级（省级）设置
- **发放规则** - 同等级查找仅发放第一个平级
- **配置灵活性** - 支持自定义平级奖励规则

### 5. 团队业绩分红
- **统计周期** - 按月基于个人/团队业绩与增量达标情况
- **档位配置** - 基础/进阶/高级等多档位
- **达标条件** - 团队业绩 + 个人业绩 + 达标人数 + 增量
- **奖池分配** - 平台总交易额 × 档位比例，达标者平分奖池

## 分佣来源

### 1. 代理等级付费/升级费
- 用户购买升级可触发升级奖励
- 直推人获得直推奖
- 间推人获得间推奖（如配置）
- 上级按等级差获得分润

### 2. 互助任务手续费
- 交易数据推送后结算
- 计入个人/团队业绩用于分红统计
- 按等级差规则分润

### 3. 第三方支付分润
- 按等级差规则配置档位与比例后发放
- 实时触发分润计算
- 支持多层级分润

## 推广流程完整示例

```
用户A注册
  ↓
用户A认证
  ↓
用户A购买等级（如：代理等级，支付1000元）
  ↓
触发奖励：
  - 推荐人B获得直推奖（如：100元）
  - 推荐人B的推荐人C获得间推奖（如：50元，如配置）
  - 推荐人B按等级差获得分润（如：等级差2级，获得10元）
  ↓
用户A分享邀请码/二维码给用户D
  ↓
用户D通过邀请码注册并绑定用户A
  ↓
用户D完成刷单任务（交易金额5000元）
  ↓
触发奖励：
  - 用户A获得直推奖（如：50元）
  - 用户B获得间推奖（如：25元，如配置）
  - 用户B按等级差获得分润（如：等级差2级，获得50元）
  - 用户A业绩 += 5000元
  - 用户B团队业绩 += 5000元
  ↓
月度1号统计分红
  ↓
用户A达标分红档位（如：团队业绩50万+个人业绩10万）
  ↓
3号前发放分红（如：1000元）
```

## 开发建议

### 1. 数据库设计
- 使用 decimal 类型存储金额
- 所有资金操作必须记录流水
- 使用事务保证数据一致性

### 2. 业务逻辑
- 实现完整的风控检查
- 支持后台配置所有规则
- 实现定时任务处理

### 3. API 设计
- 遵循统一的返回格式
- 实现完整的参数验证
- 记录所有关键操作日志

### 4. 性能优化
- 使用缓存减少数据库查询
- 实现异步处理长流程
- 定期优化数据库索引

## 相关文档

- [ThinkPHP 官方文档](https://www.thinkphp.cn/)
- [FastAdmin 官方文档](https://www.fastadmin.net/)
- [MySQL 官方文档](https://dev.mysql.com/doc/)
