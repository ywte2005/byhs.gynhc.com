# 数据库升级修复指南

## 测试结果分析

根据 https://byhs.gynhc.com/test_upgrade.php 的测试结果：

### ✅ 已成功完成（21项）
- ✅ 系统配置扩展表已创建（11条配置）
- ✅ 商户表4个新字段已添加
- ✅ 任务表4个新字段已添加
- ✅ 钱包表新字段已添加
- ✅ 子任务表新字段已添加
- ✅ 等级表时间字段已添加
- ✅ 所有数据完整性验证通过

### ❌ 需要修复（6项）
1. ❌ fa_withdraw_record 表未创建
2. ❌ 业绩表字段未重命名（period）
3. ❌ 业绩表字段未重命名（personal_performance）
4. ❌ 业绩表字段未重命名（team_performance）
5. ❌ 佣金表索引未创建
6. ❌ 业绩表联合索引未创建

## 修复步骤

### 第一步：执行修复脚本

1. **登录 phpMyAdmin**
   - 访问：https://byhs.gynhc.com/phpmyadmin
   - 输入数据库用户名和密码

2. **选择数据库**
   - 点击左侧的 `byhs_gynhc_com` 数据库

3. **执行修复脚本**
   - 点击顶部的"SQL"标签
   - 打开文件：`backend/database/upgrade_fix.sql`
   - 复制全部内容
   - 粘贴到SQL执行框
   - 点击"执行"按钮

4. **查看执行结果**
   - 确认没有错误信息
   - 应该看到"修复完成！"的提示

### 第二步：重新验证

1. **刷新测试页面**
   - 访问：https://byhs.gynhc.com/test_upgrade.php
   - 按 F5 刷新页面

2. **检查测试结果**
   - 通过率应该达到 100%
   - 所有27项测试都应该显示绿色✓

### 第三步：清理测试文件

测试通过后，删除测试文件：
```bash
# 通过FTP删除
public/test_upgrade.php
```

## 修复内容详解

### 1. 创建提现记录表
```sql
CREATE TABLE `fa_withdraw_record` (
  -- 完整的提现记录表结构
  -- 支持更多状态和字段
  -- 优化的索引设计
)
```

### 2. 重命名业绩表字段
- `month` → `period`（期数）
- `personal_amount` → `personal_performance`（个人业绩）
- `team_amount` → `team_performance`（团队业绩）
- `growth_amount` → `growth`（业绩增量）
- `direct_count` → `direct_invite_count`（直推人数）

### 3. 添加性能优化索引

**fa_promo_commission（佣金表）**
- user_id
- source_user_id
- scene
- status
- createtime

**fa_promo_performance（业绩表）**
- user_period（联合唯一索引）
- period

**fa_promo_bonus（分红表）**
- user_id
- period
- status

**fa_reward_rule（奖励规则表）**
- scene
- reward_type
- status
- sort

**fa_profit_rule（分润规则表）**
- level_diff
- status
- sort

## 常见问题

### Q1: 执行修复脚本时出错怎么办？

**答**：
1. 记录完整的错误信息
2. 检查是否选择了正确的数据库
3. 确认数据库用户有足够权限
4. 如果提示"字段已存在"或"索引已存在"，这是正常的，可以忽略

### Q2: 修复后测试仍然失败怎么办？

**答**：
1. 清除浏览器缓存后重新测试
2. 检查修复脚本是否完整执行
3. 在phpMyAdmin中手动检查表结构
4. 查看数据库错误日志

### Q3: 如何验证字段是否重命名成功？

**答**：
在phpMyAdmin中执行：
```sql
-- 查看业绩表结构
DESCRIBE fa_promo_performance;

-- 应该看到新字段名：period, personal_performance, team_performance
```

### Q4: 如何验证索引是否创建成功？

**答**：
在phpMyAdmin中执行：
```sql
-- 查看佣金表索引
SHOW INDEX FROM fa_promo_commission;

-- 查看业绩表索引
SHOW INDEX FROM fa_promo_performance;
```

## 验证清单

修复完成后，请逐项检查：

- [ ] 修复脚本执行成功，无错误
- [ ] fa_withdraw_record 表已创建
- [ ] 业绩表字段已重命名（5个字段）
- [ ] 佣金表索引已创建（5个索引）
- [ ] 业绩表索引已创建（2个索引）
- [ ] 分红表索引已创建（3个索引）
- [ ] 奖励规则表索引已创建（4个索引）
- [ ] 分润规则表索引已创建（3个索引）
- [ ] 测试页面显示100%通过
- [ ] 测试文件已删除

## 下一步

修复完成并验证通过后：

1. **更新后端代码**
   - 确保后端代码已更新到最新版本
   - 清除缓存：删除 `runtime/cache` 目录

2. **测试核心功能**
   - 商户入驻流程
   - 任务发布和执行
   - 钱包充值和提现
   - 推广关系绑定
   - 佣金和分红计算

3. **监控系统运行**
   - 查看错误日志：`runtime/log`
   - 监控数据库性能
   - 检查API响应时间

4. **备份数据库**
   - 升级成功后，立即备份当前数据库
   - 保存备份文件到安全位置

## 技术支持

如果遇到问题，请提供：
1. 错误信息截图
2. 修复脚本执行日志
3. 测试页面截图
4. 数据库版本信息

---

**文档版本**：1.0  
**创建时间**：2026-02-03  
**适用场景**：修复 upgrade_v2.sql 执行后的遗留问题
