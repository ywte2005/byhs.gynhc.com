# 路由守卫调试指南

## 问题现象

路由守卫的`isAuth`配置没有生效，需要登录的页面没有被拦截。

## 排查步骤

### 第1步：检查路由守卫是否初始化

1. 在HBuilderX中运行项目到浏览器
2. 打开浏览器控制台（F12）
3. 查看是否有以下日志：

```
[路由守卫] 已初始化
[路由守卫] PAGES数组内容:
  - /pages/auth/certification (需要登录)
  - /pages/merchant/index (需要登录)
  ...
[路由守卫] 总共 XX 个页面
```

**如果没有看到这些日志**：
- 检查`App.uvue`中是否调用了`setupRouterGuard()`
- 检查是否有JavaScript错误阻止了初始化

### 第2步：检查PAGES数组是否包含meta信息

查看控制台输出的PAGES数组，确认：
- 是否有需要登录的页面被列出
- 页面路径是否正确
- meta.isAuth是否为true

**如果PAGES数组为空或没有meta信息**：
- 这是编译问题，`pages.json`的内容没有被正确注入
- 需要检查编译配置

### 第3步：测试页面跳转

1. 清除localStorage：
   ```javascript
   localStorage.clear();
   ```

2. 点击一个需要登录的页面（如"任务大厅"）

3. 查看控制台输出：

```
[路由守卫] 准备访问页面: /pages/task/index
[路由守卫] meta信息: {isAuth: true}
[路由守卫] isAuth: true
[路由守卫] 页面 /pages/task/index 需要登录，但未检测到token，跳转到登录页
```

**如果meta信息为空或undefined**：
- 说明`router.beforeEach`接收到的`to`对象没有meta信息
- 需要检查`router.push()`方法中`getMeta()`的实现

### 第4步：手动检查PAGES数组

在控制台执行以下代码：

```javascript
// 检查PAGES数组（需要先导入）
// 由于PAGES在模块内部，我们需要通过其他方式访问

// 方法1：检查pages.json是否正确
fetch('/pages.json')
  .then(r => r.json())
  .then(data => {
    console.log('pages.json内容:', data);
    
    // 检查subPackages中的meta配置
    data.subPackages.forEach(pkg => {
      pkg.pages.forEach(page => {
        if (page.meta && page.meta.isAuth) {
          console.log(`需要登录: ${pkg.root}/${page.path}`);
        }
      });
    });
  });
```

## 可能的问题和解决方案

### 问题1：PAGES数组为空

**原因**：`ctx`对象没有被正确初始化

**解决方案**：
1. 检查`cool-unix/.cool/ctx/index.ts`中的`ctx`对象
2. 确认`pages.json`文件存在且格式正确
3. 重新编译项目

### 问题2：meta信息丢失

**原因**：在`router.push()`中，`getMeta()`方法没有正确获取meta

**解决方案**：
修改`cool-unix/.cool/router/index.ts`中的`getMeta()`方法，添加调试日志：

```typescript
// 获取页面元数据
getMeta(path: string) {
	const page = PAGES.find((e) => path.includes(e.path));
	console.log(`[Router] getMeta for ${path}:`, page?.meta);
	return page?.meta ?? ({} as UTSJSONObject);
}
```

### 问题3：beforeEach钩子没有被调用

**原因**：路由守卫没有正确注册

**解决方案**：
1. 确认`App.uvue`中调用了`setupRouterGuard()`
2. 确认`setupRouterGuard()`在`onLaunch`中执行
3. 检查是否有JavaScript错误

### 问题4：pages.json配置错误

**原因**：meta配置格式不正确

**检查**：
```json
{
  "path": "pages/task/index",
  "style": {
    "navigationBarTitleText": "任务大厅"
  },
  "meta": {
    "isAuth": true
  }
}
```

**注意**：
- `meta`必须是对象
- `isAuth`必须是布尔值`true`，不能是字符串`"true"`
- `meta`必须在`style`同级

## 临时解决方案

如果路由守卫一直无法生效，可以使用以下临时方案：

### 方案1：在页面onLoad中检查

在每个需要登录的页面的`onLoad`生命周期中添加：

```typescript
import { isLoggedIn, forceLogin } from "@/.cool/router/guard";

export default {
  onLoad() {
    if (!isLoggedIn()) {
      forceLogin(this.$route.path);
    }
  }
}
```

### 方案2：使用页面mixin

创建一个全局mixin，在所有页面加载时检查：

```typescript
// App.uvue
import { isLoggedIn, forceLogin, checkPageAuth } from "@/.cool/router/guard";

export default {
  onLaunch() {
    // 全局页面加载拦截
    uni.addInterceptor('navigateTo', {
      invoke(args) {
        const path = args.url.split('?')[0];
        if (checkPageAuth(path) && !isLoggedIn()) {
          forceLogin(path);
          return false; // 阻止跳转
        }
      }
    });
  }
}
```

## 调试命令

在浏览器控制台执行以下命令进行调试：

### 1. 检查Token
```javascript
console.log('Token:', localStorage.getItem('token'));
console.log('Token过期时间:', localStorage.getItem('token_expire'));
```

### 2. 检查当前路由
```javascript
console.log('当前路由:', window.location.hash);
```

### 3. 模拟未登录
```javascript
localStorage.clear();
location.reload();
```

### 4. 检查pages.json
```javascript
fetch('/pages.json')
  .then(r => r.json())
  .then(data => console.log('pages.json:', data));
```

## 下一步

如果以上步骤都无法解决问题，请提供以下信息：

1. 控制台完整日志
2. PAGES数组的内容
3. pages.json的配置
4. 当前使用的uni-app版本
5. HBuilderX版本

这些信息将帮助我们更准确地定位问题。
