# 前后端接口对接完整方案

## 问题总结

前端使用RESTful风格接口（`/app/user/login/phone`），但后端使用传统控制器风格（`/api/user/mobilelogin`），导致404错误。

## 后端现有接口清单

### 1. 用户登录相关（User控制器）
- `POST /api/user/login` - 账号密码登录
- `POST /api/user/mobilelogin` - 手机验证码登录 ✅
- `POST /api/user/register` - 注册
- `POST /api/user/logout` - 退出登录
- `POST /api/user/profile` - 修改个人信息

### 2. 短信验证码（Sms控制器）
- `POST /api/sms/send` - 发送短信验证码 ✅
- `POST /api/sms/check` - 检测验证码

### 3. 验证接口（Validate控制器）
- `POST /api/validate/check_mobile_available` - 检测手机号是否可用
- `POST /api/validate/check_sms_correct` - 检测短信验证码

## 解决方案：创建新的RESTful接口控制器

在 `application/api/controller/app/` 目录下创建新的控制器，实现前端需要的RESTful接口。


## 实施步骤

### 1. 创建新的RESTful控制器 ✅
文件：`application/api/controller/app/User.php`

实现的接口：
- `POST /api/app/user/login/phone` - 手机号登录
- `GET /api/app/user/login/captcha` - 获取图片验证码
- `POST /api/app/user/login/smsCode` - 发送短信验证码
- `POST /api/app/user/login/refreshToken` - 刷新Token
- `POST /api/app/user/login/mini` - 微信小程序登录
- `GET /api/app/user/info/person` - 获取用户信息
- `POST /api/app/user/info/updatePerson` - 更新用户信息

### 2. 配置路由规则 ✅
文件：`application/route.php`

添加了RESTful风格的路由映射。

### 3. 测试接口

#### 测试1：获取图片验证码
```bash
curl "http://localhost/api/app/user/login/captcha?phone=18000000000&width=200&height=70"
```

#### 测试2：发送短信验证码
```bash
curl -X POST http://localhost/api/app/user/login/smsCode \
  -H "Content-Type: application/json" \
  -d '{"phone":"18000000000","code":"1234","captchaId":"xxx"}'
```

#### 测试3：手机号登录
```bash
curl -X POST http://localhost/api/app/user/login/phone \
  -H "Content-Type: application/json" \
  -d '{"phone":"18000000000","smsCode":"6666"}'
```

## 注意事项

### 1. 图片验证码实现
当前使用ThinkPHP内置的验证码类，需要确保：
- GD库已安装
- 验证码存储在缓存中（5分钟有效期）

### 2. 短信验证码
需要在后台配置短信插件：
- 安装短信验证插件
- 配置短信服务商（阿里云、腾讯云等）
- 测试环境可以使用固定验证码 `6666`

### 3. Token机制
- 登录成功返回token和refreshToken
- token有效期：2小时
- refreshToken有效期：30天
- 需要实现完整的token刷新机制

### 4. 返回格式统一
所有接口返回格式：
```json
{
  "code": 0,
  "message": "操作成功",
  "data": {}
}
```

错误码：
- 0: 成功
- 401: 未登录
- 403: 权限不足
- 1001: 参数缺失
- 1002: 参数格式错误
- 3001: 当前状态不允许该操作
- 5001: 系统异常

## 前端配置调整

前端无需修改代码，只需确保：
1. 代理配置正确（`cool-unix/config/proxy.ts`）
2. baseUrl配置正确（开发环境使用 `/dev`）
3. 请求路径以 `/app/user/` 开头

## 测试清单

- [ ] 获取图片验证码
- [ ] 发送短信验证码
- [ ] 手机号登录
- [ ] 获取用户信息
- [ ] 更新用户信息
- [ ] 刷新Token
- [ ] 401拦截跳转登录
- [ ] 403权限不足提示

## 下一步工作

1. 完善微信小程序登录功能
2. 实现完整的Token刷新机制
3. 添加接口文档
4. 添加单元测试
5. 优化错误处理
6. 添加日志记录
