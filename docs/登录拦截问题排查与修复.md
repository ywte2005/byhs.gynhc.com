# 登录拦截问题排查与修复

## 问题描述

访问 `http://localhost:9900/#/` 前端页面，发现登录拦截功能没有生效。

## 问题排查

### 1. 后端返回格式检查

**实际返回**：
```json
{
  "code": 401,
  "msg": "请登录后操作",
  "time": "1770187550",
  "data": null
}
```

**成功返回**：
```json
{
  "code": 0,
  "message": "操作成功",
  "data": {}
}
```

### 2. 前端拦截器检查

**原代码**（`.cool/service/index.ts`）：
```typescript
switch (code) {
    case 1000:  // ❌ 错误：后端返回的是 0，不是 1000
        resolve(data);
        break;
    case 401:
        user.logout();
        reject({ message: message || t("请登录后操作"), code } as Response);
        break;
    // ...
}
```

### 3. 问题原因

**状态码不匹配**：
- 后端成功返回 `code: 0`
- 前端判断成功是 `case 1000`
- 导致所有成功请求都被当作错误处理

## 解决方案

### 修复代码

**文件**：`cool-unix/.cool/service/index.ts`

**修改**：兼容两种状态码（0 和 1000）

```typescript
switch (code) {
    // 0 或 1000 都表示成功（兼容不同后端）
    case 0:
    case 1000:
        resolve(data);
        break;
    // 401 未登录或token失效
    case 401:
        user.logout();
        reject({ message: message || t("请登录后操作"), code } as Response);
        break;
    // 403 权限不足
    case 403:
        reject({ message: message || t("权限不足"), code } as Response);
        break;
    default:
        reject({ message, code } as Response);
        break;
}
```

## 后端状态码规范

根据后端开发指南，标准状态码应该是：

| 状态码 | 说明 | 前端处理 |
|--------|------|----------|
| 0 | 成功 | 返回数据 |
| 1001 | 参数缺失 | 提示错误 |
| 1002 | 参数格式错误 | 提示错误 |
| 2001 | 未登录 | 跳转登录页 |
| 2002 | 无权限 | 提示错误 |
| 3001 | 当前状态不允许该操作 | 提示错误 |
| 3002 | 余额不足 | 提示错误 |
| 3003 | 保证金不足 | 提示错误 |
| 5001 | 系统异常 | 提示错误 |

### 建议调整

为了统一前后端，建议：

**方案 1：后端调整（推荐）**
- 将未登录状态码从 `401` 改为 `2001`
- 将无权限状态码从 `403` 改为 `2002`
- 保持成功状态码为 `0`

**方案 2：前端调整（当前方案）**
- 兼容 `code: 0` 和 `code: 1000` 作为成功
- 兼容 `code: 401` 和 `code: 2001` 作为未登录
- 兼容 `code: 403` 和 `code: 2002` 作为无权限

## 完整的拦截器代码

```typescript
// 解析响应数据
const { code, message, data } = parse<Response>(
    res.data ?? { code: 0 }
)!;

switch (code) {
    // 成功（兼容 0 和 1000）
    case 0:
    case 1000:
        resolve(data);
        break;
    
    // 未登录（兼容 401 和 2001）
    case 401:
    case 2001:
        user.logout();
        reject({ message: message || t("请登录后操作"), code } as Response);
        break;
    
    // 权限不足（兼容 403 和 2002）
    case 403:
    case 2002:
        reject({ message: message || t("权限不足"), code } as Response);
        break;
    
    // 其他错误
    default:
        reject({ message, code } as Response);
        break;
}
```

## 测试工具

### 1. 请求调试工具

**页面路径**：`/pages/demo/debug-request`

**功能**：
- ✅ 查看当前登录状态
- ✅ 测试任意接口
- ✅ 查看请求和响应详情
- ✅ 实时日志记录
- ✅ 快速清除Token

**使用方法**：
1. 在 HBuilderX 中运行项目
2. 访问调试工具页面
3. 输入接口路径（如：`/api/task/list`）
4. 点击"GET 请求"或"POST 请求"
5. 查看日志中的请求和响应

### 2. 认证测试工具

**页面路径**：`/pages/demo/test-auth`

**功能**：
- ✅ 测试正常请求
- ✅ 测试 401 未登录拦截
- ✅ 测试 403 权限不足
- ✅ 测试 Token 自动刷新

## 验证步骤

### 步骤 1：测试正常请求

```typescript
// 有 Token 的情况下请求
request({ url: '/api/task/list' })
    .then(res => {
        console.log('成功:', res);
        // 应该正常返回数据
    });
```

**预期结果**：
- ✅ 请求成功
- ✅ 返回数据
- ✅ 不跳转登录页

### 步骤 2：测试 401 拦截

```typescript
// 清除 Token 后请求
storage.remove('token');
request({ url: '/api/task/list' })
    .catch(err => {
        console.log('错误:', err);
        // 应该自动跳转登录页
    });
```

**预期结果**：
- ✅ 请求失败
- ✅ 返回 code: 401
- ✅ 自动跳转到登录页
- ✅ 清除本地 Token 和用户信息

### 步骤 3：测试 403 拦截

```typescript
// 访问无权限的接口
request({ url: '/api/admin/users' })
    .catch(err => {
        console.log('错误:', err);
        // 应该提示权限不足，但不跳转
    });
```

**预期结果**：
- ✅ 请求失败
- ✅ 返回 code: 403
- ✅ 提示"权限不足"
- ✅ 不跳转登录页

## 常见问题

### Q1: 为什么要兼容两种状态码？

**A**: 
- 不同项目可能使用不同的状态码规范
- 兼容性更好，减少迁移成本
- 可以逐步统一，不影响现有功能

### Q2: 如何确认拦截器生效？

**A**: 
1. 打开浏览器开发者工具
2. 查看 Network 标签
3. 清除 Token 后发起请求
4. 观察是否跳转到登录页

### Q3: 拦截器不生效怎么办？

**A**: 
1. 检查 `.cool/service/index.ts` 是否已修改
2. 重新编译项目（HBuilderX 中重新运行）
3. 清除浏览器缓存
4. 使用调试工具查看日志

### Q4: 如何调试请求和响应？

**A**: 
1. 使用 `/pages/demo/debug-request` 调试工具
2. 查看实时日志
3. 检查请求参数和响应数据
4. 确认状态码是否正确

## 修复清单

- ✅ 修复状态码不匹配问题
- ✅ 兼容 code: 0 和 code: 1000
- ✅ 添加 401 和 2001 拦截
- ✅ 添加 403 和 2002 拦截
- ✅ 创建请求调试工具
- ✅ 创建认证测试工具
- ✅ 更新文档说明

## 后续建议

### 1. 统一状态码规范

建议前后端统一使用以下状态码：

```typescript
// 推荐的状态码规范
export const StatusCode = {
    SUCCESS: 0,           // 成功
    PARAM_MISSING: 1001,  // 参数缺失
    PARAM_ERROR: 1002,    // 参数错误
    UNAUTHORIZED: 2001,   // 未登录
    FORBIDDEN: 2002,      // 无权限
    STATE_ERROR: 3001,    // 状态错误
    BALANCE_LOW: 3002,    // 余额不足
    DEPOSIT_LOW: 3003,    // 保证金不足
    SYSTEM_ERROR: 5001    // 系统异常
};
```

### 2. 添加状态码常量

在 `config/index.ts` 中添加：

```typescript
export const StatusCode = {
    SUCCESS: [0, 1000],
    UNAUTHORIZED: [401, 2001],
    FORBIDDEN: [403, 2002]
};
```

### 3. 完善错误处理

```typescript
// 统一错误处理
const handleError = (code: number, message: string) => {
    if (StatusCode.UNAUTHORIZED.includes(code)) {
        user.logout();
    } else if (StatusCode.FORBIDDEN.includes(code)) {
        uni.showToast({ title: message, icon: 'none' });
    } else {
        uni.showToast({ title: message, icon: 'none' });
    }
};
```

---

**修复时间**：2026-02-04  
**修复状态**：✅ 已完成  
**测试状态**：⏳ 待验证  
**负责人**：前端开发团队
