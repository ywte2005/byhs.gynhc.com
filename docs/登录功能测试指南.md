# 登录功能测试指南

## 修复内容

### 1. 登录数据处理
修改了 `cool-unix/pages/user/login.uvue` 中的 `toLogin()` 方法，正确处理后端返回的登录数据：

**后端返回格式：**
```json
{
  "code": 1,
  "msg": "登录成功",
  "data": {
    "token": "87e75f75-067a-47e4-997c-16750561f9b3",
    "expire": 7200,
    "refreshToken": "87e75f75-067a-47e4-997c-16750561f9b3",
    "refreshExpire": 2592000,
    "userinfo": {
      "id": 10,
      "username": "18000000000",
      "nickname": "180****0000",
      "mobile": "18000000000",
      "avatar": "...",
      "score": 0,
      "token": "87e75f75-067a-47e4-997c-16750561f9b3",
      "user_id": 10,
      "createtime": 1770279661,
      "expiretime": 1772871661,
      "expires_in": 2592000
    }
  }
}
```

**前端处理逻辑：**
1. 提取 token 相关数据（token、expire、refreshToken、refreshExpire）
2. 调用 `user.setToken()` 保存 token 到本地存储
3. 提取 userinfo 数据
4. 调用 `user.set()` 保存用户信息到本地存储
5. 调用 `router.nextLogin()` 跳转到首页或登录前的页面

## 测试步骤

### 1. 重启前端项目
**重要：** 修改了代码后必须在 HBuilderX 中重启项目

1. 在 HBuilderX 中停止当前运行的项目
2. 点击 `运行` → `运行到浏览器` → `Chrome`
3. 等待项目启动完成

### 2. 测试登录功能

#### 测试用例 1：正常登录
1. 打开浏览器访问 `http://localhost:9900`
2. 应该自动跳转到登录页 `/pages/user/login`
3. 输入手机号：`18000000000`
4. 输入验证码：`6666`（测试环境固定验证码）
5. 勾选用户协议
6. 点击"登录"按钮
7. **预期结果：**
   - 登录成功
   - 自动跳转到首页 `/pages/index/index`
   - 控制台无报错
   - 本地存储中有 token 和 userInfo

#### 测试用例 2：验证 Token 存储
1. 登录成功后，打开浏览器开发者工具（F12）
2. 切换到 `Application` 或 `存储` 标签
3. 查看 `Local Storage` → `http://localhost:9900`
4. **预期结果：**
   - 存在 `token` 键，值为 token 字符串
   - 存在 `refreshToken` 键，值为 refreshToken 字符串
   - 存在 `userInfo` 键，值为用户信息 JSON 字符串

#### 测试用例 3：验证路由守卫
1. 登录成功后，手动清除浏览器的 Local Storage
2. 刷新页面
3. **预期结果：**
   - 自动跳转到登录页
   - 提示"请登录后操作"

#### 测试用例 4：验证登录状态持久化
1. 登录成功后
2. 关闭浏览器标签页
3. 重新打开 `http://localhost:9900`
4. **预期结果：**
   - 不需要重新登录
   - 直接进入首页
   - 用户信息正常显示

### 3. 测试错误处理

#### 测试用例 5：错误的验证码
1. 输入手机号：`18000000000`
2. 输入验证码：`1234`（错误的验证码）
3. 点击"登录"按钮
4. **预期结果：**
   - 显示错误提示："验证码不正确或已过期"
   - 不跳转页面

#### 测试用例 6：未勾选协议
1. 输入手机号和验证码
2. 不勾选用户协议
3. 点击"登录"按钮
4. **预期结果：**
   - 显示提示："请先阅读并同意《用户协议》和《隐私政策》"
   - 不发起登录请求

## 调试技巧

### 1. 查看网络请求
打开浏览器开发者工具（F12） → Network 标签：
- 查看 `/dev/api/user/mobilelogin` 请求
- 检查请求参数是否正确
- 检查响应数据格式

### 2. 查看控制台日志
打开浏览器开发者工具（F12） → Console 标签：
- 查看是否有报错信息
- 查看请求日志（开发环境会打印）

### 3. 查看本地存储
打开浏览器开发者工具（F12） → Application 标签：
- 查看 Local Storage 中的 token
- 查看 Local Storage 中的 userInfo
- 查看过期时间是否正确

## 常见问题

### Q1: 登录成功但没有跳转
**原因：** 可能是路由守卫配置问题或首页路径错误

**解决方案：**
1. 检查 `cool-unix/pages.json` 中首页路径是否正确
2. 检查 `cool-unix/.cool/router/guard.ts` 是否正确加载
3. 查看控制台是否有报错

### Q2: 提示"请登录后操作"
**原因：** Token 未正确保存或已过期

**解决方案：**
1. 检查 Local Storage 中是否有 token
2. 检查 token 的过期时间
3. 清除 Local Storage 后重新登录

### Q3: 刷新页面后需要重新登录
**原因：** Token 未持久化到本地存储

**解决方案：**
1. 检查 `user.setToken()` 是否正确调用
2. 检查 `storage.set()` 是否正确执行
3. 查看浏览器是否禁用了 Local Storage

## 相关文件

- `cool-unix/pages/user/login.uvue` - 登录页面
- `cool-unix/pages/user/components/login/phone.uvue` - 手机号登录组件
- `cool-unix/.cool/store/user.ts` - 用户状态管理
- `cool-unix/.cool/router/index.ts` - 路由管理
- `cool-unix/.cool/router/guard.ts` - 路由守卫
- `cool-unix/.cool/service/index.ts` - 请求拦截器
- `application/api/controller/User.php` - 后端登录接口

## 下一步工作

1. 测试其他需要登录的页面（商户模块、任务模块、钱包模块等）
2. 测试 Token 刷新机制
3. 测试退出登录功能
4. 完善用户信息展示页面
