# 接口对接最终方案

## 方案说明

使用系统自带的 `application/api/controller/User.php` 控制器，通过修改现有方法来兼容前端的参数格式。

## 修改内容

### 1. 修改 User.php 控制器

**文件**：`application/api/controller/User.php`

**修改点**：`mobilelogin()` 方法

**主要改动**：
- 兼容前端参数名：`phone`/`smsCode` 和 `mobile`/`captcha`
- 返回格式符合前端要求（包含 token、expire、refreshToken 等）
- 错误码使用数字格式（1001、1002、3001、5001）

### 2. 更新路由配置

**文件**：`application/route.php`

**配置**：
```php
// RESTful风格路由配置
// 用户登录相关 - 使用现有的 User 控制器
Route::post('api/app/user/login/phone', 'api/user/mobilelogin');
Route::get('api/app/user/info/person', 'api/user/index');
Route::post('api/app/user/info/updatePerson', 'api/user/profile');
```

### 3. 删除多余文件

- ✅ 删除 `application/api/controller/app/User.php`（多余的控制器）
- ✅ 清除缓存 `runtime/cache/*` 和 `runtime/temp/*`

## 接口说明

### 1. 手机号登录

**请求**：
```
POST /api/app/user/login/phone
Content-Type: application/json

{
  "phone": "18000000000",
  "smsCode": "6666"
}
```

**响应**：
```json
{
  "code": 0,
  "msg": "登录成功",
  "time": 1770258869,
  "data": {
    "token": "xxx",
    "expire": 7200,
    "refreshToken": "xxx",
    "refreshExpire": 2592000,
    "userinfo": {
      "id": 1,
      "username": "18000000000",
      "nickname": "用户昵称",
      "mobile": "18000000000",
      "avatar": "",
      "score": 0,
      "token": "xxx"
    }
  }
}
```

### 2. 获取用户信息

**请求**：
```
GET /api/app/user/info/person
Authorization: Bearer {token}
```

**响应**：
```json
{
  "code": 0,
  "msg": "",
  "time": 1770258869,
  "data": {
    "welcome": "用户昵称"
  }
}
```

### 3. 更新用户信息

**请求**：
```
POST /api/app/user/info/updatePerson
Content-Type: application/json
Authorization: Bearer {token}

{
  "nickname": "新昵称",
  "avatar": "https://example.com/avatar.jpg",
  "bio": "个人简介"
}
```

**响应**：
```json
{
  "code": 0,
  "msg": "操作成功",
  "time": 1770258869,
  "data": null
}
```

## 测试步骤

### 1. 清除浏览器缓存
- 打开浏览器开发者工具（F12）
- 进入 Application → Local Storage
- 删除所有数据或执行 `localStorage.clear()`

### 2. 访问登录页
- 打开 `http://localhost:9900`
- 应该自动跳转到登录页 `/pages/user/login`

### 3. 测试登录
- 输入手机号：`18000000000`
- 输入验证码：`6666`（测试环境固定验证码）
- 点击登录

### 4. 预期结果
- ✅ 登录成功
- ✅ 返回 token 和用户信息
- ✅ 自动跳转到首页
- ✅ 可以正常访问需要登录的页面

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 1001 | 参数缺失 |
| 1002 | 参数格式错误（手机号格式错误、验证码错误） |
| 3001 | 当前状态不允许该操作（账号被锁定） |
| 5001 | 系统异常（登录失败） |

## 注意事项

1. **测试环境验证码**：测试环境可以使用固定验证码 `6666`，无需真实发送短信
2. **Token 有效期**：Token 有效期为 7200 秒（2小时），refreshToken 有效期为 2592000 秒（30天）
3. **自动注册**：如果手机号不存在，系统会自动注册新用户
4. **缓存清除**：修改 PHP 文件后，如果使用了 OPcache，需要重启 PHP-FPM

## 服务器端操作

如果修改后仍然报错，请在服务器上执行：

```bash
# 1. 清除 ThinkPHP 缓存
rm -rf /www/wwwroot/byhs.gynhc.com/runtime/cache/*
rm -rf /www/wwwroot/byhs.gynhc.com/runtime/temp/*

# 2. 重启 PHP-FPM（清除 OPcache）
systemctl restart php-fpm
# 或
service php-fpm restart
```

## 下一步

1. 测试登录功能是否正常
2. 测试路由守卫是否正常拦截
3. 完善其他业务接口
4. 对接商户、任务、钱包等模块
