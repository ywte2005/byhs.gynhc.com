# 路由守卫实现说明

## 功能概述

实现了基于Token的路由守卫机制，在页面跳转前自动检查登录状态，避免页面闪烁和重复的接口请求。

## 核心特性

### 1. 自动登录检查
- 在页面跳转前检查Token是否存在
- 检查Token是否过期
- 需要登录的页面自动拦截并跳转到登录页

### 2. 登录后自动跳转
- 保存用户登录前要访问的页面
- 登录成功后自动跳转回原页面
- 避免用户重复操作

### 3. 无感知体验
- 不需要在每个页面单独判断登录状态
- 不会出现页面闪烁
- 不会发起无效的API请求

## 实现文件

### 1. 路由守卫核心文件
**文件**：`cool-unix/.cool/router/guard.ts`

**主要函数**：
- `setupRouterGuard()` - 初始化路由守卫
- `checkPageAuth(path)` - 检查页面是否需要登录
- `isLoggedIn()` - 检查当前是否已登录
- `forceLogin(redirectPath)` - 强制跳转到登录页

### 2. 应用初始化
**文件**：`cool-unix/App.uvue`

在`onLaunch`生命周期中调用`setupRouterGuard()`初始化路由守卫。

### 3. 页面配置
**文件**：`cool-unix/pages.json`

在需要登录的页面配置中添加`meta.isAuth: true`：

```json
{
  "path": "pages/task/index",
  "style": {
    "navigationBarTitleText": "任务大厅"
  },
  "meta": {
    "isAuth": true
  }
}
```

## 工作流程

### 场景1：未登录访问需要登录的页面

```
用户点击"任务大厅"
  ↓
路由守卫拦截
  ↓
检查Token → 不存在
  ↓
保存目标页面：/pages/task/index
  ↓
跳转到登录页：/pages/user/login
  ↓
用户完成登录
  ↓
触发afterLogin回调
  ↓
读取保存的目标页面
  ↓
跳转到：/pages/task/index
```

### 场景2：已登录访问需要登录的页面

```
用户点击"任务大厅"
  ↓
路由守卫拦截
  ↓
检查Token → 存在且未过期
  ↓
放行，正常访问页面
```

### 场景3：访问不需要登录的页面

```
用户点击"首页"
  ↓
路由守卫拦截
  ↓
检查页面配置 → meta.isAuth !== true
  ↓
直接放行，无需检查Token
```

### 场景4：Token过期

```
用户点击"我的钱包"
  ↓
路由守卫拦截
  ↓
检查Token → 存在但已过期
  ↓
清除过期Token
  ↓
保存目标页面
  ↓
跳转到登录页
```

## 配置说明

### 1. 标记需要登录的页面

在`pages.json`中为需要登录的页面添加`meta.isAuth: true`：

```json
{
  "path": "pages/wallet/index",
  "style": {
    "navigationBarTitleText": "我的钱包"
  },
  "meta": {
    "isAuth": true
  }
}
```

### 2. 不需要登录的页面

不添加`meta.isAuth`或设置为`false`：

```json
{
  "path": "pages/index/home",
  "style": {
    "navigationStyle": "custom"
  }
}
```

### 3. 登录页配置

登录页不需要添加`meta.isAuth`：

```json
{
  "path": "pages/user/login",
  "style": {
    "navigationStyle": "custom"
  }
}
```

## 使用示例

### 1. 在代码中检查登录状态

```typescript
import { isLoggedIn } from "@/.cool/router/guard";

// 检查是否已登录
if (isLoggedIn()) {
  console.log("用户已登录");
} else {
  console.log("用户未登录");
}
```

### 2. 强制跳转到登录页

```typescript
import { forceLogin } from "@/.cool/router/guard";

// 强制跳转到登录页，登录后跳转到指定页面
forceLogin("/pages/wallet/index");
```

### 3. 检查页面是否需要登录

```typescript
import { checkPageAuth } from "@/.cool/router/guard";

// 检查页面是否需要登录
const needAuth = checkPageAuth("/pages/task/index");
console.log("是否需要登录:", needAuth);
```

## 与接口401拦截的配合

### 双重保护机制

1. **路由守卫（第一层）**
   - 在页面跳转前检查Token
   - 避免无效的页面访问和API请求
   - 提供更好的用户体验

2. **接口401拦截（第二层）**
   - 在API请求返回401时处理
   - 处理Token在请求过程中过期的情况
   - 作为兜底保护

### 工作配合

```
用户访问需要登录的页面
  ↓
[路由守卫] 检查Token
  ↓
Token有效 → 放行
  ↓
页面加载，发起API请求
  ↓
[接口拦截器] 携带Token请求
  ↓
后端返回401（Token过期）
  ↓
[接口拦截器] 清除Token，跳转登录页
```

## 优势对比

### 之前的方式（仅接口401拦截）

❌ 页面会先加载
❌ 发起API请求后才发现未登录
❌ 页面会闪烁
❌ 浪费网络请求
❌ 用户体验差

### 现在的方式（路由守卫 + 接口401拦截）

✅ 页面跳转前就检查登录状态
✅ 未登录直接拦截，不加载页面
✅ 无页面闪烁
✅ 不发起无效请求
✅ 用户体验好
✅ 双重保护更安全

## 调试信息

路由守卫会在控制台输出调试信息：

```
[路由守卫] 已初始化
[路由守卫] 页面 /pages/task/index 需要登录，但未检测到token，跳转到登录页
[路由守卫] Token已过期，跳转到登录页
[路由守卫] Token有效，允许访问 /pages/wallet/index
[路由守卫] 登录成功，跳转到 /pages/task/index
```

## 注意事项

### 1. Token存储
- Token存储在localStorage中
- 使用`storage.set("token", value, expire)`设置
- 使用`storage.get("token")`获取
- 使用`storage.isExpired("token")`检查是否过期

### 2. 页面配置
- 所有需要登录的页面必须在`pages.json`中配置`meta.isAuth: true`
- 登录页、注册页、首页等公开页面不需要配置

### 3. 登录流程
- 登录成功后必须调用`user.setToken()`设置Token
- 登录成功后必须调用`router.nextLogin()`触发登录后回调

### 4. 兼容性
- 支持H5、App、小程序所有平台
- 使用uni-app条件编译处理平台差异

## 相关文件

- `cool-unix/.cool/router/guard.ts` - 路由守卫实现
- `cool-unix/.cool/router/index.ts` - 路由管理器
- `cool-unix/.cool/service/index.ts` - 接口拦截器
- `cool-unix/App.uvue` - 应用初始化
- `cool-unix/pages.json` - 页面配置

## 测试清单

- [ ] 未登录访问需要登录的页面 → 跳转到登录页
- [ ] 登录后自动跳转到之前要访问的页面
- [ ] 已登录访问需要登录的页面 → 正常访问
- [ ] 访问不需要登录的页面 → 直接访问
- [ ] Token过期后访问页面 → 跳转到登录页
- [ ] 登录页不会被拦截
- [ ] 首页不会被拦截
- [ ] 控制台输出正确的调试信息
