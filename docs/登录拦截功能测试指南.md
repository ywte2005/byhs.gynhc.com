# 登录拦截功能测试指南

## 修复内容总结

### 1. H5环境兼容性修复
已修复 `cool-unix/.cool/utils/comm.ts` 中的3个函数，解决了 `UTSJSONObject.keys is not a function` 错误：

- `keys()` - 使用条件编译，H5环境使用 `Object.keys()`
- `get()` - H5环境使用路径分割方式访问属性
- `assign()` - H5环境使用 `Object.assign()`

### 2. 请求拦截器修复
已修复 `cool-unix/.cool/service/index.ts` 中的状态码处理：

- 兼容 `code: 0` 和 `code: 1000` 作为成功响应
- 401状态码：自动清除Token并跳转登录页
- 403状态码：提示权限不足但不跳转

## 测试步骤

### 第1步：启动项目

1. 打开 HBuilderX
2. 打开 `cool-unix` 文件夹
3. 点击 `运行` → `运行到浏览器` → `Chrome`
4. 等待编译完成，浏览器会自动打开 `http://localhost:9900`

### 第2步：清除浏览器缓存

**重要：** 必须清除缓存，否则可能加载旧代码

1. 打开浏览器开发者工具（F12）
2. 右键点击刷新按钮
3. 选择 "清空缓存并硬性重新加载"
4. 或者按 `Ctrl+Shift+Delete` 清除缓存

### 第3步：检查控制台错误

1. 打开浏览器开发者工具（F12）
2. 切换到 "Console" 标签
3. 刷新页面
4. **预期结果：** 不应该再出现 `UTSJSONObject.keys is not a function` 错误

### 第4步：测试401拦截（未登录）

#### 方法1：使用调试工具页面

1. 在浏览器地址栏输入：`http://localhost:9900/#/pages/demo/debug-request`
2. 点击 "测试401未登录" 按钮
3. **预期结果：**
   - 控制台显示 "401拦截成功"
   - Token被清除
   - 自动跳转到登录页 `/pages/user/login`

#### 方法2：使用浏览器控制台

1. 打开浏览器开发者工具（F12）
2. 切换到 "Console" 标签
3. 粘贴以下代码并回车：

```javascript
fetch("http://localhost:9900/dev/task/list?category=all&page=1&pageSize=10", {
  "headers": {
    "authorization": "invalid-token",
    "language": "zh-cn"
  },
  "method": "GET"
}).then(res => res.json()).then(data => console.log(data));
```

4. **预期结果：**
   - 控制台显示返回数据：`{"code":401,"msg":"请登录后操作",...}`
   - 页面自动跳转到登录页
   - localStorage 中的 token 被清除

### 第5步：测试403拦截（权限不足）

#### 方法1：使用调试工具页面

1. 在浏览器地址栏输入：`http://localhost:9900/#/pages/demo/debug-request`
2. 点击 "测试403权限不足" 按钮
3. **预期结果：**
   - 控制台显示 "403拦截成功"
   - 显示错误提示 "权限不足"
   - **不跳转**到登录页，停留在当前页面

#### 方法2：模拟403响应

由于后端可能没有返回403的接口，可以临时修改代码测试：

1. 打开 `cool-unix/.cool/service/index.ts`
2. 在 `success` 回调中临时添加测试代码：

```typescript
// 临时测试代码 - 测试完成后删除
if (url.includes('/task/list')) {
  reject({ message: "权限不足", code: 403 } as Response);
  return;
}
```

3. 刷新页面，访问任务列表
4. **预期结果：** 显示 "权限不足" 提示，但不跳转登录页

### 第6步：验证正常请求

1. 确保已登录（有有效的Token）
2. 访问任意需要登录的页面（如任务列表）
3. **预期结果：**
   - 请求正常返回数据
   - 页面正常显示内容
   - 不会跳转到登录页

## 常见问题排查

### 问题1：仍然出现 `UTSJSONObject.keys is not a function` 错误

**原因：** 浏览器缓存了旧代码

**解决方案：**
1. 完全关闭浏览器
2. 在 HBuilderX 中停止运行
3. 重新运行项目
4. 清空浏览器缓存并硬性重新加载

### 问题2：401时没有跳转到登录页

**原因：** 可能是路由配置问题或Token未清除

**排查步骤：**
1. 打开浏览器控制台，查看是否有错误信息
2. 检查 localStorage 中的 token 是否被清除：
   ```javascript
   console.log(localStorage.getItem('token'));
   ```
3. 检查是否调用了 `user.logout()` 方法
4. 检查路由跳转是否被其他逻辑拦截

### 问题3：403时跳转到了登录页

**原因：** 代码逻辑错误，403不应该跳转

**排查步骤：**
1. 检查 `cool-unix/.cool/service/index.ts` 中的403处理逻辑
2. 确认403分支中没有调用 `user.logout()`
3. 确认只是 `reject` 错误，没有跳转逻辑

### 问题4：HBuilderX无法识别项目

**解决方案：**
1. 确保打开的是 `cool-unix` 文件夹，不是项目根目录
2. 确保 `pages.json` 文件存在
3. 重启 HBuilderX
4. 删除 `node_modules` 后重新 `npm install`

## 测试检查清单

- [ ] 浏览器控制台没有 `UTSJSONObject.keys is not a function` 错误
- [ ] 401时自动清除Token
- [ ] 401时自动跳转到登录页
- [ ] 403时显示错误提示
- [ ] 403时不跳转到登录页
- [ ] 正常请求（code: 0）能正常返回数据
- [ ] 正常请求（code: 1000）能正常返回数据
- [ ] 页面功能正常，没有其他错误

## 下一步工作

测试通过后，可以：

1. 删除测试页面（如果不需要）：
   - `cool-unix/pages/demo/test-auth.uvue`
   - `cool-unix/pages/demo/debug-request.uvue`

2. 删除临时测试代码（如果添加了）

3. 继续开发其他功能

## 相关文档

- [H5环境兼容性修复总结](./H5环境兼容性修复总结.md)
- [登录拦截问题排查与修复](./登录拦截问题排查与修复.md)
- [登录拦截机制说明](../cool-unix/docs/登录拦截机制说明.md)
