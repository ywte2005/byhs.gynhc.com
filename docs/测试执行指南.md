# 数据库字段更新测试指南

## 快速开始

### 第一步：本地检查
运行本地检查脚本：
```bash
check_update.bat
```

这个脚本会：
- ✓ 清除缓存
- ✓ 清除临时文件
- ✓ 检查所有更新的文件是否存在

### 第二步：上传测试文件
将 `test_field_update.php` 上传到网站根目录（通过 FTP 或 SFTP）

### 第三步：运行在线测试
访问：`http://你的域名/test_field_update.php`

测试工具会自动检查：
1. ✓ 数据库表字段是否正确
2. ✓ Model 方法是否正常
3. ✓ Service 方法是否正常
4. ✓ 语言包是否更新
5. ✓ 代码中是否还有旧字段名

### 第四步：查看测试结果
测试工具会显示：
- 总测试数
- 通过数量
- 失败数量
- 通过率
- 详细的测试结果

**期望结果**：通过率 100%

### 第五步：手动功能测试

#### 1. 测试推广模块
- 访问后台：`/admin/promo/relation`
- 点击任意用户的"详情"按钮
- 检查业绩统计是否正常显示
- 检查业绩历史是否正常显示

#### 2. 测试业绩统计
- 访问后台：`/admin/statistics/performance`
- 选择月份查看业绩统计
- 检查数据是否正常显示
- 检查图表是否正常渲染

#### 3. 测试分红管理
- 访问后台：`/admin/statistics/bonus`
- 选择月份查看分红统计
- 检查分红数据是否正常
- 检查期数显示是否正确

#### 4. 测试 API 接口
使用 Postman 或浏览器测试：

**业绩汇总接口**
```
GET /api/promo/performanceSummary?month=2026-02
```

期望返回：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "personal": {
      "total": "0.00",
      "month": "0.00",
      "growth": "0.00"
    },
    "team": {
      "total": "0.00",
      "month": "0.00",
      "growth": "0.00",
      "direct_count": 0
    }
  }
}
```

### 第六步：检查错误日志
```bash
# Windows
type runtime\log\error_*.log

# Linux
cat runtime/log/error_*.log
```

如果有错误，记录错误信息并修复。

### 第七步：清理测试文件
测试完成后，立即删除测试文件：
```bash
# 删除测试文件
del test_field_update.php

# 或通过 FTP/SFTP 删除
```

## 常见问题

### Q1: 测试工具显示"表中不存在 period 字段"
**原因**：数据库升级脚本未执行

**解决方案**：
1. 登录 phpMyAdmin
2. 执行 `backend/database/upgrade_v2.sql`
3. 执行 `backend/database/upgrade_fix.sql`
4. 重新运行测试

### Q2: 测试工具显示"方法调用失败"
**原因**：缓存未清除或代码未更新

**解决方案**：
1. 运行 `check_update.bat` 清除缓存
2. 确认所有文件已上传到服务器
3. 重启 PHP-FPM（如果是 Linux 服务器）
4. 重新运行测试

### Q3: 后台页面显示异常
**原因**：浏览器缓存或语言包未更新

**解决方案**：
1. 清除浏览器缓存（Ctrl+Shift+Delete）
2. 确认语言包文件已更新
3. 刷新页面（Ctrl+F5）

### Q4: API 接口返回错误
**原因**：字段名不匹配或数据库未更新

**解决方案**：
1. 检查数据库字段是否已重命名
2. 检查 Model 文件是否已更新
3. 查看错误日志定位问题
4. 清除缓存后重试

## 测试检查清单

### 数据库检查
- [ ] fa_promo_performance 表有 period 字段
- [ ] fa_promo_performance 表有 personal_performance 字段
- [ ] fa_promo_performance 表有 team_performance 字段
- [ ] fa_promo_performance 表有 growth 字段
- [ ] fa_promo_performance 表有 direct_invite_count 字段
- [ ] fa_promo_bonus 表有 period 字段

### 代码检查
- [ ] Performance Model 已更新
- [ ] PromoService 已更新
- [ ] SettlementService 已更新
- [ ] Performance Command 已更新
- [ ] Promo Controller 已更新
- [ ] Statistics Controller 已更新
- [ ] Relation Controller 已更新
- [ ] performance 语言包已更新
- [ ] bonus 语言包已更新

### 功能检查
- [ ] 推广关系详情页正常
- [ ] 业绩统计页面正常
- [ ] 分红管理页面正常
- [ ] API 接口返回正常
- [ ] 无错误日志

### 清理检查
- [ ] 缓存已清除
- [ ] 临时文件已清除
- [ ] 测试文件已删除

## 回滚步骤

如果测试失败需要回滚：

### 1. 恢复代码
```bash
# 使用 Git 回滚
git checkout HEAD~1

# 或手动恢复备份的文件
```

### 2. 恢复数据库
```bash
# 使用备份恢复
mysql -u用户名 -p密码 byhs_gynhc_com < backup.sql
```

### 3. 清除缓存
```bash
check_update.bat
```

## 技术支持

如遇到问题，请提供：
1. 测试工具截图
2. 错误日志内容
3. 数据库表结构
4. 具体的错误信息

---

**文档版本**：1.0  
**创建时间**：2026-02-03  
**维护人员**：开发团队
