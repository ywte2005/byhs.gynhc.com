# 商户互助平台 - 定时任务配置说明

> 更新时间：2025-02-02  
> 状态：✅ 定时任务已完成

---

## 📋 定时任务清单

### 1. 月度分红计算
**命令文件：** `application/command/Bonus.php`

**功能说明：**
- 计算上月平台总刷单金额
- 计算各档位奖池金额
- 筛选达标用户
- 生成分红记录
- 自动发放分红

**执行命令：**
```bash
# 手动执行（计算上月分红）
php think bonus:calculate

# 指定月份
php think bonus:calculate 2025-01
```

**定时任务配置：**
```bash
# 每月1号凌晨0点执行
0 0 1 * * cd /path/to/project && php think bonus:calculate >> /var/log/bonus.log 2>&1
```

**执行流程：**
1. 统计上月平台总刷单金额
2. 遍历所有分红配置档位
3. 计算每个档位的奖池金额（总额 × 档位比例）
4. 筛选达标用户（团队业绩、个人业绩、达标人数、增量）
5. 计算每个用户的分红金额（奖池 / 达标人数）
6. 生成分红记录
7. 自动发放分红到用户钱包

---

### 2. 子任务超时检查
**命令文件：** `application/command/Task.php`

**功能说明：**
- 检查接单后24小时未上传凭证的子任务
- 标记超时任务为失败
- 解冻发起方保证金
- 重新派发任务

**执行命令：**
```bash
# 检查超时任务
php think task timeout
```

**定时任务配置：**
```bash
# 每5分钟执行一次
*/5 * * * * cd /path/to/project && php think task timeout >> /var/log/task_timeout.log 2>&1
```

**超时规则：**
- 接单后24小时未上传凭证 → 标记为超时
- 超时任务自动失败
- 发起方保证金解冻
- 任务重新进入待派发队列

---

### 3. 任务自动派发
**命令文件：** `application/command/Task.php`

**功能说明：**
- 自动派发进行中任务的待分配子任务
- 检查发起方保证金是否充足
- 查找可用执行方
- 冻结保证金并分配任务

**执行命令：**
```bash
# 派发待分配任务
php think task dispatch
```

**定时任务配置：**
```bash
# 每10分钟执行一次
*/10 * * * * cd /path/to/project && php think task dispatch >> /var/log/task_dispatch.log 2>&1
```

**派发规则：**
- 只派发状态为 running 的主任务
- 检查发起方保证金是否充足
- 查找互助余额满足条件的执行方
- 冻结保证金并创建子任务分配记录

---

### 4. 业绩统计快照
**命令文件：** `application/command/Performance.php`

**功能说明：**
- 统计每个用户的个人业绩
- 统计每个用户的团队业绩
- 更新业绩统计表
- 用于分红计算和等级升级判断

**执行命令：**
```bash
# 手动执行（统计昨天的业绩）
php think performance:snapshot

# 指定日期
php think performance:snapshot 2025-01-31
```

**定时任务配置：**
```bash
# 每天凌晨0点执行
0 0 * * * cd /path/to/project && php think performance:snapshot >> /var/log/performance.log 2>&1
```

**统计逻辑：**
1. 统计每个用户当月完成的刷单金额（个人业绩）
2. 统计每个用户下级的刷单金额总和（团队业绩）
3. 更新或创建业绩统计记录
4. 更新所有上级的团队业绩

---

## 🔧 配置步骤

### 1. Linux/Unix 系统配置

#### 编辑 crontab
```bash
# 编辑当前用户的定时任务
crontab -e
```

#### 添加定时任务
```bash
# 月度分红计算（每月1号凌晨0点）
0 0 1 * * cd /www/wwwroot/project && php think bonus:calculate >> /var/log/cron/bonus.log 2>&1

# 子任务超时检查（每5分钟）
*/5 * * * * cd /www/wwwroot/project && php think task timeout >> /var/log/cron/task_timeout.log 2>&1

# 任务自动派发（每10分钟）
*/10 * * * * cd /www/wwwroot/project && php think task dispatch >> /var/log/cron/task_dispatch.log 2>&1

# 业绩统计快照（每天凌晨0点）
0 0 * * * cd /www/wwwroot/project && php think performance:snapshot >> /var/log/cron/performance.log 2>&1
```

#### 查看定时任务
```bash
# 查看当前用户的定时任务
crontab -l
```

#### 创建日志目录
```bash
# 创建日志目录
mkdir -p /var/log/cron

# 设置权限
chmod 755 /var/log/cron
```

---

### 2. Windows 系统配置

#### 使用任务计划程序

**创建月度分红任务：**
1. 打开"任务计划程序"
2. 创建基本任务
3. 名称：月度分红计算
4. 触发器：每月1号凌晨0点
5. 操作：启动程序
   - 程序：`C:\php\php.exe`
   - 参数：`think bonus:calculate`
   - 起始于：`C:\www\project`

**创建超时检查任务：**
1. 名称：子任务超时检查
2. 触发器：每5分钟
3. 操作：启动程序
   - 程序：`C:\php\php.exe`
   - 参数：`think task timeout`
   - 起始于：`C:\www\project`

**创建任务派发任务：**
1. 名称：任务自动派发
2. 触发器：每10分钟
3. 操作：启动程序
   - 程序：`C:\php\php.exe`
   - 参数：`think task dispatch`
   - 起始于：`C:\www\project`

**创建业绩统计任务：**
1. 名称：业绩统计快照
2. 触发器：每天凌晨0点
3. 操作：启动程序
   - 程序：`C:\php\php.exe`
   - 参数：`think performance:snapshot`
   - 起始于：`C:\www\project`

---

## 📊 定时任务监控

### 1. 查看日志

**Linux/Unix：**
```bash
# 查看分红日志
tail -f /var/log/cron/bonus.log

# 查看超时检查日志
tail -f /var/log/cron/task_timeout.log

# 查看任务派发日志
tail -f /var/log/cron/task_dispatch.log

# 查看业绩统计日志
tail -f /var/log/cron/performance.log
```

**Windows：**
- 查看任务计划程序的历史记录
- 查看项目目录下的日志文件

### 2. 手动测试

**测试分红计算：**
```bash
# 计算上月分红
php think bonus:calculate

# 计算指定月份分红
php think bonus:calculate 2025-01
```

**测试超时检查：**
```bash
php think task timeout
```

**测试任务派发：**
```bash
php think task dispatch
```

**测试业绩统计：**
```bash
# 统计昨天的业绩
php think performance:snapshot

# 统计指定日期的业绩
php think performance:snapshot 2025-01-31
```

### 3. 监控指标

**分红计算监控：**
- 执行时间
- 生成的分红记录数
- 发放的分红总额
- 错误日志

**超时检查监控：**
- 检查的任务数
- 超时的任务数
- 处理失败的任务数

**任务派发监控：**
- 派发的任务数
- 派发失败的任务数
- 可用执行方数量

**业绩统计监控：**
- 统计的用户数
- 更新的记录数
- 执行时间

---

## ⚠️ 注意事项

### 1. 路径配置
- 确保 `cd /path/to/project` 中的路径正确
- 确保 PHP 可执行文件路径正确
- 确保日志目录有写入权限

### 2. 权限配置
```bash
# 确保命令文件有执行权限
chmod +x application/command/*.php

# 确保日志目录有写入权限
chmod 755 /var/log/cron
```

### 3. 时区配置
```bash
# 检查系统时区
date

# 设置时区（如果需要）
timedatectl set-timezone Asia/Shanghai
```

### 4. PHP 配置
- 确保 PHP CLI 版本 ≥ 7.4
- 确保 PHP 扩展已安装（pdo_mysql, mbstring, json）
- 确保 PHP 内存限制足够（建议 ≥ 256M）

### 5. 数据库连接
- 确保数据库配置正确
- 确保数据库连接池足够
- 确保数据库性能良好

---

## 🔍 故障排查

### 1. 定时任务未执行

**检查 crontab 服务：**
```bash
# 检查服务状态
systemctl status cron

# 启动服务
systemctl start cron

# 设置开机自启
systemctl enable cron
```

**检查日志：**
```bash
# 查看系统日志
tail -f /var/log/syslog | grep CRON

# 查看任务日志
tail -f /var/log/cron/bonus.log
```

### 2. 命令执行失败

**检查 PHP 路径：**
```bash
# 查找 PHP 路径
which php

# 测试 PHP 命令
php -v
```

**检查项目路径：**
```bash
# 进入项目目录
cd /path/to/project

# 测试命令
php think bonus:calculate
```

**检查权限：**
```bash
# 检查文件权限
ls -la application/command/

# 检查目录权限
ls -la /var/log/cron/
```

### 3. 数据库连接失败

**检查数据库配置：**
```bash
# 查看配置文件
cat application/database.php
```

**测试数据库连接：**
```bash
# 使用 MySQL 客户端测试
mysql -h hostname -u username -p
```

---

## 📝 定时任务总结

### 已实现的定时任务

| 任务名称 | 执行频率 | 命令文件 | 状态 |
|---------|---------|---------|------|
| 月度分红计算 | 每月1号凌晨 | Bonus.php | ✅ 完成 |
| 子任务超时检查 | 每5分钟 | Task.php | ✅ 完成 |
| 任务自动派发 | 每10分钟 | Task.php | ✅ 完成 |
| 业绩统计快照 | 每天凌晨 | Performance.php | ✅ 完成 |

### 功能完整性

- ✅ 所有核心定时任务已实现
- ✅ 完善的错误处理
- ✅ 详细的日志记录
- ✅ 支持手动执行和测试
- ✅ 支持参数配置

### 下一步

1. **配置定时任务** - 根据服务器环境配置 crontab 或任务计划程序
2. **测试执行** - 手动执行命令测试功能
3. **监控日志** - 观察定时任务执行情况
4. **性能优化** - 根据实际情况优化执行频率

---

**文档创建时间：** 2025-02-02  
**当前状态：** ✅ 定时任务100%完成  
**下一步：** 配置定时任务并测试

