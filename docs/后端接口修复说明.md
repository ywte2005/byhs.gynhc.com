# 后端接口修复说明

## 问题描述

前端调用登录接口时出现 PHP 语法错误：
```
语法解析错误: syntax error, unexpected end of file, expecting function (T_FUNCTION) or const (T_CONST)
```

## 问题原因

路由配置语法错误。ThinkPHP 5 的 `Route::post()` 方法的参数顺序为：
```php
Route::post(路由规则, 路由地址, 路由参数, 变量规则);
```

之前的配置错误地将空数组 `[]` 作为第三个参数，将参数数组作为第四个参数。

## 修复内容

### 1. 修复路由配置

**文件**：`application/route.php`

**修改前**：
```php
Route::post('api/app/user/login/phone', 'api/app.user/login', [], ['action' => 'phone']);
```

**修改后**：
```php
Route::post('api/app/user/login/phone', 'api/app.user/login', ['action' => 'phone']);
```

### 2. 清除缓存

```bash
rm -rf runtime/cache/*
rm -rf runtime/temp/*
```

## 测试接口

### 1. 手机号登录

**请求**：
```bash
POST /api/app/user/login/phone
Content-Type: application/json

{
  "phone": "18000000000",
  "smsCode": "6666"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "登录成功",
  "data": {
    "token": "xxx",
    "expire": 7200,
    "refreshToken": "xxx",
    "refreshExpire": 2592000,
    "userinfo": {
      "id": 1,
      "username": "18000000000",
      "nickname": "用户昵称",
      ...
    }
  }
}
```

### 2. 获取图片验证码

**请求**：
```bash
GET /api/app/user/login/captcha?phone=18000000000
```

**响应**：
```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "captchaId": "xxx",
    "data": "data:image/png;base64,..."
  }
}
```

### 3. 发送短信验证码

**请求**：
```bash
POST /api/app/user/login/smsCode
Content-Type: application/json

{
  "phone": "18000000000",
  "code": "1234",
  "captchaId": "xxx"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "短信已发送",
  "data": null
}
```

### 4. 刷新Token

**请求**：
```bash
POST /api/app/user/login/refreshToken
Content-Type: application/json
Authorization: Bearer xxx

{
  "refreshToken": "xxx"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "刷新成功",
  "data": {
    "token": "xxx",
    "expire": 7200,
    "refreshToken": "xxx",
    "refreshExpire": 2592000
  }
}
```

### 5. 获取用户信息

**请求**：
```bash
GET /api/app/user/info/person
Authorization: Bearer xxx
```

**响应**：
```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "id": 1,
    "username": "18000000000",
    "nickname": "用户昵称",
    ...
  }
}
```

### 6. 更新用户信息

**请求**：
```bash
POST /api/app/user/info/updatePerson
Content-Type: application/json
Authorization: Bearer xxx

{
  "nickname": "新昵称",
  "avatar": "https://example.com/avatar.jpg",
  "bio": "个人简介"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "更新成功",
  "data": null
}
```

## 注意事项

1. **短信验证码**：测试环境可以使用固定验证码 `6666`，生产环境需要对接真实的短信服务
2. **图片验证码**：需要先获取图片验证码，然后才能发送短信验证码
3. **Token认证**：除了登录接口外，其他接口都需要在请求头中携带 `Authorization: Bearer {token}`
4. **缓存清除**：修改路由配置后必须清除缓存才能生效

## 下一步

1. 测试所有接口是否正常工作
2. 对接前端登录页面
3. 实现微信小程序登录功能
4. 完善错误处理和日志记录
