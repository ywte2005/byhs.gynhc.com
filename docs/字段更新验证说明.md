# 数据库字段更新验证说明

## 更新完成情况

✅ **代码更新**：9个文件已全部更新完成  
✅ **缓存清理**：本地缓存已清除  
✅ **测试工具**：已创建并放置在 public 目录  

## 验证方法

由于测试文件需要通过 SFTP 同步到服务器，你可以通过以下方式验证更新：

### 方法 1：通过 phpMyAdmin 验证数据库字段

登录 phpMyAdmin，执行以下 SQL 查询：

```sql
-- 检查 fa_promo_performance 表字段
SHOW COLUMNS FROM fa_promo_performance;

-- 应该看到以下新字段：
-- period (不是 month)
-- personal_performance (不是 personal_amount)
-- team_performance (不是 team_amount)
-- growth (不是 growth_amount)
-- direct_invite_count (不是 direct_count)
-- team_member_count (新增)

-- 检查 fa_promo_bonus 表字段
SHOW COLUMNS FROM fa_promo_bonus;

-- 应该看到：
-- period (不是 month)
```

### 方法 2：通过后台管理验证

1. 登录后台管理系统
2. 访问推广管理 → 推广关系
3. 点击任意用户的"详情"按钮
4. 查看业绩统计是否正常显示
5. 如果没有报错，说明更新成功

### 方法 3：通过 API 接口验证

使用 Postman 或浏览器访问：

```
GET https://byhs.gynhc.com/api/promo/performanceSummary?month=2026-02
```

如果返回正常数据（不报错），说明更新成功。

### 方法 4：检查错误日志

查看服务器错误日志：

```bash
# 查看 PHP 错误日志
tail -f /www/wwwroot/byhs.gynhc.com/runtime/log/error_*.log

# 或通过 FTP 下载日志文件查看
```

如果没有字段不存在的错误，说明更新成功。

## 测试文件说明

以下测试文件已创建在 `public` 目录：

1. **test_field_update.php** - 完整测试工具（需要 ThinkPHP 框架）
2. **test_db_fields.php** - 简化版测试（直接连接数据库）
3. **test_simple.php** - 最简版测试（使用 ThinkPHP 数据库连接）

**使用方法：**
- 等待 SFTP 自动同步文件到服务器
- 访问：`https://byhs.gynhc.com/test_simple.php`
- 查看测试结果
- 测试完成后删除测试文件

## 快速验证 SQL

如果你有数据库访问权限，可以直接执行以下 SQL 快速验证：

```sql
-- 快速检查所有新字段是否存在
SELECT 
    CASE WHEN COUNT(*) = 6 THEN '✓ 所有字段存在' ELSE '✗ 缺少字段' END AS result
FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA = 'byhs_gynhc_com' 
AND TABLE_NAME = 'fa_promo_performance'
AND COLUMN_NAME IN ('period', 'personal_performance', 'team_performance', 'growth', 'direct_invite_count', 'team_member_count');

-- 检查旧字段是否已删除
SELECT 
    CASE WHEN COUNT(*) = 0 THEN '✓ 旧字段已删除' ELSE '✗ 旧字段仍存在' END AS result
FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA = 'byhs_gynhc_com' 
AND TABLE_NAME = 'fa_promo_performance'
AND COLUMN_NAME IN ('month', 'personal_amount', 'team_amount', 'growth_amount', 'direct_count');
```

## 预期结果

### 数据库字段检查
- ✅ fa_promo_performance.period 存在
- ✅ fa_promo_performance.personal_performance 存在
- ✅ fa_promo_performance.team_performance 存在
- ✅ fa_promo_performance.growth 存在
- ✅ fa_promo_performance.direct_invite_count 存在
- ✅ fa_promo_performance.team_member_count 存在
- ✅ fa_promo_bonus.period 存在
- ✅ 旧字段 month, personal_amount, team_amount 已删除

### 功能测试
- ✅ 后台推广管理页面正常
- ✅ 业绩统计页面正常
- ✅ 分红管理页面正常
- ✅ API 接口返回正常
- ✅ 无字段不存在错误

## 如果发现问题

### 问题1：字段不存在错误
**原因**：数据库升级脚本未执行

**解决方案**：
1. 登录 phpMyAdmin
2. 执行 `backend/database/upgrade_v2.sql`
3. 执行 `backend/database/upgrade_fix.sql`
4. 清除缓存

### 问题2：页面显示异常
**原因**：缓存未清除

**解决方案**：
```bash
# 清除缓存
rm -rf /www/wwwroot/byhs.gynhc.com/runtime/cache/*
rm -rf /www/wwwroot/byhs.gynhc.com/runtime/temp/*

# 重启 PHP-FPM
systemctl restart php-fpm
```

### 问题3：测试文件无法访问
**原因**：文件未同步或路径错误

**解决方案**：
1. 检查 SFTP 配置是否正确
2. 手动上传测试文件到 public 目录
3. 检查文件权限（644）

## 文件清单

### 已更新的代码文件
- application/common/model/promo/Performance.php
- application/common/library/PromoService.php
- application/common/library/SettlementService.php
- application/command/Performance.php
- application/api/controller/Promo.php
- application/admin/controller/Statistics.php
- application/admin/controller/promo/Relation.php
- application/admin/lang/zh-cn/promo/performance.php
- application/admin/lang/zh-cn/promo/bonus.php

### 测试工具（public 目录）
- public/test_field_update.php
- public/test_db_fields.php
- public/test_simple.php
- public/check_update.bat

### 文档（docs 目录）
- docs/数据库字段更新完成总结.md
- docs/测试执行指南.md
- docs/数据库字段更新说明.md
- docs/本次更新工作总结.md
- docs/字段更新验证说明.md

## 下一步

1. ✅ 代码已更新完成
2. ⏳ 等待 SFTP 同步测试文件
3. ⏳ 访问测试页面验证
4. ⏳ 测试核心功能
5. ⏳ 删除测试文件

---

**更新时间**：2026-02-03  
**状态**：代码更新完成，等待验证
