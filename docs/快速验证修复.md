# 快速验证修复

## 一键验证脚本

打开浏览器访问 `http://localhost:9900`，然后在浏览器控制台（F12）中粘贴以下代码并回车：

```javascript
// ========================================
// 登录拦截功能快速验证脚本
// ========================================

console.log('%c开始验证登录拦截功能...', 'color: blue; font-size: 16px; font-weight: bold;');

// 测试1：检查是否还有 UTSJSONObject 错误
console.log('%c\n[测试1] 检查H5兼容性修复', 'color: green; font-weight: bold;');
try {
  // 尝试访问可能导致错误的代码
  const testObj = { a: 1, b: 2 };
  const keys = Object.keys(testObj);
  console.log('✅ H5兼容性正常，Object.keys() 可用:', keys);
} catch (err) {
  console.error('❌ H5兼容性问题:', err);
}

// 测试2：检查401拦截
console.log('%c\n[测试2] 测试401拦截（未登录）', 'color: green; font-weight: bold;');
fetch("http://localhost:9900/dev/task/list?category=all&page=1&pageSize=10", {
  headers: {
    "authorization": "invalid-token-for-test",
    "language": "zh-cn"
  },
  method: "GET"
})
.then(res => res.json())
.then(data => {
  console.log('📡 后端返回数据:', data);
  
  if (data.code === 401) {
    console.log('✅ 后端正确返回401状态码');
    console.log('⏳ 等待前端拦截器处理...');
    
    // 检查是否跳转到登录页
    setTimeout(() => {
      const currentPath = window.location.hash;
      if (currentPath.includes('/pages/user/login')) {
        console.log('✅ 401拦截成功：已跳转到登录页');
      } else {
        console.log('❌ 401拦截失败：未跳转到登录页，当前路径:', currentPath);
      }
      
      // 检查Token是否被清除
      const token = localStorage.getItem('token');
      if (!token || token === 'null') {
        console.log('✅ Token已清除');
      } else {
        console.log('❌ Token未清除，当前值:', token);
      }
    }, 1000);
  } else {
    console.log('⚠️ 后端未返回401，可能已登录或接口配置问题');
  }
})
.catch(err => {
  console.log('✅ 请求被拦截（这是预期行为）:', err.message || err);
});

// 测试3：检查localStorage中的数据
console.log('%c\n[测试3] 检查本地存储', 'color: green; font-weight: bold;');
setTimeout(() => {
  const token = localStorage.getItem('token');
  const userInfo = localStorage.getItem('userInfo');
  
  console.log('Token:', token || '(空)');
  console.log('UserInfo:', userInfo || '(空)');
  
  if (!token || token === 'null') {
    console.log('✅ Token状态正常（未登录）');
  } else {
    console.log('⚠️ 检测到Token，当前可能已登录');
  }
}, 1500);

// 测试4：检查当前路由
console.log('%c\n[测试4] 检查当前路由', 'color: green; font-weight: bold;');
setTimeout(() => {
  const currentPath = window.location.hash;
  console.log('当前路由:', currentPath);
  
  if (currentPath.includes('/pages/user/login')) {
    console.log('✅ 已在登录页');
  } else {
    console.log('ℹ️ 当前不在登录页');
  }
}, 2000);

// 总结
setTimeout(() => {
  console.log('%c\n========================================', 'color: blue; font-size: 14px;');
  console.log('%c验证完成！请查看上方测试结果', 'color: blue; font-size: 16px; font-weight: bold;');
  console.log('%c========================================', 'color: blue; font-size: 14px;');
  console.log('\n预期结果：');
  console.log('1. ✅ H5兼容性正常');
  console.log('2. ✅ 后端返回401状态码');
  console.log('3. ✅ 前端拦截器捕获401');
  console.log('4. ✅ Token被清除');
  console.log('5. ✅ 自动跳转到登录页');
  console.log('\n如果所有测试都通过，说明修复成功！');
}, 2500);
```

## 预期输出

如果修复成功，控制台应该显示：

```
开始验证登录拦截功能...

[测试1] 检查H5兼容性修复
✅ H5兼容性正常，Object.keys() 可用: ['a', 'b']

[测试2] 测试401拦截（未登录）
📡 后端返回数据: {code: 401, msg: "请登录后操作", ...}
✅ 后端正确返回401状态码
⏳ 等待前端拦截器处理...
✅ 请求被拦截（这是预期行为）: 请登录后操作
✅ 401拦截成功：已跳转到登录页
✅ Token已清除

[测试3] 检查本地存储
Token: (空)
UserInfo: (空)
✅ Token状态正常（未登录）

[测试4] 检查当前路由
当前路由: #/pages/user/login
✅ 已在登录页

========================================
验证完成！请查看上方测试结果
========================================

预期结果：
1. ✅ H5兼容性正常
2. ✅ 后端返回401状态码
3. ✅ 前端拦截器捕获401
4. ✅ Token被清除
5. ✅ 自动跳转到登录页

如果所有测试都通过，说明修复成功！
```

## 手动验证步骤

如果不想使用脚本，可以手动验证：

### 1. 启动项目
- 在 HBuilderX 中运行项目到浏览器
- 访问 `http://localhost:9900`

### 2. 清除缓存
- 按 `Ctrl+Shift+Delete` 清除浏览器缓存
- 或右键刷新按钮 → "清空缓存并硬性重新加载"

### 3. 检查控制台
- 按 F12 打开开发者工具
- 查看 Console 标签
- **不应该有** `UTSJSONObject.keys is not a function` 错误

### 4. 测试401拦截
- 在控制台粘贴以下代码：
```javascript
fetch("http://localhost:9900/dev/task/list", {
  headers: { "authorization": "invalid" },
  method: "GET"
}).then(r => r.json()).then(console.log);
```
- 观察是否跳转到登录页

### 5. 检查Token
- 在控制台输入：`localStorage.getItem('token')`
- 应该返回 `null` 或空字符串

## 常见问题

### Q1: 控制台仍然报错 `UTSJSONObject.keys is not a function`
**A:** 清除浏览器缓存，完全关闭浏览器后重新打开

### Q2: 401时没有跳转到登录页
**A:** 检查控制台是否有其他错误，查看 Network 标签确认请求是否发出

### Q3: 脚本执行后没有任何输出
**A:** 确保在正确的页面执行（`http://localhost:9900`），不是 `file://` 协议

### Q4: 提示跨域错误
**A:** 确保项目在 HBuilderX 中运行，使用的是开发服务器（`localhost:9900`）

## 下一步

验证通过后，可以：

1. ✅ 删除测试页面和调试工具
2. ✅ 继续开发其他功能
3. ✅ 提交代码到版本控制

验证失败，请查看：
- [登录拦截功能测试指南](./登录拦截功能测试指南.md) - 详细测试步骤
- [登录拦截问题排查与修复](./登录拦截问题排查与修复.md) - 问题排查
- [H5环境兼容性修复总结](./H5环境兼容性修复总结.md) - 兼容性修复详情
