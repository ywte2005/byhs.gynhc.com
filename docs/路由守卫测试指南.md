# 路由守卫测试指南

## 测试前准备

1. 在HBuilderX中运行前端项目到浏览器
2. 打开浏览器开发者工具（F12）
3. 切换到Console标签，查看日志输出

## 测试场景

### 测试1：未登录访问需要登录的页面

**步骤：**
1. 清除浏览器localStorage：
   ```javascript
   localStorage.clear();
   ```
2. 刷新页面
3. 点击"任务大厅"或其他需要登录的页面

**预期结果：**
- ✅ 控制台输出：`[路由守卫] 页面 /pages/task/index 需要登录，但未检测到token，跳转到登录页`
- ✅ 自动跳转到登录页
- ✅ 不会看到任务大厅页面闪烁
- ✅ 不会发起任务列表的API请求

### 测试2：登录后自动跳转

**步骤：**
1. 在登录页输入手机号：18000000000
2. 输入验证码：6666
3. 点击登录

**预期结果：**
- ✅ 控制台输出：`[路由守卫] 登录成功，跳转到 /pages/task/index`
- ✅ 自动跳转到之前要访问的"任务大厅"页面
- ✅ 页面正常加载数据

### 测试3：已登录访问需要登录的页面

**步骤：**
1. 确保已登录（localStorage中有token）
2. 点击"我的钱包"

**预期结果：**
- ✅ 控制台输出：`[路由守卫] Token有效，允许访问 /pages/wallet/index`
- ✅ 直接进入钱包页面
- ✅ 无需跳转到登录页

### 测试4：访问不需要登录的页面

**步骤：**
1. 清除localStorage
2. 点击"首页"

**预期结果：**
- ✅ 直接进入首页
- ✅ 不会跳转到登录页
- ✅ 控制台无拦截日志

### 测试5：Token过期后访问页面

**步骤：**
1. 在控制台手动设置一个过期的token：
   ```javascript
   localStorage.setItem('token', 'expired_token');
   localStorage.setItem('token_expire', Date.now() - 1000); // 设置为已过期
   ```
2. 点击"任务大厅"

**预期结果：**
- ✅ 控制台输出：`[路由守卫] Token已过期，跳转到登录页`
- ✅ 自动跳转到登录页
- ✅ Token被清除

### 测试6：登录页不会被拦截

**步骤：**
1. 清除localStorage
2. 直接访问登录页：`http://localhost:9900/#/pages/user/login`

**预期结果：**
- ✅ 正常显示登录页
- ✅ 不会被拦截
- ✅ 不会重定向

## 浏览器控制台测试命令

### 1. 检查当前登录状态
```javascript
// 检查是否有token
console.log('Token:', localStorage.getItem('token'));

// 检查token是否过期
const expire = localStorage.getItem('token_expire');
if (expire) {
  const isExpired = Date.now() > parseInt(expire);
  console.log('Token过期:', isExpired);
}
```

### 2. 模拟未登录
```javascript
localStorage.clear();
location.reload();
```

### 3. 模拟Token过期
```javascript
localStorage.setItem('token', 'test_token');
localStorage.setItem('token_expire', Date.now() - 1000);
```

### 4. 模拟已登录
```javascript
localStorage.setItem('token', 'test_token_' + Date.now());
localStorage.setItem('token_expire', Date.now() + 7200000); // 2小时后过期
```

### 5. 查看保存的跳转路径
```javascript
console.log('登录后跳转:', localStorage.getItem('redirect_after_login'));
```

## 完整测试流程

### 流程1：完整的登录流程

```
1. 清除localStorage
   ↓
2. 访问首页（不需要登录）→ 正常访问
   ↓
3. 点击"任务大厅"（需要登录）→ 跳转到登录页
   ↓
4. 输入手机号和验证码
   ↓
5. 点击登录 → 登录成功
   ↓
6. 自动跳转到"任务大厅"
   ↓
7. 点击"我的钱包"（需要登录）→ 正常访问
```

### 流程2：Token过期处理

```
1. 登录成功，获得Token
   ↓
2. 手动设置Token为过期状态
   ↓
3. 点击"我的钱包"
   ↓
4. 路由守卫检测到Token过期
   ↓
5. 清除Token，跳转到登录页
   ↓
6. 重新登录
   ↓
7. 自动跳转回"我的钱包"
```

## 常见问题排查

### 问题1：路由守卫没有生效

**排查步骤：**
1. 检查控制台是否输出：`[路由守卫] 已初始化`
2. 检查`App.uvue`中是否调用了`setupRouterGuard()`
3. 检查`pages.json`中页面是否配置了`meta.isAuth: true`

### 问题2：登录后没有自动跳转

**排查步骤：**
1. 检查登录成功后是否调用了`router.nextLogin()`
2. 检查localStorage中是否保存了`redirect_after_login`
3. 检查控制台是否有错误信息

### 问题3：页面仍然闪烁

**排查步骤：**
1. 确认路由守卫已初始化
2. 检查是否在页面的`onLoad`中发起了API请求
3. 确认Token检查在页面加载前执行

### 问题4：无限重定向到登录页

**排查步骤：**
1. 检查登录页是否配置了`meta.isAuth: true`（不应该配置）
2. 检查Token是否正确保存
3. 检查Token过期时间是否正确

## 性能对比测试

### 测试方法
使用浏览器Network标签，对比路由守卫前后的请求数量。

### 之前（仅接口401拦截）
```
访问任务大厅（未登录）：
1. 加载页面HTML
2. 加载页面资源（JS/CSS）
3. 发起任务列表API请求 → 返回401
4. 跳转到登录页
5. 加载登录页HTML
6. 加载登录页资源

总请求数：6+
页面闪烁：是
无效请求：1个
```

### 现在（路由守卫 + 接口401拦截）
```
访问任务大厅（未登录）：
1. 路由守卫拦截 → 直接跳转登录页
2. 加载登录页HTML
3. 加载登录页资源

总请求数：3
页面闪烁：否
无效请求：0个
```

**性能提升：**
- ✅ 请求数减少50%
- ✅ 无页面闪烁
- ✅ 无无效API请求
- ✅ 用户体验更好

## 测试检查清单

### 基础功能
- [ ] 路由守卫已初始化
- [ ] 未登录访问需要登录的页面被拦截
- [ ] 登录后自动跳转到之前的页面
- [ ] 已登录访问需要登录的页面正常
- [ ] 访问不需要登录的页面不被拦截

### Token处理
- [ ] Token过期后被拦截
- [ ] Token被清除后跳转登录页
- [ ] 登录成功后Token正确保存
- [ ] Token有效期正确设置

### 用户体验
- [ ] 无页面闪烁
- [ ] 无无效API请求
- [ ] 跳转流畅
- [ ] 控制台日志清晰

### 边界情况
- [ ] 登录页不会被拦截
- [ ] 首页不会被拦截
- [ ] 多次快速点击不会出错
- [ ] 刷新页面后状态正确

## 相关文档

- [路由守卫实现说明](./路由守卫实现说明.md)
- [前端登录拦截完整修复总结](./前端登录拦截完整修复总结.md)
- [登录拦截机制说明](../cool-unix/docs/登录拦截机制说明.md)
