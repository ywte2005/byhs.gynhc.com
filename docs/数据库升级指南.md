# 数据库升级指南

## 概述

本文档说明如何将现有线上数据库升级到新版本。升级脚本会在保留现有数据的基础上，添加新字段、修改表结构、创建新表。

## 升级前准备

### 1. 备份数据库（必须！）

在执行升级前，务必备份整个数据库：

```bash
# 方法1：使用phpMyAdmin导出
1. 登录phpMyAdmin
2. 选择数据库 byhs_gynhc_com
3. 点击"导出"
4. 选择"快速"导出方式
5. 点击"执行"下载备份文件

# 方法2：使用命令行（如果有SSH权限）
mysqldump -u用户名 -p密码 byhs_gynhc_com > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 2. 检查当前数据库状态

确认当前数据库中的表和数据：

```sql
-- 查看所有表
SHOW TABLES;

-- 查看关键表的记录数
SELECT 'fa_merchant' as table_name, COUNT(*) as count FROM fa_merchant
UNION ALL
SELECT 'fa_mutual_task', COUNT(*) FROM fa_mutual_task
UNION ALL
SELECT 'fa_promo_level', COUNT(*) FROM fa_promo_level
UNION ALL
SELECT 'fa_promo_relation', COUNT(*) FROM fa_promo_relation
UNION ALL
SELECT 'fa_wallet', COUNT(*) FROM fa_wallet;
```

## 升级步骤

### 方法1：使用phpMyAdmin执行（推荐）

1. **登录phpMyAdmin**
   - 访问：http://你的域名/phpmyadmin
   - 输入数据库用户名和密码

2. **选择数据库**
   - 在左侧列表中点击 `byhs_gynhc_com` 数据库

3. **执行升级脚本**
   - 点击顶部菜单的"SQL"标签
   - 打开 `backend/database/upgrade.sql` 文件
   - 复制全部内容
   - 粘贴到SQL执行框中
   - 点击"执行"按钮

4. **查看执行结果**
   - 检查是否有错误信息
   - 如果有错误，记录错误信息并联系技术支持
   - 如果成功，会显示"查询已成功执行"

### 方法2：使用命令行执行（如果有SSH权限）

```bash
# 进入项目目录
cd /path/to/project

# 执行升级脚本
mysql -u用户名 -p密码 byhs_gynhc_com < backend/database/upgrade.sql

# 检查执行结果
echo $?  # 如果返回0表示成功
```

## 升级内容说明

### 一、修改的表结构

#### 1. 商户表 (fa_merchant)
- **新增字段**：
  - `type` - 商户类型（个人/企业）
  - `business_license_no` - 统一社会信用代码
  - `contact_address` - 联系地址
  - `category` - 经营类目
  - `approved_time` - 审核通过时间
- **删除字段**：
  - `entry_fee_paid` - 已合并到status字段逻辑中

#### 2. 商户审核表 (fa_merchant_audit)
- **新增字段**：
  - `user_id` - 用户ID
  - `operator_id` - 操作员ID
  - `operator_name` - 操作员姓名
- **字段重命名**：
  - `action` → `status`
  - `remark` → `reason`

#### 3. 互助主任务表 (fa_mutual_task)
- **新增字段**：
  - `title` - 任务标题
  - `category` - 任务类目
  - `platform` - 平台类型
  - `time_limit` - 完成时限
  - `proof_type` - 凭证类型
  - `requirements` - 任务要求
- **删除字段**：
  - `receipt_type` - 收款类型
  - `entry_qrcode` - 进件二维码
  - `collection_qrcode` - 收款码
  - `reject_reason` - 驳回原因

#### 4. 子任务表 (fa_sub_task)
- **新增字段**：
  - `proof_desc` - 凭证说明

#### 5. 钱包表 (fa_wallet)
- **新增字段**：
  - `total_recharge` - 累计充值

#### 6. 提现表 (fa_withdraw)
- **字段重命名**：
  - `withdraw_no` → `order_no`
- **新增字段**：
  - `complete_time` - 完成时间
  - `fail_reason` - 失败原因
  - `remark` - 备注
- **删除字段**：
  - `reject_reason` - 已改为fail_reason
  - `admin_id` - 不再使用
  - `paid_time` - 已改为complete_time

#### 7. 等级配置表 (fa_promo_level)
- **新增字段**：
  - `createtime` - 创建时间
  - `updatetime` - 更新时间

#### 8. 推广关系表 (fa_promo_relation)
- **新增字段**：
  - `updatetime` - 更新时间

#### 9. 佣金记录表 (fa_promo_commission)
- **新增字段**：
  - `createtime` - 创建时间

#### 10. 分红配置表 (fa_promo_bonus_config)
- **新增字段**：
  - `createtime` - 创建时间
  - `updatetime` - 更新时间

#### 11. 分红记录表 (fa_promo_bonus)
- **字段重命名**：
  - `month` → `period`
- **新增字段**：
  - `createtime` - 创建时间

#### 12. 业绩统计表 (fa_promo_performance)
- **字段重命名**：
  - `month` → `period`
  - `personal_amount` → `personal_performance`
  - `team_amount` → `team_performance`
  - `growth_amount` → `growth`
  - `direct_count` → `direct_invite_count`
- **新增字段**：
  - `team_member_count` - 团队人数
  - `createtime` - 创建时间

#### 13. 奖励规则表 (fa_reward_rule)
- **新增字段**：
  - `sort` - 排序
  - `updatetime` - 更新时间

#### 14. 分润规则表 (fa_profit_rule)
- **字段重命名**：
  - `profit_rate` → `rate`
- **新增字段**：
  - `sort` - 排序
  - `updatetime` - 更新时间

### 二、新建的表

#### 1. 提现记录表 (fa_withdraw_record)
新的提现记录表，结构更完善，支持更多状态和字段。

#### 2. 系统配置扩展表 (fa_system_config_ext)
用于存储系统配置参数，包括：
- 任务配置（子任务金额范围、服务费率、互助余额阈值）
- 钱包配置（提现手续费、提现金额限制）
- 分红配置（计算日期、发放日期）

### 三、索引优化

为以下表添加了索引以提升查询性能：
- `fa_promo_commission` - 用户ID、来源用户ID、场景、状态、创建时间
- `fa_promo_bonus` - 用户ID、期数、状态
- `fa_promo_performance` - 用户ID+期数联合唯一索引、期数
- `fa_reward_rule` - 场景、奖励类型、状态、排序
- `fa_profit_rule` - 等级差、状态、排序

## 升级后验证

### 1. 检查表结构

```sql
-- 检查商户表结构
DESCRIBE fa_merchant;

-- 检查新增的系统配置表
DESCRIBE fa_system_config_ext;
SELECT * FROM fa_system_config_ext;

-- 检查提现记录表
DESCRIBE fa_withdraw_record;
```

### 2. 检查数据完整性

```sql
-- 检查商户数据是否完整
SELECT COUNT(*) FROM fa_merchant;

-- 检查钱包数据是否完整
SELECT COUNT(*) FROM fa_wallet;

-- 检查推广关系是否完整
SELECT COUNT(*) FROM fa_promo_relation;

-- 检查等级配置
SELECT * FROM fa_promo_level ORDER BY sort;

-- 检查分红配置
SELECT * FROM fa_promo_bonus_config ORDER BY sort;

-- 检查奖励规则
SELECT * FROM fa_reward_rule ORDER BY sort;

-- 检查分润规则
SELECT * FROM fa_profit_rule ORDER BY sort;
```

### 3. 检查索引

```sql
-- 检查fa_promo_commission的索引
SHOW INDEX FROM fa_promo_commission;

-- 检查fa_promo_performance的索引
SHOW INDEX FROM fa_promo_performance;
```

## 常见问题

### Q1: 执行升级脚本时出现"字段已存在"错误

**原因**：某些字段可能已经手动添加过

**解决方案**：
1. 记录错误信息
2. 跳过该字段的添加语句
3. 继续执行后续语句

### Q2: 执行升级脚本时出现"表不存在"错误

**原因**：数据库中缺少某些表

**解决方案**：
1. 检查是否选择了正确的数据库
2. 确认数据库备份是否完整
3. 联系技术支持

### Q3: 升级后数据丢失

**原因**：升级脚本执行失败或数据库损坏

**解决方案**：
1. 立即停止所有操作
2. 使用备份文件恢复数据库
3. 检查升级脚本是否有问题
4. 联系技术支持

### Q4: 升级后系统报错

**原因**：代码与新数据库结构不匹配

**解决方案**：
1. 确认后端代码已更新到最新版本
2. 清除缓存：删除 `runtime/cache` 目录
3. 重启Web服务器
4. 检查错误日志：`runtime/log`

## 回滚方案

如果升级后出现严重问题，可以回滚到升级前的状态：

### 方法1：使用备份恢复（推荐）

```bash
# 使用phpMyAdmin导入
1. 登录phpMyAdmin
2. 选择数据库 byhs_gynhc_com
3. 点击"导入"
4. 选择备份文件
5. 点击"执行"

# 使用命令行（如果有SSH权限）
mysql -u用户名 -p密码 byhs_gynhc_com < backup_文件名.sql
```

### 方法2：手动回滚（不推荐）

如果没有备份，需要手动删除新增的字段和表：

```sql
-- 警告：此操作会丢失升级后的数据！
-- 仅在确认无法恢复时使用

-- 删除新增的表
DROP TABLE IF EXISTS fa_withdraw_record;
DROP TABLE IF EXISTS fa_system_config_ext;

-- 删除新增的字段（示例）
ALTER TABLE fa_merchant DROP COLUMN IF EXISTS type;
ALTER TABLE fa_merchant DROP COLUMN IF EXISTS business_license_no;
-- ... 其他字段
```

## 技术支持

如果在升级过程中遇到问题，请联系技术支持并提供以下信息：

1. 错误信息截图
2. 数据库版本：`SELECT VERSION();`
3. 表结构：`SHOW CREATE TABLE 表名;`
4. 执行的SQL语句
5. 数据库备份文件（如果可能）

## 升级检查清单

升级完成后，请逐项检查：

- [ ] 数据库备份已完成
- [ ] 升级脚本执行成功，无错误
- [ ] 所有表结构已正确更新
- [ ] 新表已成功创建
- [ ] 索引已正确添加
- [ ] 系统配置数据已初始化
- [ ] 现有数据完整性验证通过
- [ ] 后端代码已更新到最新版本
- [ ] 缓存已清除
- [ ] 系统功能测试通过
- [ ] 前端页面显示正常
- [ ] API接口调用正常

## 下一步

升级完成后，建议：

1. **测试核心功能**
   - 商户入驻流程
   - 任务发布和执行
   - 钱包充值和提现
   - 推广关系绑定
   - 佣金和分红计算

2. **监控系统运行**
   - 查看错误日志
   - 监控数据库性能
   - 检查API响应时间

3. **更新文档**
   - 更新API文档
   - 更新操作手册
   - 记录升级过程

4. **培训用户**
   - 通知用户新功能
   - 提供使用指南
   - 收集用户反馈
