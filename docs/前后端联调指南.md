# 商户互助平台 - 前后端联调指南

> 更新时间：2025-02-02  
> 状态：待联调

---

## 📋 联调准备

### 1. 环境检查

**后端环境：**
- ✅ PHP ≥ 7.4
- ✅ MySQL ≥ 5.7
- ✅ Web服务器运行中
- ✅ 数据库已初始化
- ✅ 后端地址：`http://127.0.0.1:80`

**前端环境：**
- ✅ HBuilderX ≥ 3.8.0
- ✅ Node.js ≥ 16
- ✅ 依赖已安装
- ✅ 前端地址：`http://127.0.0.1:9900`

### 2. 配置检查

**后端配置：**
```php
// application/config.php
'app_debug' => true,  // 开启调试模式
'log' => [
    'type' => 'File',
    'path' => LOG_PATH,
    'level' => ['error', 'warning', 'info'],
],
```

**前端配置：**
```typescript
// backend/cool-unix/.env
VITE_APP_API_URL=http://127.0.0.1:80/api
```

### 3. 跨域配置

**后端添加跨域支持：**
```php
// public/index.php 或 application/common.php
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
header('Access-Control-Allow-Headers: Token, Content-Type');
```

---

## 🔧 联调步骤

### 第一步：启动后端服务

**Windows：**
```bash
# 启动Apache/Nginx
# 或使用PHP内置服务器
cd public
php -S 127.0.0.1:80
```

**Linux/Mac：**
```bash
# 启动Apache/Nginx
sudo systemctl start apache2
# 或
sudo systemctl start nginx
```

### 第二步：启动前端项目

**在HBuilderX中：**
1. 打开 `backend/cool-unix` 文件夹
2. 点击 `运行` → `运行到浏览器` → `Chrome`
3. 或按快捷键 `Ctrl+Shift+R`

**注意：** 不要使用命令行运行（npm run dev无效）

### 第三步：测试基础连接

**测试后端API：**
```bash
# 测试后端是否正常
curl http://127.0.0.1:80/api/index/index

# 应该返回JSON格式数据
```

**测试前端访问：**
- 打开浏览器访问：`http://127.0.0.1:9900`
- 应该能看到前端页面

---

## 📝 联调清单

### 1. 认证模块联调

#### 1.1 用户注册
- [ ] 前端页面：`pages/auth/register.uvue`
- [ ] 后端接口：`POST /api/user/register`
- [ ] 测试内容：
  - [ ] 表单验证
  - [ ] 邀请码绑定
  - [ ] 注册成功跳转
  - [ ] 错误提示

#### 1.2 用户登录
- [ ] 前端页面：`pages/auth/login.uvue`
- [ ] 后端接口：`POST /api/user/login`
- [ ] 测试内容：
  - [ ] 账号密码验证
  - [ ] Token保存
  - [ ] 登录成功跳转
  - [ ] 错误提示

#### 1.3 实名认证
- [ ] 前端页面：`pages/auth/certification.uvue`
- [ ] 后端接口：`POST /api/user/certification`
- [ ] 测试内容：
  - [ ] 身份证验证
  - [ ] 图片上传
  - [ ] 认证成功提示

---

### 2. 商户模块联调

#### 2.1 商户入驻
- [ ] 前端页面：`pages/merchant/register.uvue`
- [ ] 后端接口：`POST /api/merchant/register`
- [ ] 测试内容：
  - [ ] 表单验证
  - [ ] 图片上传
  - [ ] 提交成功提示

#### 2.2 审核状态
- [ ] 前端页面：`pages/merchant/audit-status.uvue`
- [ ] 后端接口：`GET /api/merchant/auditStatus`
- [ ] 测试内容：
  - [ ] 状态显示
  - [ ] 审核进度
  - [ ] 拒绝原因显示

#### 2.3 商户中心
- [ ] 前端页面：`pages/merchant/index.uvue`
- [ ] 后端接口：`GET /api/merchant/info`
- [ ] 测试内容：
  - [ ] 商户信息显示
  - [ ] 统计数据显示
  - [ ] 功能入口跳转

#### 2.4 支付入驻费
- [ ] 前端页面：`pages/merchant/register.uvue`
- [ ] 后端接口：`POST /api/merchant/payEntryFee`
- [ ] 测试内容：
  - [ ] 支付方式选择
  - [ ] 余额检查
  - [ ] 支付成功提示
  - [ ] 奖励触发验证

---

### 3. 任务模块联调

#### 3.1 任务大厅
- [ ] 前端页面：`pages/task/index.uvue`
- [ ] 后端接口：`GET /api/task/list`
- [ ] 测试内容：
  - [ ] 任务列表显示
  - [ ] 筛选功能
  - [ ] 分页加载
  - [ ] 任务详情跳转

#### 3.2 发起任务
- [ ] 前端页面：`pages/task/create.uvue`
- [ ] 后端接口：`POST /api/task/create`
- [ ] 测试内容：
  - [ ] 表单验证
  - [ ] 保证金检查
  - [ ] 任务拆分预览
  - [ ] 提交成功提示

#### 3.3 任务详情
- [ ] 前端页面：`pages/task/detail.uvue`
- [ ] 后端接口：`GET /api/task/detail`
- [ ] 测试内容：
  - [ ] 任务信息显示
  - [ ] 进度显示
  - [ ] 子任务列表
  - [ ] 操作按钮

#### 3.4 我的任务
- [ ] 前端页面：`pages/task/my-tasks.uvue`
- [ ] 后端接口：`GET /api/task/myTasks`
- [ ] 测试内容：
  - [ ] 任务列表显示
  - [ ] 状态筛选
  - [ ] 取消任务功能

#### 3.5 可接任务
- [ ] 前端页面：`pages/task/subtask/list.uvue`
- [ ] 后端接口：`GET /api/task/subtaskAvailable`
- [ ] 测试内容：
  - [ ] 任务列表显示
  - [ ] 接单资格检查
  - [ ] 接单功能

#### 3.6 我接的任务
- [ ] 前端页面：`pages/task/subtask/my.uvue`
- [ ] 后端接口：`GET /api/task/subtaskMy`
- [ ] 测试内容：
  - [ ] 任务列表显示
  - [ ] 状态筛选
  - [ ] 上传凭证入口

#### 3.7 子任务详情
- [ ] 前端页面：`pages/task/subtask/detail.uvue`
- [ ] 后端接口：`GET /api/task/subtaskDetail`
- [ ] 测试内容：
  - [ ] 任务信息显示
  - [ ] 凭证显示
  - [ ] 操作按钮

#### 3.8 上传凭证
- [ ] 前端页面：`pages/task/subtask/upload.uvue`
- [ ] 后端接口：`POST /api/task/subtaskUploadProof`
- [ ] 测试内容：
  - [ ] 图片上传
  - [ ] 提交成功提示
  - [ ] 自动完成结算

#### 3.9 保证金管理
- [ ] 前端页面：`pages/task/deposit.uvue`
- [ ] 后端接口：`POST /api/wallet/depositPay`
- [ ] 测试内容：
  - [ ] 保证金余额显示
  - [ ] 充值功能
  - [ ] 提取功能

---

### 4. 钱包模块联调

#### 4.1 钱包首页
- [ ] 前端页面：`pages/wallet/index.uvue`
- [ ] 后端接口：`GET /api/wallet/info`
- [ ] 测试内容：
  - [ ] 余额显示
  - [ ] 保证金显示
  - [ ] 互助余额显示
  - [ ] 功能入口

#### 4.2 充值
- [ ] 前端页面：`pages/wallet/recharge.uvue`
- [ ] 后端接口：`POST /api/wallet/recharge`
- [ ] 测试内容：
  - [ ] 金额输入
  - [ ] 支付方式选择
  - [ ] 充值成功提示

#### 4.3 提现
- [ ] 前端页面：`pages/wallet/withdraw.uvue`
- [ ] 后端接口：`POST /api/wallet/withdraw`
- [ ] 测试内容：
  - [ ] 金额验证
  - [ ] 银行卡信息
  - [ ] 手续费计算
  - [ ] 提现成功提示

#### 4.4 账单明细
- [ ] 前端页面：`pages/wallet/logs.uvue`
- [ ] 后端接口：`GET /api/wallet/logs`
- [ ] 测试内容：
  - [ ] 流水列表显示
  - [ ] 类型筛选
  - [ ] 分页加载

---

### 5. 推广模块联调

#### 5.1 推广中心
- [ ] 前端页面：`pages/promo/index.uvue`
- [ ] 后端接口：`GET /api/promo/overview`
- [ ] 测试内容：
  - [ ] 等级信息显示
  - [ ] 业绩统计显示
  - [ ] 团队统计显示
  - [ ] 功能入口

#### 5.2 等级体系
- [ ] 前端页面：`pages/promo/level.uvue`
- [ ] 后端接口：`GET /api/promo/levels`
- [ ] 测试内容：
  - [ ] 等级列表显示
  - [ ] 权益说明
  - [ ] 购买功能

#### 5.3 邀请好友
- [ ] 前端页面：`pages/promo/invite.uvue`
- [ ] 后端接口：`GET /api/promo/myInviteCode`
- [ ] 测试内容：
  - [ ] 邀请码显示
  - [ ] 二维码生成
  - [ ] 分享功能

#### 5.4 我的团队
- [ ] 前端页面：`pages/promo/team.uvue`
- [ ] 后端接口：`GET /api/promo/myTeam`
- [ ] 测试内容：
  - [ ] 团队列表显示
  - [ ] 层级筛选
  - [ ] 成员详情

#### 5.5 佣金记录
- [ ] 前端页面：`pages/promo/commission.uvue`
- [ ] 后端接口：`GET /api/promo/commissionList`
- [ ] 测试内容：
  - [ ] 佣金列表显示
  - [ ] 类型筛选
  - [ ] 统计数据

#### 5.6 业绩统计
- [ ] 前端页面：`pages/promo/performance.uvue`
- [ ] 后端接口：`GET /api/promo/performanceSummary`
- [ ] 测试内容：
  - [ ] 个人业绩显示
  - [ ] 团队业绩显示
  - [ ] 月度统计
  - [ ] 增量显示

#### 5.7 分红记录
- [ ] 前端页面：`pages/promo/bonus.uvue`
- [ ] 后端接口：`GET /api/promo/bonusSummary`
- [ ] 测试内容：
  - [ ] 分红概览
  - [ ] 分红记录
  - [ ] 达标档位显示

#### 5.8 推广钱包
- [ ] 前端页面：`pages/promo/wallet.uvue`
- [ ] 后端接口：`GET /api/promo/walletLogs`
- [ ] 测试内容：
  - [ ] 佣金余额显示
  - [ ] 流水记录
  - [ ] 提现功能

---

## 🧪 完整业务流程测试

### 流程1：商户入驻完整流程

**测试步骤：**
1. 用户注册（填写邀请码）
2. 用户登录
3. 实名认证
4. 商户入驻申请
5. 等待后台审核
6. 审核通过后支付入驻费
7. 验证推荐人获得奖励
8. 验证商户状态变更

**预期结果：**
- ✅ 注册成功，推广关系建立
- ✅ 登录成功，获取Token
- ✅ 认证成功
- ✅ 入驻申请提交成功
- ✅ 审核通过
- ✅ 支付成功，余额扣除
- ✅ 推荐人获得直推奖、间推奖
- ✅ 商户状态变为已入驻

---

### 流程2：互助任务完整流程

**测试步骤：**
1. 商户A发起任务（10000元，5笔）
2. 商户A充值保证金
3. 后台审核任务通过
4. 系统自动拆分并派发子任务
5. 商户B查看可接任务
6. 商户B接受子任务
7. 商户B线下支付并上传凭证
8. 系统自动完成结算
9. 验证佣金发放
10. 验证互助余额更新

**预期结果：**
- ✅ 任务创建成功
- ✅ 保证金充值成功
- ✅ 任务审核通过
- ✅ 子任务自动派发
- ✅ 商户B可以看到任务
- ✅ 接单成功，保证金冻结
- ✅ 凭证上传成功
- ✅ 自动完成结算
- ✅ 商户B获得刷单金额+佣金
- ✅ 商户A保证金解冻+扣除服务费
- ✅ 双方互助余额正确更新
- ✅ 推荐人获得分润

---

### 流程3：推广完整流程

**测试步骤：**
1. 用户A获取邀请码
2. 用户B通过邀请码注册
3. 用户B购买等级（初级代理）
4. 验证用户A获得直推奖
5. 用户C通过用户B邀请码注册
6. 用户C购买等级
7. 验证用户B获得直推奖
8. 验证用户A获得间推奖
9. 用户B完成刷单任务
10. 验证用户A获得等级差分润
11. 查看团队业绩统计
12. 月度分红计算
13. 验证分红发放

**预期结果：**
- ✅ 邀请码生成成功
- ✅ 推广关系建立正确
- ✅ 等级购买成功
- ✅ 直推奖发放正确
- ✅ 间推奖发放正确
- ✅ 等级差分润正确
- ✅ 业绩统计正确
- ✅ 分红计算正确
- ✅ 分红发放成功

---

## 🐛 常见问题排查

### 1. 跨域问题

**现象：**
- 前端请求后端接口报错：`CORS policy`

**解决方案：**
```php
// 在后端添加跨域支持
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
header('Access-Control-Allow-Headers: Token, Content-Type');
```

### 2. Token失效

**现象：**
- 接口返回：`未登录` 或 `Token无效`

**解决方案：**
- 检查Token是否正确保存
- 检查请求头是否正确设置
- 检查Token是否过期

### 3. 接口404

**现象：**
- 接口返回：`404 Not Found`

**解决方案：**
- 检查后端路由配置
- 检查URL是否正确
- 检查Web服务器配置

### 4. 数据不显示

**现象：**
- 页面空白或数据为空

**解决方案：**
- 检查接口返回数据格式
- 检查前端数据解析逻辑
- 检查数据库是否有数据

### 5. 图片上传失败

**现象：**
- 图片上传报错

**解决方案：**
- 检查上传目录权限
- 检查文件大小限制
- 检查文件类型限制

---

## 📊 联调进度跟踪

### 模块完成度

| 模块 | 页面数 | 已联调 | 未联调 | 完成率 |
|------|--------|--------|--------|--------|
| 认证模块 | 3 | 0 | 3 | 0% |
| 商户模块 | 4 | 0 | 4 | 0% |
| 任务模块 | 9 | 0 | 9 | 0% |
| 钱包模块 | 4 | 0 | 4 | 0% |
| 推广模块 | 8 | 0 | 8 | 0% |
| **总计** | **28** | **0** | **28** | **0%** |

### 问题记录

| 编号 | 模块 | 页面 | 问题描述 | 严重程度 | 状态 |
|------|------|------|----------|----------|------|
| 1 | - | - | - | - | - |

---

## 📝 联调报告模板

### 测试环境
- 后端地址：http://127.0.0.1:80
- 前端地址：http://127.0.0.1:9900
- 测试时间：2025-02-02
- 测试人员：XXX

### 测试结果
- 总页面数：28个
- 已联调：0个
- 未联调：28个
- 完成率：0%

### 问题汇总
- 严重问题：0个
- 一般问题：0个
- 轻微问题：0个

### 下一步计划
1. 完成认证模块联调
2. 完成商户模块联调
3. 完成任务模块联调
4. 完成钱包模块联调
5. 完成推广模块联调

---

**文档创建时间：** 2025-02-02  
**当前状态：** 待联调  
**预计完成时间：** 3-4天
