# 商户入驻费支付功能实现说明

## 功能概述

实现了完整的商户入驻费支付流程，包括后台配置、前端支付页面和权限控制。

## 已完成的功能

### 1. 后台管理

#### 1.1 数据库表
- 创建 `fa_merchant_entry_fee_config` 表用于配置入驻费
- 支持按商户类型（个人/个体工商户/企业）设置不同的入驻费
- 默认入驻费为 0（免费入驻）

#### 1.2 后台管理页面
- 路径：`merchant/entryfeeconfig`
- 功能：查看和编辑入驻费配置
- 文件：
  - `application/admin/controller/merchant/Entryfeeconfig.php`
  - `application/admin/view/merchant/entryfeeconfig/index.html`
  - `application/admin/view/merchant/entryfeeconfig/edit.html`
  - `public/assets/js/backend/merchant/entryfeeconfig.js`

#### 1.3 数据模型
- `application/common/model/merchant/EntryFeeConfig.php`
- 提供 `getEntryFee($merchantType)` 方法获取指定类型的入驻费

### 2. 后端 API

#### 2.1 商户注册时自动获取入驻费
- 修改 `MerchantService::register()` 方法
- 根据商户类型从配置表读取入驻费并保存到商户记录

#### 2.2 审核状态接口增强
- `MerchantService::getAuditStatus()` 返回：
  - `entry_fee`: 入驻费金额
  - `entry_fee_paid`: 是否已支付
  - `wallet_balance`: 钱包余额

#### 2.3 支付入驻费接口
- `Merchant::payEntryFee()` 接口
- 功能：
  - 检查商户状态（必须是 approved）
  - 检查是否已支付
  - 从钱包扣款
  - 更新 `entry_fee_paid` 字段
  - 创建钱包流水记录
  - 触发推广奖励（如果入驻费 > 0）
  - 使用数据库事务保证数据一致性

#### 2.4 用户信息接口增强
- `User::person()` 接口增加 `entryFeePaid` 字段
- `isMerchant` 判断逻辑：`status === 'approved' && entry_fee_paid`

### 3. 前端实现

#### 3.1 入驻费支付页面
- 路径：`/pages/merchant/pay-entry-fee`
- 文件：`cool-unix/pages/merchant/pay-entry-fee.uvue`
- 功能：
  - 显示入驻费金额
  - 显示钱包余额
  - 显示支付后余额
  - 余额不足时显示充值按钮
  - 余额充足时显示支付按钮
  - 支付成功后跳转到首页

#### 3.2 审核状态页面增强
- 文件：`cool-unix/pages/merchant/audit-status.uvue`
- 功能：
  - 审核通过后显示入驻费信息
  - 未支付时显示"支付入驻费"按钮（橙色）
  - 已支付时显示"进入商户中心"按钮（蓝色）

#### 3.3 首页路由逻辑增强
- 文件：`cool-unix/pages/index/home.uvue`
- `goToMerchantPage()` 函数逻辑：
  - 未登录 → 登录页
  - 未注册商户 → 入驻申请页
  - 审核中/被拒绝/已禁用 → 审核状态页
  - 已通过审核但未支付 → 支付入驻费页面
  - 已通过审核且已支付 → 商户中心

#### 3.4 服务层增强
- 文件：`cool-unix/services/merchant.ts`
- 新增/修改接口：
  - `getAuditStatus()`: 返回入驻费和钱包余额信息
  - `payEntryFee()`: 支付入驻费
  - 导出 `merchantService` 对象

### 4. 权限控制

#### 4.1 商户权限判断
- 用户信息中的 `isMerchant` 字段：`status === 'approved' && entry_fee_paid`
- 只有已支付入驻费的商户才能访问商户中心功能

#### 4.2 路由守卫
- 首页自动检查商户状态和支付状态
- 未支付时自动引导到支付页面
- 已支付时才能进入商户中心

## 业务流程

### 完整的商户入驻流程

```
1. 用户注册/登录
   ↓
2. 提交商户入驻申请
   ↓
3. 系统根据商户类型自动设置入驻费（从配置表读取）
   ↓
4. 后台管理员审核
   ↓
5. 审核通过
   ↓
6. 用户查看审核状态，看到"支付入驻费"按钮
   ↓
7. 点击进入支付页面
   ↓
8. 检查钱包余额
   ↓
9a. 余额不足 → 跳转充值页面
9b. 余额充足 → 确认支付
   ↓
10. 从钱包扣款
   ↓
11. 更新 entry_fee_paid = 1
   ↓
12. 创建钱包流水记录
   ↓
13. 触发推广奖励（如果入驻费 > 0）
   ↓
14. 支付成功，跳转到首页
   ↓
15. 首页检测到已支付，允许进入商户中心
```

## 配置说明

### 后台配置入驻费

1. 登录后台管理系统
2. 进入 `商户管理` → `入驻费配置`
3. 编辑对应商户类型的入驻费
4. 设置为 0 表示免费入驻
5. 保存后立即生效（只影响新申请的商户）

### 数据库配置

```sql
-- 查看当前配置
SELECT * FROM fa_merchant_entry_fee_config;

-- 修改个人商户入驻费为 100 元
UPDATE fa_merchant_entry_fee_config 
SET entry_fee = 100.00 
WHERE merchant_type = 'personal';

-- 修改个体工商户入驻费为 200 元
UPDATE fa_merchant_entry_fee_config 
SET entry_fee = 200.00 
WHERE merchant_type = 'individual';

-- 修改企业商户入驻费为 500 元
UPDATE fa_merchant_entry_fee_config 
SET entry_fee = 500.00 
WHERE merchant_type = 'enterprise';
```

## 安全设计

1. **数据库事务**：支付操作使用事务保证数据一致性
2. **悲观锁**：使用 `lock(true)` 防止并发支付
3. **状态检查**：
   - 必须是 approved 状态才能支付
   - 防止重复支付
   - 余额不足时阻止支付
4. **钱包流水**：所有资金操作都记录流水
5. **权限控制**：未支付入驻费无法访问商户功能

## 测试建议

### 1. 后台配置测试
- 测试修改入驻费配置
- 测试设置为 0（免费入驻）
- 测试不同商户类型的配置

### 2. 支付流程测试
- 测试余额充足时的支付
- 测试余额不足时的提示
- 测试重复支付的阻止
- 测试支付成功后的跳转

### 3. 权限控制测试
- 测试未支付时无法进入商户中心
- 测试支付后可以进入商户中心
- 测试首页路由的正确跳转

### 4. 奖励触发测试
- 测试入驻费 > 0 时触发推广奖励
- 测试入驻费 = 0 时不触发奖励
- 测试奖励金额计算是否正确

## 注意事项

1. **入驻费配置只影响新申请**：修改配置后，只对新提交的商户申请生效，不影响已审核通过的商户
2. **免费入驻**：入驻费设置为 0 时，系统自动标记为已支付，用户无需支付即可进入商户中心
3. **钱包余额**：用户需要先充值钱包，才能支付入驻费
4. **推广奖励**：只有入驻费 > 0 时才触发推广奖励，免费入驻不触发奖励
5. **数据一致性**：所有资金操作都使用事务，确保数据一致性

## 相关文件清单

### 后端文件
- `backend/database/18_merchant_entry_fee_config.sql` - 数据库表和菜单
- `application/common/model/merchant/EntryFeeConfig.php` - 配置模型
- `application/admin/controller/merchant/Entryfeeconfig.php` - 后台控制器
- `application/admin/view/merchant/entryfeeconfig/index.html` - 列表页面
- `application/admin/view/merchant/entryfeeconfig/edit.html` - 编辑页面
- `public/assets/js/backend/merchant/entryfeeconfig.js` - 前端脚本
- `application/common/library/MerchantService.php` - 商户服务（已修改）
- `application/api/controller/User.php` - 用户接口（已修改）

### 前端文件
- `cool-unix/pages/merchant/pay-entry-fee.uvue` - 支付页面
- `cool-unix/pages/merchant/audit-status.uvue` - 审核状态页面（已修改）
- `cool-unix/pages/index/home.uvue` - 首页（已修改）
- `cool-unix/services/merchant.ts` - 商户服务（已修改）
- `cool-unix/pages.json` - 路由配置（已修改）

## 部署步骤

1. 执行数据库脚本：`backend/database/18_merchant_entry_fee_config.sql`
2. 上传后端文件到服务器
3. 上传前端文件到服务器
4. 清除缓存
5. 在后台配置入驻费
6. 测试完整流程

## 完成时间

2026-02-12
