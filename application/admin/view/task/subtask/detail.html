<style>
    /* 基础布局优化 */
    .panel-heading { position: relative; padding: 0 !important; border-bottom: none; background: #fff; }
    .tab-content { padding: 25px; background: #fff; min-height: 400px; }

    /* 详情信息表格标准化 - 极致对齐 */
    .info-table { width: 100%; border: 1px solid #f0f0f0; border-radius: 4px; border-collapse: separate; border-spacing: 0; margin-bottom: 20px; table-layout: fixed; }
    .info-table td { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; line-height: 1.5; vertical-align: middle; }
    .info-table tr:last-child td { border-bottom: none; }
    .info-table .label-col { width: 130px; background: #fafafa; color: #8c8c8c; font-weight: 500; border-right: 1px solid #f0f0f0; text-align: right; }
    .info-table .content-col { color: #262626; word-break: break-all; padding-left: 20px; }
    
    /* 标题与装饰 */
    .section-header { display: flex; align-items: center; margin-bottom: 16px; margin-top: 10px; }
    .section-header i { color: #1890ff; margin-right: 8px; font-size: 16px; }
    .section-header span { font-size: 16px; font-weight: 600; color: #262626; }

    /* 凭证图片展示 */
    .proof-container { background: #fafafa; border: 1px solid #f0f0f0; border-radius: 8px; padding: 20px; text-align: center; }
    .proof-img { max-width: 100%; max-height: 400px; border-radius: 4px; border: 1px solid #d9d9d9; transition: all 0.3s; cursor: zoom-in; background: #fff; }
    .proof-img:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: scale(1.02); }

    /* 时间轴 Timeline */
    .timeline-container { padding: 20px 0 20px 20px; }
    .timeline { position: relative; padding-left: 30px; list-style: none; }
    .timeline::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: #f0f0f0; }
    .timeline-item { position: relative; margin-bottom: 30px; }
    .timeline-item::before { content: ""; position: absolute; left: -34px; top: 5px; width: 10px; height: 10px; border-radius: 50%; background: #fff; border: 2px solid #1890ff; z-index: 1; }
    .timeline-item.active::before { background: #1890ff; box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.2); }
    .timeline-item.disabled::before { border-color: #d9d9d9; }
    .timeline-item .timeline-time { font-size: 12px; color: #8c8c8c; margin-bottom: 4px; }
    .timeline-item .timeline-content { font-size: 14px; font-weight: 500; color: #262626; }
    .timeline-item .timeline-desc { font-size: 12px; color: #8c8c8c; margin-top: 4px; }

    /* 返回按钮位置 */
    .btn-back-container { position: absolute; right: 20px; top: 12px; z-index: 10; }

    /* 顶部操作区 */
    .header-actions { background: #e6f7ff; border: 1px solid #91d5ff; padding: 15px 20px; border-radius: 4px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
    .header-actions .action-tips { color: #0050b3; font-size: 14px; }
    .page-close-btn {
        position: fixed;
        top: 60px;
        right: 20px;
        z-index: 1000;
    }
</style>

<a href="javascript:;" class="btn btn-sm btn-danger page-close-btn" onclick="Backend.api.closetabs();"><i class="fa fa-times"></i> 返回列表</a>

<div class="panel panel-default panel-intro">
    <div class="panel-heading">
        {:build_heading(null, false)}
    </div>
    <div class="panel-body">
        <!-- 快速操作 -->
        {if in_array($row.status, ['paid', 'verified'])}
        <div class="header-actions">
            <div class="action-tips">
                <i class="fa fa-info-circle"></i> 当前任务已支付，待确认完成。请核实支付凭证。
            </div>
            <div class="action-btns">
                <a href="task/subtask/complete/ids/{$row.id}" class="btn btn-success btn-embossed btn-ajax" data-confirm="确定标记为已完成吗？此操作将释放佣金。"><i class="fa fa-check"></i> 确认完成</a>
                <a href="task/subtask/fail/ids/{$row.id}" class="btn btn-danger btn-embossed btn-dialog" title="标记失败"><i class="fa fa-times"></i> 标记失败</a>
            </div>
        </div>
        {/if}

        <div class="row">
            <div class="col-md-8">
                <div class="section-header">
                    <i class="fa fa-caret-right"></i>
                    <span>子任务详情</span>
                </div>
                <table class="info-table">
                    <tr>
                        <td class="label-col">子任务号</td>
                        <td class="content-col"><code>{$row.task_no|htmlentities}</code></td>
                    </tr>
                    <tr>
                        <td class="label-col">主任务号</td>
                        <td class="content-col">
                            <a href="task/mutualtask/detail/ids/{$row.task_id}" class="addtabsit">{$row.task.task_no|htmlentities}</a>
                        </td>
                    </tr>
                    <tr>
                        <td class="label-col">发起商户</td>
                        <td class="content-col">
                            <a href="user/user/detail/ids/{$row.from_user_id}" class="addtabsit">{$row.from_user.nickname|htmlentities}</a>
                            <small class="text-muted" style="margin-left: 5px;">(ID {$row.from_user_id})</small>
                        </td>
                    </tr>
                    <tr>
                        <td class="label-col">执行会员</td>
                        <td class="content-col">
                            {if $row.to_user_id}
                            <a href="user/user/detail/ids/{$row.to_user_id}" class="addtabsit">{$row.to_user.nickname|htmlentities}</a>
                            <small class="text-muted" style="margin-left: 5px;">(ID {$row.to_user_id})</small>
                            {else/}
                            <span class="text-muted">未分配</span>
                            {/if}
                        </td>
                    </tr>
                    <tr>
                        <td class="label-col">任务金额</td>
                        <td class="content-col text-primary" style="font-weight: 600;">¥{$row.amount|number_format=2}</td>
                    </tr>
                    <tr>
                        <td class="label-col">收益佣金</td>
                        <td class="content-col text-success">¥{$row.commission|number_format=2}</td>
                    </tr>
                    <tr>
                        <td class="label-col">当前状态</td>
                        <td class="content-col">
                            {switch $row.status}
                                {case pending}<span class="label label-default">待分配</span>{/case}
                                {case assigned}<span class="label label-primary">已分配</span>{/case}
                                {case accepted}<span class="label label-info">已接单</span>{/case}
                                {case paid}<span class="label label-warning">已支付</span>{/case}
                                {case completed}<span class="label label-success">已完成</span>{/case}
                                {case failed}<span class="label label-danger">失败</span>{/case}
                                {default /}<span class="label label-info">{$row.status_text}</span>
                            {/switch}
                        </td>
                    </tr>
                </table>

                <div class="section-header" style="margin-top: 25px;">
                    <i class="fa fa-caret-right"></i>
                    <span>支付凭证与单号</span>
                </div>
                <div class="proof-container">
                    {if $row.proof_image}
                    <div style="margin-bottom: 15px; text-align: left; padding: 10px; background: #fff; border: 1px dashed #d9d9d9;">
                        <strong>第三方支付单号：</strong> <code class="text-primary">{$row.third_order_no|default='未填写'}</code>
                    </div>
                    <a href="{$row.proof_image|cdnurl|htmlentities}" target="_blank">
                        <img src="{$row.proof_image|cdnurl|htmlentities}" class="proof-img">
                    </a>
                    {else/}
                    <div class="text-muted" style="padding: 100px 0;">
                        <i class="fa fa-picture-o fa-3x"></i>
                        <p style="margin-top: 10px;">执行方尚未上传支付凭证</p>
                    </div>
                    {/if}
                </div>
                
                {if $row.fail_reason}
                <div class="alert alert-danger-light" style="margin-top: 20px;">
                    <i class="fa fa-warning"></i> <strong>失败原因：</strong> {$row.fail_reason|htmlentities}
                </div>
                {/if}
            </div>

            <div class="col-md-4">
                <div class="section-header">
                    <i class="fa fa-clock-o"></i>
                    <span>状态流转时间轴</span>
                </div>
                <div class="timeline-container">
                    <ul class="timeline">
                        <li class="timeline-item {if $row.createtime}active{/if}">
                            <div class="timeline-time">{if $row.createtime}{:date('Y-m-d H:i:s', $row.createtime)}{else}-{/if}</div>
                            <div class="timeline-content">任务创建</div>
                            <div class="timeline-desc">主任务生成后自动拆分</div>
                        </li>
                        <li class="timeline-item {if $row.assigned_time}active{/if} {if !$row.assigned_time}disabled{/if}">
                            <div class="timeline-time">{if $row.assigned_time}{:date('Y-m-d H:i:s', $row.assigned_time)}{else}-{/if}</div>
                            <div class="timeline-content">分配完成</div>
                            <div class="timeline-desc">任务已进入待接单池</div>
                        </li>
                        <li class="timeline-item {if $row.accepted_time}active{/if} {if !$row.accepted_time}disabled{/if}">
                            <div class="timeline-time">{if $row.accepted_time}{:date('Y-m-d H:i:s', $row.accepted_time)}{else}-{/if}</div>
                            <div class="timeline-content">会员已接单</div>
                            <div class="timeline-desc">执行会员：{$row.to_user.nickname|default='-'}</div>
                        </li>
                        <li class="timeline-item {if $row.paid_time}active{/if} {if !$row.paid_time}disabled{/if}">
                            <div class="timeline-time">{if $row.paid_time}{:date('Y-m-d H:i:s', $row.paid_time)}{else}-{/if}</div>
                            <div class="timeline-content">已上传凭证</div>
                            <div class="timeline-desc">等待后台/商户审核确认</div>
                        </li>
                        <li class="timeline-item {if $row.completed_time || $row.status=='failed'}active{/if} {if !$row.completed_time && $row.status!='failed'}disabled{/if}">
                            <div class="timeline-time">
                                {if $row.status=='completed'}{:date('Y-m-d H:i:s', $row.completed_time)}
                                {elseif $row.status=='failed'}{:date('Y-m-d H:i:s', $row.updatetime)}
                                {else}-{/if}
                            </div>
                            <div class="timeline-content">
                                {if $row.status=='failed'}<span class="text-danger">任务失败</span>
                                {elseif $row.status=='completed'}<span class="text-success">任务完成</span>
                                {else}最终结果{/if}
                            </div>
                            <div class="timeline-desc">
                                {if $row.status=='completed'}佣金已发放到账
                                {elseif $row.status=='failed'}原因：{$row.fail_reason|default='未知'}
                                {else}等待最终判定{/if}
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="panel-footer">
        <div class="row">
            <div class="col-md-12 text-center">
                <button type="button" class="btn btn-default btn-embossed" onclick="Backend.api.close();">关闭页面</button>
            </div>
        </div>
    </div>
</div>
