<template>
	<view class="flex flex-col h-full bg-[#f5f5f5]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="flex items-center justify-between px-4 py-3 bg-white">
			<view class="flex items-center" @click="goBack">
				<text class="text-6">â†</text>
				<text class="text-4 ml-2">å•†æˆ·ä¿¡æ¯</text>
			</view>
			<view @click="toggleEdit">
				<text class="text-4 text-[#07c160]">{{ isEditing ? 'ä¿å­˜' : 'ç¼–è¾‘' }}</text>
			</view>
		</view>

		<!-- å†…å®¹åŒºåŸŸ -->
		<scroll-view class="flex-1" scroll-y>
			<view class="px-4 py-4">
				<!-- å•†æˆ·å¤´åƒ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<view class="flex items-center">
						<view class="w-20 h-20 rounded-full bg-[#f5f5f5] flex items-center justify-center mr-4">
							<text class="text-10">ğŸª</text>
						</view>
						<view class="flex-1">
							<text class="text-5 font-bold text-[#1f2329]">{{ merchantInfo.name }}</text>
							<text class="text-3.5 text-[#999] mt-1">å•†æˆ·ç¼–å·ï¼š{{ merchantInfo.merchantNo }}</text>
							<view class="flex items-center mt-2">
								<view class="bg-[#07c160] rounded px-2 py-0.5 mr-2">
									<text class="text-3 text-white">{{ merchantInfo.level }}</text>
								</view>
								<view class="bg-[#ff9500] rounded px-2 py-0.5">
									<text class="text-3 text-white">ä¿¡ç”¨åˆ†ï¼š{{ merchantInfo.credit }}</text>
								</view>
							</view>
						</view>
					</view>
				</view>

				<!-- åŸºæœ¬ä¿¡æ¯ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">åŸºæœ¬ä¿¡æ¯</text>
					
					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">å•†æˆ·ç±»å‹</text>
						<text class="text-4 text-[#1f2329]">{{ merchantInfo.type === 'personal' ? 'ä¸ªäººå•†æˆ·' : 'ä¼ä¸šå•†æˆ·' }}</text>
					</view>

					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">å•†æˆ·åç§°</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.name"
							class="border border-[#e5e5e5] rounded-2 px-3 py-2.5 text-4"
							placeholder="è¯·è¾“å…¥å•†æˆ·åç§°"
						/>
						<text v-else class="text-4 text-[#1f2329]">{{ merchantInfo.name }}</text>
					</view>

					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">è”ç³»äºº</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.contact"
							class="border border-[#e5e5e5] rounded-2 px-3 py-2.5 text-4"
							placeholder="è¯·è¾“å…¥è”ç³»äºº"
						/>
						<text v-else class="text-4 text-[#1f2329]">{{ merchantInfo.contact }}</text>
					</view>

					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">è”ç³»ç”µè¯</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.phone"
							type="number"
							class="border border-[#e5e5e5] rounded-2 px-3 py-2.5 text-4"
							placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
						/>
						<text v-else class="text-4 text-[#1f2329]">{{ merchantInfo.phone }}</text>
					</view>

					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">ç»è¥åœ°å€</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.address"
							class="border border-[#e5e5e5] rounded-2 px-3 py-2.5 text-4"
							placeholder="è¯·è¾“å…¥ç»è¥åœ°å€"
						/>
						<text v-else class="text-4 text-[#1f2329]">{{ merchantInfo.address }}</text>
					</view>

					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">ç»è¥ç±»ç›®</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.category"
							class="border border-[#e5e5e5] rounded-2 px-3 py-2.5 text-4"
							placeholder="è¯·è¾“å…¥ç»è¥ç±»ç›®"
						/>
						<text v-else class="text-4 text-[#1f2329]">{{ merchantInfo.category }}</text>
					</view>

					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">å…¥é©»æ—¶é—´</text>
						<text class="text-4 text-[#1f2329]">{{ merchantInfo.joinTime }}</text>
					</view>
				</view>

				<!-- ä¼ä¸šä¿¡æ¯ï¼ˆä»…ä¼ä¸šå•†æˆ·ï¼‰ -->
				<view v-if="merchantInfo.type === 'enterprise'" class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">ä¼ä¸šä¿¡æ¯</text>
					
					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </text>
						<text class="text-4 text-[#1f2329]">{{ merchantInfo.creditCode }}</text>
					</view>

					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">æ³•äººå§“å</text>
						<text class="text-4 text-[#1f2329]">{{ merchantInfo.legalPerson }}</text>
					</view>

					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">æ³•äººèº«ä»½è¯å·</text>
						<text class="text-4 text-[#1f2329]">{{ merchantInfo.legalIdCard }}</text>
					</view>
				</view>

				<!-- è®¤è¯ä¿¡æ¯ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">è®¤è¯ä¿¡æ¯</text>
					
					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">å®åè®¤è¯</text>
						<view class="flex items-center">
							<text class="text-4 text-[#07c160] mr-2">âœ“ å·²è®¤è¯</text>
							<text class="text-3.5 text-[#999]">{{ merchantInfo.realName }}</text>
						</view>
					</view>

					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">èº«ä»½è¯å·</text>
						<text class="text-4 text-[#1f2329]">{{ merchantInfo.idCard }}</text>
					</view>
				</view>

				<!-- è¯ä»¶ç…§ç‰‡ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">è¯ä»¶ç…§ç‰‡</text>
					
					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">èº«ä»½è¯æ­£é¢</text>
						<image 
							:src="merchantInfo.idCardFront || '/static/images/placeholder.png'" 
							class="w-full h-40 rounded-2 mt-2"
							mode="aspectFit"
						/>
					</view>

					<view class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">èº«ä»½è¯åé¢</text>
						<image 
							:src="merchantInfo.idCardBack || '/static/images/placeholder.png'" 
							class="w-full h-40 rounded-2 mt-2"
							mode="aspectFit"
						/>
					</view>

					<view v-if="merchantInfo.type === 'enterprise'" class="mb-4">
						<text class="text-3.5 text-[#999] mb-2">è¥ä¸šæ‰§ç…§</text>
						<image 
							:src="merchantInfo.businessLicense || '/static/images/placeholder.png'" 
							class="w-full h-40 rounded-2 mt-2"
							mode="aspectFit"
						/>
					</view>
				</view>

				<!-- è´¦æˆ·ç»Ÿè®¡ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">è´¦æˆ·ç»Ÿè®¡</text>
					
					<view class="flex items-center justify-between mb-3">
						<view class="flex-1 text-center">
							<text class="text-5 font-bold text-[#1f2329]">{{ merchantInfo.totalOrders }}</text>
							<text class="text-3.5 text-[#999] mt-1">æ€»è®¢å•æ•°</text>
						</view>
						<view class="w-0.5 h-10 bg-[#e5e5e5]"></view>
						<view class="flex-1 text-center">
							<text class="text-5 font-bold text-[#1f2329]">{{ merchantInfo.completedOrders }}</text>
							<text class="text-3.5 text-[#999] mt-1">å®Œæˆè®¢å•</text>
						</view>
						<view class="w-0.5 h-10 bg-[#e5e5e5]"></view>
						<view class="flex-1 text-center">
							<text class="text-5 font-bold text-[#1f2329]">{{ merchantInfo.completionRate }}%</text>
							<text class="text-3.5 text-[#999] mt-1">å®Œæˆç‡</text>
						</view>
					</view>

					<view class="flex items-center justify-between">
						<view class="flex-1 text-center">
							<text class="text-5 font-bold text-[#07c160]">Â¥{{ merchantInfo.totalIncome }}</text>
							<text class="text-3.5 text-[#999] mt-1">ç´¯è®¡æ”¶å…¥</text>
						</view>
						<view class="w-0.5 h-10 bg-[#e5e5e5]"></view>
						<view class="flex-1 text-center">
							<text class="text-5 font-bold text-[#ff9500]">Â¥{{ merchantInfo.totalCommission }}</text>
							<text class="text-3.5 text-[#999] mt-1">ç´¯è®¡ä½£é‡‘</text>
						</view>
					</view>
				</view>

				<!-- æ“ä½œæŒ‰é’® -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<button 
						@click="logout"
						class="w-full bg-white border border-[#ff3b30] text-[#ff3b30] rounded-full py-3"
					>
						<text class="text-4">é€€å‡ºç™»å½•</text>
					</button>
				</view>
			</view>
		</scroll-view>
	</view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { getMerchantInfo, updateMerchantInfo } from '@/services/merchant'

// æ˜¯å¦ç¼–è¾‘æ¨¡å¼
const isEditing = ref(false)

// å•†æˆ·ä¿¡æ¯
const merchantInfo = ref({
	merchantNo: 'M202501290001',
	type: 'personal',
	name: 'ç¤ºä¾‹å•†æˆ·',
	contact: 'å¼ ä¸‰',
	phone: '13800138000',
	address: 'å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­',
	category: 'é¤é¥®',
	level: 'VIP',
	credit: 98,
	joinTime: '2025-01-15 10:30:00',
	creditCode: '',
	legalPerson: '',
	legalIdCard: '',
	realName: 'å¼ ä¸‰',
	idCard: '440***********1234',
	idCardFront: '',
	idCardBack: '',
	businessLicense: '',
	totalOrders: 156,
	completedOrders: 148,
	completionRate: 94.9,
	totalIncome: '125,800.00',
	totalCommission: '12,580.00'
})

// åŸå§‹æ•°æ®å¤‡ä»½
const originalInfo = ref({})

// åŠ è½½å•†æˆ·ä¿¡æ¯
const loadMerchantInfo = async () => {
	try {
		uni.showLoading({ title: 'åŠ è½½ä¸­...' })
		
		const res = await getMerchantInfo()
		
		uni.hideLoading()
		
		if (res.code === 0) {
			merchantInfo.value = res.data
			originalInfo.value = JSON.parse(JSON.stringify(res.data))
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: 'åŠ è½½å¤±è´¥',
			icon: 'none'
		})
	}
}

// åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
const toggleEdit = async () => {
	if (isEditing.value) {
		// ä¿å­˜ä¿®æ”¹
		try {
			uni.showLoading({ title: 'ä¿å­˜ä¸­...' })
			
			const res = await updateMerchantInfo(merchantInfo.value)
			
			uni.hideLoading()
			
			if (res.code === 0) {
				uni.showToast({
					title: 'ä¿å­˜æˆåŠŸ',
					icon: 'success'
				})
				isEditing.value = false
				originalInfo.value = JSON.parse(JSON.stringify(merchantInfo.value))
			} else {
				uni.showToast({
					title: res.message || 'ä¿å­˜å¤±è´¥',
					icon: 'none'
				})
			}
		} catch (error) {
			uni.hideLoading()
			uni.showToast({
				title: 'ä¿å­˜å¤±è´¥',
				icon: 'none'
			})
		}
	} else {
		// è¿›å…¥ç¼–è¾‘æ¨¡å¼
		isEditing.value = true
	}
}

// é€€å‡ºç™»å½•
const logout = () => {
	uni.showModal({
		title: 'æç¤º',
		content: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
		success: (res) => {
			if (res.confirm) {
				// æ¸…é™¤ç™»å½•ä¿¡æ¯
				uni.removeStorageSync('token')
				uni.removeStorageSync('userInfo')
				
				// è·³è½¬åˆ°ç™»å½•é¡µ
				uni.reLaunch({
					url: '/pages/auth/login'
				})
			}
		}
	})
}

// è¿”å›
const goBack = () => {
	if (isEditing.value) {
		// å¦‚æœåœ¨ç¼–è¾‘æ¨¡å¼ï¼Œæ¢å¤åŸå§‹æ•°æ®
		merchantInfo.value = JSON.parse(JSON.stringify(originalInfo.value))
		isEditing.value = false
	} else {
		uni.navigateBack()
	}
}

// é¡µé¢åŠ è½½æ—¶è·å–å•†æˆ·ä¿¡æ¯
onMounted(() => {
	loadMerchantInfo()
})
</script>
