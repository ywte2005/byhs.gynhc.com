<template>
	<view class="flex flex-col h-screen bg-[#f5f7fa]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<cl-topbar title="å•†æˆ·ä¿¡æ¯" :show-back="true" background-color="#ffffff" color="#1f2329" safe-area-top>
			<template #append>
				<view @click="toggleEdit" class="flex items-center px-[32rpx] h-full">
					<text class="text-[28rpx] text-[#0052d9]">{{ isEditing ? 'ä¿å­˜' : 'ç¼–è¾‘' }}</text>
				</view>
			</template>
		</cl-topbar>

		<!-- å†…å®¹åŒºåŸŸ -->
		<scroll-view class="flex-1 h-0" scroll-y>
			<view class="p-[32rpx] flex flex-col gap-[24rpx]">
				<!-- å•†æˆ·å¤´åƒ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx]">
					<view class="flex items-center">
						<view class="w-[160rpx] h-[160rpx] rounded-full bg-[#f5f5f5] flex items-center justify-center mr-[32rpx]">
							<text class="text-[80rpx]">ğŸª</text>
						</view>
						<view class="flex-1">
							<text class="text-[40rpx] font-bold text-[#1f2329]">{{ merchantInfo.name }}</text>
							<text class="text-[28rpx] text-[#999999] mt-[8rpx]">å•†æˆ·ç¼–å·ï¼š{{ merchantInfo.merchantNo }}</text>
							<view class="flex flex-row items-center mt-[16rpx]">
								<view class="bg-[#0052d9] rounded-[8rpx] px-[16rpx] py-[4rpx] mr-[16rpx]">
									<text class="text-[24rpx] text-white">{{ merchantInfo.level }}</text>
								</view>
								<view class="bg-[#ff9500] rounded-[8rpx] px-[16rpx] py-[4rpx]">
									<text class="text-[24rpx] text-white">ä¿¡ç”¨åˆ†ï¼š{{ merchantInfo.credit }}</text>
								</view>
							</view>
						</view>
					</view>
				</view>

				<!-- åŸºæœ¬ä¿¡æ¯ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx] flex flex-col gap-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[8rpx]">åŸºæœ¬ä¿¡æ¯</text>
					
					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">å•†æˆ·ç±»å‹</text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.type === 'personal' ? 'ä¸ªäººå•†æˆ·' : 'ä¼ä¸šå•†æˆ·' }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">å•†æˆ·åç§°</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.name"
							class="h-[80rpx] border-[2rpx] border-[#e5e5e5] rounded-[12rpx] px-[24rpx] text-[30rpx] text-[#1f2329]"
							placeholder="è¯·è¾“å…¥å•†æˆ·åç§°"
						/>
						<text v-else class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.name }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">è”ç³»äºº</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.contact"
							class="h-[80rpx] border-[2rpx] border-[#e5e5e5] rounded-[12rpx] px-[24rpx] text-[30rpx] text-[#1f2329]"
							placeholder="è¯·è¾“å…¥è”ç³»äºº"
						/>
						<text v-else class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.contact }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">è”ç³»ç”µè¯</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.phone"
							type="number"
							class="h-[80rpx] border-[2rpx] border-[#e5e5e5] rounded-[12rpx] px-[24rpx] text-[30rpx] text-[#1f2329]"
							placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
						/>
						<text v-else class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.phone }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">ç»è¥åœ°å€</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.address"
							class="h-[80rpx] border-[2rpx] border-[#e5e5e5] rounded-[12rpx] px-[24rpx] text-[30rpx] text-[#1f2329]"
							placeholder="è¯·è¾“å…¥ç»è¥åœ°å€"
						/>
						<text v-else class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.address }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">ç»è¥ç±»ç›®</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.category"
							class="h-[80rpx] border-[2rpx] border-[#e5e5e5] rounded-[12rpx] px-[24rpx] text-[30rpx] text-[#1f2329]"
							placeholder="è¯·è¾“å…¥ç»è¥ç±»ç›®"
						/>
						<text v-else class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.category }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">å…¥é©»æ—¶é—´</text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.joinTime }}</text>
					</view>
				</view>

				<!-- ä¼ä¸šä¿¡æ¯ï¼ˆä»…ä¼ä¸šå•†æˆ·ï¼‰ -->
				<view v-if="merchantInfo.type === 'enterprise'" class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx] flex flex-col gap-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[8rpx]">ä¼ä¸šä¿¡æ¯</text>
					
					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.creditCode }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">æ³•äººå§“å</text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.legalPerson }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">æ³•äººèº«ä»½è¯å·</text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.legalIdCard }}</text>
					</view>
				</view>

				<!-- è®¤è¯ä¿¡æ¯ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx] flex flex-col gap-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[8rpx]">è®¤è¯ä¿¡æ¯</text>
					
					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">å®åè®¤è¯</text>
						<view class="flex flex-row items-center">
							<text class="text-[30rpx] text-[#0052d9] mr-[16rpx]">âœ“ å·²è®¤è¯</text>
							<text class="text-[28rpx] text-[#999999]">{{ merchantInfo.realName }}</text>
						</view>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">èº«ä»½è¯å·</text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.idCard }}</text>
					</view>
				</view>

				<!-- è¯ä»¶ç…§ç‰‡ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx] flex flex-col gap-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[8rpx]">è¯ä»¶ç…§ç‰‡</text>
					
					<view class="flex flex-col gap-[16rpx]">
						<text class="text-[28rpx] text-[#999999]">èº«ä»½è¯æ­£é¢</text>
						<image 
							:src="merchantInfo.idCardFront || '/static/images/placeholder.png'" 
							class="w-full h-[320rpx] rounded-[16rpx] bg-[#f5f5f5]"
							mode="aspectFit"
						/>
					</view>

					<view class="flex flex-col gap-[16rpx]">
						<text class="text-[28rpx] text-[#999999]">èº«ä»½è¯åé¢</text>
						<image 
							:src="merchantInfo.idCardBack || '/static/images/placeholder.png'" 
							class="w-full h-[320rpx] rounded-[16rpx] bg-[#f5f5f5]"
							mode="aspectFit"
						/>
					</view>

					<view v-if="merchantInfo.type === 'enterprise'" class="flex flex-col gap-[16rpx]">
						<text class="text-[28rpx] text-[#999999]">è¥ä¸šæ‰§ç…§</text>
						<image 
							:src="merchantInfo.businessLicense || '/static/images/placeholder.png'" 
							class="w-full h-[320rpx] rounded-[16rpx] bg-[#f5f5f5]"
							mode="aspectFit"
						/>
					</view>
				</view>

				<!-- è´¦æˆ·ç»Ÿè®¡ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx] flex flex-col gap-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[8rpx]">è´¦æˆ·ç»Ÿè®¡</text>
					
					<view class="flex items-center justify-between">
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#1f2329]">{{ merchantInfo.totalOrders }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[8rpx]">æ€»è®¢å•æ•°</text>
						</view>
						<view class="w-[2rpx] h-[64rpx] bg-[#e5e5e5]"></view>
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#1f2329]">{{ merchantInfo.completedOrders }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[8rpx]">å®Œæˆè®¢å•</text>
						</view>
						<view class="w-[2rpx] h-[64rpx] bg-[#e5e5e5]"></view>
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#1f2329]">{{ merchantInfo.completionRate }}%</text>
							<text class="text-[24rpx] text-[#999999] mt-[8rpx]">å®Œæˆç‡</text>
						</view>
					</view>

					<view class="flex items-center justify-between border-t-[2rpx] border-[#e5e5e5] pt-[32rpx]">
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#0052d9]">Â¥{{ merchantInfo.totalIncome }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[8rpx]">ç´¯è®¡æ”¶å…¥</text>
						</view>
						<view class="w-[2rpx] h-[64rpx] bg-[#e5e5e5]"></view>
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#ff9500]">Â¥{{ merchantInfo.totalCommission }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[8rpx]">ç´¯è®¡ä½£é‡‘</text>
						</view>
					</view>
				</view>

				<!-- æ“ä½œæŒ‰é’® -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[64rpx]">
					<button 
						@click="logout"
						class="w-full h-[88rpx] bg-white border-[2rpx] border-[#ff3b30] rounded-full flex items-center justify-center"
					>
						<text class="text-[32rpx] text-[#ff3b30]">é€€å‡ºç™»å½•</text>
					</button>
				</view>
			</view>
		</scroll-view>
	</view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { getMerchantInfo, updateMerchantInfo } from '@/services/merchant'

// æ˜¯å¦ç¼–è¾‘æ¨¡å¼
const isEditing = ref(false)

// å•†æˆ·ä¿¡æ¯
const merchantInfo = ref({
	merchantNo: 'M202501290001',
	type: 'personal',
	name: 'ç¤ºä¾‹å•†æˆ·',
	contact: 'å¼ ä¸‰',
	phone: '13800138000',
	address: 'å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­',
	category: 'é¤é¥®',
	level: 'VIP',
	credit: 98,
	joinTime: '2025-01-15 10:30:00',
	creditCode: '',
	legalPerson: '',
	legalIdCard: '',
	realName: 'å¼ ä¸‰',
	idCard: '440***********1234',
	idCardFront: '',
	idCardBack: '',
	businessLicense: '',
	totalOrders: 156,
	completedOrders: 148,
	completionRate: 94.9,
	totalIncome: '125,800.00',
	totalCommission: '12,580.00'
})

// åŸå§‹æ•°æ®å¤‡ä»½
const originalInfo = ref({})

// åŠ è½½å•†æˆ·ä¿¡æ¯
const loadMerchantInfo = async () => {
	try {
		uni.showLoading({ title: 'åŠ è½½ä¸­...' })
		
		const res = await getMerchantInfo()
		
		uni.hideLoading()
		
		if (res.code === 0) {
			merchantInfo.value = res.data
			originalInfo.value = JSON.parse(JSON.stringify(res.data))
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: 'åŠ è½½å¤±è´¥',
			icon: 'none'
		})
	}
}

// åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
const toggleEdit = async () => {
	if (isEditing.value) {
		// ä¿å­˜ä¿®æ”¹
		try {
			uni.showLoading({ title: 'ä¿å­˜ä¸­...' })
			
			const res = await updateMerchantInfo(merchantInfo.value)
			
			uni.hideLoading()
			
			if (res.code === 0) {
				uni.showToast({
					title: 'ä¿å­˜æˆåŠŸ',
					icon: 'success'
				})
				isEditing.value = false
				originalInfo.value = JSON.parse(JSON.stringify(merchantInfo.value))
			} else {
				uni.showToast({
					title: res.msg || 'ä¿å­˜å¤±è´¥',
					icon: 'none'
				})
			}
		} catch (error) {
			uni.hideLoading()
			uni.showToast({
				title: 'ä¿å­˜å¤±è´¥',
				icon: 'none'
			})
		}
	} else {
		// è¿›å…¥ç¼–è¾‘æ¨¡å¼
		isEditing.value = true
	}
}

// é€€å‡ºç™»å½•
const logout = () => {
	uni.showModal({
		title: 'æç¤º',
		content: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
		success: (res) => {
			if (res.confirm) {
				// æ¸…é™¤ç™»å½•ä¿¡æ¯
				uni.removeStorageSync('token')
				uni.removeStorageSync('userInfo')
				
				// è·³è½¬åˆ°ç™»å½•é¡µ
				uni.reLaunch({
					url: '/pages/user/login'
				})
			}
		}
	})
}

// é¡µé¢åŠ è½½æ—¶è·å–å•†æˆ·ä¿¡æ¯
onMounted(() => {
	loadMerchantInfo()
})
</script>
