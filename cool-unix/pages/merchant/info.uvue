<template>
	<view class="flex flex-col h-screen bg-[#f5f7fa]">
		<!-- 顶部导航 -->
		<cl-topbar title="商户信息" :show-back="true" background-color="#ffffff" color="#1f2329" safe-area-top>
			<template #append>
				<view @click="toggleEdit" class="flex items-center px-[32rpx] h-full">
					<text class="text-[28rpx] text-[#0052d9]">{{ isEditing ? '保存' : '编辑' }}</text>
				</view>
			</template>
		</cl-topbar>

		<!-- 内容区域 -->
		<scroll-view class="flex-1 h-0" scroll-y>
			<view class="p-[32rpx] flex flex-col gap-[24rpx]">
				<!-- 商户头像 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx]">
					<view class="flex items-center">
						<view class="w-[160rpx] h-[160rpx] rounded-full bg-[#f5f5f5] flex items-center justify-center mr-[32rpx]">
							<uni-icons type="shop" size="40" color="#0052d9"></uni-icons>
						</view>
						<view class="flex-1">
							<text class="text-[40rpx] font-bold text-[#1f2329]">{{ merchantInfo.name }}</text>
							<text class="text-[28rpx] text-[#999999] mt-[8rpx]">商户编号：{{ merchantInfo.merchantNo }}</text>
							<view class="flex flex-row items-center mt-[16rpx]">
								<view class="bg-[#0052d9] rounded-[8rpx] px-[16rpx] py-[4rpx] mr-[16rpx]">
									<text class="text-[24rpx] text-white">{{ merchantInfo.level }}</text>
								</view>
								<view class="bg-[#ff9500] rounded-[8rpx] px-[16rpx] py-[4rpx]">
									<text class="text-[24rpx] text-white">信用分：{{ merchantInfo.credit }}</text>
								</view>
							</view>
						</view>
					</view>
				</view>

				<!-- 基本信息 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx] flex flex-col gap-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[8rpx]">基本信息</text>
					
					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">商户类型</text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.type === 'personal' ? '个人商户' : '企业商户' }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">商户名称</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.name"
							class="h-[80rpx] border-[2rpx] border-[#e5e5e5] rounded-[12rpx] px-[24rpx] text-[30rpx] text-[#1f2329]"
							placeholder="请输入商户名称"
						/>
						<text v-else class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.name }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">联系人</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.contact"
							class="h-[80rpx] border-[2rpx] border-[#e5e5e5] rounded-[12rpx] px-[24rpx] text-[30rpx] text-[#1f2329]"
							placeholder="请输入联系人"
						/>
						<text v-else class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.contact }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">联系电话</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.phone"
							type="number"
							class="h-[80rpx] border-[2rpx] border-[#e5e5e5] rounded-[12rpx] px-[24rpx] text-[30rpx] text-[#1f2329]"
							placeholder="请输入联系电话"
						/>
						<text v-else class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.phone }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">经营地址</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.address"
							class="h-[80rpx] border-[2rpx] border-[#e5e5e5] rounded-[12rpx] px-[24rpx] text-[30rpx] text-[#1f2329]"
							placeholder="请输入经营地址"
						/>
						<text v-else class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.address }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">经营类目</text>
						<input 
							v-if="isEditing"
							v-model="merchantInfo.category"
							class="h-[80rpx] border-[2rpx] border-[#e5e5e5] rounded-[12rpx] px-[24rpx] text-[30rpx] text-[#1f2329]"
							placeholder="请输入经营类目"
						/>
						<text v-else class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.category }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">入驻时间</text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.joinTime }}</text>
					</view>
				</view>

				<!-- 企业信息（仅企业商户） -->
				<view v-if="merchantInfo.type === 'enterprise'" class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx] flex flex-col gap-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[8rpx]">企业信息</text>
					
					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">统一社会信用代码</text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.creditCode }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">法人姓名</text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.legalPerson }}</text>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">法人身份证号</text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.legalIdCard }}</text>
					</view>
				</view>

				<!-- 认证信息 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx] flex flex-col gap-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[8rpx]">认证信息</text>
					
					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">实名认证</text>
						<view class="flex flex-row items-center">
							<uni-icons type="checkbox-filled" size="16" color="#0052d9"></uni-icons>
							<text class="text-[30rpx] text-[#0052d9] ml-[8rpx] mr-[16rpx]">已认证</text>
							<text class="text-[28rpx] text-[#999999]">{{ merchantInfo.realName }}</text>
						</view>
					</view>

					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[28rpx] text-[#999999]">身份证号</text>
						<text class="text-[30rpx] text-[#1f2329]">{{ merchantInfo.idCard }}</text>
					</view>
				</view>

				<!-- 证件照片 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx] flex flex-col gap-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[8rpx]">证件照片</text>
					
					<view class="flex flex-col gap-[16rpx]">
						<text class="text-[28rpx] text-[#999999]">身份证正面</text>
						<image 
							:src="merchantInfo.idCardFront || '/static/images/placeholder.png'" 
							class="w-full h-[320rpx] rounded-[16rpx] bg-[#f5f5f5]"
							mode="aspectFit"
						/>
					</view>

					<view class="flex flex-col gap-[16rpx]">
						<text class="text-[28rpx] text-[#999999]">身份证反面</text>
						<image 
							:src="merchantInfo.idCardBack || '/static/images/placeholder.png'" 
							class="w-full h-[320rpx] rounded-[16rpx] bg-[#f5f5f5]"
							mode="aspectFit"
						/>
					</view>

					<view v-if="merchantInfo.type === 'enterprise'" class="flex flex-col gap-[16rpx]">
						<text class="text-[28rpx] text-[#999999]">营业执照</text>
						<image 
							:src="merchantInfo.businessLicense || '/static/images/placeholder.png'" 
							class="w-full h-[320rpx] rounded-[16rpx] bg-[#f5f5f5]"
							mode="aspectFit"
						/>
					</view>
				</view>

				<!-- 账户统计 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[24rpx] flex flex-col gap-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[8rpx]">账户统计</text>
					
					<view class="flex items-center justify-between">
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#1f2329]">{{ merchantInfo.totalOrders }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[8rpx]">总订单数</text>
						</view>
						<view class="w-[2rpx] h-[64rpx] bg-[#e5e5e5]"></view>
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#1f2329]">{{ merchantInfo.completedOrders }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[8rpx]">完成订单</text>
						</view>
						<view class="w-[2rpx] h-[64rpx] bg-[#e5e5e5]"></view>
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#1f2329]">{{ merchantInfo.completionRate }}%</text>
							<text class="text-[24rpx] text-[#999999] mt-[8rpx]">完成率</text>
						</view>
					</view>

					<view class="flex items-center justify-between border-t-[2rpx] border-[#e5e5e5] pt-[32rpx]">
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#0052d9]">¥{{ merchantInfo.totalIncome }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[8rpx]">累计收入</text>
						</view>
						<view class="w-[2rpx] h-[64rpx] bg-[#e5e5e5]"></view>
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#ff9500]">¥{{ merchantInfo.totalCommission }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[8rpx]">累计佣金</text>
						</view>
					</view>
				</view>

				<!-- 操作按钮 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[64rpx]">
					<button 
						@click="logout"
						class="w-full h-[88rpx] bg-white border-[2rpx] border-[#ff3b30] rounded-full flex items-center justify-center"
					>
						<text class="text-[32rpx] text-[#ff3b30]">退出登录</text>
					</button>
				</view>
			</view>
		</scroll-view>
	</view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { getMerchantInfo, updateMerchantInfo } from '@/services/merchant'

// 是否编辑模式
const isEditing = ref(false)

// 商户信息
const merchantInfo = ref({
	merchantNo: 'M202501290001',
	type: 'personal',
	name: '示例商户',
	contact: '张三',
	phone: '13800138000',
	address: '广东省深圳市南山区科技园',
	category: '餐饮',
	level: 'VIP',
	credit: 98,
	joinTime: '2025-01-15 10:30:00',
	creditCode: '',
	legalPerson: '',
	legalIdCard: '',
	realName: '张三',
	idCard: '440***********1234',
	idCardFront: '',
	idCardBack: '',
	businessLicense: '',
	totalOrders: 156,
	completedOrders: 148,
	completionRate: 94.9,
	totalIncome: '125,800.00',
	totalCommission: '12,580.00'
})

// 原始数据备份
const originalInfo = ref({})

// 加载商户信息
const loadMerchantInfo = async () => {
	try {
		uni.showLoading({ title: '加载中...' })
		
		const res = await getMerchantInfo()
		
		uni.hideLoading()
		
		if (res.code === 0) {
			merchantInfo.value = res.data
			originalInfo.value = JSON.parse(JSON.stringify(res.data))
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: '加载失败',
			icon: 'none'
		})
	}
}

// 切换编辑模式
const toggleEdit = async () => {
	if (isEditing.value) {
		// 保存修改
		try {
			uni.showLoading({ title: '保存中...' })
			
			const res = await updateMerchantInfo(merchantInfo.value)
			
			uni.hideLoading()
			
			if (res.code === 0) {
				uni.showToast({
					title: '保存成功',
					icon: 'success'
				})
				isEditing.value = false
				originalInfo.value = JSON.parse(JSON.stringify(merchantInfo.value))
			} else {
				uni.showToast({
					title: res.msg || '保存失败',
					icon: 'none'
				})
			}
		} catch (error) {
			uni.hideLoading()
			uni.showToast({
				title: '保存失败',
				icon: 'none'
			})
		}
	} else {
		// 进入编辑模式
		isEditing.value = true
	}
}

// 退出登录
const logout = () => {
	uni.showModal({
		title: '提示',
		content: '确定要退出登录吗？',
		success: (res) => {
			if (res.confirm) {
				// 清除登录信息
				uni.removeStorageSync('token')
				uni.removeStorageSync('userInfo')
				
				// 跳转到登录页
				uni.reLaunch({
					url: '/pages/user/login'
				})
			}
		}
	})
}

// 页面加载时获取商户信息
onMounted(() => {
	loadMerchantInfo()
})
</script>
