<template>
	<view class="flex flex-col h-full bg-[#f5f5f5]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="flex items-center justify-between px-4 py-3 bg-white">
			<view class="flex items-center" @click="goBack">
				<text class="text-6">â†</text>
				<text class="text-4 ml-2">æ¶ˆæ¯ä¸­å¿ƒ</text>
			</view>
			<view @click="markAllRead">
				<text class="text-4 text-[#07c160]">å…¨éƒ¨å·²è¯»</text>
			</view>
		</view>

		<!-- æ ‡ç­¾æ  -->
		<view class="bg-white px-4 py-3 mb-2">
			<view class="flex">
				<view 
					v-for="(tab, index) in tabs" 
					:key="index"
					@click="selectTab(tab.value)"
					class="flex-1 text-center"
				>
					<text :class="['text-4', currentTab === tab.value ? 'text-[#07c160] font-bold' : 'text-[#646a73]']">
						{{ tab.label }}
					</text>
					<view v-if="currentTab === tab.value" class="w-8 h-1 bg-[#07c160] rounded-full mx-auto mt-2"></view>
				</view>
			</view>
		</view>

		<!-- æ¶ˆæ¯åˆ—è¡¨ -->
		<scroll-view class="flex-1" scroll-y @scrolltolower="loadMore">
			<view class="px-4 py-2">
				<view 
					v-for="(item, index) in messageList" 
					:key="index"
					@click="goToDetail(item.id)"
					class="bg-white rounded-2 p-4 mb-3 relative"
				>
					<!-- æœªè¯»æ ‡è¯† -->
					<view v-if="!item.isRead" class="absolute top-4 right-4 w-2 h-2 rounded-full bg-[#ff3b30]"></view>

					<view class="flex items-start">
						<view class="w-12 h-12 rounded-full bg-[#f5f5f5] flex items-center justify-center mr-3">
							<text class="text-6">{{ item.icon }}</text>
						</view>
						<view class="flex-1">
							<view class="flex items-center justify-between mb-2">
								<text :class="['text-4 font-bold', item.isRead ? 'text-[#646a73]' : 'text-[#1f2329]']">
									{{ item.title }}
								</text>
								<text class="text-3 text-[#999]">{{ item.time }}</text>
							</view>
							<text :class="['text-3.5', item.isRead ? 'text-[#999]' : 'text-[#646a73]']">
								{{ item.content }}
							</text>
						</view>
					</view>
				</view>

				<!-- åŠ è½½æ›´å¤š -->
				<view v-if="loading" class="flex justify-center py-4">
					<text class="text-3.5 text-[#999]">åŠ è½½ä¸­...</text>
				</view>
				<view v-if="!hasMore && messageList.length > 0" class="flex justify-center py-4">
					<text class="text-3.5 text-[#999]">æ²¡æœ‰æ›´å¤šäº†</text>
				</view>
				<view v-if="messageList.length === 0 && !loading" class="flex flex-col items-center justify-center py-20">
					<text class="text-10 mb-3">ğŸ“­</text>
					<text class="text-4 text-[#999]">æš‚æ— æ¶ˆæ¯</text>
				</view>
			</view>
		</scroll-view>
	</view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { getMessageList, markAllAsRead } from '@/services/message'

// å½“å‰æ ‡ç­¾
const currentTab = ref('all')

// æ ‡ç­¾åˆ—è¡¨
const tabs = [
	{ label: 'å…¨éƒ¨', value: 'all' },
	{ label: 'ç³»ç»Ÿ', value: 'system' },
	{ label: 'ä»»åŠ¡', value: 'task' },
	{ label: 'äº¤æ˜“', value: 'transaction' }
]

// æ¶ˆæ¯åˆ—è¡¨
const messageList = ref([
	{
		id: 1,
		icon: 'ğŸ’°',
		title: 'ä»»åŠ¡ä½£é‡‘åˆ°è´¦',
		content: 'æ‚¨å®Œæˆçš„å­ä»»åŠ¡å·²ç»“ç®—ï¼Œä½£é‡‘15.00å…ƒå·²åˆ°è´¦',
		time: '10åˆ†é’Ÿå‰',
		isRead: false
	},
	{
		id: 2,
		icon: 'ğŸ“',
		title: 'ä»»åŠ¡å®¡æ ¸é€šè¿‡',
		content: 'æ‚¨å‘èµ·çš„ä»»åŠ¡"ç¾å›¢å¤–å–è®¢å•äº’åŠ©"å·²é€šè¿‡å®¡æ ¸',
		time: '1å°æ—¶å‰',
		isRead: false
	},
	{
		id: 3,
		icon: 'ğŸ””',
		title: 'ç³»ç»Ÿé€šçŸ¥',
		content: 'å¹³å°å°†äºä»Šæ™š22:00-24:00è¿›è¡Œç³»ç»Ÿç»´æŠ¤',
		time: '2å°æ—¶å‰',
		isRead: true
	},
	{
		id: 4,
		icon: 'ğŸ’³',
		title: 'æç°æˆåŠŸ',
		content: 'æ‚¨çš„æç°ç”³è¯·å·²å¤„ç†ï¼Œé‡‘é¢5000.00å…ƒå·²åˆ°è´¦',
		time: 'æ˜¨å¤©',
		isRead: true
	}
])

// åŠ è½½çŠ¶æ€
const loading = ref(false)
const hasMore = ref(true)
const page = ref(1)

// é€‰æ‹©æ ‡ç­¾
const selectTab = (value: string) => {
	currentTab.value = value
	page.value = 1
	messageList.value = []
	loadMessageList()
}

// åŠ è½½æ¶ˆæ¯åˆ—è¡¨
const loadMessageList = async () => {
	if (loading.value) return
	
	try {
		loading.value = true
		
		const res = await messageService.getList({
			type: currentTab.value,
			page: page.value,
			pageSize: 10
		})
		
		loading.value = false
		
		if (res.code === 0) {
			if (page.value === 1) {
				messageList.value = res.data.list
			} else {
				messageList.value = messageList.value.concat(res.data.list)
			}
			hasMore.value = res.data.hasMore
		}
	} catch (error) {
		loading.value = false
		console.log('åŠ è½½æ¶ˆæ¯åˆ—è¡¨å¤±è´¥', error)
	}
}

// åŠ è½½æ›´å¤š
const loadMore = () => {
	if (!loading.value && hasMore.value) {
		page.value++
		loadMessageList()
	}
}

// å…¨éƒ¨å·²è¯»
const markAllRead = async () => {
	try {
		const res = await messageService.markAllRead()
		if (res.code === 0) {
			uni.showToast({
				title: 'å·²å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»',
				icon: 'success'
			})
			// æ›´æ–°åˆ—è¡¨
			messageList.value.forEach(item => {
				item.isRead = true
			})
		}
	} catch (error) {
		console.log('æ ‡è®°å·²è¯»å¤±è´¥', error)
	}
}

// è¿›å…¥æ¶ˆæ¯è¯¦æƒ…
const goToDetail = async (id: number) => {
	// æ ‡è®°ä¸ºå·²è¯»
	try {
		await messageService.markRead(id)
		// æ›´æ–°åˆ—è¡¨ä¸­çš„å·²è¯»çŠ¶æ€
		const message = messageList.value.find(item => item.id === id)
		if (message) {
			message.isRead = true
		}
	} catch (error) {
		console.log('æ ‡è®°å·²è¯»å¤±è´¥', error)
	}
	
	// è·³è½¬åˆ°è¯¦æƒ…é¡µï¼ˆå¦‚æœéœ€è¦ï¼‰
	// uni.navigateTo({
	//   url: `/pages/message/detail?id=${id}`
	// })
}

// è¿”å›
const goBack = () => {
	uni.navigateBack()
}

// é¡µé¢åŠ è½½æ—¶è·å–æ¶ˆæ¯åˆ—è¡¨
onMounted(() => {
	loadMessageList()
})
</script>
