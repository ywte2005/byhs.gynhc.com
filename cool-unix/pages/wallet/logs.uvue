<template>
	<view class="flex flex-col h-full bg-[#f5f5f5]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="flex items-center justify-between px-4 py-3 bg-white">
			<view class="flex items-center" @click="goBack">
				<text class="text-6">â†</text>
				<text class="text-4 ml-2">è´¦å•æ˜ç»†</text>
			</view>
			<view @click="showFilterDialog = true">
				<text class="text-4 text-[#07c160]">ç­›é€‰</text>
			</view>
		</view>

		<!-- æ ‡ç­¾æ  -->
		<view class="bg-white px-4 py-3 mb-2">
			<view class="flex">
				<view 
					v-for="(tab, index) in tabs" 
					:key="index"
					@click="selectTab(tab.value)"
					class="flex-1 text-center"
				>
					<text :class="['text-4', currentTab === tab.value ? 'text-[#07c160] font-bold' : 'text-[#646a73]']">
						{{ tab.label }}
					</text>
					<view v-if="currentTab === tab.value" class="w-8 h-1 bg-[#07c160] rounded-full mx-auto mt-2"></view>
				</view>
			</view>
		</view>

		<!-- è´¦å•åˆ—è¡¨ -->
		<scroll-view class="flex-1" scroll-y @scrolltolower="loadMore">
			<view class="px-4 py-2">
				<view 
					v-for="(item, index) in logList" 
					:key="index"
					class="bg-white rounded-2 p-4 mb-3"
				>
					<view class="flex items-center justify-between mb-2">
						<view class="flex items-center flex-1">
							<view class="w-10 h-10 rounded-full bg-[#f5f5f5] flex items-center justify-center mr-3">
								<text class="text-5">{{ item.icon }}</text>
							</view>
							<view class="flex-1">
								<text class="text-4 font-bold text-[#1f2329]">{{ item.title }}</text>
								<text class="text-3 text-[#999] mt-1">{{ item.time }}</text>
							</view>
						</view>
						<view class="text-right">
							<text :class="['text-5 font-bold', item.type === 'in' ? 'text-[#07c160]' : 'text-[#ff3b30]']">
								{{ item.type === 'in' ? '+' : '-' }}{{ item.amount }}
							</text>
							<text class="text-3 text-[#999] mt-1">ä½™é¢ï¼š{{ item.balance }}</text>
						</view>
					</view>

					<view v-if="item.remark" class="bg-[#f5f5f5] rounded-2 p-2 mt-2">
						<text class="text-3 text-[#646a73]">{{ item.remark }}</text>
					</view>
				</view>

				<!-- åŠ è½½æ›´å¤š -->
				<view v-if="loading" class="flex justify-center py-4">
					<text class="text-3.5 text-[#999]">åŠ è½½ä¸­...</text>
				</view>
				<view v-if="!hasMore && logList.length > 0" class="flex justify-center py-4">
					<text class="text-3.5 text-[#999]">æ²¡æœ‰æ›´å¤šäº†</text>
				</view>
				<view v-if="logList.length === 0 && !loading" class="flex flex-col items-center justify-center py-20">
					<text class="text-10 mb-3">ğŸ“</text>
					<text class="text-4 text-[#999]">æš‚æ— è´¦å•è®°å½•</text>
				</view>
			</view>
		</scroll-view>

		<!-- ç­›é€‰å¯¹è¯æ¡† -->
		<view v-if="showFilterDialog" class="fixed inset-0 bg-black/50 flex items-end" @click="showFilterDialog = false">
			<view class="bg-white w-full rounded-t-3 p-4" @click.stop>
				<text class="text-4 font-bold text-[#1f2329] mb-4">ç­›é€‰æ¡ä»¶</text>
				
				<view class="mb-4">
					<text class="text-3.5 text-[#646a73] mb-2">äº¤æ˜“ç±»å‹</text>
					<view class="flex flex-wrap mt-2">
						<view 
							v-for="(item, index) in transactionTypes" 
							:key="index"
							@click="filter.type = item.value"
							:class="['border rounded-full px-4 py-2 mr-2 mb-2', filter.type === item.value ? 'border-[#07c160] bg-[#f0f9ff]' : 'border-[#e5e5e5]']"
						>
							<text :class="['text-3.5', filter.type === item.value ? 'text-[#07c160]' : 'text-[#646a73]']">{{ item.label }}</text>
						</view>
					</view>
				</view>

				<view class="mb-4">
					<text class="text-3.5 text-[#646a73] mb-2">æ—¶é—´èŒƒå›´</text>
					<view class="flex flex-wrap mt-2">
						<view 
							v-for="(item, index) in timeRanges" 
							:key="index"
							@click="filter.timeRange = item.value"
							:class="['border rounded-full px-4 py-2 mr-2 mb-2', filter.timeRange === item.value ? 'border-[#07c160] bg-[#f0f9ff]' : 'border-[#e5e5e5]']"
						>
							<text :class="['text-3.5', filter.timeRange === item.value ? 'text-[#07c160]' : 'text-[#646a73]']">{{ item.label }}</text>
						</view>
					</view>
				</view>

				<view class="flex">
					<button 
						@click="resetFilter"
						class="flex-1 bg-[#f5f5f5] text-[#646a73] rounded-full py-3 mr-2"
					>
						<text class="text-4">é‡ç½®</text>
					</button>
					<button 
						@click="applyFilter"
						class="flex-1 bg-[#07c160] text-white rounded-full py-3"
					>
						<text class="text-4">ç¡®å®š</text>
					</button>
				</view>
			</view>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { getWalletLogs } from '@/services/wallet'

// å½“å‰æ ‡ç­¾
const currentTab = ref('all')

// æ ‡ç­¾åˆ—è¡¨
const tabs = [
	{ label: 'å…¨éƒ¨', value: 'all' },
	{ label: 'æ”¶å…¥', value: 'in' },
	{ label: 'æ”¯å‡º', value: 'out' }
]

// è´¦å•åˆ—è¡¨
const logList = ref([
	{
		icon: 'ğŸ’°',
		title: 'ä»»åŠ¡ä½£é‡‘',
		time: '2025-01-30 10:30:00',
		type: 'in',
		amount: '15.00',
		balance: '12,580.00',
		remark: 'å®Œæˆå­ä»»åŠ¡ #ST202501300001'
	},
	{
		icon: 'ğŸ“',
		title: 'å‘èµ·ä»»åŠ¡',
		time: '2025-01-30 09:00:00',
		type: 'out',
		amount: '1,500.00',
		balance: '12,565.00',
		remark: 'ä»»åŠ¡ç¼–å·ï¼šT202501300001'
	},
	{
		icon: 'ğŸ’¸',
		title: 'å……å€¼',
		time: '2025-01-29 15:00:00',
		type: 'in',
		amount: '3,000.00',
		balance: '14,065.00',
		remark: 'å¾®ä¿¡æ”¯ä»˜'
	},
	{
		icon: 'ğŸ’³',
		title: 'æç°',
		time: '2025-01-29 10:00:00',
		type: 'out',
		amount: '5,000.00',
		balance: '11,065.00',
		remark: 'æç°åˆ°å·¥å•†é“¶è¡Œ å°¾å·8888'
	}
])

// åŠ è½½çŠ¶æ€
const loading = ref(false)
const hasMore = ref(true)
const page = ref(1)

// æ˜¾ç¤ºç­›é€‰å¯¹è¯æ¡†
const showFilterDialog = ref(false)

// ç­›é€‰æ¡ä»¶
const filter = ref({
	type: 'all',
	timeRange: 'all'
})

// äº¤æ˜“ç±»å‹
const transactionTypes = [
	{ label: 'å…¨éƒ¨', value: 'all' },
	{ label: 'å……å€¼', value: 'recharge' },
	{ label: 'æç°', value: 'withdraw' },
	{ label: 'ä»»åŠ¡ä½£é‡‘', value: 'commission' },
	{ label: 'å‘èµ·ä»»åŠ¡', value: 'task' },
	{ label: 'ä¿è¯é‡‘', value: 'deposit' }
]

// æ—¶é—´èŒƒå›´
const timeRanges = [
	{ label: 'å…¨éƒ¨', value: 'all' },
	{ label: 'ä»Šå¤©', value: 'today' },
	{ label: 'æœ¬å‘¨', value: 'week' },
	{ label: 'æœ¬æœˆ', value: 'month' },
	{ label: 'è¿‘ä¸‰æœˆ', value: 'quarter' }
]

// é€‰æ‹©æ ‡ç­¾
const selectTab = (value: string) => {
	currentTab.value = value
	page.value = 1
	logList.value = []
	loadLogList()
}

// åŠ è½½è´¦å•åˆ—è¡¨
const loadLogList = async () => {
	if (loading.value) return
	
	try {
		loading.value = true
		
		const res = await getWalletLogs({
			type: currentTab.value,
			filterType: filter.value.type,
			timeRange: filter.value.timeRange,
			page: page.value,
			pageSize: 10
		})
		
		loading.value = false
		
		if (res.code === 0) {
			if (page.value === 1) {
				logList.value = res.data.list
			} else {
				logList.value = logList.value.concat(res.data.list)
			}
			hasMore.value = res.data.hasMore
		}
	} catch (error) {
		loading.value = false
		console.log('åŠ è½½è´¦å•åˆ—è¡¨å¤±è´¥', error)
	}
}

// åŠ è½½æ›´å¤š
const loadMore = () => {
	if (!loading.value && hasMore.value) {
		page.value++
		loadLogList()
	}
}

// é‡ç½®ç­›é€‰
const resetFilter = () => {
	filter.value = {
		type: 'all',
		timeRange: 'all'
	}
}

// åº”ç”¨ç­›é€‰
const applyFilter = () => {
	showFilterDialog.value = false
	page.value = 1
	logList.value = []
	loadLogList()
}

// è¿”å›
const goBack = () => {
	uni.navigateBack()
}

// é¡µé¢åŠ è½½æ—¶è·å–è´¦å•åˆ—è¡¨
onMounted(() => {
	loadLogList()
})
</script>
