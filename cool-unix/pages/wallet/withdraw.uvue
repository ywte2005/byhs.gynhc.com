<template>
	<view class="flex flex-col bg-[#f5f7fa] h-screen">
		<!-- 顶部导航 -->
		<cl-topbar title="提现" :show-back="true" background-color="#ffffff" color="#1f2329" safe-area-top></cl-topbar>

		<!-- 内容区域 -->
		<scroll-view class="flex-1 h-0" scroll-y>
			<view class="p-[32rpx] flex flex-col gap-[32rpx]">
				<!-- 可提现余额 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] flex flex-col">
					<text class="text-[28rpx] text-[#999999] mb-[16rpx]">可提现余额（元）</text>
					<text class="text-[56rpx] font-bold text-[#1f2329]">{{ availableBalance }}</text>
				</view>

				<!-- 提现金额 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] flex flex-col">
					<text class="text-[32rpx] font-semibold text-[#1f2329] mb-[24rpx]">提现金额</text>
					
					<view class="flex flex-row items-center border-b-[2rpx] border-[#e5e5e5] pb-[24rpx] mb-[24rpx]">
						<text class="text-[48rpx] text-[#1f2329] mr-[16rpx] font-semibold">¥</text>
						<input 
							v-model="withdrawAmount"
							type="digit"
							class="flex-1 text-[56rpx] font-bold text-[#1f2329] h-[80rpx]"
							placeholder="请输入提现金额"
							placeholder-class="text-[#c8c9cc]"
							:focus="true"
						/>
					</view>

					<view class="flex flex-row justify-between items-center">
						<text class="text-[28rpx] text-[#999999]">手续费：{{ serviceFee }}元</text>
						<view @click="withdrawAll">
							<text class="text-[28rpx] text-[#0052d9]">全部提现</text>
						</view>
					</view>
				</view>

				<!-- 提现账户 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] flex flex-col">
					<text class="text-[32rpx] font-semibold text-[#1f2329] mb-[24rpx]">提现账户</text>
					
					<view 
						v-for="(item, index) in bankCards" 
						:key="index"
						@click="selectBankCard(item.id)"
						class="flex flex-row items-center justify-between py-[24rpx] border-b-[2rpx] border-[#e5e5e5]"
					>
						<view class="flex flex-row items-center flex-1">
							<view class="w-[80rpx] h-[80rpx] rounded-[12rpx] bg-[#f5f5f5] flex items-center justify-center mr-[24rpx]">
								<uni-icons type="home" size="20" color="#0052d9"></uni-icons>
							</view>
							<view class="flex flex-col gap-[8rpx]">
								<text class="text-[32rpx] text-[#1f2329]">{{ item.bankName }}</text>
								<text class="text-[24rpx] text-[#999999]">{{ item.cardNo }}</text>
							</view>
						</view>
						<view class="w-[40rpx] h-[40rpx] rounded-full border-[4rpx] flex items-center justify-center" :class="selectedBankCard === item.id ? 'border-[#0052d9]' : 'border-[#e5e5e5]'">
							<view v-if="selectedBankCard === item.id" class="w-[24rpx] h-[24rpx] rounded-full bg-[#0052d9]"></view>
						</view>
					</view>

					<view @click="addBankCard" class="flex items-center justify-center pt-[24rpx]">
						<text class="text-[32rpx] text-[#0052d9]">+ 添加银行卡</text>
					</view>
				</view>

				<!-- 到账时间 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] flex flex-col">
					<text class="text-[32rpx] font-semibold text-[#1f2329] mb-[24rpx]">到账时间</text>
					
					<view class="flex flex-row justify-between items-center">
						<view class="flex flex-row items-center gap-[24rpx]">
							<uni-icons type="bolt" size="20" color="#faad14"></uni-icons>
							<view class="flex flex-col gap-[8rpx]">
								<text class="text-[32rpx] text-[#1f2329]">实时到账</text>
								<text class="text-[24rpx] text-[#999999]">预计2小时内到账</text>
							</view>
						</view>
						<text class="text-[32rpx] text-[#ff9500]">手续费 {{ serviceFee }}元</text>
					</view>
				</view>

				<!-- 提现说明 -->
				<view class="bg-[#fff7e6] rounded-[16rpx] p-[24rpx] flex flex-col gap-[16rpx]">
					<view class="flex flex-row items-center gap-[8rpx]">
						<uni-icons type="info-filled" size="16" color="#ed6a0c"></uni-icons>
						<text class="text-[28rpx] font-bold text-[#ed6a0c]">提现说明</text>
					</view>
					<view class="flex flex-col gap-[8rpx]">
						<text class="text-[26rpx] text-[#646a73]">• 单笔提现金额：10-50,000元</text>
						<text class="text-[26rpx] text-[#646a73]">• 手续费：提现金额的0.6%，最低2元</text>
						<text class="text-[26rpx] text-[#646a73]">• 实时到账：2小时内到账</text>
						<text class="text-[26rpx] text-[#646a73]">• 每日限额：单日最多提现100,000元</text>
						<text class="text-[26rpx] text-[#646a73]">• 如有疑问请联系客服：400-123-4567</text>
					</view>
				</view>

				<!-- 提交按钮 -->
				<view class="h-[96rpx] bg-[#0052d9] rounded-[24rpx] flex items-center justify-center mt-[16rpx]" :class="{ 'bg-[#c0c4cc]': !canSubmit }" @tap="confirmWithdraw">
					<text class="text-[32rpx] text-white font-medium">确认提现</text>
				</view>
			</view>
		</scroll-view>
	</view>
</template>

<script setup lang="uts">
import { ref, computed, onMounted } from 'vue'
// import { getWalletInfo, withdraw, getWithdrawConfig } from '@/services/wallet'

// 可提现余额
const availableBalance = ref('12,580.00')

// 提现金额
const withdrawAmount = ref('')

// 选中的银行卡
const selectedBankCard = ref(1)

// 银行卡列表
const bankCards = ref([
	{
		id: 1,
		bankName: '中国工商银行',
		cardNo: '尾号 8888'
	},
	{
		id: 2,
		bankName: '中国建设银行',
		cardNo: '尾号 6666'
	}
])

// 计算手续费
const serviceFee = computed(() => {
	const amount = parseFloat(withdrawAmount.value) || 0
	const fee = amount * 0.006
	return Math.max(fee, 2).toFixed(2)
})

// 计算实际到账金额
const actualAmount = computed(() => {
	const amount = parseFloat(withdrawAmount.value) || 0
	const fee = parseFloat(serviceFee.value)
	return Math.max(amount - fee, 0).toFixed(2)
})

// 判断是否可以提交
const canSubmit = computed(() => {
	const amount = parseFloat(withdrawAmount.value)
	const available = parseFloat(availableBalance.value.replace(/,/g, ''))
	return amount >= 10 && amount <= 50000 && amount <= available && selectedBankCard.value > 0
})

// 加载钱包信息
const loadWalletInfo = async () => {
	// Mock implementation
}

// 加载银行卡列表
const loadBankCards = async () => {
	// Mock implementation
}

// 全部提现
const withdrawAll = () => {
	withdrawAmount.value = availableBalance.value.replace(/,/g, '')
}

// 选择银行卡
const selectBankCard = (id: number) => {
	selectedBankCard.value = id
}

// 添加银行卡
const addBankCard = () => {
	uni.showToast({
		title: '添加银行卡功能开发中',
		icon: 'none'
	})
}

// 确认提现
const confirmWithdraw = async () => {
	if (!canSubmit.value) return

	const amount = parseFloat(withdrawAmount.value)
	const available = parseFloat(availableBalance.value.replace(/,/g, ''))

	if (amount < 10) {
		uni.showToast({
			title: '提现金额不能少于10元',
			icon: 'none'
		})
		return
	}

	if (amount > 50000) {
		uni.showToast({
			title: '单笔提现金额不能超过50,000元',
			icon: 'none'
		})
		return
	}

	if (amount > available) {
		uni.showToast({
			title: '提现金额不能大于可用余额',
			icon: 'none'
		})
		return
	}

	uni.showModal({
		title: '确认提现',
		content: `提现金额：¥${amount}\n手续费：¥${serviceFee.value}\n实际到账：¥${actualAmount.value}`,
		success: async (res) => {
			if (res.confirm) {
				try {
					uni.showLoading({ title: '处理中...' })
					
					// Mock withdraw
					setTimeout(() => {
						uni.hideLoading()
						uni.showToast({
							title: '提现申请已提交',
							icon: 'success'
						})
						setTimeout(() => {
							uni.navigateBack()
						}, 1500)
					}, 1000)
					
				} catch (error) {
					uni.hideLoading()
					uni.showToast({
						title: '提现失败，请重试',
						icon: 'none'
					})
				}
			}
		}
	})
}

// 页面加载时获取数据
onMounted(() => {
	loadWalletInfo()
	loadBankCards()
})
</script>

<style>
</style>
