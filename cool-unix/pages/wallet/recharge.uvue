<template>
	<view class="flex flex-col h-full bg-[#f5f5f5]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="flex items-center justify-between px-4 py-3 bg-white">
			<view class="flex items-center" @click="goBack">
				<text class="text-6">â†</text>
				<text class="text-4 ml-2">å……å€¼</text>
			</view>
		</view>

		<!-- å†…å®¹åŒºåŸŸ -->
		<scroll-view class="flex-1" scroll-y>
			<view class="px-4 py-4">
				<!-- å½“å‰ä½™é¢ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-3.5 text-[#999] mb-2">å½“å‰ä½™é¢ï¼ˆå…ƒï¼‰</text>
					<text class="text-7 font-bold text-[#1f2329]">{{ currentBalance }}</text>
				</view>

				<!-- å……å€¼é‡‘é¢ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">å……å€¼é‡‘é¢</text>
					
					<view class="flex items-center border-b border-[#e5e5e5] pb-3 mb-3">
						<text class="text-6 text-[#1f2329] mr-2">Â¥</text>
						<input 
							v-model="rechargeAmount"
							type="digit"
							class="flex-1 text-7 font-bold text-[#1f2329]"
							placeholder="è¯·è¾“å…¥å……å€¼é‡‘é¢"
							placeholder-class="text-[#c8c9cc]"
							:focus="true"
						/>
					</view>

					<view class="flex flex-wrap">
						<view 
							v-for="(amount, index) in quickAmounts" 
							:key="index"
							@click="selectAmount(amount)"
							:class="['w-1/3 px-1 mb-2']"
						>
							<view :class="['border rounded-2 py-3 text-center', rechargeAmount === amount ? 'border-[#07c160] bg-[#f0f9ff]' : 'border-[#e5e5e5]']">
								<text :class="['text-4', rechargeAmount === amount ? 'text-[#07c160] font-bold' : 'text-[#1f2329]']">{{ amount }}å…ƒ</text>
							</view>
						</view>
					</view>
				</view>

				<!-- æ”¯ä»˜æ–¹å¼ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">æ”¯ä»˜æ–¹å¼</text>
					
					<view 
						v-for="(item, index) in paymentMethods" 
						:key="index"
						@click="selectPayment(item.value)"
						class="flex items-center justify-between py-3 border-b border-[#e5e5e5]"
					>
						<view class="flex items-center flex-1">
							<text class="text-6 mr-3">{{ item.icon }}</text>
							<view>
								<text class="text-4 text-[#1f2329]">{{ item.label }}</text>
								<text class="text-3 text-[#999] mt-1">{{ item.desc }}</text>
							</view>
						</view>
						<view :class="['w-5 h-5 rounded-full border-2 flex items-center justify-center', selectedPayment === item.value ? 'border-[#07c160]' : 'border-[#e5e5e5]']">
							<view v-if="selectedPayment === item.value" class="w-3 h-3 rounded-full bg-[#07c160]"></view>
						</view>
					</view>
				</view>

				<!-- å……å€¼è¯´æ˜ -->
				<view class="bg-[#fff9e6] rounded-2 p-4 mb-3">
					<text class="text-3.5 text-[#ed6a0c] font-bold mb-2">ğŸ’¡ å……å€¼è¯´æ˜</text>
					<text class="text-3.5 text-[#646a73] mt-2">â€¢ å……å€¼é‡‘é¢å®æ—¶åˆ°è´¦ï¼Œå¯ç«‹å³ä½¿ç”¨</text>
					<text class="text-3.5 text-[#646a73] mt-1">â€¢ å……å€¼é‡‘é¢å¯ç”¨äºå‘èµ·ä»»åŠ¡ã€è´­ä¹°ç­‰çº§ç­‰</text>
					<text class="text-3.5 text-[#646a73] mt-1">â€¢ å……å€¼é‡‘é¢å¯éšæ—¶æç°åˆ°é“¶è¡Œå¡</text>
					<text class="text-3.5 text-[#646a73] mt-1">â€¢ å¦‚æœ‰ç–‘é—®è¯·è”ç³»å®¢æœï¼š400-123-4567</text>
				</view>
			</view>
		</scroll-view>

		<!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
		<view class="bg-white px-4 py-3 border-t border-[#e5e5e5]">
			<view class="flex items-center justify-between mb-3">
				<text class="text-4 text-[#646a73]">å……å€¼é‡‘é¢</text>
				<text class="text-6 font-bold text-[#ff3b30]">Â¥{{ rechargeAmount || '0.00' }}</text>
			</view>
			<button 
				@click="confirmRecharge"
				:class="['w-full rounded-full py-3', canSubmit ? 'bg-[#07c160] text-white' : 'bg-[#e5e5e5] text-[#999]']"
				:disabled="!canSubmit"
			>
				<text class="text-4">ç¡®è®¤å……å€¼</text>
			</button>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, computed, onMounted } from 'vue'
import { getWalletInfo, recharge } from '@/services/wallet'

// å½“å‰ä½™é¢
const currentBalance = ref('12,580.00')

// å……å€¼é‡‘é¢
const rechargeAmount = ref('')

// é€‰ä¸­çš„æ”¯ä»˜æ–¹å¼
const selectedPayment = ref('wechat')

// å¿«æ·é‡‘é¢
const quickAmounts = ['100', '500', '1000', '2000', '5000', '10000']

// æ”¯ä»˜æ–¹å¼
const paymentMethods = [
	{
		value: 'wechat',
		icon: 'ğŸ’š',
		label: 'å¾®ä¿¡æ”¯ä»˜',
		desc: 'æ¨èä½¿ç”¨ï¼Œå¿«é€Ÿåˆ°è´¦'
	},
	{
		value: 'alipay',
		icon: 'ğŸ’™',
		label: 'æ”¯ä»˜å®',
		desc: 'å®‰å…¨ä¾¿æ·'
	},
	{
		value: 'bank',
		icon: 'ğŸ’³',
		label: 'é“¶è¡Œå¡',
		desc: 'æ”¯æŒå„å¤§é“¶è¡Œ'
	}
]

// åˆ¤æ–­æ˜¯å¦å¯ä»¥æäº¤
const canSubmit = computed(() => {
	const amount = parseFloat(rechargeAmount.value)
	return amount > 0 && selectedPayment.value !== ''
})

// åŠ è½½é’±åŒ…ä¿¡æ¯
const loadWalletInfo = async () => {
	try {
		const res = await getWalletInfo()
		if (res.code === 0) {
			currentBalance.value = res.data.balance
		}
	} catch (error) {
		console.log('åŠ è½½é’±åŒ…ä¿¡æ¯å¤±è´¥', error)
	}
}

// é€‰æ‹©é‡‘é¢
const selectAmount = (amount: string) => {
	rechargeAmount.value = amount
}

// é€‰æ‹©æ”¯ä»˜æ–¹å¼
const selectPayment = (value: string) => {
	selectedPayment.value = value
}

// ç¡®è®¤å……å€¼
const confirmRecharge = async () => {
	if (!canSubmit.value) return

	const amount = parseFloat(rechargeAmount.value)
	if (amount <= 0) {
		uni.showToast({
			title: 'è¯·è¾“å…¥æ­£ç¡®çš„å……å€¼é‡‘é¢',
			icon: 'none'
		})
		return
	}

	try {
		uni.showLoading({ title: 'å¤„ç†ä¸­...' })
		
		const res = await recharge({
			amount: rechargeAmount.value,
			paymentMethod: selectedPayment.value
		})
		
		uni.hideLoading()
		
		if (res.code === 0) {
			// è¿™é‡Œåº”è¯¥è·³è½¬åˆ°æ”¯ä»˜é¡µé¢æˆ–è°ƒèµ·æ”¯ä»˜
			uni.showToast({
				title: 'å……å€¼æˆåŠŸ',
				icon: 'success'
			})
			
			// è¿”å›ä¸Šä¸€é¡µ
			setTimeout(() => {
				uni.navigateBack()
			}, 1500)
		} else {
			uni.showToast({
				title: res.message || 'å……å€¼å¤±è´¥',
				icon: 'none'
			})
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: 'å……å€¼å¤±è´¥ï¼Œè¯·é‡è¯•',
			icon: 'none'
		})
	}
}

// è¿”å›
const goBack = () => {
	uni.navigateBack()
}

// é¡µé¢åŠ è½½æ—¶è·å–é’±åŒ…ä¿¡æ¯
onMounted(() => {
	loadWalletInfo()
})
</script>
