<template>
	<view class="page-container">
		<!-- Header -->
		<view class="header">
			<view class="header-left" @click="goBack">
				<uni-icons type="left" size="24" color="#1f2329"></uni-icons>
				<text class="header-title">æ³¨å†Œ</text>
			</view>
		</view>

		<scroll-view class="content" scroll-y>
			<view class="content-wrapper">
				<view class="form-section">
					<!-- Phone -->
					<view class="input-group">
						<text class="label">æ‰‹æœºå·</text>
						<view class="input-wrapper">
							<input
								v-model="form.mobile"
								type="number"
								placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
								class="input"
								placeholder-class="input-placeholder"
								maxlength="11"
							/>
						</view>
					</view>

					<!-- Code -->
					<view class="input-group">
						<text class="label">éªŒè¯ç </text>
						<view class="input-wrapper code-wrapper">
							<input
								v-model="form.code"
								type="number"
								placeholder="è¯·è¾“å…¥éªŒè¯ç "
								class="input"
								placeholder-class="input-placeholder"
								maxlength="6"
							/>
							<view 
								class="code-btn" 
								:class="{ disabled: countdown > 0 || form.mobile.length !== 11 }"
								@tap="sendCode"
							>
								<text class="code-btn-text">{{ countdown > 0 ? `${countdown}s` : "è·å–éªŒè¯ç " }}</text>
							</view>
						</view>
					</view>

					<!-- Password -->
					<view class="input-group">
						<text class="label">è®¾ç½®å¯†ç </text>
						<view class="input-wrapper">
							<input
								v-model="form.password"
								:type="showPassword ? 'text' : 'password'"
								placeholder="è¯·è®¾ç½®6-20ä½å¯†ç "
								class="input"
								placeholder-class="input-placeholder"
							/>
							<view class="eye-icon" @tap="showPassword = !showPassword">
								<text>{{ showPassword ? 'ğŸ‘ï¸' : 'ğŸ”’' }}</text>
							</view>
						</view>
					</view>

					<!-- Confirm Password -->
					<view class="input-group">
						<text class="label">ç¡®è®¤å¯†ç </text>
						<view class="input-wrapper">
							<input
								v-model="form.confirm_password"
								:type="showConfirmPassword ? 'text' : 'password'"
								placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
								class="input"
								placeholder-class="input-placeholder"
							/>
							<view class="eye-icon" @tap="showConfirmPassword = !showConfirmPassword">
								<text>{{ showConfirmPassword ? 'ğŸ‘ï¸' : 'ğŸ”’' }}</text>
							</view>
						</view>
					</view>

					<!-- Invite Code -->
					<view class="input-group">
						<text class="label">é‚€è¯·ç ï¼ˆé€‰å¡«ï¼‰</text>
						<view class="input-wrapper">
							<input
								v-model="form.invite_code"
								placeholder="è¯·è¾“å…¥é‚€è¯·ç "
								class="input"
								placeholder-class="input-placeholder"
							/>
						</view>
					</view>

					<!-- Agreement -->
					<view class="agreement" @tap="form.agree = !form.agree">
						<view class="checkbox" :class="{ active: form.agree }">
							<view v-if="form.agree" class="checkbox-inner"></view>
						</view>
						<text class="agreement-text">æˆ‘å·²é˜…è¯»å¹¶åŒæ„ã€Šç”¨æˆ·åè®®ã€‹å’Œã€Šéšç§æ”¿ç­–ã€‹</text>
					</view>

					<!-- Register Button -->
					<view 
						class="btn-primary" 
						:class="{ disabled: !canRegister }"
						@tap="handleRegister"
					>
						<text class="btn-text">æ³¨å†Œ</text>
					</view>
				</view>
			</view>
		</scroll-view>
	</view>
</template>

<script setup lang="uts">
import { ref, computed } from "vue";
import { register, sendSmsCode } from "@/services/auth";
import { useStore } from "@/.cool";

const form = ref({
	mobile: "",
	code: "",
	password: "",
	confirm_password: "",
	invite_code: "",
	agree: false
});

const showPassword = ref(false);
const showConfirmPassword = ref(false);
const loading = ref(false);
const countdown = ref(0);

// æ˜¯å¦å¯ä»¥æ³¨å†Œ
const canRegister = computed(() => {
	return (
		form.value.mobile.length === 11 &&
		form.value.code.length === 6 &&
		form.value.password.length >= 6 &&
		form.value.password === form.value.confirm_password &&
		form.value.agree
	);
});

// å‘é€éªŒè¯ç 
async function sendCode() {
	if (form.value.mobile.length !== 11) {
		uni.showToast({
			title: "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·",
			icon: "none"
		});
		return;
	}

	if (countdown.value > 0) return;

	try {
		await sendSmsCode(form.value.mobile, "register");

		uni.showToast({
			title: "éªŒè¯ç å·²å‘é€",
			icon: "success"
		});

		// å€’è®¡æ—¶
		countdown.value = 60;
		const timer = setInterval(() => {
			countdown.value--;
			if (countdown.value <= 0) {
				clearInterval(timer);
			}
		}, 1000);
	} catch (error : any) {
		uni.showToast({
			title: error.message || "å‘é€å¤±è´¥",
			icon: "none"
		});
	}
}

// æ³¨å†Œ
async function handleRegister() {
	if (!canRegister.value) {
		return;
	}

	try {
		loading.value = true;

		const res = await register(form.value);

		ä¿å­˜token
		const { user } = useStore();
		user.setToken(res.token);

		uni.showToast({
			title: "æ³¨å†ŒæˆåŠŸ",
			icon: "success"
		});

		// è·³è½¬é¦–é¡µ
		setTimeout(() => {
			uni.reLaunch({
				url: "/pages/index/home"
			});
		}, 1000);
	} catch (error : any) {
		uni.showToast({
			title: error.message || "æ³¨å†Œå¤±è´¥",
			icon: "none"
		});
	} finally {
		loading.value = false;
	}
}

function goBack() {
	uni.navigateBack();
}
</script>

<style>
.page-container {
	display: flex;
	flex-direction: column;
	background-color: #ffffff;
	height: 100vh;
}

/* Header */
.header {
	height: 112rpx; /* 56px */
	background-color: #ffffff;
	display: flex;
	align-items: center;
	padding: 0 32rpx;
	justify-content: center;
	position: relative;
}

.header-left {
	position: absolute;
	left: 32rpx;
	display: flex;
	align-items: center;
	gap: 16rpx;
}



.header-title {
	font-size: 34rpx; /* 17px */
	font-weight: 600;
	color: #1f2329;
	font-family: 'Inter', sans-serif;
}

/* Content */
.content {
	flex: 1;
	height: 0;
}

.content-wrapper {
	padding: 32rpx 48rpx;
}

.form-section {
	display: flex;
	flex-direction: column;
	gap: 32rpx;
}

.input-group {
	display: flex;
	flex-direction: column;
	gap: 16rpx;
}

.label {
	font-size: 28rpx;
	font-weight: 500;
	color: #1f2329;
}

.input-wrapper {
	height: 96rpx;
	background-color: #f5f7fa;
	border-radius: 16rpx;
	display: flex;
	align-items: center;
	padding: 0 24rpx;
}

.code-wrapper {
	padding-right: 0;
}

.input {
	flex: 1;
	font-size: 30rpx;
	color: #1f2329;
	height: 100%;
}

.input-placeholder {
	color: #c0c4cc;
}

.code-btn {
	height: 100%;
	padding: 0 32rpx;
	display: flex;
	align-items: center;
	justify-content: center;
	border-left: 2rpx solid #e5e6eb;
}

.code-btn.disabled {
	opacity: 0.5;
}

.code-btn-text {
	font-size: 28rpx;
	color: #0052d9;
}

.eye-icon {
	padding: 0 16rpx;
}

/* Agreement */
.agreement {
	display: flex;
	flex-direction: row;
	align-items: center;
	gap: 16rpx;
	margin-top: 16rpx;
}

.checkbox {
	width: 32rpx;
	height: 32rpx;
	border: 2rpx solid #c0c4cc;
	border-radius: 50%;
	display: flex;
	align-items: center;
	justify-content: center;
}

.checkbox.active {
	border-color: #0052d9;
	background-color: #0052d9;
}

.checkbox-inner {
	width: 12rpx;
	height: 24rpx;
	border-bottom: 4rpx solid #ffffff;
	border-right: 4rpx solid #ffffff;
	transform: rotate(45deg) translate(-2rpx, -2rpx);
}

.agreement-text {
	font-size: 24rpx;
	color: #86909c;
}

/* Buttons */
.btn-primary {
	height: 96rpx;
	background-color: #0052d9;
	border-radius: 16rpx;
	display: flex;
	align-items: center;
	justify-content: center;
	margin-top: 32rpx;
}

.btn-primary.disabled {
	background-color: #bbd3fb;
}

.btn-text {
	font-size: 32rpx;
	color: #ffffff;
	font-weight: 500;
}
</style>
