<template>
	<view class="page-container">
		<!-- Header -->
		<view class="header">
			<view class="header-left" @click="goBack">
				<text class="back-icon">â†</text>
				<text class="header-title">è´­ç‰©è½¦ ({{ list.length }})</text>
			</view>
			<view class="header-right" @click="isDel = !isDel">
				<text class="header-action">{{ isDel ? t("å®Œæˆ") : t("ç®¡ç†") }}</text>
			</view>
		</view>

		<scroll-view class="content" scroll-y>
			<view class="content-wrapper">
				<!-- Notification -->
				<view class="notification-card">
					<text class="notification-text">ğŸ”¥ æœ€æ–°é™ä»·å•†å“ï¼Œé™æ—¶ä¼˜æƒ ï¼ŒæŠ“ç´§æŠ¢è´­ï¼</text>
				</view>

				<!-- Cart List -->
				<view class="cart-list">
					<cl-list-item
						v-for="(item, index) in list"
						:key="item.id"
						:pt="{
							className: 'cart-item-wrapper',
							inner: { className: '!p-0' }
						}"
						swipeable
					>
						<view class="cart-item">
							<view class="checkbox-area" @tap="selectItem(item)">
								<cl-icon
									name="checkbox-circle-line"
									color="#0052d9"
									:size="40"
									v-if="item.checked"
								></cl-icon>
								<cl-icon name="checkbox-blank-circle-line" :size="40" color="#c0c4cc" v-else></cl-icon>
							</view>

							<image class="item-img" :src="item.cover" mode="aspectFill"></image>

							<view class="item-info">
								<text class="item-name">{{ item.name }}</text>

								<view class="item-sku">
									<text class="sku-text">{{ item.skuName }}</text>
									<cl-icon name="arrow-down-s-line" :size="24" color="#999"></cl-icon>
								</view>

								<view class="item-bottom">
									<view class="price-box">
										<text class="currency">Â¥</text>
										<text class="price">{{ item.price }}</text>
									</view>

									<view class="action-box">
										<view
											v-if="isDel"
											class="del-btn-icon"
											@tap="delItem(index)"
										>
											<cl-icon name="delete-bin-line" color="#ffffff" :size="28"></cl-icon>
										</view>

										<cl-input-number
											v-else
											v-model="item.count"
											:size="24"
											:min="1"
											:pt="{
												op: {
													plus: { className: '!bg-gray-100 !rounded-8' },
													minus: { className: '!bg-gray-100 !rounded-8' },
													icon: { size: 24 }
												},
												value: {
													className: '!bg-transparent !w-60',
													input: { className: '!text-28' }
												}
											}"
										></cl-input-number>
									</view>
								</view>

								<view class="tags-row">
									<text class="tag-text">æ¯”åŠ å…¥æ—¶é™100å…ƒ</text>
								</view>
							</view>
						</view>

						<template #swipe-right>
							<view class="swipe-del-btn" @tap="delItem(index)">
								<text class="swipe-del-text">{{ t("åˆ é™¤") }}</text>
							</view>
						</template>
					</cl-list-item>
				</view>

				<view v-if="list.length == 0" class="empty-state">
					<cl-empty></cl-empty>
				</view>
			</view>
		</scroll-view>

		<!-- Footer -->
		<view class="footer-bar">
			<view class="select-all" @tap="onSelectAllChange(!selectAll)">
				<cl-icon
					name="checkbox-circle-line"
					color="#0052d9"
					:size="40"
					v-if="selectAll"
				></cl-icon>
				<cl-icon name="checkbox-blank-circle-line" :size="40" color="#c0c4cc" v-else></cl-icon>
				<text class="select-all-text">{{ t("å…¨é€‰") }}</text>
			</view>

			<view class="footer-right">
				<template v-if="isDel">
					<view class="btn-delete" @tap="delAll">
						<text class="btn-text">{{ t("åˆ é™¤") }}</text>
					</view>
				</template>

				<template v-else>
					<view class="total-box">
						<text class="total-label">{{ t("åˆè®¡") }}</text>
						<text class="total-price">Â¥{{ totalPrice }}</text>
					</view>

					<view class="btn-settle" @tap="toSettle">
						<text class="btn-text">{{ t("å»ç»“ç®—") }}</text>
					</view>
				</template>
			</view>
		</view>
	</view>
</template>

<script lang="ts" setup>
import { parseClass, isEmpty, $t, t } from "@/.cool";
import { useUi } from "@/uni_modules/cool-ui";
import { computed, ref } from "vue";

const ui = useUi();

// å•†å“ç±»å‹
type Goods = {
	id: number;
	name: string;
	count: number;
	price: number;
	cover: string;
	skuName: string;
	checked: boolean;
};

// å•†å“åˆ—è¡¨
const list = ref<Goods[]>([
	{
		id: 1,
		name: "Apple iPad",
		count: 1,
		price: 450,
		cover: "https://img.yzcdn.cn/vant/ipad.png",
		skuName: "æ·±ç©ºç°è‰² 128GB WLANç‰ˆ",
		checked: true
	},
	{
		id: 2,
		name: "Samsung Galaxy S24",
		count: 2,
		price: 699,
		cover: "https://img.yzcdn.cn/vant/samsung.png",
		skuName: "æ›œçŸ³é»‘ 12GB+256GB å®˜æ–¹æ ‡é…",
		checked: false
	},
	{
		id: 3,
		name: "Sony WH-1000XM5",
		count: 1,
		price: 299,
		cover: "https://img.yzcdn.cn/vant/sony.png",
		skuName: "é»‘è‰² æ— çº¿è“ç‰™ å®˜æ–¹æ ‡é…",
		checked: false
	},
	{
		id: 4,
		name: "å°ç±³æ‰‹ç¯8",
		count: 3,
		price: 49,
		cover: "https://img.yzcdn.cn/vant/xiaomi.png",
		skuName: "æ›œçŸ³é»‘ æ ‡å‡†ç‰ˆ ç¡…èƒ¶è¡¨å¸¦",
		checked: false
	},
	{
		id: 5,
		name: "Kindle Paperwhite",
		count: 1,
		price: 120,
		cover: "https://img.yzcdn.cn/vant/kindle.png",
		skuName: "é»‘è‰² 8GB å®˜æ–¹æ ‡é…",
		checked: false
	}
]);

// æ˜¯å¦å…¨é€‰
const selectAll = ref(false);

function goBack() {
	uni.navigateBack();
}

/**
 * é€‰æ‹©/å–æ¶ˆé€‰æ‹©å•ä¸ªå•†å“
 * @param item éœ€è¦æ“ä½œçš„å•†å“
 */
function selectItem(item: Goods) {
	// åˆ‡æ¢é€‰ä¸­çŠ¶æ€
	item.checked = !item.checked;
	// åˆ¤æ–­æ˜¯å¦æ‰€æœ‰å•†å“éƒ½è¢«é€‰ä¸­ï¼Œæ›´æ–°å…¨é€‰çŠ¶æ€
	selectAll.value = list.value.every((item) => item.checked);
}

/**
 * å…¨é€‰/å–æ¶ˆå…¨é€‰
 * @param val æ˜¯å¦å…¨é€‰
 */
function onSelectAllChange(val: boolean) {
	selectAll.value = val;
	list.value.forEach((item, index, arr) => {
		arr[index].checked = val;
	});
}

// æ˜¯å¦å¤„äºåˆ é™¤æ¨¡å¼
const isDel = ref(false);

/**
 * åˆ é™¤å•ä¸ªå•†å“
 * @param index å•†å“ç´¢å¼•
 */
function delItem(index: number) {
	ui.showConfirm({
		title: t("æ¸©é¦¨æç¤º"),
		message: t("ç¡®å®šåˆ é™¤è¯¥å•†å“å—ï¼Ÿ"),
		callback(action) {
			if (action === "confirm") {
				// åˆ é™¤æŒ‡å®šç´¢å¼•çš„å•†å“
				list.value.splice(index, 1);

				ui.showToast({
					message: t("åˆ é™¤æˆåŠŸ")
				});
			}
		}
	});
}

/**
 * åˆ é™¤æ‰€æœ‰å·²é€‰ä¸­çš„å•†å“
 */
function delAll() {
	const checked = list.value.filter((item) => item.checked);

	// å¦‚æœæ²¡æœ‰é€‰ä¸­å•†å“ï¼Œæç¤ºç”¨æˆ·
	if (isEmpty(checked)) {
		return ui.showToast({
			message: t("è¯·å…ˆé€‰æ‹©å•†å“")
		});
	}

	ui.showConfirm({
		title: t("æ¸©é¦¨æç¤º"),
		message: t("ç¡®å®šåˆ é™¤é€‰ä¸­çš„å•†å“å—ï¼Ÿ"),
		callback(action) {
			if (action == "confirm") {
				// åªä¿ç•™æœªé€‰ä¸­çš„å•†å“
				list.value = list.value.filter((item) => !item.checked);

				// å¦‚æœä¹‹å‰æ˜¯å…¨é€‰ï¼Œåˆ é™¤åå–æ¶ˆå…¨é€‰çŠ¶æ€
				if (selectAll.value) {
					selectAll.value = false;
				}

				ui.showToast({
					message: t("åˆ é™¤æˆåŠŸ")
				});
			}
		}
	});
}

/**
 * æ¸…ç©ºè´­ç‰©è½¦
 */
function clear() {
	list.value = [];
	selectAll.value = false;
	isDel.value = false;
}

/**
 * è®¡ç®—å·²é€‰ä¸­å•†å“çš„æ€»ä»·
 */
const totalPrice = computed(() => {
	return list.value
		.filter((item) => item.checked)
		.reduce((acc, item) => acc + item.price * item.count, 0);
});

/**
 * ç»“ç®—æ“ä½œ
 */
function toSettle() {
	// å¦‚æœæ²¡æœ‰é€‰ä¸­å•†å“ï¼Œæç¤ºç”¨æˆ·
	if (totalPrice.value <= 0) {
		return ui.showToast({
			message: t("è¯·å…ˆé€‰æ‹©å•†å“")
		});
	}

	ui.showConfirm({
		title: t("æ¸©é¦¨æç¤º"),
		message: $t("æ‚¨éœ€æ”¯ä»˜ {price} å…ƒï¼Œè¯·ç¡®è®¤æ”¯ä»˜", { price: totalPrice.value }),
		beforeClose(action, { showLoading, close }) {
			if (action == "confirm") {
				showLoading();

				setTimeout(() => {
					ui.showToast({
						message: t("æ”¯ä»˜æˆåŠŸ")
					});

					close();
				}, 1000);
			} else {
				close();
			}
		}
	});
}
</script>

<style>
.page-container {
	display: flex;
	flex-direction: column;
	background-color: #f5f7fa;
	height: 100vh;
}

/* Header */
.header {
	height: 112rpx; /* 56px */
	background-color: #0052d9;
	display: flex;
	align-items: center;
	padding: 0 32rpx;
	justify-content: space-between;
	position: relative;
}

.header-left {
	display: flex;
	align-items: center;
	gap: 16rpx;
}

.back-icon {
	font-size: 48rpx;
	color: #ffffff;
}

.header-title {
	font-size: 34rpx; /* 17px */
	font-weight: 600;
	color: #ffffff;
	font-family: 'Inter', sans-serif;
}

.header-right {
	display: flex;
	align-items: center;
}

.header-action {
	font-size: 28rpx;
	color: #ffffff;
}

/* Content */
.content {
	flex: 1;
	height: 0;
}

.content-wrapper {
	padding: 32rpx;
	padding-bottom: 120rpx;
	display: flex;
	flex-direction: column;
	gap: 24rpx;
}

/* Notification */
.notification-card {
	background-color: #fff7e6;
	padding: 24rpx;
	border-radius: 16rpx;
}

.notification-text {
	font-size: 26rpx;
	color: #ed6a0c;
}

/* Cart List */
.cart-list {
	display: flex;
	flex-direction: column;
	gap: 24rpx;
}

.cart-item-wrapper {
	background-color: #ffffff;
	border-radius: 24rpx;
	margin-bottom: 24rpx;
	overflow: hidden;
}

.cart-item {
	display: flex;
	flex-direction: row;
	padding: 24rpx;
}

.checkbox-area {
	display: flex;
	align-items: center;
	justify-content: center;
	margin-right: 24rpx;
}

.item-img {
	width: 160rpx;
	height: 160rpx;
	border-radius: 12rpx;
	background-color: #f5f5f5;
}

.item-info {
	flex: 1;
	display: flex;
	flex-direction: column;
	margin-left: 24rpx;
	justify-content: space-between;
}

.item-name {
	font-size: 30rpx;
	font-weight: 600;
	color: #1f2329;
	line-height: 1.4;
	margin-bottom: 12rpx;
}

.item-sku {
	display: flex;
	flex-direction: row;
	align-items: center;
	background-color: #f5f7fa;
	padding: 4rpx 12rpx;
	border-radius: 8rpx;
	align-self: flex-start;
	margin-bottom: 16rpx;
}

.sku-text {
	font-size: 24rpx;
	color: #646a73;
	margin-right: 8rpx;
}

.item-bottom {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	align-items: center;
}

.price-box {
	display: flex;
	flex-direction: row;
	align-items: baseline;
}

.currency {
	font-size: 24rpx;
	color: #ff3b30;
	margin-right: 2rpx;
}

.price {
	font-size: 34rpx;
	font-weight: 700;
	color: #ff3b30;
}

.action-box {
	display: flex;
	align-items: center;
}

.del-btn-icon {
	width: 56rpx;
	height: 56rpx;
	background-color: #ff3b30;
	border-radius: 28rpx;
	display: flex;
	align-items: center;
	justify-content: center;
}

.tags-row {
	margin-top: 8rpx;
}

.tag-text {
	font-size: 22rpx;
	color: #ff3b30;
}

.swipe-del-btn {
	background-color: #ff3b30;
	width: 140rpx;
	height: 100%;
	display: flex;
	align-items: center;
	justify-content: center;
}

.swipe-del-text {
	color: #ffffff;
	font-size: 28rpx;
}

/* Empty State */
.empty-state {
	padding: 64rpx 0;
	display: flex;
	justify-content: center;
}

/* Footer Bar */
.footer-bar {
	position: fixed;
	bottom: 0;
	left: 0;
	right: 0;
	background-color: #ffffff;
	border-top: 1rpx solid #e5e5e5;
	display: flex;
	flex-direction: row;
	align-items: center;
	justify-content: space-between;
	padding: 24rpx 32rpx;
	padding-bottom: calc(24rpx + env(safe-area-inset-bottom));
	z-index: 100;
}

.select-all {
	display: flex;
	flex-direction: row;
	align-items: center;
	gap: 16rpx;
}

.select-all-text {
	font-size: 28rpx;
	color: #646a73;
}

.footer-right {
	display: flex;
	flex-direction: row;
	align-items: center;
	gap: 24rpx;
}

.total-box {
	display: flex;
	flex-direction: column;
	align-items: flex-end;
}

.total-label {
	font-size: 24rpx;
	color: #646a73;
}

.total-price {
	font-size: 34rpx;
	font-weight: 700;
	color: #ff3b30;
}

.btn-settle {
	background-color: #0052d9;
	padding: 16rpx 48rpx;
	border-radius: 40rpx;
}

.btn-delete {
	background-color: #ff3b30;
	padding: 16rpx 48rpx;
	border-radius: 40rpx;
}

.btn-text {
	color: #ffffff;
	font-size: 30rpx;
	font-weight: 600;
}
</style>
