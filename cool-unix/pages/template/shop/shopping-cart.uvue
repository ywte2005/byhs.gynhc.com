<template>
	<view class="flex flex-col h-screen bg-[#f5f7fa]">
		<!-- Header -->
		<view class="bg-[#0052d9] pb-[24rpx]">
			<cl-topbar :title="`è´­ç‰©è½¦ (${list.length})`" :show-back="true" background-color="#0052d9" color="#ffffff" safe-area-top :border="false">
				<template #append>
					<view class="flex items-center justify-center px-[32rpx] h-full" @click="isDel = !isDel">
						<text class="text-[28rpx] text-white">{{ isDel ? t("å®Œæˆ") : t("ç®¡ç†") }}</text>
					</view>
				</template>
			</cl-topbar>
		</view>

		<scroll-view class="flex-1 h-0 -mt-[24rpx] rounded-t-[24rpx] overflow-hidden bg-[#f5f7fa]" scroll-y>
			<view class="p-[32rpx] pb-[120rpx] flex flex-col gap-[24rpx]">
				<!-- Notification -->
				<view class="bg-[#fff7e6] p-[24rpx] rounded-[16rpx]">
					<text class="text-[26rpx] text-[#ed6a0c]">ğŸ”¥ æœ€æ–°é™ä»·å•†å“ï¼Œé™æ—¶ä¼˜æƒ ï¼ŒæŠ“ç´§æŠ¢è´­ï¼</text>
				</view>

				<!-- Cart List -->
				<view class="flex flex-col gap-[24rpx]">
					<cl-list-item
						v-for="(item, index) in list"
						:key="item.id"
						:pt="{
							className: 'bg-white rounded-[24rpx] mb-[24rpx] overflow-hidden',
							inner: { className: '!p-0' }
						}"
						swipeable
					>
						<view class="flex flex-row p-[24rpx]">
							<view class="flex items-center justify-center mr-[24rpx]" @tap="selectItem(item)">
								<cl-icon
									name="checkbox-circle-line"
									color="#0052d9"
									:size="40"
									v-if="item.checked"
								></cl-icon>
								<cl-icon name="checkbox-blank-circle-line" :size="40" color="#c0c4cc" v-else></cl-icon>
							</view>

							<image class="w-[160rpx] h-[160rpx] rounded-[12rpx] bg-[#f5f5f5]" :src="item.cover" mode="aspectFill"></image>

							<view class="flex-1 flex flex-col ml-[24rpx] justify-between">
								<text class="text-[30rpx] font-semibold text-[#1f2329] leading-[1.4] mb-[12rpx]">{{ item.name }}</text>

								<view class="flex flex-row items-center bg-[#f5f7fa] px-[12rpx] py-[4rpx] rounded-[8rpx] self-start mb-[16rpx]">
									<text class="text-[24rpx] text-[#646a73] mr-[8rpx]">{{ item.skuName }}</text>
									<cl-icon name="arrow-down-s-line" :size="24" color="#999"></cl-icon>
								</view>

								<view class="flex flex-row justify-between items-center">
									<view class="flex flex-row items-baseline">
										<text class="text-[24rpx] text-[#ff3b30] mr-[2rpx]">Â¥</text>
										<text class="text-[34rpx] font-bold text-[#ff3b30]">{{ item.price }}</text>
									</view>

									<view class="flex items-center">
										<view
											v-if="isDel"
											class="w-[56rpx] h-[56rpx] bg-[#ff3b30] rounded-[28rpx] flex items-center justify-center"
											@tap="delItem(index)"
										>
											<cl-icon name="delete-bin-line" color="#ffffff" :size="28"></cl-icon>
										</view>

										<cl-input-number
											v-else
											v-model="item.count"
											:size="24"
											:min="1"
											:pt="{
												op: {
													plus: { className: '!bg-gray-100 !rounded-8' },
													minus: { className: '!bg-gray-100 !rounded-8' },
													icon: { size: 24 }
												},
												value: {
													className: '!bg-transparent !w-60',
													input: { className: '!text-28' }
												}
											}"
										></cl-input-number>
									</view>
								</view>

								<view class="mt-[8rpx]">
									<text class="text-[22rpx] text-[#ff3b30]">æ¯”åŠ å…¥æ—¶é™100å…ƒ</text>
								</view>
							</view>
						</view>

						<template #swipe-right>
							<view class="bg-[#ff3b30] w-[140rpx] h-full flex items-center justify-center" @tap="delItem(index)">
								<text class="text-white text-[28rpx]">{{ t("åˆ é™¤") }}</text>
							</view>
						</template>
					</cl-list-item>
				</view>

				<view v-if="list.length == 0" class="flex justify-center py-[64rpx]">
					<cl-empty></cl-empty>
				</view>
			</view>
		</scroll-view>

		<!-- Footer -->
		<view class="fixed bottom-0 left-0 right-0 bg-white border-t-[1rpx] border-[#e5e5e5] flex flex-row items-center justify-between px-[32rpx] py-[24rpx] pb-[calc(24rpx+env(safe-area-inset-bottom))] z-100">
			<view class="flex flex-row items-center gap-[16rpx]" @tap="onSelectAllChange(!selectAll)">
				<cl-icon
					name="checkbox-circle-line"
					color="#0052d9"
					:size="40"
					v-if="selectAll"
				></cl-icon>
				<cl-icon name="checkbox-blank-circle-line" :size="40" color="#c0c4cc" v-else></cl-icon>
				<text class="text-[28rpx] text-[#646a73]">{{ t("å…¨é€‰") }}</text>
			</view>

			<view class="flex flex-row items-center gap-[24rpx]">
				<template v-if="isDel">
					<view class="bg-[#ff3b30] px-[48rpx] py-[16rpx] rounded-[40rpx]" @tap="delAll">
						<text class="text-white text-[30rpx] font-semibold">{{ t("åˆ é™¤") }}</text>
					</view>
				</template>

				<template v-else>
					<view class="flex flex-col items-end">
						<text class="text-[24rpx] text-[#646a73]">{{ t("åˆè®¡") }}</text>
						<text class="text-[34rpx] font-bold text-[#ff3b30]">Â¥{{ totalPrice }}</text>
					</view>

					<view class="bg-[#0052d9] px-[48rpx] py-[16rpx] rounded-[40rpx]" @tap="toSettle">
						<text class="text-white text-[30rpx] font-semibold">{{ t("å»ç»“ç®—") }}</text>
					</view>
				</template>
			</view>
		</view>
	</view>
</template>

<script lang="ts" setup>
import { parseClass, isEmpty, $t, t } from "@/.cool";
import { useUi } from "@/uni_modules/cool-ui";
import { computed, ref } from "vue";

const ui = useUi();

// å•†å“ç±»å‹
type Goods = {
	id: number;
	name: string;
	count: number;
	price: number;
	cover: string;
	skuName: string;
	checked: boolean;
};

// å•†å“åˆ—è¡¨
const list = ref<Goods[]>([
	{
		id: 1,
		name: "Apple iPad",
		count: 1,
		price: 450,
		cover: "https://img.yzcdn.cn/vant/ipad.png",
		skuName: "æ·±ç©ºç°è‰² 128GB WLANç‰ˆ",
		checked: true
	},
	{
		id: 2,
		name: "Samsung Galaxy S24",
		count: 2,
		price: 699,
		cover: "https://img.yzcdn.cn/vant/samsung.png",
		skuName: "æ›œçŸ³é»‘ 12GB+256GB å®˜æ–¹æ ‡é…",
		checked: false
	},
	{
		id: 3,
		name: "Sony WH-1000XM5",
		count: 1,
		price: 299,
		cover: "https://img.yzcdn.cn/vant/sony.png",
		skuName: "é»‘è‰² æ— çº¿è“ç‰™ å®˜æ–¹æ ‡é…",
		checked: false
	},
	{
		id: 4,
		name: "å°ç±³æ‰‹ç¯8",
		count: 3,
		price: 49,
		cover: "https://img.yzcdn.cn/vant/xiaomi.png",
		skuName: "æ›œçŸ³é»‘ æ ‡å‡†ç‰ˆ ç¡…èƒ¶è¡¨å¸¦",
		checked: false
	},
	{
		id: 5,
		name: "Kindle Paperwhite",
		count: 1,
		price: 120,
		cover: "https://img.yzcdn.cn/vant/kindle.png",
		skuName: "é»‘è‰² 8GB å®˜æ–¹æ ‡é…",
		checked: false
	}
]);

// æ˜¯å¦å…¨é€‰
const selectAll = ref(false);

function goBack() {
	uni.navigateBack();
}

/**
 * é€‰æ‹©/å–æ¶ˆé€‰æ‹©å•ä¸ªå•†å“
 * @param item éœ€è¦æ“ä½œçš„å•†å“
 */
function selectItem(item: Goods) {
	// åˆ‡æ¢é€‰ä¸­çŠ¶æ€
	item.checked = !item.checked;
	// åˆ¤æ–­æ˜¯å¦æ‰€æœ‰å•†å“éƒ½è¢«é€‰ä¸­ï¼Œæ›´æ–°å…¨é€‰çŠ¶æ€
	selectAll.value = list.value.every((item) => item.checked);
}

/**
 * å…¨é€‰/å–æ¶ˆå…¨é€‰
 * @param val æ˜¯å¦å…¨é€‰
 */
function onSelectAllChange(val: boolean) {
	selectAll.value = val;
	list.value.forEach((item, index, arr) => {
		arr[index].checked = val;
	});
}

// æ˜¯å¦å¤„äºåˆ é™¤æ¨¡å¼
const isDel = ref(false);

/**
 * åˆ é™¤å•ä¸ªå•†å“
 * @param index å•†å“ç´¢å¼•
 */
function delItem(index: number) {
	ui.showConfirm({
		title: t("æ¸©é¦¨æç¤º"),
		message: t("ç¡®å®šåˆ é™¤è¯¥å•†å“å—ï¼Ÿ"),
		callback(action) {
			if (action === "confirm") {
				// åˆ é™¤æŒ‡å®šç´¢å¼•çš„å•†å“
				list.value.splice(index, 1);

				ui.showToast({
					message: t("åˆ é™¤æˆåŠŸ")
				});
			}
		}
	});
}

/**
 * åˆ é™¤æ‰€æœ‰å·²é€‰ä¸­çš„å•†å“
 */
function delAll() {
	const checked = list.value.filter((item) => item.checked);

	// å¦‚æœæ²¡æœ‰é€‰ä¸­å•†å“ï¼Œæç¤ºç”¨æˆ·
	if (isEmpty(checked)) {
		return ui.showToast({
			message: t("è¯·å…ˆé€‰æ‹©å•†å“")
		});
	}

	ui.showConfirm({
		title: t("æ¸©é¦¨æç¤º"),
		message: t("ç¡®å®šåˆ é™¤é€‰ä¸­çš„å•†å“å—ï¼Ÿ"),
		callback(action) {
			if (action == "confirm") {
				// åªä¿ç•™æœªé€‰ä¸­çš„å•†å“
				list.value = list.value.filter((item) => !item.checked);

				// å¦‚æœä¹‹å‰æ˜¯å…¨é€‰ï¼Œåˆ é™¤åå–æ¶ˆå…¨é€‰çŠ¶æ€
				if (selectAll.value) {
					selectAll.value = false;
				}

				ui.showToast({
					message: t("åˆ é™¤æˆåŠŸ")
				});
			}
		}
	});
}

/**
 * æ¸…ç©ºè´­ç‰©è½¦
 */
function clear() {
	list.value = [];
	selectAll.value = false;
	isDel.value = false;
}

/**
 * è®¡ç®—å·²é€‰ä¸­å•†å“çš„æ€»ä»·
 */
const totalPrice = computed(() => {
	return list.value
		.filter((item) => item.checked)
		.reduce((acc, item) => acc + item.price * item.count, 0);
});

/**
 * ç»“ç®—æ“ä½œ
 */
function toSettle() {
	// å¦‚æœæ²¡æœ‰é€‰ä¸­å•†å“ï¼Œæç¤ºç”¨æˆ·
	if (totalPrice.value <= 0) {
		return ui.showToast({
			message: t("è¯·å…ˆé€‰æ‹©å•†å“")
		});
	}

	ui.showConfirm({
		title: t("æ¸©é¦¨æç¤º"),
		message: $t("æ‚¨éœ€æ”¯ä»˜ {price} å…ƒï¼Œè¯·ç¡®è®¤æ”¯ä»˜", { price: totalPrice.value }),
		beforeClose(action, { showLoading, close }) {
			if (action == "confirm") {
				showLoading();

				setTimeout(() => {
					ui.showToast({
						message: t("æ”¯ä»˜æˆåŠŸ")
					});

					close();
				}, 1000);
			} else {
				close();
			}
		}
	});
}
</script>

<style>
</style>
