<template>
	<view class="flex flex-col h-screen bg-[#f5f7fa]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<cl-topbar title="ä»»åŠ¡è¯¦æƒ…" :show-back="true" background-color="#ffffff" color="#1f2329" safe-area-top>
			<template #append>
				<view @click="shareTask" class="flex items-center px-[32rpx] h-full">
					<text class="text-[28rpx] text-[#0052d9]">åˆ†äº«</text>
				</view>
			</template>
		</cl-topbar>

		<!-- å†…å®¹åŒºåŸŸ -->
		<scroll-view class="flex-1 h-0" scroll-y>
			<view class="p-[32rpx] flex flex-col gap-[24rpx]">
				<!-- ä»»åŠ¡çŠ¶æ€å¡ç‰‡ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<view class="flex items-center justify-between mb-[24rpx]">
						<view class="px-[24rpx] py-[8rpx] rounded-[8rpx]" :class="getStatusBgColor(taskInfo.status)">
							<text class="text-[24rpx] font-bold" :class="getStatusTextColor(taskInfo.status)">
								{{ getStatusText(taskInfo.status) }}
							</text>
						</view>
						<text class="text-[24rpx] text-[#999999]">ä»»åŠ¡ç¼–å·ï¼š{{ taskInfo.taskNo }}</text>
					</view>

					<text class="text-[36rpx] font-bold text-[#1f2329] mb-[16rpx] block">{{ taskInfo.title }}</text>
					<text class="text-[28rpx] text-[#646a73] leading-relaxed block">{{ taskInfo.description }}</text>
				</view>

				<!-- å•†æˆ·ä¿¡æ¯ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">å‘å¸ƒå•†æˆ·</text>
					<view class="flex items-center">
						<view class="w-[96rpx] h-[96rpx] rounded-full bg-[#f5f5f5] flex items-center justify-center mr-[24rpx]">
							<text class="text-[48rpx]">{{ taskInfo.merchantAvatar }}</text>
						</view>
						<view class="flex-1">
							<text class="text-[32rpx] font-bold text-[#1f2329] block">{{ taskInfo.merchantName }}</text>
							<view class="flex flex-row items-center mt-[8rpx]">
								<view class="bg-[#07c160] px-[12rpx] py-[4rpx] rounded-[4rpx] mr-[16rpx]">
									<text class="text-[20rpx] text-white">{{ taskInfo.merchantLevel }}</text>
								</view>
								<text class="text-[24rpx] text-[#999999]">ä¿¡ç”¨åˆ†ï¼š{{ taskInfo.merchantCredit }}</text>
							</view>
						</view>
					</view>
				</view>

				<!-- ä»»åŠ¡è¿›åº¦ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">ä»»åŠ¡è¿›åº¦</text>
					
					<view class="mb-[24rpx]">
						<view class="flex items-center justify-between mb-[16rpx]">
							<text class="text-[26rpx] text-[#999999]">å®Œæˆè¿›åº¦</text>
							<text class="text-[28rpx] font-bold text-[#07c160]">{{ taskInfo.completedCount }}/{{ taskInfo.totalCount }}</text>
						</view>
						<view class="w-full h-[16rpx] bg-[#f5f5f5] rounded-full overflow-hidden">
							<view 
								class="h-full bg-[#07c160] rounded-full" 
								:style="{ width: taskInfo.progress + '%' }"
							></view>
						</view>
					</view>

					<view class="flex items-center justify-between">
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#1f2329]">{{ taskInfo.totalCount }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[4rpx]">æ€»æ•°é‡</text>
						</view>
						<view class="w-[2rpx] h-[64rpx] bg-[#e5e5e5]"></view>
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#07c160]">{{ taskInfo.completedCount }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[4rpx]">å·²å®Œæˆ</text>
						</view>
						<view class="w-[2rpx] h-[64rpx] bg-[#e5e5e5]"></view>
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#ff9500]">{{ taskInfo.remainCount }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[4rpx]">å‰©ä½™</text>
						</view>
					</view>
				</view>

				<!-- ä»»åŠ¡ä¿¡æ¯ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">ä»»åŠ¡ä¿¡æ¯</text>
					
					<view class="flex flex-col gap-[24rpx]">
						<view class="flex justify-between">
							<text class="text-[28rpx] text-[#999999]">ä»»åŠ¡ç±»ç›®</text>
							<text class="text-[28rpx] text-[#1f2329]">{{ taskInfo.category }}</text>
						</view>
						<view class="flex justify-between">
							<text class="text-[28rpx] text-[#999999]">å¹³å°åç§°</text>
							<text class="text-[28rpx] text-[#1f2329]">{{ taskInfo.platform }}</text>
						</view>
						<view class="flex justify-between">
							<text class="text-[28rpx] text-[#999999]">å•ä»·ä½£é‡‘</text>
							<text class="text-[32rpx] font-bold text-[#ff3b30]">Â¥{{ taskInfo.unitPrice }}</text>
						</view>
						<view class="flex justify-between">
							<text class="text-[28rpx] text-[#999999]">å®Œæˆæ—¶é™</text>
							<text class="text-[28rpx] text-[#1f2329]">{{ taskInfo.timeLimit }}å°æ—¶</text>
						</view>
						<view class="flex justify-between">
							<text class="text-[28rpx] text-[#999999]">å‘å¸ƒæ—¶é—´</text>
							<text class="text-[28rpx] text-[#1f2329]">{{ taskInfo.createTime }}</text>
						</view>
					</view>
				</view>

				<!-- ä»»åŠ¡è¦æ±‚ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">ä»»åŠ¡è¦æ±‚</text>
					
					<view class="mb-[24rpx]">
						<text class="text-[28rpx] text-[#999999] mb-[16rpx] block">å‡­è¯è¦æ±‚</text>
						<view class="flex flex-row flex-wrap gap-[16rpx]">
							<view 
								v-for="(item, index) in taskInfo.proofTypes" 
								:key="index"
								class="bg-[#f0f9ff] px-[16rpx] py-[8rpx] rounded-[8rpx]"
							>
								<text class="text-[24rpx] text-[#0052d9]">{{ item }}</text>
							</view>
						</view>
					</view>

					<view v-if="taskInfo.specialRequirement">
						<text class="text-[28rpx] text-[#999999] mb-[16rpx] block">ç‰¹æ®Šè¦æ±‚</text>
						<view class="bg-[#fff9e6] rounded-[16rpx] p-[24rpx]">
							<text class="text-[26rpx] text-[#646a73] leading-relaxed">{{ taskInfo.specialRequirement }}</text>
						</view>
					</view>
				</view>

				<!-- å­ä»»åŠ¡åˆ—è¡¨ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[140rpx]">
					<view class="flex items-center justify-between mb-[24rpx]">
						<text class="text-[32rpx] font-bold text-[#1f2329]">å­ä»»åŠ¡åˆ—è¡¨</text>
						<view @click="goToSubtaskList" class="flex items-center gap-[4rpx]">
							<text class="text-[26rpx] text-[#0052d9]">æŸ¥çœ‹å…¨éƒ¨</text>
							<uni-icons type="right" size="12" color="#0052d9"></uni-icons>
						</view>
					</view>

					<view class="flex flex-col">
						<view 
							v-for="(item, index) in subtaskList" 
							:key="index"
							@click="goToSubtaskDetail(item.id)"
							class="flex items-center justify-between py-[24rpx] border-b-[2rpx] border-[#f5f7fa]"
						>
							<view class="flex-1 flex flex-col gap-[8rpx]">
								<text class="text-[30rpx] text-[#1f2329]">å­ä»»åŠ¡ #{{ item.no }}</text>
								<text class="text-[24rpx] text-[#999999]">{{ item.receiverName || 'å¾…æ¥å•' }}</text>
							</view>
							<view class="px-[16rpx] py-[8rpx] rounded-[8rpx]" :class="getSubtaskStatusColor(item.status)">
								<text class="text-[22rpx] text-white">{{ getSubtaskStatusText(item.status) }}</text>
							</view>
						</view>
					</view>
				</view>
			</view>
		</scroll-view>

		<!-- åº•éƒ¨æ“ä½œæ  -->
		<view v-if="showActions" class="fixed bottom-0 left-0 right-0 bg-white px-[32rpx] py-[24rpx] border-t-[2rpx] border-[#e5e5e5] pb-[calc(24rpx+env(safe-area-inset-bottom))]">
			<view class="flex flex-row gap-[24rpx]">
				<button 
					v-if="taskInfo.canCancel"
					@click="cancelTask"
					class="flex-1 h-[88rpx] bg-white border-[2rpx] border-[#ff3b30] rounded-full flex items-center justify-center"
				>
					<text class="text-[30rpx] text-[#ff3b30]">å–æ¶ˆä»»åŠ¡</text>
				</button>
				<button 
					v-if="taskInfo.canReceive"
					@click="receiveTask"
					class="flex-1 h-[88rpx] bg-[#0052d9] rounded-full flex items-center justify-center"
				>
					<text class="text-[30rpx] text-white">ç«‹å³æ¥å•</text>
				</button>
			</view>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, computed, onMounted } from 'vue'
import { getTaskDetail, cancelTask } from '@/services/task'

// ä»»åŠ¡ID
const taskId = ref(0)

// ä»»åŠ¡ä¿¡æ¯
const taskInfo = ref({
	taskNo: 'T202501300001',
	status: 'ongoing',
	title: 'ç¾å›¢å¤–å–è®¢å•äº’åŠ©',
	description: 'éœ€è¦å¸®å¿™å®Œæˆç¾å›¢å¤–å–è®¢å•ï¼Œè¦æ±‚çœŸå®ä¸‹å•å¹¶ä¸Šä¼ æˆªå›¾',
	merchantAvatar: 'ğŸª',
	merchantName: 'ç¤ºä¾‹å•†æˆ·A',
	merchantLevel: 'VIP',
	merchantCredit: 98,
	totalCount: 100,
	completedCount: 55,
	remainCount: 45,
	progress: 55,
	category: 'å¤–å–',
	platform: 'ç¾å›¢',
	unitPrice: '15.00',
	timeLimit: 24,
	createTime: '2025-01-30 10:00:00',
	proofTypes: ['è®¢å•æˆªå›¾', 'èŠå¤©è®°å½•'],
	specialRequirement: 'è¯·åœ¨ä¸‹å•å30åˆ†é’Ÿå†…ä¸Šä¼ æˆªå›¾',
	canCancel: false,
	canReceive: true
})

// å­ä»»åŠ¡åˆ—è¡¨
const subtaskList = ref([
	{ id: 1, no: '001', receiverName: 'å¼ ä¸‰', status: 'completed' },
	{ id: 2, no: '002', receiverName: 'æå››', status: 'ongoing' },
	{ id: 3, no: '003', receiverName: '', status: 'pending' }
])

// æ˜¯å¦æ˜¾ç¤ºæ“ä½œæŒ‰é’®
const showActions = computed(() => {
	return taskInfo.value.canCancel || taskInfo.value.canReceive
})

// åŠ è½½ä»»åŠ¡è¯¦æƒ…
const loadTaskDetail = async () => {
	try {
		uni.showLoading({ title: 'åŠ è½½ä¸­...' })
		
		const res = await getTaskDetail(taskId.value)
		
		uni.hideLoading()
		
		if (res.code === 0) {
			taskInfo.value = res.data.task
			subtaskList.value = res.data.subtasks
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: 'åŠ è½½å¤±è´¥',
			icon: 'none'
		})
	}
}

// è·å–çŠ¶æ€æ–‡æœ¬
const getStatusText = (status: string): string => {
	const statusMap = {
		ongoing: 'è¿›è¡Œä¸­',
		completed: 'å·²å®Œæˆ',
		cancelled: 'å·²å–æ¶ˆ'
	}
	return statusMap[status] || 'æœªçŸ¥'
}

// è·å–çŠ¶æ€èƒŒæ™¯è‰²
const getStatusBgColor = (status: string): string => {
	const colorMap = {
		ongoing: 'bg-[#f0f9ff]',
		completed: 'bg-[#f5f5f5]',
		cancelled: 'bg-[#fff5f5]'
	}
	return colorMap[status] || 'bg-[#f5f5f5]'
}

// è·å–çŠ¶æ€æ–‡å­—é¢œè‰²
const getStatusTextColor = (status: string): string => {
	const colorMap = {
		ongoing: 'text-[#0052d9]',
		completed: 'text-[#999999]',
		cancelled: 'text-[#ff3b30]'
	}
	return colorMap[status] || 'text-[#999999]'
}

// è·å–å­ä»»åŠ¡çŠ¶æ€æ–‡æœ¬
const getSubtaskStatusText = (status: string): string => {
	const statusMap = {
		pending: 'å¾…æ¥å•',
		ongoing: 'è¿›è¡Œä¸­',
		completed: 'å·²å®Œæˆ',
		cancelled: 'å·²å–æ¶ˆ'
	}
	return statusMap[status] || 'æœªçŸ¥'
}

// è·å–å­ä»»åŠ¡çŠ¶æ€é¢œè‰²
const getSubtaskStatusColor = (status: string): string => {
	const colorMap = {
		pending: 'bg-[#999999]',
		ongoing: 'bg-[#ff9500]',
		completed: 'bg-[#00b578]',
		cancelled: 'bg-[#ff3b30]'
	}
	return colorMap[status] || 'bg-[#999999]'
}

// æ¥å•
const receiveTask = () => {
	uni.navigateTo({
		url: `/pages/task/subtask/list?taskId=${taskId.value}`
	})
}

// å–æ¶ˆä»»åŠ¡
const cancelTask = () => {
	uni.showModal({
		title: 'æç¤º',
		content: 'ç¡®å®šè¦å–æ¶ˆè¯¥ä»»åŠ¡å—ï¼Ÿ',
		success: async (res) => {
			if (res.confirm) {
				try {
					uni.showLoading({ title: 'å¤„ç†ä¸­...' })
					
					const result = await cancelTask(taskId.value, 'ç”¨æˆ·å–æ¶ˆ')
					
					uni.hideLoading()
					
					if (result.code === 0) {
						uni.showToast({
							title: 'å–æ¶ˆæˆåŠŸ',
							icon: 'success'
						})
						loadTaskDetail()
					} else {
						uni.showToast({
							title: result.msg || 'å–æ¶ˆå¤±è´¥',
							icon: 'none'
						})
					}
				} catch (error) {
					uni.hideLoading()
					uni.showToast({
						title: 'å–æ¶ˆå¤±è´¥',
						icon: 'none'
					})
				}
			}
		}
	})
}

// åˆ†äº«ä»»åŠ¡
const shareTask = () => {
	uni.showToast({
		title: 'åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­',
		icon: 'none'
	})
}

// æŸ¥çœ‹å­ä»»åŠ¡åˆ—è¡¨
const goToSubtaskList = () => {
	uni.navigateTo({
		url: `/pages/task/subtask/list?taskId=${taskId.value}`
	})
}

// æŸ¥çœ‹å­ä»»åŠ¡è¯¦æƒ…
const goToSubtaskDetail = (id: number) => {
	uni.navigateTo({
		url: `/pages/task/subtask/detail?id=${id}`
	})
}

// é¡µé¢åŠ è½½æ—¶è·å–ä»»åŠ¡è¯¦æƒ…
onMounted(() => {
	// è·å–ä»»åŠ¡ID
	const pages = getCurrentPages()
	const currentPage = pages[pages.length - 1]
	// @ts-ignore
	taskId.value = parseInt(currentPage.options?.id || '0')
	
	if (taskId.value > 0) {
		loadTaskDetail()
	}
})
</script>

<style>
</style>
