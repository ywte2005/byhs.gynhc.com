<template>
	<view class="flex flex-col h-screen bg-[#f5f7fa]">
		<!-- 顶部导航 -->
		<cl-topbar title="任务详情" :show-back="true" background-color="#ffffff" color="#1f2329" safe-area-top>
			<template #append>
				<view @click="shareTask" class="flex items-center px-[32rpx] h-full">
					<text class="text-[28rpx] text-[#0052d9]">分享</text>
				</view>
			</template>
		</cl-topbar>

		<!-- 内容区域 -->
		<scroll-view class="flex-1 h-0" scroll-y>
			<view class="p-[32rpx] flex flex-col gap-[24rpx]">
				<!-- 任务状态卡片 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<view class="flex items-center justify-between mb-[24rpx]">
						<view class="px-[24rpx] py-[8rpx] rounded-[8rpx]" :class="getStatusBgColor(taskInfo.status)">
							<text class="text-[24rpx] font-bold" :class="getStatusTextColor(taskInfo.status)">
								{{ getStatusText(taskInfo.status) }}
							</text>
						</view>
						<text class="text-[24rpx] text-[#999999]">任务编号：{{ taskInfo.taskNo }}</text>
					</view>

					<text class="text-[36rpx] font-bold text-[#1f2329] mb-[16rpx] block">{{ taskInfo.title }}</text>
					<text class="text-[28rpx] text-[#646a73] leading-relaxed block">{{ taskInfo.description }}</text>
				</view>

				<!-- 商户信息 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">发布商户</text>
					<view class="flex items-center">
						<view class="w-[96rpx] h-[96rpx] rounded-full bg-[#f5f5f5] flex items-center justify-center mr-[24rpx]">
							<uni-icons type="shop" size="32" color="#0052d9"></uni-icons>
						</view>
						<view class="flex-1">
							<text class="text-[32rpx] font-bold text-[#1f2329] block">{{ taskInfo.merchantName }}</text>
							<view class="flex flex-row items-center mt-[8rpx]">
								<view class="bg-[#07c160] px-[12rpx] py-[4rpx] rounded-[4rpx] mr-[16rpx]">
									<text class="text-[20rpx] text-white">{{ taskInfo.merchantLevel }}</text>
								</view>
								<text class="text-[24rpx] text-[#999999]">信用分：{{ taskInfo.merchantCredit }}</text>
							</view>
						</view>
					</view>
				</view>

				<!-- 任务进度 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">任务进度</text>
					
					<view class="mb-[24rpx]">
						<view class="flex items-center justify-between mb-[16rpx]">
							<text class="text-[26rpx] text-[#999999]">完成进度</text>
							<text class="text-[28rpx] font-bold text-[#07c160]">{{ taskInfo.completedCount }}/{{ taskInfo.totalCount }}</text>
						</view>
						<view class="w-full h-[16rpx] bg-[#f5f5f5] rounded-full overflow-hidden">
							<view 
								class="h-full bg-[#07c160] rounded-full" 
								:style="{ width: taskInfo.progress + '%' }"
							></view>
						</view>
					</view>

					<view class="flex items-center justify-between">
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#1f2329]">{{ taskInfo.totalCount }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[4rpx]">总数量</text>
						</view>
						<view class="w-[2rpx] h-[64rpx] bg-[#e5e5e5]"></view>
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#07c160]">{{ taskInfo.completedCount }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[4rpx]">已完成</text>
						</view>
						<view class="w-[2rpx] h-[64rpx] bg-[#e5e5e5]"></view>
						<view class="flex-1 flex flex-col items-center">
							<text class="text-[40rpx] font-bold text-[#ff9500]">{{ taskInfo.remainCount }}</text>
							<text class="text-[24rpx] text-[#999999] mt-[4rpx]">剩余</text>
						</view>
					</view>
				</view>

				<!-- 任务信息 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">任务信息</text>
					
					<view class="flex flex-col gap-[24rpx]">
						<view class="flex justify-between">
							<text class="text-[28rpx] text-[#999999]">任务类目</text>
							<text class="text-[28rpx] text-[#1f2329]">{{ taskInfo.category }}</text>
						</view>
						<view class="flex justify-between">
							<text class="text-[28rpx] text-[#999999]">平台名称</text>
							<text class="text-[28rpx] text-[#1f2329]">{{ taskInfo.platform }}</text>
						</view>
						<view class="flex justify-between">
							<text class="text-[28rpx] text-[#999999]">单价佣金</text>
							<text class="text-[32rpx] font-bold text-[#ff3b30]">¥{{ taskInfo.unitPrice }}</text>
						</view>
						<view class="flex justify-between">
							<text class="text-[28rpx] text-[#999999]">完成时限</text>
							<text class="text-[28rpx] text-[#1f2329]">{{ taskInfo.timeLimit }}小时</text>
						</view>
						<view class="flex justify-between">
							<text class="text-[28rpx] text-[#999999]">发布时间</text>
							<text class="text-[28rpx] text-[#1f2329]">{{ taskInfo.createTime }}</text>
						</view>
					</view>
				</view>

				<!-- 任务要求 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">任务要求</text>
					
					<view class="mb-[24rpx]">
						<text class="text-[28rpx] text-[#999999] mb-[16rpx] block">凭证要求</text>
						<view class="flex flex-row flex-wrap gap-[16rpx]">
							<view 
								v-for="(item, index) in taskInfo.proofTypes" 
								:key="index"
								class="bg-[#f0f9ff] px-[16rpx] py-[8rpx] rounded-[8rpx]"
							>
								<text class="text-[24rpx] text-[#0052d9]">{{ item }}</text>
							</view>
						</view>
					</view>

					<view v-if="taskInfo.specialRequirement">
						<text class="text-[28rpx] text-[#999999] mb-[16rpx] block">特殊要求</text>
						<view class="bg-[#fff9e6] rounded-[16rpx] p-[24rpx]">
							<text class="text-[26rpx] text-[#646a73] leading-relaxed">{{ taskInfo.specialRequirement }}</text>
						</view>
					</view>
				</view>

				<!-- 子任务列表 -->
				<view class="bg-white rounded-[24rpx] p-[32rpx] mb-[140rpx]">
					<view class="flex items-center justify-between mb-[24rpx]">
						<text class="text-[32rpx] font-bold text-[#1f2329]">子任务列表</text>
						<view @click="goToSubtaskList" class="flex items-center gap-[4rpx]">
							<text class="text-[26rpx] text-[#0052d9]">查看全部</text>
							<uni-icons type="right" size="12" color="#0052d9"></uni-icons>
						</view>
					</view>

					<view class="flex flex-col">
						<view 
							v-for="(item, index) in subtaskList" 
							:key="index"
							@click="goToSubtaskDetail(item.id)"
							class="flex items-center justify-between py-[24rpx] border-b-[2rpx] border-[#f5f7fa]"
						>
							<view class="flex-1 flex flex-col gap-[8rpx]">
								<text class="text-[30rpx] text-[#1f2329]">子任务 #{{ item.no }}</text>
								<text class="text-[24rpx] text-[#999999]">{{ item.receiverName || '待接单' }}</text>
							</view>
							<view class="px-[16rpx] py-[8rpx] rounded-[8rpx]" :class="getSubtaskStatusColor(item.status)">
								<text class="text-[22rpx] text-white">{{ getSubtaskStatusText(item.status) }}</text>
							</view>
						</view>
					</view>
				</view>
			</view>
		</scroll-view>

		<!-- 底部操作栏 -->
		<view v-if="showActions" class="fixed bottom-0 left-0 right-0 bg-white px-[32rpx] py-[24rpx] border-t-[2rpx] border-[#e5e5e5] pb-[calc(24rpx+env(safe-area-inset-bottom))]">
			<view class="flex flex-row gap-[24rpx]">
				<button 
					v-if="taskInfo.canCancel"
					@click="cancelTask"
					class="flex-1 h-[88rpx] bg-white border-[2rpx] border-[#ff3b30] rounded-full flex items-center justify-center"
				>
					<text class="text-[30rpx] text-[#ff3b30]">取消任务</text>
				</button>
				<button 
					v-if="taskInfo.canReceive"
					@click="receiveTask"
					class="flex-1 h-[88rpx] bg-[#0052d9] rounded-full flex items-center justify-center"
				>
					<text class="text-[30rpx] text-white">立即接单</text>
				</button>
			</view>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, computed, onMounted } from 'vue'
import { getTaskDetail, cancelTask } from '@/services/task'

// 任务ID
const taskId = ref(0)

// 任务信息
const taskInfo = ref({
	taskNo: 'T202501300001',
	status: 'ongoing',
	title: '美团外卖订单互助',
	description: '需要帮忙完成美团外卖订单，要求真实下单并上传截图',
	merchantAvatar: '',
	merchantName: '示例商户A',
	merchantLevel: 'VIP',
	merchantCredit: 98,
	totalCount: 100,
	completedCount: 55,
	remainCount: 45,
	progress: 55,
	category: '外卖',
	platform: '美团',
	unitPrice: '15.00',
	timeLimit: 24,
	createTime: '2025-01-30 10:00:00',
	proofTypes: ['订单截图', '聊天记录'],
	specialRequirement: '请在下单后30分钟内上传截图',
	canCancel: false,
	canReceive: true
})

// 子任务列表
const subtaskList = ref([
	{ id: 1, no: '001', receiverName: '张三', status: 'completed' },
	{ id: 2, no: '002', receiverName: '李四', status: 'ongoing' },
	{ id: 3, no: '003', receiverName: '', status: 'pending' }
])

// 是否显示操作按钮
const showActions = computed(() => {
	return taskInfo.value.canCancel || taskInfo.value.canReceive
})

// 加载任务详情
const loadTaskDetail = async () => {
	try {
		uni.showLoading({ title: '加载中...' })
		
		const res = await getTaskDetail(taskId.value)
		
		uni.hideLoading()
		
		if (res.code === 0) {
			taskInfo.value = res.data.task
			subtaskList.value = res.data.subtasks
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: '加载失败',
			icon: 'none'
		})
	}
}

// 获取状态文本
const getStatusText = (status: string): string => {
	const statusMap = {
		ongoing: '进行中',
		completed: '已完成',
		cancelled: '已取消'
	}
	return statusMap[status] || '未知'
}

// 获取状态背景色
const getStatusBgColor = (status: string): string => {
	const colorMap = {
		ongoing: 'bg-[#f0f9ff]',
		completed: 'bg-[#f5f5f5]',
		cancelled: 'bg-[#fff5f5]'
	}
	return colorMap[status] || 'bg-[#f5f5f5]'
}

// 获取状态文字颜色
const getStatusTextColor = (status: string): string => {
	const colorMap = {
		ongoing: 'text-[#0052d9]',
		completed: 'text-[#999999]',
		cancelled: 'text-[#ff3b30]'
	}
	return colorMap[status] || 'text-[#999999]'
}

// 获取子任务状态文本
const getSubtaskStatusText = (status: string): string => {
	const statusMap = {
		pending: '待接单',
		ongoing: '进行中',
		completed: '已完成',
		cancelled: '已取消'
	}
	return statusMap[status] || '未知'
}

// 获取子任务状态颜色
const getSubtaskStatusColor = (status: string): string => {
	const colorMap = {
		pending: 'bg-[#999999]',
		ongoing: 'bg-[#ff9500]',
		completed: 'bg-[#00b578]',
		cancelled: 'bg-[#ff3b30]'
	}
	return colorMap[status] || 'bg-[#999999]'
}

// 接单
const receiveTask = () => {
	uni.navigateTo({
		url: `/pages/task/subtask/list?taskId=${taskId.value}`
	})
}

// 取消任务
const cancelTask = () => {
	uni.showModal({
		title: '提示',
		content: '确定要取消该任务吗？',
		success: async (res) => {
			if (res.confirm) {
				try {
					uni.showLoading({ title: '处理中...' })
					
					const result = await cancelTask(taskId.value, '用户取消')
					
					uni.hideLoading()
					
					if (result.code === 0) {
						uni.showToast({
							title: '取消成功',
							icon: 'success'
						})
						loadTaskDetail()
					} else {
						uni.showToast({
							title: result.msg || '取消失败',
							icon: 'none'
						})
					}
				} catch (error) {
					uni.hideLoading()
					uni.showToast({
						title: '取消失败',
						icon: 'none'
					})
				}
			}
		}
	})
}

// 分享任务
const shareTask = () => {
	uni.showToast({
		title: '分享功能开发中',
		icon: 'none'
	})
}

// 查看子任务列表
const goToSubtaskList = () => {
	uni.navigateTo({
		url: `/pages/task/subtask/list?taskId=${taskId.value}`
	})
}

// 查看子任务详情
const goToSubtaskDetail = (id: number) => {
	uni.navigateTo({
		url: `/pages/task/subtask/detail?id=${id}`
	})
}

// 页面加载时获取任务详情
onMounted(() => {
	// 获取任务ID
	const pages = getCurrentPages()
	const currentPage = pages[pages.length - 1]
	// @ts-ignore
	taskId.value = parseInt(currentPage.options?.id || '0')
	
	if (taskId.value > 0) {
		loadTaskDetail()
	}
})
</script>

<style>
</style>
