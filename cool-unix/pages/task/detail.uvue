<template>
	<view class="flex flex-col h-full bg-[#f5f5f5]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="flex items-center justify-between px-4 py-3 bg-white">
			<view class="flex items-center" @click="goBack">
				<uni-icons type="left" size="24" color="#1f2329"></uni-icons>
				<text class="text-4 ml-2">ä»»åŠ¡è¯¦æƒ…</text>
			</view>
			<view @click="shareTask">
				<text class="text-4 text-[#07c160]">åˆ†äº«</text>
			</view>
		</view>

		<!-- å†…å®¹åŒºåŸŸ -->
		<scroll-view class="flex-1" scroll-y>
			<view class="px-4 py-4">
				<!-- ä»»åŠ¡çŠ¶æ€å¡ç‰‡ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<view class="flex items-center justify-between mb-3">
						<view :class="['px-3 py-1.5 rounded-full', getStatusBgColor(taskInfo.status)]">
							<text :class="['text-4 font-bold', getStatusTextColor(taskInfo.status)]">
								{{ getStatusText(taskInfo.status) }}
							</text>
						</view>
						<text class="text-3.5 text-[#999]">ä»»åŠ¡ç¼–å·ï¼š{{ taskInfo.taskNo }}</text>
					</view>

					<text class="text-5 font-bold text-[#1f2329] mb-2">{{ taskInfo.title }}</text>
					<text class="text-3.5 text-[#646a73]">{{ taskInfo.description }}</text>
				</view>

				<!-- å•†æˆ·ä¿¡æ¯ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">å‘å¸ƒå•†æˆ·</text>
					<view class="flex items-center">
						<view class="w-12 h-12 rounded-full bg-[#f5f5f5] flex items-center justify-center mr-3">
							<text class="text-6">{{ taskInfo.merchantAvatar }}</text>
						</view>
						<view class="flex-1">
							<text class="text-4 font-bold text-[#1f2329]">{{ taskInfo.merchantName }}</text>
							<view class="flex items-center mt-1">
								<view class="bg-[#07c160] px-2 py-0.5 rounded mr-2">
									<text class="text-3 text-white">{{ taskInfo.merchantLevel }}</text>
								</view>
								<text class="text-3 text-[#999]">ä¿¡ç”¨åˆ†ï¼š{{ taskInfo.merchantCredit }}</text>
							</view>
						</view>
					</view>
				</view>

				<!-- ä»»åŠ¡è¿›åº¦ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">ä»»åŠ¡è¿›åº¦</text>
					
					<view class="mb-3">
						<view class="flex items-center justify-between mb-2">
							<text class="text-3.5 text-[#999]">å®Œæˆè¿›åº¦</text>
							<text class="text-4 font-bold text-[#07c160]">{{ taskInfo.completedCount }}/{{ taskInfo.totalCount }}</text>
						</view>
						<view class="w-full h-2 bg-[#f5f5f5] rounded-full overflow-hidden">
							<view 
								class="h-full bg-[#07c160]" 
								:style="{ width: taskInfo.progress + '%' }"
							></view>
						</view>
					</view>

					<view class="flex items-center justify-between">
						<view class="flex-1 text-center">
							<text class="text-5 font-bold text-[#1f2329]">{{ taskInfo.totalCount }}</text>
							<text class="text-3 text-[#999] mt-1">æ€»æ•°é‡</text>
						</view>
						<view class="w-0.5 h-10 bg-[#e5e5e5]"></view>
						<view class="flex-1 text-center">
							<text class="text-5 font-bold text-[#07c160]">{{ taskInfo.completedCount }}</text>
							<text class="text-3 text-[#999] mt-1">å·²å®Œæˆ</text>
						</view>
						<view class="w-0.5 h-10 bg-[#e5e5e5]"></view>
						<view class="flex-1 text-center">
							<text class="text-5 font-bold text-[#ff9500]">{{ taskInfo.remainCount }}</text>
							<text class="text-3 text-[#999] mt-1">å‰©ä½™</text>
						</view>
					</view>
				</view>

				<!-- ä»»åŠ¡ä¿¡æ¯ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">ä»»åŠ¡ä¿¡æ¯</text>
					
					<view class="mb-3">
						<text class="text-3.5 text-[#999]">ä»»åŠ¡ç±»ç›®</text>
						<text class="text-4 text-[#1f2329] ml-2">{{ taskInfo.category }}</text>
					</view>
					<view class="mb-3">
						<text class="text-3.5 text-[#999]">å¹³å°åç§°</text>
						<text class="text-4 text-[#1f2329] ml-2">{{ taskInfo.platform }}</text>
					</view>
					<view class="mb-3">
						<text class="text-3.5 text-[#999]">å•ä»·ä½£é‡‘</text>
						<text class="text-5 font-bold text-[#ff3b30] ml-2">Â¥{{ taskInfo.unitPrice }}</text>
					</view>
					<view class="mb-3">
						<text class="text-3.5 text-[#999]">å®Œæˆæ—¶é™</text>
						<text class="text-4 text-[#1f2329] ml-2">{{ taskInfo.timeLimit }}å°æ—¶</text>
					</view>
					<view class="mb-3">
						<text class="text-3.5 text-[#999]">å‘å¸ƒæ—¶é—´</text>
						<text class="text-4 text-[#1f2329] ml-2">{{ taskInfo.createTime }}</text>
					</view>
				</view>

				<!-- ä»»åŠ¡è¦æ±‚ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">ä»»åŠ¡è¦æ±‚</text>
					
					<view class="mb-3">
						<text class="text-3.5 text-[#999] mb-2">å‡­è¯è¦æ±‚</text>
						<view class="flex flex-wrap mt-2">
							<view 
								v-for="(item, index) in taskInfo.proofTypes" 
								:key="index"
								class="bg-[#f0f9ff] px-2 py-1 rounded mr-2 mb-2"
							>
								<text class="text-3 text-[#07c160]">{{ item }}</text>
							</view>
						</view>
					</view>

					<view v-if="taskInfo.specialRequirement" class="mb-3">
						<text class="text-3.5 text-[#999] mb-2">ç‰¹æ®Šè¦æ±‚</text>
						<view class="bg-[#fff9e6] rounded-2 p-3 mt-2">
							<text class="text-3.5 text-[#646a73]">{{ taskInfo.specialRequirement }}</text>
						</view>
					</view>
				</view>

				<!-- å­ä»»åŠ¡åˆ—è¡¨ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<view class="flex items-center justify-between mb-3">
						<text class="text-4 font-bold text-[#1f2329]">å­ä»»åŠ¡åˆ—è¡¨</text>
						<view @click="goToSubtaskList" class="flex items-center">
							<text class="text-3.5 text-[#07c160]">æŸ¥çœ‹å…¨éƒ¨</text>
							<uni-icons type="right" size="12" color="#07c160"></uni-icons>
						</view>
					</view>

					<view 
						v-for="(item, index) in subtaskList" 
						:key="index"
						@click="goToSubtaskDetail(item.id)"
						class="flex items-center justify-between py-3 border-b border-[#e5e5e5]"
					>
						<view class="flex-1">
							<text class="text-4 text-[#1f2329]">å­ä»»åŠ¡ #{{ item.no }}</text>
							<text class="text-3 text-[#999] mt-1">{{ item.receiverName || 'å¾…æ¥å•' }}</text>
						</view>
						<view :class="['px-2 py-1 rounded', getSubtaskStatusColor(item.status)]">
							<text class="text-3 text-white">{{ getSubtaskStatusText(item.status) }}</text>
						</view>
					</view>
				</view>
			</view>
		</scroll-view>

		<!-- åº•éƒ¨æ“ä½œæ  -->
		<view v-if="showActions" class="bg-white px-4 py-3 border-t border-[#e5e5e5]">
			<view class="flex">
				<button 
					v-if="taskInfo.canCancel"
					@click="cancelTask"
					class="flex-1 bg-white border border-[#ff3b30] text-[#ff3b30] rounded-full py-3 mr-2"
				>
					<text class="text-4">å–æ¶ˆä»»åŠ¡</text>
				</button>
				<button 
					v-if="taskInfo.canReceive"
					@click="receiveTask"
					class="flex-1 bg-[#07c160] text-white rounded-full py-3"
				>
					<text class="text-4">ç«‹å³æ¥å•</text>
				</button>
			</view>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, computed, onMounted } from 'vue'
import { getTaskDetail, cancelTask } from '@/services/task'

// ä»»åŠ¡ID
const taskId = ref(0)

// ä»»åŠ¡ä¿¡æ¯
const taskInfo = ref({
	taskNo: 'T202501300001',
	status: 'ongoing',
	title: 'ç¾å›¢å¤–å–è®¢å•äº’åŠ©',
	description: 'éœ€è¦å¸®å¿™å®Œæˆç¾å›¢å¤–å–è®¢å•ï¼Œè¦æ±‚çœŸå®ä¸‹å•å¹¶ä¸Šä¼ æˆªå›¾',
	merchantAvatar: 'ğŸª',
	merchantName: 'ç¤ºä¾‹å•†æˆ·A',
	merchantLevel: 'VIP',
	merchantCredit: 98,
	totalCount: 100,
	completedCount: 55,
	remainCount: 45,
	progress: 55,
	category: 'å¤–å–',
	platform: 'ç¾å›¢',
	unitPrice: '15.00',
	timeLimit: 24,
	createTime: '2025-01-30 10:00:00',
	proofTypes: ['è®¢å•æˆªå›¾', 'èŠå¤©è®°å½•'],
	specialRequirement: 'è¯·åœ¨ä¸‹å•å30åˆ†é’Ÿå†…ä¸Šä¼ æˆªå›¾',
	canCancel: false,
	canReceive: true
})

// å­ä»»åŠ¡åˆ—è¡¨
const subtaskList = ref([
	{ id: 1, no: '001', receiverName: 'å¼ ä¸‰', status: 'completed' },
	{ id: 2, no: '002', receiverName: 'æå››', status: 'ongoing' },
	{ id: 3, no: '003', receiverName: '', status: 'pending' }
])

// æ˜¯å¦æ˜¾ç¤ºæ“ä½œæŒ‰é’®
const showActions = computed(() => {
	return taskInfo.value.canCancel || taskInfo.value.canReceive
})

// åŠ è½½ä»»åŠ¡è¯¦æƒ…
const loadTaskDetail = async () => {
	try {
		uni.showLoading({ title: 'åŠ è½½ä¸­...' })
		
		const res = await getTaskDetail(taskId.value)
		
		uni.hideLoading()
		
		if (res.code === 0) {
			taskInfo.value = res.data.task
			subtaskList.value = res.data.subtasks
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: 'åŠ è½½å¤±è´¥',
			icon: 'none'
		})
	}
}

// è·å–çŠ¶æ€æ–‡æœ¬
const getStatusText = (status: string): string => {
	const statusMap = {
		ongoing: 'è¿›è¡Œä¸­',
		completed: 'å·²å®Œæˆ',
		cancelled: 'å·²å–æ¶ˆ'
	}
	return statusMap[status] || 'æœªçŸ¥'
}

// è·å–çŠ¶æ€èƒŒæ™¯è‰²
const getStatusBgColor = (status: string): string => {
	const colorMap = {
		ongoing: 'bg-[#f0f9ff]',
		completed: 'bg-[#f5f5f5]',
		cancelled: 'bg-[#fff5f5]'
	}
	return colorMap[status] || 'bg-[#f5f5f5]'
}

// è·å–çŠ¶æ€æ–‡å­—é¢œè‰²
const getStatusTextColor = (status: string): string => {
	const colorMap = {
		ongoing: 'text-[#07c160]',
		completed: 'text-[#999]',
		cancelled: 'text-[#ff3b30]'
	}
	return colorMap[status] || 'text-[#999]'
}

// è·å–å­ä»»åŠ¡çŠ¶æ€æ–‡æœ¬
const getSubtaskStatusText = (status: string): string => {
	const statusMap = {
		pending: 'å¾…æ¥å•',
		ongoing: 'è¿›è¡Œä¸­',
		completed: 'å·²å®Œæˆ',
		cancelled: 'å·²å–æ¶ˆ'
	}
	return statusMap[status] || 'æœªçŸ¥'
}

// è·å–å­ä»»åŠ¡çŠ¶æ€é¢œè‰²
const getSubtaskStatusColor = (status: string): string => {
	const colorMap = {
		pending: 'bg-[#999]',
		ongoing: 'bg-[#ff9500]',
		completed: 'bg-[#07c160]',
		cancelled: 'bg-[#ff3b30]'
	}
	return colorMap[status] || 'bg-[#999]'
}

// æ¥å•
const receiveTask = () => {
	uni.navigateTo({
		url: `/pages/task/subtask/list?taskId=${taskId.value}`
	})
}

// å–æ¶ˆä»»åŠ¡
const cancelTask = () => {
	uni.showModal({
		title: 'æç¤º',
		content: 'ç¡®å®šè¦å–æ¶ˆè¯¥ä»»åŠ¡å—ï¼Ÿ',
		success: async (res) => {
			if (res.confirm) {
				try {
					uni.showLoading({ title: 'å¤„ç†ä¸­...' })
					
					const result = await cancelTask(taskId.value, reason)
					
					uni.hideLoading()
					
					if (result.code === 0) {
						uni.showToast({
							title: 'å–æ¶ˆæˆåŠŸ',
							icon: 'success'
						})
						loadTaskDetail()
					} else {
						uni.showToast({
							title: result.msg || 'å–æ¶ˆå¤±è´¥',
							icon: 'none'
						})
					}
				} catch (error) {
					uni.hideLoading()
					uni.showToast({
						title: 'å–æ¶ˆå¤±è´¥',
						icon: 'none'
					})
				}
			}
		}
	})
}

// åˆ†äº«ä»»åŠ¡
const shareTask = () => {
	uni.showToast({
		title: 'åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­',
		icon: 'none'
	})
}

// æŸ¥çœ‹å­ä»»åŠ¡åˆ—è¡¨
const goToSubtaskList = () => {
	uni.navigateTo({
		url: `/pages/task/subtask/list?taskId=${taskId.value}`
	})
}

// æŸ¥çœ‹å­ä»»åŠ¡è¯¦æƒ…
const goToSubtaskDetail = (id: number) => {
	uni.navigateTo({
		url: `/pages/task/subtask/detail?id=${id}`
	})
}

// è¿”å›
const goBack = () => {
	uni.navigateBack()
}

// é¡µé¢åŠ è½½æ—¶è·å–ä»»åŠ¡è¯¦æƒ…
onMounted(() => {
	// è·å–ä»»åŠ¡ID
	const pages = getCurrentPages()
	const currentPage = pages[pages.length - 1]
	// @ts-ignore
	taskId.value = parseInt(currentPage.options?.id || '0')
	
	if (taskId.value > 0) {
		loadTaskDetail()
	}
})
</script>
