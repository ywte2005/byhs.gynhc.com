<template>
	<view class="flex flex-col h-full bg-[#f5f5f5]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="flex items-center justify-between px-4 py-3 bg-white">
			<view class="flex items-center" @click="goBack">
				<text class="text-6">â†</text>
				<text class="text-4 ml-2">æˆ‘çš„ä»»åŠ¡</text>
			</view>
		</view>

		<!-- æ ‡ç­¾æ  -->
		<view class="bg-white px-4 py-3 mb-2">
			<view class="flex">
				<view 
					v-for="(tab, index) in tabs" 
					:key="index"
					@click="selectTab(tab.value)"
					class="flex-1 text-center"
				>
					<text :class="['text-4', currentTab === tab.value ? 'text-[#07c160] font-bold' : 'text-[#646a73]']">
						{{ tab.label }}
					</text>
					<view v-if="currentTab === tab.value" class="w-8 h-1 bg-[#07c160] rounded-full mx-auto mt-2"></view>
				</view>
			</view>
		</view>

		<!-- ä»»åŠ¡åˆ—è¡¨ -->
		<scroll-view class="flex-1" scroll-y @scrolltolower="loadMore">
			<view class="px-4 py-2">
				<view 
					v-for="(task, index) in taskList" 
					:key="index"
					@click="goToDetail(task.id)"
					class="bg-white rounded-2 p-4 mb-3"
				>
					<!-- ä»»åŠ¡å¤´éƒ¨ -->
					<view class="flex items-center justify-between mb-3">
						<text class="text-3.5 text-[#999]">{{ task.createTime }}</text>
						<view :class="['px-2 py-1 rounded', getStatusColor(task.status)]">
							<text class="text-3 text-white">{{ getStatusText(task.status) }}</text>
						</view>
					</view>

					<!-- ä»»åŠ¡ä¿¡æ¯ -->
					<view class="mb-3">
						<text class="text-4.5 font-bold text-[#1f2329]">{{ task.title }}</text>
						<text class="text-3.5 text-[#646a73] mt-2">{{ task.description }}</text>
					</view>

					<!-- ä»»åŠ¡æ ‡ç­¾ -->
					<view class="flex flex-wrap mb-3">
						<view class="bg-[#f0f9ff] px-2 py-1 rounded mr-2 mb-2">
							<text class="text-3 text-[#07c160]">{{ task.category }}</text>
						</view>
						<view class="bg-[#fff9e6] px-2 py-1 rounded mr-2 mb-2">
							<text class="text-3 text-[#ed6a0c]">{{ task.platform }}</text>
						</view>
						<view class="bg-[#f5f5f5] px-2 py-1 rounded mr-2 mb-2">
							<text class="text-3 text-[#646a73]">ç¼–å·ï¼š{{ task.taskNo }}</text>
						</view>
					</view>

					<!-- ä»»åŠ¡æ•°æ® -->
					<view class="flex items-center justify-between border-t border-[#e5e5e5] pt-3">
						<view class="flex-1">
							<text class="text-3 text-[#999]">å•ä»·</text>
							<text class="text-5 font-bold text-[#ff3b30] ml-1">Â¥{{ task.unitPrice }}</text>
						</view>
						<view class="flex-1">
							<text class="text-3 text-[#999]">æ€»æ•°</text>
							<text class="text-4 font-bold text-[#1f2329] ml-1">{{ task.totalCount }}</text>
						</view>
						<view class="flex-1">
							<text class="text-3 text-[#999]">å·²å®Œæˆ</text>
							<text class="text-4 font-bold text-[#07c160] ml-1">{{ task.completedCount }}</text>
						</view>
						<view class="flex-1 text-right">
							<text class="text-3 text-[#999]">è¿›åº¦</text>
							<text class="text-4 font-bold text-[#5856d6] ml-1">{{ task.progress }}%</text>
						</view>
					</view>

					<!-- æ“ä½œæŒ‰é’® -->
					<view v-if="task.showActions" class="flex mt-3">
						<button 
							v-if="task.canCancel"
							@click.stop="cancelTask(task.id)"
							class="flex-1 bg-white border border-[#ff3b30] text-[#ff3b30] rounded-full py-2 mr-2"
						>
							<text class="text-3.5">å–æ¶ˆä»»åŠ¡</text>
						</button>
						<button 
							v-if="task.canViewSubtasks"
							@click.stop="viewSubtasks(task.id)"
							class="flex-1 bg-[#07c160] text-white rounded-full py-2"
						>
							<text class="text-3.5">æŸ¥çœ‹å­ä»»åŠ¡</text>
						</button>
					</view>
				</view>

				<!-- åŠ è½½æ›´å¤š -->
				<view v-if="loading" class="flex justify-center py-4">
					<text class="text-3.5 text-[#999]">åŠ è½½ä¸­...</text>
				</view>
				<view v-if="!hasMore && taskList.length > 0" class="flex justify-center py-4">
					<text class="text-3.5 text-[#999]">æ²¡æœ‰æ›´å¤šäº†</text>
				</view>
				<view v-if="taskList.length === 0 && !loading" class="flex flex-col items-center justify-center py-20">
					<text class="text-10 mb-3">ğŸ“‹</text>
					<text class="text-4 text-[#999]">æš‚æ— ä»»åŠ¡</text>
				</view>
			</view>
		</scroll-view>
	</view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { getMyTasks, cancelTask } from '@/services/task'

// å½“å‰æ ‡ç­¾
const currentTab = ref('all')

// æ ‡ç­¾åˆ—è¡¨
const tabs = [
	{ label: 'å…¨éƒ¨', value: 'all' },
	{ label: 'è¿›è¡Œä¸­', value: 'ongoing' },
	{ label: 'å·²å®Œæˆ', value: 'completed' },
	{ label: 'å·²å–æ¶ˆ', value: 'cancelled' }
]

// ä»»åŠ¡åˆ—è¡¨
const taskList = ref([
	{
		id: 1,
		taskNo: 'T202501300001',
		createTime: '2025-01-30 10:00:00',
		status: 'ongoing',
		title: 'ç¾å›¢å¤–å–è®¢å•äº’åŠ©',
		description: 'éœ€è¦å¸®å¿™å®Œæˆç¾å›¢å¤–å–è®¢å•ï¼Œè¦æ±‚çœŸå®ä¸‹å•å¹¶ä¸Šä¼ æˆªå›¾',
		category: 'å¤–å–',
		platform: 'ç¾å›¢',
		unitPrice: '15.00',
		totalCount: 100,
		completedCount: 55,
		progress: 55,
		showActions: true,
		canCancel: true,
		canViewSubtasks: true
	},
	{
		id: 2,
		taskNo: 'T202501290002',
		createTime: '2025-01-29 15:30:00',
		status: 'completed',
		title: 'æ·˜å®åº—é“ºåˆ·å•ä»»åŠ¡',
		description: 'æ·˜å®åº—é“ºéœ€è¦åˆ·å•æå‡é”€é‡ï¼Œè¦æ±‚æŒ‰ç…§æŒ‡å®šæµç¨‹æ“ä½œ',
		category: 'ç”µå•†',
		platform: 'æ·˜å®',
		unitPrice: '20.00',
		totalCount: 50,
		completedCount: 50,
		progress: 100,
		showActions: true,
		canCancel: false,
		canViewSubtasks: true
	}
])

// åŠ è½½çŠ¶æ€
const loading = ref(false)
const hasMore = ref(true)
const page = ref(1)

// é€‰æ‹©æ ‡ç­¾
const selectTab = (value: string) => {
	currentTab.value = value
	page.value = 1
	taskList.value = []
	loadTaskList()
}

// åŠ è½½ä»»åŠ¡åˆ—è¡¨
const loadTaskList = async () => {
	if (loading.value) return
	
	try {
		loading.value = true
		
		const res = await getMyTasks({
			status: currentTab.value,
			page: page.value,
			pageSize: 10
		})
		
		loading.value = false
		
		if (res.code === 0) {
			if (page.value === 1) {
				taskList.value = res.data.list
			} else {
				taskList.value = taskList.value.concat(res.data.list)
			}
			hasMore.value = res.data.hasMore
		}
	} catch (error) {
		loading.value = false
		console.log('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥', error)
	}
}

// åŠ è½½æ›´å¤š
const loadMore = () => {
	if (!loading.value && hasMore.value) {
		page.value++
		loadTaskList()
	}
}

// è·å–çŠ¶æ€æ–‡æœ¬
const getStatusText = (status: string): string => {
	const statusMap = {
		ongoing: 'è¿›è¡Œä¸­',
		completed: 'å·²å®Œæˆ',
		cancelled: 'å·²å–æ¶ˆ'
	}
	return statusMap[status] || 'æœªçŸ¥'
}

// è·å–çŠ¶æ€é¢œè‰²
const getStatusColor = (status: string): string => {
	const colorMap = {
		ongoing: 'bg-[#07c160]',
		completed: 'bg-[#999]',
		cancelled: 'bg-[#ff3b30]'
	}
	return colorMap[status] || 'bg-[#999]'
}

// å–æ¶ˆä»»åŠ¡
const cancelTask = (id: number) => {
	uni.showModal({
		title: 'æç¤º',
		content: 'ç¡®å®šè¦å–æ¶ˆè¯¥ä»»åŠ¡å—ï¼Ÿ',
		success: async (res) => {
			if (res.confirm) {
				try {
					uni.showLoading({ title: 'å¤„ç†ä¸­...' })
					
					const result = await cancelTask(id, 'ç”¨æˆ·å–æ¶ˆ')
					
					uni.hideLoading()
					
					if (result.code === 0) {
						uni.showToast({
							title: 'å–æ¶ˆæˆåŠŸ',
							icon: 'success'
						})
						loadTaskList()
					} else {
						uni.showToast({
							title: result.msg || 'å–æ¶ˆå¤±è´¥',
							icon: 'none'
						})
					}
				} catch (error) {
					uni.hideLoading()
					uni.showToast({
						title: 'å–æ¶ˆå¤±è´¥',
						icon: 'none'
					})
				}
			}
		}
	})
}

// æŸ¥çœ‹å­ä»»åŠ¡
const viewSubtasks = (id: number) => {
	uni.navigateTo({
		url: `/pages/task/subtask/list?taskId=${id}`
	})
}

// è¿›å…¥ä»»åŠ¡è¯¦æƒ…
const goToDetail = (id: number) => {
	uni.navigateTo({
		url: `/pages/task/detail?id=${id}`
	})
}

// è¿”å›
const goBack = () => {
	uni.navigateBack()
}

// é¡µé¢åŠ è½½æ—¶è·å–ä»»åŠ¡åˆ—è¡¨
onMounted(() => {
	loadTaskList()
})
</script>
