<template>
	<view class="flex flex-col h-full bg-[#f5f5f5]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="flex items-center justify-between px-4 py-3 bg-white">
			<view class="flex items-center" @click="goBack">
				<text class="text-6">â†</text>
				<text class="text-4 ml-2">ä¿è¯é‡‘ç®¡ç†</text>
			</view>
		</view>

		<!-- ä¿è¯é‡‘ä½™é¢å¡ç‰‡ -->
		<view class="px-4 py-4">
			<view class="bg-gradient-to-r from-[#5856d6] to-[#4845c7] rounded-2 p-4 mb-3">
				<text class="text-3.5 text-white mb-2">ä¿è¯é‡‘ä½™é¢ï¼ˆå…ƒï¼‰</text>
				<text class="text-8 font-bold text-white mb-4">{{ depositInfo.balance }}</text>
				
				<view class="flex items-center justify-between bg-white/20 rounded-2 p-3">
					<view class="flex-1 text-center">
						<text class="text-4 font-bold text-white">{{ depositInfo.frozen }}</text>
						<text class="text-3 text-white mt-1">å†»ç»“ä¸­</text>
					</view>
					<view class="w-0.5 h-10 bg-white/30"></view>
					<view class="flex-1 text-center">
						<text class="text-4 font-bold text-white">{{ depositInfo.available }}</text>
						<text class="text-3 text-white mt-1">å¯ç”¨</text>
					</view>
					<view class="w-0.5 h-10 bg-white/30"></view>
					<view class="flex-1 text-center">
						<text class="text-4 font-bold text-white">{{ depositInfo.total }}</text>
						<text class="text-3 text-white mt-1">ç´¯è®¡</text>
					</view>
				</view>
			</view>

			<!-- æ“ä½œæŒ‰é’® -->
			<view class="flex mb-3">
				<button 
					@click="showRechargeDialog = true"
					class="flex-1 bg-[#07c160] text-white rounded-full py-3 mr-2"
				>
					<text class="text-4">å……å€¼ä¿è¯é‡‘</text>
				</button>
				<button 
					@click="showWithdrawDialog = true"
					class="flex-1 bg-white border border-[#07c160] text-[#07c160] rounded-full py-3"
				>
					<text class="text-4">æå–ä¿è¯é‡‘</text>
				</button>
			</view>

			<!-- è¯´æ˜å¡ç‰‡ -->
			<view class="bg-white rounded-2 p-4 mb-3">
				<text class="text-4 font-bold text-[#1f2329] mb-3">ä¿è¯é‡‘è¯´æ˜</text>
				<text class="text-3.5 text-[#646a73] mb-2">â€¢ å‘èµ·ä»»åŠ¡éœ€è¦ç¼´çº³ä»»åŠ¡æ€»é¢10%çš„ä¿è¯é‡‘</text>
				<text class="text-3.5 text-[#646a73] mb-2">â€¢ ä»»åŠ¡å®Œæˆåä¿è¯é‡‘è‡ªåŠ¨é€€è¿˜</text>
				<text class="text-3.5 text-[#646a73] mb-2">â€¢ å¯ç”¨ä¿è¯é‡‘å¯éšæ—¶æå–åˆ°é’±åŒ…</text>
				<text class="text-3.5 text-[#646a73]">â€¢ å†»ç»“ä¿è¯é‡‘ä¸ºè¿›è¡Œä¸­ä»»åŠ¡å ç”¨çš„é‡‘é¢</text>
			</view>

			<!-- æµæ°´è®°å½• -->
			<view class="bg-white rounded-2 p-4">
				<text class="text-4 font-bold text-[#1f2329] mb-3">æµæ°´è®°å½•</text>
				
				<view 
					v-for="(item, index) in logList" 
					:key="index"
					class="flex items-center justify-between py-3 border-b border-[#e5e5e5]"
				>
					<view class="flex-1">
						<text class="text-4 text-[#1f2329]">{{ item.title }}</text>
						<text class="text-3 text-[#999] mt-1">{{ item.time }}</text>
					</view>
					<view class="text-right">
						<text :class="['text-5 font-bold', item.type === 'in' ? 'text-[#07c160]' : 'text-[#ff3b30]']">
							{{ item.type === 'in' ? '+' : '-' }}{{ item.amount }}
						</text>
						<text class="text-3 text-[#999] mt-1">ä½™é¢ï¼š{{ item.balance }}</text>
					</view>
				</view>

				<view v-if="logList.length === 0" class="flex flex-col items-center justify-center py-10">
					<text class="text-8 mb-2">ğŸ“</text>
					<text class="text-3.5 text-[#999]">æš‚æ— æµæ°´è®°å½•</text>
				</view>
			</view>
		</view>

		<!-- å……å€¼å¯¹è¯æ¡† -->
		<view v-if="showRechargeDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center" @click="showRechargeDialog = false">
			<view class="bg-white w-4/5 rounded-2 p-4" @click.stop>
				<text class="text-5 font-bold text-[#1f2329] mb-4">å……å€¼ä¿è¯é‡‘</text>
				
				<view class="mb-4">
					<text class="text-3.5 text-[#646a73] mb-2">å……å€¼é‡‘é¢ï¼ˆå…ƒï¼‰</text>
					<input 
						v-model="rechargeAmount"
						type="digit"
						class="border border-[#e5e5e5] rounded-2 px-3 py-2.5 text-4"
						placeholder="è¯·è¾“å…¥å……å€¼é‡‘é¢"
						placeholder-class="text-[#c8c9cc]"
					/>
				</view>

				<view class="flex flex-wrap mb-4">
					<view 
						v-for="(amount, index) in quickAmounts" 
						:key="index"
						@click="rechargeAmount = amount"
						class="w-1/3 px-1 mb-2"
					>
						<view class="border border-[#e5e5e5] rounded-2 py-2 text-center">
							<text class="text-4 text-[#1f2329]">{{ amount }}å…ƒ</text>
						</view>
					</view>
				</view>

				<view class="flex">
					<button 
						@click="showRechargeDialog = false"
						class="flex-1 bg-[#f5f5f5] text-[#646a73] rounded-full py-3 mr-2"
					>
						<text class="text-4">å–æ¶ˆ</text>
					</button>
					<button 
						@click="confirmRecharge"
						class="flex-1 bg-[#07c160] text-white rounded-full py-3"
					>
						<text class="text-4">ç¡®è®¤å……å€¼</text>
					</button>
				</view>
			</view>
		</view>

		<!-- æå–å¯¹è¯æ¡† -->
		<view v-if="showWithdrawDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center" @click="showWithdrawDialog = false">
			<view class="bg-white w-4/5 rounded-2 p-4" @click.stop>
				<text class="text-5 font-bold text-[#1f2329] mb-4">æå–ä¿è¯é‡‘</text>
				
				<view class="mb-4">
					<view class="flex items-center justify-between mb-2">
						<text class="text-3.5 text-[#646a73]">æå–é‡‘é¢ï¼ˆå…ƒï¼‰</text>
						<text class="text-3.5 text-[#999]">å¯ç”¨ï¼š{{ depositInfo.available }}å…ƒ</text>
					</view>
					<input 
						v-model="withdrawAmount"
						type="digit"
						class="border border-[#e5e5e5] rounded-2 px-3 py-2.5 text-4"
						placeholder="è¯·è¾“å…¥æå–é‡‘é¢"
						placeholder-class="text-[#c8c9cc]"
					/>
					<view @click="withdrawAmount = depositInfo.available" class="mt-2">
						<text class="text-3.5 text-[#07c160]">å…¨éƒ¨æå–</text>
					</view>
				</view>

				<view class="bg-[#fff9e6] rounded-2 p-3 mb-4">
					<text class="text-3 text-[#ed6a0c]">æå–åå°†è½¬å…¥é’±åŒ…ä½™é¢ï¼Œå¯éšæ—¶æç°</text>
				</view>

				<view class="flex">
					<button 
						@click="showWithdrawDialog = false"
						class="flex-1 bg-[#f5f5f5] text-[#646a73] rounded-full py-3 mr-2"
					>
						<text class="text-4">å–æ¶ˆ</text>
					</button>
					<button 
						@click="confirmWithdraw"
						class="flex-1 bg-[#07c160] text-white rounded-full py-3"
					>
						<text class="text-4">ç¡®è®¤æå–</text>
					</button>
				</view>
			</view>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { getDepositInfo, rechargeDeposit, withdrawDeposit } from '@/services/task'

// ä¿è¯é‡‘ä¿¡æ¯
const depositInfo = ref({
	balance: '5,000.00',
	frozen: '2,500.00',
	available: '2,500.00',
	total: '15,000.00'
})

// æµæ°´è®°å½•
const logList = ref([
	{
		title: 'ä»»åŠ¡å®Œæˆé€€è¿˜',
		time: '2025-01-30 10:30:00',
		type: 'in',
		amount: '500.00',
		balance: '5,000.00'
	},
	{
		title: 'å‘èµ·ä»»åŠ¡å†»ç»“',
		time: '2025-01-30 09:00:00',
		type: 'out',
		amount: '1,500.00',
		balance: '4,500.00'
	},
	{
		title: 'å……å€¼ä¿è¯é‡‘',
		time: '2025-01-29 15:00:00',
		type: 'in',
		amount: '3,000.00',
		balance: '6,000.00'
	}
])

// æ˜¾ç¤ºå……å€¼å¯¹è¯æ¡†
const showRechargeDialog = ref(false)
// æ˜¾ç¤ºæå–å¯¹è¯æ¡†
const showWithdrawDialog = ref(false)

// å……å€¼é‡‘é¢
const rechargeAmount = ref('')
// æå–é‡‘é¢
const withdrawAmount = ref('')

// å¿«æ·é‡‘é¢
const quickAmounts = ['500', '1000', '2000', '3000', '5000', '10000']

// åŠ è½½ä¿è¯é‡‘ä¿¡æ¯
const loadDepositInfo = async () => {
	try {
		const res = await getDepositInfo()
		if (res.code === 0) {
			depositInfo.value = res.data
		}
	} catch (error) {
		console.log('åŠ è½½ä¿è¯é‡‘ä¿¡æ¯å¤±è´¥', error)
	}
}

// åŠ è½½æµæ°´è®°å½•
const loadLogList = async () => {
	try {
		// TODO: å®ç°è·å–ä¿è¯é‡‘æµæ°´æ¥å£
		const res = { code: 0, data: { list: [] } } as any
		if (res.code === 0) {
			logList.value = res.data.list
		}
	} catch (error) {
		console.log('åŠ è½½æµæ°´è®°å½•å¤±è´¥', error)
	}
}

// ç¡®è®¤å……å€¼
const confirmRecharge = async () => {
	if (!rechargeAmount.value) {
		uni.showToast({
			title: 'è¯·è¾“å…¥å……å€¼é‡‘é¢',
			icon: 'none'
		})
		return
	}

	const amount = parseFloat(rechargeAmount.value)
	if (amount <= 0) {
		uni.showToast({
			title: 'å……å€¼é‡‘é¢å¿…é¡»å¤§äº0',
			icon: 'none'
		})
		return
	}

	try {
		uni.showLoading({ title: 'å¤„ç†ä¸­...' })
		
		const res = await rechargeDeposit(rechargeAmount.value)
		
		uni.hideLoading()
		
		if (res.code === 0) {
			uni.showToast({
				title: 'å……å€¼æˆåŠŸ',
				icon: 'success'
			})
			showRechargeDialog.value = false
			rechargeAmount.value = ''
			loadDepositInfo()
			loadLogList()
		} else {
			uni.showToast({
				title: res.msg || 'å……å€¼å¤±è´¥',
				icon: 'none'
			})
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: 'å……å€¼å¤±è´¥',
			icon: 'none'
		})
	}
}

// ç¡®è®¤æå–
const confirmWithdraw = async () => {
	if (!withdrawAmount.value) {
		uni.showToast({
			title: 'è¯·è¾“å…¥æå–é‡‘é¢',
			icon: 'none'
		})
		return
	}

	const amount = parseFloat(withdrawAmount.value)
	const available = parseFloat(depositInfo.value.available.replace(/,/g, ''))
	
	if (amount <= 0) {
		uni.showToast({
			title: 'æå–é‡‘é¢å¿…é¡»å¤§äº0',
			icon: 'none'
		})
		return
	}

	if (amount > available) {
		uni.showToast({
			title: 'æå–é‡‘é¢ä¸èƒ½å¤§äºå¯ç”¨ä½™é¢',
			icon: 'none'
		})
		return
	}

	try {
		uni.showLoading({ title: 'å¤„ç†ä¸­...' })
		
		const res = await withdrawDeposit(withdrawAmount.value)
		
		uni.hideLoading()
		
		if (res.code === 0) {
			uni.showToast({
				title: 'æå–æˆåŠŸ',
				icon: 'success'
			})
			showWithdrawDialog.value = false
			withdrawAmount.value = ''
			loadDepositInfo()
			loadLogList()
		} else {
			uni.showToast({
				title: res.msg || 'æå–å¤±è´¥',
				icon: 'none'
			})
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: 'æå–å¤±è´¥',
			icon: 'none'
		})
	}
}

// è¿”å›
const goBack = () => {
	uni.navigateBack()
}

// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
onMounted(() => {
	loadDepositInfo()
	loadLogList()
})
</script>
