<template>
	<view class="flex flex-col h-screen bg-[#f5f7fa]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<cl-topbar title="ä»»åŠ¡å¤§å…" :show-back="false" background-color="#0052d9" color="#ffffff" safe-area-top>
			<template #append>
				<view class="bg-white/20 px-[24rpx] py-[12rpx] rounded-full mr-[16rpx]" @click="goToMyTasks">
					<text class="text-white text-[24rpx]">æˆ‘çš„ä»»åŠ¡</text>
				</view>
			</template>
		</cl-topbar>

		<!-- ç­›é€‰æ  -->
		<view class="bg-white py-[24rpx] border-b-[2rpx] border-[#f0f0f0]">
			<scroll-view class="w-full" scroll-x :show-scrollbar="false">
				<view class="flex flex-row px-[32rpx] gap-[16rpx]">
					<view 
						v-for="(item, index) in categories" 
						:key="index"
						@click="selectCategory(item.value)"
						class="px-[32rpx] py-[12rpx] rounded-[32rpx] flex-shrink-0"
						:class="[currentCategory === item.value ? 'bg-[#0052d9]' : 'bg-[#f5f7fa]']"
					>
						<text class="text-[28rpx]" :class="[currentCategory === item.value ? 'text-white' : 'text-[#646a73]']">{{ item.label }}</text>
					</view>
				</view>
			</scroll-view>
		</view>

		<!-- ä»»åŠ¡åˆ—è¡¨ -->
		<scroll-view class="flex-1 h-0" scroll-y @scrolltolower="loadMore">
			<view class="p-[32rpx_32rpx_24rpx_32rpx] flex flex-col gap-[24rpx]">
				<view 
					v-for="(task, index) in taskList" 
					:key="index"
					@click="goToDetail(task.id)"
					class="bg-white rounded-[24rpx] p-[32rpx] shadow-[0_2rpx_12rpx_rgba(0,0,0,0.03)]"
				>
					<!-- ä»»åŠ¡å¤´éƒ¨ -->
					<view class="flex flex-row justify-between items-center mb-[24rpx]">
						<view class="flex flex-row items-center gap-[24rpx]">
							<view class="w-[80rpx] h-[80rpx] rounded-full bg-[#f5f7fa] flex items-center justify-center">
								<text class="text-[40rpx]">{{ task.merchantAvatar }}</text>
							</view>
							<view class="flex flex-col gap-[4rpx]">
								<text class="text-[30rpx] font-semibold text-[#1f2329]">{{ task.merchantName }}</text>
								<text class="text-[24rpx] text-[#9aa0a6]">{{ task.createTime }}</text>
							</view>
						</view>
						<view class="px-[16rpx] py-[6rpx] rounded-[8rpx]" :class="getStatusClass(task.status)">
							<text class="text-[24rpx]" :class="getStatusTextClass(task.status)">{{ getStatusText(task.status) }}</text>
						</view>
					</view>

					<!-- ä»»åŠ¡ä¿¡æ¯ -->
					<view class="mb-[24rpx]">
						<text class="text-[32rpx] font-semibold text-[#1f2329] mb-[12rpx] block">{{ task.title }}</text>
						<text class="text-[28rpx] text-[#646a73] leading-[1.5] block">{{ task.description }}</text>
					</view>

					<!-- ä»»åŠ¡æ ‡ç­¾ -->
					<view class="flex flex-row flex-wrap gap-[16rpx] mb-[24rpx]">
						<view class="px-[16rpx] py-[6rpx] rounded-[8rpx] bg-[#e6f0ff]">
							<text class="text-[24rpx] text-[#0052d9]">{{ task.category }}</text>
						</view>
						<view class="px-[16rpx] py-[6rpx] rounded-[8rpx] bg-[#fffbe6]">
							<text class="text-[24rpx] text-[#faad14]">{{ task.platform }}</text>
						</view>
					</view>

					<!-- ä»»åŠ¡æ•°æ® -->
					<view class="flex flex-row justify-between items-center pt-[24rpx] border-t-[2rpx] border-[#f5f7fa]">
						<view class="flex-1 flex flex-col gap-[8rpx]">
							<text class="text-[24rpx] text-[#9aa0a6]">å•ä»·</text>
							<text class="text-[32rpx] font-semibold text-[#e34d59]">Â¥{{ task.unitPrice }}</text>
						</view>
						<view class="flex-1 flex flex-col gap-[8rpx]">
							<text class="text-[24rpx] text-[#9aa0a6]">æ€»æ•°</text>
							<text class="text-[28rpx] font-semibold text-[#1f2329]">{{ task.totalCount }}</text>
						</view>
						<view class="flex-1 flex flex-col gap-[8rpx]">
							<text class="text-[24rpx] text-[#9aa0a6]">å‰©ä½™</text>
							<text class="text-[28rpx] font-semibold text-[#00b578]">{{ task.remainCount }}</text>
						</view>
						<view class="flex-1 flex flex-col items-end gap-[8rpx]">
							<text class="text-[24rpx] text-[#9aa0a6]">è¿›åº¦</text>
							<text class="text-[28rpx] font-semibold text-[#0052d9]">{{ task.progress }}%</text>
						</view>
					</view>
				</view>

				<!-- åŠ è½½çŠ¶æ€ -->
				<view v-if="loading" class="flex flex-col items-center justify-center py-[48rpx]">
					<text class="text-[28rpx] text-[#9aa0a6]">åŠ è½½ä¸­...</text>
				</view>
				<view v-if="!hasMore && taskList.length > 0" class="flex flex-col items-center justify-center py-[48rpx]">
					<text class="text-[28rpx] text-[#9aa0a6]">æ²¡æœ‰æ›´å¤šäº†</text>
				</view>
				<view v-if="taskList.length === 0 && !loading" class="flex flex-col items-center justify-center pt-[120rpx] pb-[48rpx]">
					<uni-icons type="compose" size="48" color="#c0c4cc"></uni-icons>
					<text class="text-[28rpx] text-[#9aa0a6] mt-[24rpx]">æš‚æ— ä»»åŠ¡</text>
				</view>
			</view>
		</scroll-view>

		<!-- åº•éƒ¨æ“ä½œæ  -->
		<view class="p-[24rpx_32rpx] bg-white border-t-[2rpx] border-[#f0f0f0] pb-[calc(24rpx+env(safe-area-inset-bottom))]">
			<button 
				@click="goToCreate"
				class="bg-[#0052d9] rounded-[48rpx] h-[88rpx] flex items-center justify-center"
			>
				<text class="text-[32rpx] text-white font-semibold">å‘èµ·ä»»åŠ¡</text>
			</button>
		</view>

		<custom-tabbar></custom-tabbar>
	</view>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { getTaskList } from '@/services/task'
import CustomTabbar from '@/components/custom-tabbar/custom-tabbar.uvue';

// å½“å‰åˆ†ç±»
const currentCategory = ref('all')

// åˆ†ç±»åˆ—è¡¨ï¼ˆä¸åç«¯ä¿æŒä¸€è‡´ï¼‰
const categories = [
	{ label: 'å…¨éƒ¨', value: 'all' },
	{ label: 'ç”µå•†å¹³å°', value: 'ecommerce' },
	{ label: 'å¤–å–é…é€', value: 'food' },
	{ label: 'å‡ºè¡ŒæœåŠ¡', value: 'travel' },
	{ label: 'ç”Ÿæ´»æœåŠ¡', value: 'life' },
	{ label: 'é‡‘èæ”¯ä»˜', value: 'finance' },
	{ label: 'å…¶ä»–', value: 'other' }
]

// ä»»åŠ¡åˆ—è¡¨ï¼ˆåˆå§‹ä¸ºç©ºï¼Œä»åç«¯åŠ è½½ï¼‰
const taskList = ref([] as any[])

// åŠ è½½çŠ¶æ€
const loading = ref(false)
const hasMore = ref(true)
const page = ref(1)

// é€‰æ‹©åˆ†ç±»
const selectCategory = (value: string) => {
	currentCategory.value = value
	page.value = 1
	taskList.value = []
	loadTaskList()
}

// åŠ è½½ä»»åŠ¡åˆ—è¡¨
const loadTaskList = async () => {
	if (loading.value) return
	
	try {
		loading.value = true
		
		const data = await getTaskList({
			category: currentCategory.value,
			page: page.value,
			pageSize: 10
		})
		
		loading.value = false
		
		// å¤„ç†è¿”å›çš„æ•°æ®
		if (data && data.list) {
			// è½¬æ¢åç«¯æ•°æ®æ ¼å¼ä¸ºå‰ç«¯éœ€è¦çš„æ ¼å¼
			const formattedList = data.list.map((item: any) => ({
				id: item.id,
				merchantAvatar: 'ğŸª',
				merchantName: `å•†æˆ·${item.from_user_id}`,
				createTime: formatTime(item.createtime),
				status: getTaskStatus(item.status),
				title: `äº’åŠ©ä»»åŠ¡ #${item.task_no}`,
				description: `é‡‘é¢ï¼šÂ¥${item.amount}ï¼Œä½£é‡‘ï¼šÂ¥${item.commission}`,
				category: 'äº’åŠ©',
				platform: 'å¹³å°',
				unitPrice: item.amount,
				totalCount: 1,
				remainCount: item.status === 'assigned' ? 1 : 0,
				progress: item.status === 'completed' ? 100 : 0
			}))
			
			if (page.value === 1) {
				taskList.value = formattedList
			} else {
				taskList.value = taskList.value.concat(formattedList)
			}
			hasMore.value = data.hasMore || false
		}
	} catch (error) {
		loading.value = false
		console.log('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥', error)
		uni.showToast({
			title: error.msg || 'åŠ è½½å¤±è´¥',
			icon: 'none'
		})
	}
}

// æ ¼å¼åŒ–æ—¶é—´
const formatTime = (timestamp: number): string => {
	const now = Date.now() / 1000
	const diff = now - timestamp
	
	if (diff < 60) {
		return 'åˆšåˆš'
	} else if (diff < 3600) {
		return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`
	} else if (diff < 86400) {
		return `${Math.floor(diff / 3600)}å°æ—¶å‰`
	} else {
		return `${Math.floor(diff / 86400)}å¤©å‰`
	}
}

// è½¬æ¢ä»»åŠ¡çŠ¶æ€
const getTaskStatus = (status: string): string => {
	const statusMap: Record<string, string> = {
		'pending': 'ongoing',
		'assigned': 'ongoing',
		'accepted': 'ongoing',
		'paid': 'ongoing',
		'verified': 'ongoing',
		'completed': 'completed',
		'failed': 'cancelled',
		'cancelled': 'cancelled'
	}
	return statusMap[status] || 'ongoing'
}

// åŠ è½½æ›´å¤š
const loadMore = () => {
	if (!loading.value && hasMore.value) {
		page.value++
		loadTaskList()
	}
}

// è·å–çŠ¶æ€æ–‡æœ¬
const getStatusText = (status: string): string => {
	const statusMap = {
		ongoing: 'è¿›è¡Œä¸­',
		completed: 'å·²å®Œæˆ',
		cancelled: 'å·²å–æ¶ˆ'
	}
	return statusMap[status] || 'æœªçŸ¥'
}

// è·å–çŠ¶æ€æ ·å¼ç±»
const getStatusClass = (status: string): string => {
	const classMap = {
		ongoing: 'bg-[#e6f0ff]',
		completed: 'bg-[#f5f5f5]',
		cancelled: 'bg-[#fff0ed]'
	}
	return classMap[status] || 'bg-[#f5f5f5]'
}

const getStatusTextClass = (status: string): string => {
	const classMap = {
		ongoing: 'text-[#0052d9]',
		completed: 'text-[#909399]',
		cancelled: 'text-[#e34d59]'
	}
	return classMap[status] || 'text-[#909399]'
}

// è¿›å…¥ä»»åŠ¡è¯¦æƒ…
const goToDetail = (id: number) => {
	uni.navigateTo({
		url: `/pages/task/detail?id=${id}`
	})
}

// è¿›å…¥æˆ‘çš„ä»»åŠ¡
const goToMyTasks = () => {
	uni.navigateTo({
		url: '/pages/task/my-tasks'
	})
}

// å‘èµ·ä»»åŠ¡
const goToCreate = () => {
	uni.navigateTo({
		url: '/pages/task/create'
	})
}

onMounted(() => {
	loadTaskList()
})
</script>

<style>
</style>
