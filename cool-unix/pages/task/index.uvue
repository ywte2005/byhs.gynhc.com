<template>
	<view class="flex flex-col h-full bg-[#f5f5f5]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="flex items-center justify-between px-4 py-3 bg-white">
			<text class="text-5 font-bold text-[#1f2329]">ä»»åŠ¡å¤§å…</text>
			<view @click="goToMyTasks">
				<text class="text-4 text-[#07c160]">æˆ‘çš„ä»»åŠ¡</text>
			</view>
		</view>

		<!-- ç­›é€‰æ  -->
		<view class="bg-white px-4 py-3 mb-2">
			<scroll-view class="flex" scroll-x>
				<view class="flex">
					<view 
						v-for="(item, index) in categories" 
						:key="index"
						@click="selectCategory(item.value)"
						:class="['px-4 py-2 rounded-full mr-2', currentCategory === item.value ? 'bg-[#07c160] text-white' : 'bg-[#f5f5f5] text-[#646a73]']"
					>
						<text :class="['text-3.5', currentCategory === item.value ? 'text-white' : 'text-[#646a73]']">{{ item.label }}</text>
					</view>
				</view>
			</scroll-view>
		</view>

		<!-- ä»»åŠ¡åˆ—è¡¨ -->
		<scroll-view class="flex-1" scroll-y @scrolltolower="loadMore">
			<view class="px-4 py-2">
				<view 
					v-for="(task, index) in taskList" 
					:key="index"
					@click="goToDetail(task.id)"
					class="bg-white rounded-2 p-4 mb-3"
				>
					<!-- ä»»åŠ¡å¤´éƒ¨ -->
					<view class="flex items-center justify-between mb-3">
						<view class="flex items-center">
							<view class="w-10 h-10 rounded-full bg-[#f5f5f5] flex items-center justify-center mr-3">
								<text class="text-5">{{ task.merchantAvatar }}</text>
							</view>
							<view>
								<text class="text-4 font-bold text-[#1f2329]">{{ task.merchantName }}</text>
								<text class="text-3 text-[#999] mt-0.5">{{ task.createTime }}</text>
							</view>
						</view>
						<view :class="['px-2 py-1 rounded', getStatusColor(task.status)]">
							<text class="text-3 text-white">{{ getStatusText(task.status) }}</text>
						</view>
					</view>

					<!-- ä»»åŠ¡ä¿¡æ¯ -->
					<view class="mb-3">
						<text class="text-4.5 font-bold text-[#1f2329]">{{ task.title }}</text>
						<text class="text-3.5 text-[#646a73] mt-2">{{ task.description }}</text>
					</view>

					<!-- ä»»åŠ¡æ ‡ç­¾ -->
					<view class="flex flex-wrap mb-3">
						<view class="bg-[#f0f9ff] px-2 py-1 rounded mr-2 mb-2">
							<text class="text-3 text-[#07c160]">{{ task.category }}</text>
						</view>
						<view class="bg-[#fff9e6] px-2 py-1 rounded mr-2 mb-2">
							<text class="text-3 text-[#ed6a0c]">{{ task.platform }}</text>
						</view>
					</view>

					<!-- ä»»åŠ¡æ•°æ® -->
					<view class="flex items-center justify-between border-t border-[#e5e5e5] pt-3">
						<view class="flex-1">
							<text class="text-3 text-[#999]">å•ä»·</text>
							<text class="text-5 font-bold text-[#ff3b30] ml-1">Â¥{{ task.unitPrice }}</text>
						</view>
						<view class="flex-1">
							<text class="text-3 text-[#999]">æ€»æ•°</text>
							<text class="text-4 font-bold text-[#1f2329] ml-1">{{ task.totalCount }}</text>
						</view>
						<view class="flex-1">
							<text class="text-3 text-[#999]">å‰©ä½™</text>
							<text class="text-4 font-bold text-[#07c160] ml-1">{{ task.remainCount }}</text>
						</view>
						<view class="flex-1 text-right">
							<text class="text-3 text-[#999]">è¿›åº¦</text>
							<text class="text-4 font-bold text-[#5856d6] ml-1">{{ task.progress }}%</text>
						</view>
					</view>
				</view>

				<!-- åŠ è½½æ›´å¤š -->
				<view v-if="loading" class="flex justify-center py-4">
					<text class="text-3.5 text-[#999]">åŠ è½½ä¸­...</text>
				</view>
				<view v-if="!hasMore && taskList.length > 0" class="flex justify-center py-4">
					<text class="text-3.5 text-[#999]">æ²¡æœ‰æ›´å¤šäº†</text>
				</view>
				<view v-if="taskList.length === 0 && !loading" class="flex flex-col items-center justify-center py-20">
					<uni-icons type="compose" size="40" color="#999999"></uni-icons>
					<text class="text-4 text-[#999] mt-3">æš‚æ— ä»»åŠ¡</text>
				</view>
			</view>
		</scroll-view>

		<!-- åº•éƒ¨æ“ä½œæ  -->
		<view class="bg-white px-4 py-3 border-t border-[#e5e5e5]">
			<button 
				@click="goToCreate"
				class="w-full bg-[#07c160] text-white rounded-full py-3"
			>
				<text class="text-4">å‘èµ·ä»»åŠ¡</text>
			</button>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { getTaskList } from '@/services/task'

// å½“å‰åˆ†ç±»
const currentCategory = ref('all')

// åˆ†ç±»åˆ—è¡¨ï¼ˆä¸åç«¯ä¿æŒä¸€è‡´ï¼‰
const categories = [
	{ label: 'å…¨éƒ¨', value: 'all' },
	{ label: 'ç”µå•†å¹³å°', value: 'ecommerce' },
	{ label: 'å¤–å–é…é€', value: 'food' },
	{ label: 'å‡ºè¡ŒæœåŠ¡', value: 'travel' },
	{ label: 'ç”Ÿæ´»æœåŠ¡', value: 'life' },
	{ label: 'é‡‘èæ”¯ä»˜', value: 'finance' },
	{ label: 'å…¶ä»–', value: 'other' }
]

// ä»»åŠ¡åˆ—è¡¨ï¼ˆåˆå§‹ä¸ºç©ºï¼Œä»åç«¯åŠ è½½ï¼‰
const taskList = ref([] as any[])

// åŠ è½½çŠ¶æ€
const loading = ref(false)
const hasMore = ref(true)
const page = ref(1)

// é€‰æ‹©åˆ†ç±»
const selectCategory = (value: string) => {
	currentCategory.value = value
	page.value = 1
	taskList.value = []
	loadTaskList()
}

// åŠ è½½ä»»åŠ¡åˆ—è¡¨
const loadTaskList = async () => {
	if (loading.value) return
	
	try {
		loading.value = true
		
		const data = await getTaskList({
			category: currentCategory.value,
			page: page.value,
			pageSize: 10
		})
		
		loading.value = false
		
		// å¤„ç†è¿”å›çš„æ•°æ®
		if (data && data.list) {
			// è½¬æ¢åç«¯æ•°æ®æ ¼å¼ä¸ºå‰ç«¯éœ€è¦çš„æ ¼å¼
			const formattedList = data.list.map((item: any) => ({
				id: item.id,
				merchantAvatar: 'ğŸª',
				merchantName: `å•†æˆ·${item.from_user_id}`,
				createTime: formatTime(item.createtime),
				status: getTaskStatus(item.status),
				title: `äº’åŠ©ä»»åŠ¡ #${item.task_no}`,
				description: `é‡‘é¢ï¼šÂ¥${item.amount}ï¼Œä½£é‡‘ï¼šÂ¥${item.commission}`,
				category: 'äº’åŠ©',
				platform: 'å¹³å°',
				unitPrice: item.amount,
				totalCount: 1,
				remainCount: item.status === 'assigned' ? 1 : 0,
				progress: item.status === 'completed' ? 100 : 0
			}))
			
			if (page.value === 1) {
				taskList.value = formattedList
			} else {
				taskList.value = taskList.value.concat(formattedList)
			}
			hasMore.value = data.hasMore || false
		}
	} catch (error) {
		loading.value = false
		console.log('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥', error)
		uni.showToast({
			title: error.msg || 'åŠ è½½å¤±è´¥',
			icon: 'none'
		})
	}
}

// æ ¼å¼åŒ–æ—¶é—´
const formatTime = (timestamp: number): string => {
	const now = Date.now() / 1000
	const diff = now - timestamp
	
	if (diff < 60) {
		return 'åˆšåˆš'
	} else if (diff < 3600) {
		return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`
	} else if (diff < 86400) {
		return `${Math.floor(diff / 3600)}å°æ—¶å‰`
	} else {
		return `${Math.floor(diff / 86400)}å¤©å‰`
	}
}

// è½¬æ¢ä»»åŠ¡çŠ¶æ€
const getTaskStatus = (status: string): string => {
	const statusMap: Record<string, string> = {
		'pending': 'ongoing',
		'assigned': 'ongoing',
		'accepted': 'ongoing',
		'paid': 'ongoing',
		'verified': 'ongoing',
		'completed': 'completed',
		'failed': 'cancelled',
		'cancelled': 'cancelled'
	}
	return statusMap[status] || 'ongoing'
}

// åŠ è½½æ›´å¤š
const loadMore = () => {
	if (!loading.value && hasMore.value) {
		page.value++
		loadTaskList()
	}
}

// è·å–çŠ¶æ€æ–‡æœ¬
const getStatusText = (status: string): string => {
	const statusMap = {
		ongoing: 'è¿›è¡Œä¸­',
		completed: 'å·²å®Œæˆ',
		cancelled: 'å·²å–æ¶ˆ'
	}
	return statusMap[status] || 'æœªçŸ¥'
}

// è·å–çŠ¶æ€é¢œè‰²
const getStatusColor = (status: string): string => {
	const colorMap = {
		ongoing: 'bg-[#07c160]',
		completed: 'bg-[#999]',
		cancelled: 'bg-[#ff3b30]'
	}
	return colorMap[status] || 'bg-[#999]'
}

// è¿›å…¥ä»»åŠ¡è¯¦æƒ…
const goToDetail = (id: number) => {
	uni.navigateTo({
		url: `/pages/task/detail?id=${id}`
	})
}

// è¿›å…¥æˆ‘çš„ä»»åŠ¡
const goToMyTasks = () => {
	uni.navigateTo({
		url: '/pages/task/my-tasks'
	})
}

// å‘èµ·ä»»åŠ¡
const goToCreate = () => {
	uni.navigateTo({
		url: '/pages/task/create'
	})
}

// é¡µé¢åŠ è½½æ—¶è·å–ä»»åŠ¡åˆ—è¡¨
onMounted(() => {
	loadTaskList()
})
</script>
