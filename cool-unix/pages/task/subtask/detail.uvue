<template>
	<view class="flex flex-col h-full bg-[#f5f5f5]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="flex items-center justify-between px-4 py-3 bg-white">
			<view class="flex items-center" @click="goBack">
				<uni-icons type="left" size="24" color="#1f2329"></uni-icons>
				<text class="text-4 ml-2">å­ä»»åŠ¡è¯¦æƒ…</text>
			</view>
		</view>

		<!-- å†…å®¹åŒºåŸŸ -->
		<scroll-view class="flex-1" scroll-y>
			<view class="px-4 py-4">
				<!-- ä»»åŠ¡çŠ¶æ€å¡ç‰‡ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<view class="flex items-center justify-between mb-3">
						<view :class="['px-3 py-1.5 rounded-full', getStatusBgColor(subtaskInfo.status)]">
							<text :class="['text-4 font-bold', getStatusTextColor(subtaskInfo.status)]">
								{{ getStatusText(subtaskInfo.status) }}
							</text>
						</view>
						<text class="text-3.5 text-[#999]">ç¼–å·ï¼š{{ subtaskInfo.subtaskNo }}</text>
					</view>

					<text class="text-5 font-bold text-[#1f2329] mb-2">{{ subtaskInfo.title }}</text>
					<text class="text-3.5 text-[#646a73]">{{ subtaskInfo.description }}</text>
				</view>

				<!-- æ—¶é—´ä¿¡æ¯ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">æ—¶é—´ä¿¡æ¯</text>
					
					<view class="mb-3">
						<text class="text-3.5 text-[#999]">æ¥å•æ—¶é—´</text>
						<text class="text-4 text-[#1f2329] ml-2">{{ subtaskInfo.receiveTime }}</text>
					</view>
					<view class="mb-3">
						<text class="text-3.5 text-[#999]">å®Œæˆæ—¶é™</text>
						<text class="text-4 text-[#1f2329] ml-2">{{ subtaskInfo.timeLimit }}å°æ—¶</text>
					</view>
					<view class="mb-3">
						<text class="text-3.5 text-[#999]">å‰©ä½™æ—¶é—´</text>
						<text class="text-4 font-bold text-[#ff9500] ml-2">{{ subtaskInfo.remainTime }}</text>
					</view>
					<view v-if="subtaskInfo.completeTime">
						<text class="text-3.5 text-[#999]">å®Œæˆæ—¶é—´</text>
						<text class="text-4 text-[#1f2329] ml-2">{{ subtaskInfo.completeTime }}</text>
					</view>
				</view>

				<!-- ä»»åŠ¡ä¿¡æ¯ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">ä»»åŠ¡ä¿¡æ¯</text>
					
					<view class="mb-3">
						<text class="text-3.5 text-[#999]">ä»»åŠ¡ç±»ç›®</text>
						<text class="text-4 text-[#1f2329] ml-2">{{ subtaskInfo.category }}</text>
					</view>
					<view class="mb-3">
						<text class="text-3.5 text-[#999]">å¹³å°åç§°</text>
						<text class="text-4 text-[#1f2329] ml-2">{{ subtaskInfo.platform }}</text>
					</view>
					<view class="mb-3">
						<text class="text-3.5 text-[#999]">ä»»åŠ¡ä½£é‡‘</text>
						<text class="text-5 font-bold text-[#ff3b30] ml-2">Â¥{{ subtaskInfo.commission }}</text>
					</view>
				</view>

				<!-- ä»»åŠ¡è¦æ±‚ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">ä»»åŠ¡è¦æ±‚</text>
					
					<view class="mb-3">
						<text class="text-3.5 text-[#999] mb-2">æ“ä½œæ­¥éª¤</text>
						<view class="bg-[#f5f5f5] rounded-2 p-3 mt-2">
							<text class="text-3.5 text-[#646a73]">{{ subtaskInfo.steps }}</text>
						</view>
					</view>

					<view class="mb-3">
						<text class="text-3.5 text-[#999] mb-2">å‡­è¯è¦æ±‚</text>
						<view class="flex flex-wrap mt-2">
							<view 
								v-for="(item, index) in subtaskInfo.proofTypes" 
								:key="index"
								class="bg-[#f0f9ff] px-2 py-1 rounded mr-2 mb-2"
							>
								<text class="text-3 text-[#07c160]">{{ item }}</text>
							</view>
						</view>
					</view>

					<view v-if="subtaskInfo.specialRequirement">
						<text class="text-3.5 text-[#999] mb-2">ç‰¹æ®Šè¦æ±‚</text>
						<view class="bg-[#fff9e6] rounded-2 p-3 mt-2">
							<text class="text-3.5 text-[#646a73]">{{ subtaskInfo.specialRequirement }}</text>
						</view>
					</view>
				</view>

				<!-- ä¸Šä¼ çš„å‡­è¯ -->
				<view v-if="subtaskInfo.proofImages && subtaskInfo.proofImages.length > 0" class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">ä¸Šä¼ çš„å‡­è¯</text>
					
					<view class="flex flex-wrap">
						<view 
							v-for="(img, index) in subtaskInfo.proofImages" 
							:key="index"
							@click="previewImage(index)"
							class="w-24 h-24 rounded-2 mr-2 mb-2 overflow-hidden"
						>
							<image :src="img" class="w-full h-full" mode="aspectFill" />
						</view>
					</view>

					<view v-if="subtaskInfo.proofNote" class="bg-[#f5f5f5] rounded-2 p-3 mt-3">
						<text class="text-3.5 text-[#646a73]">{{ subtaskInfo.proofNote }}</text>
					</view>
				</view>

				<!-- å‘å¸ƒå•†æˆ· -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">å‘å¸ƒå•†æˆ·</text>
					<view class="flex items-center">
						<view class="w-12 h-12 rounded-full bg-[#f5f5f5] flex items-center justify-center mr-3">
							<text class="text-6">{{ subtaskInfo.merchantAvatar }}</text>
						</view>
						<view class="flex-1">
							<text class="text-4 font-bold text-[#1f2329]">{{ subtaskInfo.merchantName }}</text>
							<view class="flex items-center mt-1">
								<view class="bg-[#07c160] px-2 py-0.5 rounded mr-2">
									<text class="text-3 text-white">{{ subtaskInfo.merchantLevel }}</text>
								</view>
								<text class="text-3 text-[#999]">ä¿¡ç”¨åˆ†ï¼š{{ subtaskInfo.merchantCredit }}</text>
							</view>
						</view>
					</view>
				</view>
			</view>
		</scroll-view>

		<!-- åº•éƒ¨æ“ä½œæ  -->
		<view v-if="showActions" class="bg-white px-4 py-3 border-t border-[#e5e5e5]">
			<button 
				v-if="subtaskInfo.canUpload"
				@click="goToUpload"
				class="w-full bg-[#07c160] text-white rounded-full py-3"
			>
				<text class="text-4">ä¸Šä¼ å‡­è¯</text>
			</button>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, computed, onMounted } from 'vue'
import { getSubTaskDetail, cancelSubTask } from '@/services/task'

// å­ä»»åŠ¡ID
const subtaskId = ref(0)

// å­ä»»åŠ¡ä¿¡æ¯
const subtaskInfo = ref({
	subtaskNo: 'ST202501300001',
	status: 'ongoing',
	title: 'ç¾å›¢å¤–å–è®¢å•äº’åŠ©',
	description: 'éœ€è¦å¸®å¿™å®Œæˆç¾å›¢å¤–å–è®¢å•ï¼Œè¦æ±‚çœŸå®ä¸‹å•å¹¶ä¸Šä¼ æˆªå›¾',
	receiveTime: '2025-01-30 10:00:00',
	timeLimit: 24,
	remainTime: '23å°æ—¶30åˆ†',
	completeTime: '',
	category: 'å¤–å–',
	platform: 'ç¾å›¢',
	commission: '15.00',
	steps: '1. æ‰“å¼€ç¾å›¢APP\n2. æœç´¢æŒ‡å®šå•†å®¶\n3. ä¸‹å•æŒ‡å®šå•†å“\n4. å®Œæˆæ”¯ä»˜\n5. ä¸Šä¼ è®¢å•æˆªå›¾',
	proofTypes: ['è®¢å•æˆªå›¾', 'èŠå¤©è®°å½•'],
	specialRequirement: 'è¯·åœ¨ä¸‹å•å30åˆ†é’Ÿå†…ä¸Šä¼ æˆªå›¾',
	proofImages: [],
	proofNote: '',
	merchantAvatar: 'ğŸª',
	merchantName: 'ç¤ºä¾‹å•†æˆ·A',
	merchantLevel: 'VIP',
	merchantCredit: 98,
	canUpload: true
})

// æ˜¯å¦æ˜¾ç¤ºæ“ä½œæŒ‰é’®
const showActions = computed(() => {
	return subtaskInfo.value.canUpload
})

// åŠ è½½å­ä»»åŠ¡è¯¦æƒ…
const loadSubtaskDetail = async () => {
	try {
		uni.showLoading({ title: 'åŠ è½½ä¸­...' })
		
		const res = await getSubTaskDetail(subtaskId.value)
		
		uni.hideLoading()
		
		if (res.code === 0) {
			subtaskInfo.value = res.data
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: 'åŠ è½½å¤±è´¥',
			icon: 'none'
		})
	}
}

// è·å–çŠ¶æ€æ–‡æœ¬
const getStatusText = (status: string): string => {
	const statusMap = {
		ongoing: 'è¿›è¡Œä¸­',
		completed: 'å·²å®Œæˆ',
		cancelled: 'å·²å–æ¶ˆ',
		timeout: 'å·²è¶…æ—¶'
	}
	return statusMap[status] || 'æœªçŸ¥'
}

// è·å–çŠ¶æ€èƒŒæ™¯è‰²
const getStatusBgColor = (status: string): string => {
	const colorMap = {
		ongoing: 'bg-[#fff9e6]',
		completed: 'bg-[#f0f9ff]',
		cancelled: 'bg-[#fff5f5]',
		timeout: 'bg-[#f5f5f5]'
	}
	return colorMap[status] || 'bg-[#f5f5f5]'
}

// è·å–çŠ¶æ€æ–‡å­—é¢œè‰²
const getStatusTextColor = (status: string): string => {
	const colorMap = {
		ongoing: 'text-[#ff9500]',
		completed: 'text-[#07c160]',
		cancelled: 'text-[#ff3b30]',
		timeout: 'text-[#999]'
	}
	return colorMap[status] || 'text-[#999]'
}

// é¢„è§ˆå›¾ç‰‡
const previewImage = (index: number) => {
	uni.previewImage({
		urls: subtaskInfo.value.proofImages,
		current: index
	})
}

// ä¸Šä¼ å‡­è¯
const goToUpload = () => {
	uni.navigateTo({
		url: `/pages/task/subtask/upload?id=${subtaskId.value}`
	})
}

// è¿”å›
const goBack = () => {
	uni.navigateBack()
}

// é¡µé¢åŠ è½½æ—¶è·å–å­ä»»åŠ¡è¯¦æƒ…
onMounted(() => {
	// è·å–å­ä»»åŠ¡ID
	const pages = getCurrentPages()
	const currentPage = pages[pages.length - 1]
	// @ts-ignore
	subtaskId.value = parseInt(currentPage.options?.id || '0')
	
	if (subtaskId.value > 0) {
		loadSubtaskDetail()
	}
})
</script>
