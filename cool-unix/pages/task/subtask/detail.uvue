<template>
	<view class="flex flex-col h-screen bg-[#f5f7fa]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<cl-topbar title="å­ä»»åŠ¡è¯¦æƒ…" :show-back="true" background-color="#ffffff" color="#1f2329" safe-area-top></cl-topbar>

		<!-- å†…å®¹åŒºåŸŸ -->
		<scroll-view class="flex-1 h-0" scroll-y>
			<view class="p-[32rpx] flex flex-col gap-[24rpx]">
				<!-- ä»»åŠ¡çŠ¶æ€å¡ç‰‡ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<view class="flex flex-row items-center justify-between mb-[24rpx]">
						<view :class="['px-[24rpx] py-[12rpx] rounded-full', getStatusBgColor(subtaskInfo.status)]">
							<text :class="['text-[32rpx] font-bold', getStatusTextColor(subtaskInfo.status)]">
								{{ getStatusText(subtaskInfo.status) }}
							</text>
						</view>
						<text class="text-[28rpx] text-[#999999]">ç¼–å·ï¼š{{ subtaskInfo.subtaskNo }}</text>
					</view>

					<text class="text-[40rpx] font-bold text-[#1f2329] mb-[16rpx] block">{{ subtaskInfo.title }}</text>
					<text class="text-[28rpx] text-[#646a73] leading-relaxed block">{{ subtaskInfo.description }}</text>
				</view>

				<!-- æ—¶é—´ä¿¡æ¯ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">æ—¶é—´ä¿¡æ¯</text>
					
					<view class="flex flex-col gap-[24rpx]">
						<view class="flex flex-row items-center">
							<text class="text-[28rpx] text-[#999999] w-[140rpx]">æ¥å•æ—¶é—´</text>
							<text class="text-[32rpx] text-[#1f2329]">{{ subtaskInfo.receiveTime }}</text>
						</view>
						<view class="flex flex-row items-center">
							<text class="text-[28rpx] text-[#999999] w-[140rpx]">å®Œæˆæ—¶é™</text>
							<text class="text-[32rpx] text-[#1f2329]">{{ subtaskInfo.timeLimit }}å°æ—¶</text>
						</view>
						<view class="flex flex-row items-center">
							<text class="text-[28rpx] text-[#999999] w-[140rpx]">å‰©ä½™æ—¶é—´</text>
							<text class="text-[32rpx] font-bold text-[#ff9500]">{{ subtaskInfo.remainTime }}</text>
						</view>
						<view v-if="subtaskInfo.completeTime" class="flex flex-row items-center">
							<text class="text-[28rpx] text-[#999999] w-[140rpx]">å®Œæˆæ—¶é—´</text>
							<text class="text-[32rpx] text-[#1f2329]">{{ subtaskInfo.completeTime }}</text>
						</view>
					</view>
				</view>

				<!-- ä»»åŠ¡ä¿¡æ¯ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">ä»»åŠ¡ä¿¡æ¯</text>
					
					<view class="flex flex-col gap-[24rpx]">
						<view class="flex flex-row items-center">
							<text class="text-[28rpx] text-[#999999] w-[140rpx]">ä»»åŠ¡ç±»ç›®</text>
							<text class="text-[32rpx] text-[#1f2329]">{{ subtaskInfo.category }}</text>
						</view>
						<view class="flex flex-row items-center">
							<text class="text-[28rpx] text-[#999999] w-[140rpx]">å¹³å°åç§°</text>
							<text class="text-[32rpx] text-[#1f2329]">{{ subtaskInfo.platform }}</text>
						</view>
						<view class="flex flex-row items-center">
							<text class="text-[28rpx] text-[#999999] w-[140rpx]">ä»»åŠ¡ä½£é‡‘</text>
							<text class="text-[40rpx] font-bold text-[#ff3b30]">Â¥{{ subtaskInfo.commission }}</text>
						</view>
					</view>
				</view>

				<!-- ä»»åŠ¡è¦æ±‚ -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">ä»»åŠ¡è¦æ±‚</text>
					
					<view class="flex flex-col gap-[24rpx]">
						<view class="flex flex-col gap-[16rpx]">
							<text class="text-[28rpx] text-[#999999]">æ“ä½œæ­¥éª¤</text>
							<view class="bg-[#f5f5f5] rounded-[16rpx] p-[24rpx]">
								<text class="text-[28rpx] text-[#646a73] leading-relaxed block">{{ subtaskInfo.steps }}</text>
							</view>
						</view>

						<view class="flex flex-col gap-[16rpx]">
							<text class="text-[28rpx] text-[#999999]">å‡­è¯è¦æ±‚</text>
							<view class="flex flex-row flex-wrap gap-[16rpx]">
								<view 
									v-for="(item, index) in subtaskInfo.proofTypes" 
									:key="index"
									class="bg-[#f0f9ff] px-[16rpx] py-[8rpx] rounded-[8rpx]"
								>
									<text class="text-[24rpx] text-[#07c160]">{{ item }}</text>
								</view>
							</view>
						</view>

						<view v-if="subtaskInfo.specialRequirement" class="flex flex-col gap-[16rpx]">
							<text class="text-[28rpx] text-[#999999]">ç‰¹æ®Šè¦æ±‚</text>
							<view class="bg-[#fff9e6] rounded-[16rpx] p-[24rpx]">
								<text class="text-[28rpx] text-[#646a73] leading-relaxed block">{{ subtaskInfo.specialRequirement }}</text>
							</view>
						</view>
					</view>
				</view>

				<!-- ä¸Šä¼ çš„å‡­è¯ -->
				<view v-if="subtaskInfo.proofImages && subtaskInfo.proofImages.length > 0" class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">ä¸Šä¼ çš„å‡­è¯</text>
					
					<view class="flex flex-row flex-wrap gap-[16rpx]">
						<view 
							v-for="(img, index) in subtaskInfo.proofImages" 
							:key="index"
							@click="previewImage(index)"
							class="w-[192rpx] h-[192rpx] rounded-[16rpx] overflow-hidden bg-[#f5f5f5]"
						>
							<image :src="img" class="w-full h-full" mode="aspectFill" />
						</view>
					</view>

					<view v-if="subtaskInfo.proofNote" class="bg-[#f5f5f5] rounded-[16rpx] p-[24rpx] mt-[24rpx]">
						<text class="text-[28rpx] text-[#646a73] leading-relaxed block">{{ subtaskInfo.proofNote }}</text>
					</view>
				</view>

				<!-- å‘å¸ƒå•†æˆ· -->
				<view class="bg-white rounded-[24rpx] p-[32rpx]">
					<text class="text-[32rpx] font-bold text-[#1f2329] mb-[24rpx] block">å‘å¸ƒå•†æˆ·</text>
					<view class="flex flex-row items-center gap-[24rpx]">
						<view class="w-[96rpx] h-[96rpx] rounded-full bg-[#f5f5f5] flex items-center justify-center">
							<text class="text-[48rpx]">{{ subtaskInfo.merchantAvatar }}</text>
						</view>
						<view class="flex-1 flex flex-col gap-[8rpx]">
							<text class="text-[32rpx] font-bold text-[#1f2329]">{{ subtaskInfo.merchantName }}</text>
							<view class="flex flex-row items-center gap-[16rpx]">
								<view class="bg-[#07c160] px-[16rpx] py-[4rpx] rounded-[8rpx]">
									<text class="text-[22rpx] text-white">{{ subtaskInfo.merchantLevel }}</text>
								</view>
								<text class="text-[24rpx] text-[#999999]">ä¿¡ç”¨åˆ†ï¼š{{ subtaskInfo.merchantCredit }}</text>
							</view>
						</view>
					</view>
				</view>
			</view>
		</scroll-view>

		<!-- åº•éƒ¨æ“ä½œæ  -->
		<view v-if="showActions" class="bg-white px-[32rpx] py-[24rpx] border-t-[2rpx] border-[#e5e5e5] pb-[calc(24rpx+env(safe-area-inset-bottom))]">
			<button 
				v-if="subtaskInfo.canUpload"
				@click="goToUpload"
				class="w-full bg-[#07c160] text-white rounded-full h-[88rpx] flex items-center justify-center"
			>
				<text class="text-[32rpx] font-bold">ä¸Šä¼ å‡­è¯</text>
			</button>
		</view>
	</view>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { getSubTaskDetail, cancelSubTask } from '@/services/task'

// å­ä»»åŠ¡ID
const subtaskId = ref(0)

// å­ä»»åŠ¡ä¿¡æ¯
const subtaskInfo = ref({
	subtaskNo: 'ST202501300001',
	status: 'ongoing',
	title: 'ç¾å›¢å¤–å–è®¢å•äº’åŠ©',
	description: 'éœ€è¦å¸®å¿™å®Œæˆç¾å›¢å¤–å–è®¢å•ï¼Œè¦æ±‚çœŸå®ä¸‹å•å¹¶ä¸Šä¼ æˆªå›¾',
	receiveTime: '2025-01-30 10:00:00',
	timeLimit: 24,
	remainTime: '23å°æ—¶30åˆ†',
	completeTime: '',
	category: 'å¤–å–',
	platform: 'ç¾å›¢',
	commission: '15.00',
	steps: '1. æ‰“å¼€ç¾å›¢APP\n2. æœç´¢æŒ‡å®šå•†å®¶\n3. ä¸‹å•æŒ‡å®šå•†å“\n4. å®Œæˆæ”¯ä»˜\n5. ä¸Šä¼ è®¢å•æˆªå›¾',
	proofTypes: ['è®¢å•æˆªå›¾', 'èŠå¤©è®°å½•'],
	specialRequirement: 'è¯·åœ¨ä¸‹å•å30åˆ†é’Ÿå†…ä¸Šä¼ æˆªå›¾',
	proofImages: [],
	proofNote: '',
	merchantAvatar: 'ğŸª',
	merchantName: 'ç¤ºä¾‹å•†æˆ·A',
	merchantLevel: 'VIP',
	merchantCredit: 98,
	canUpload: true
})

// æ˜¯å¦æ˜¾ç¤ºæ“ä½œæŒ‰é’®
const showActions = computed(() => {
	return subtaskInfo.value.canUpload
})

// åŠ è½½å­ä»»åŠ¡è¯¦æƒ…
const loadSubtaskDetail = async () => {
	try {
		uni.showLoading({ title: 'åŠ è½½ä¸­...' })
		
		const res = await getSubTaskDetail(subtaskId.value)
		
		uni.hideLoading()
		
		if (res.code === 0) {
			subtaskInfo.value = res.data
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: 'åŠ è½½å¤±è´¥',
			icon: 'none'
		})
	}
}

// è·å–çŠ¶æ€æ–‡æœ¬
const getStatusText = (status: string): string => {
	const statusMap = {
		ongoing: 'è¿›è¡Œä¸­',
		completed: 'å·²å®Œæˆ',
		cancelled: 'å·²å–æ¶ˆ',
		timeout: 'å·²è¶…æ—¶'
	}
	return statusMap[status] || 'æœªçŸ¥'
}

// è·å–çŠ¶æ€èƒŒæ™¯è‰²
const getStatusBgColor = (status: string): string => {
	const colorMap = {
		ongoing: 'bg-[#fff9e6]',
		completed: 'bg-[#f0f9ff]',
		cancelled: 'bg-[#fff5f5]',
		timeout: 'bg-[#f5f5f5]'
	}
	return colorMap[status] || 'bg-[#f5f5f5]'
}

// è·å–çŠ¶æ€æ–‡å­—é¢œè‰²
const getStatusTextColor = (status: string): string => {
	const colorMap = {
		ongoing: 'text-[#ff9500]',
		completed: 'text-[#07c160]',
		cancelled: 'text-[#ff3b30]',
		timeout: 'text-[#999]'
	}
	return colorMap[status] || 'text-[#999]'
}

// é¢„è§ˆå›¾ç‰‡
const previewImage = (index: number) => {
	uni.previewImage({
		urls: subtaskInfo.value.proofImages,
		current: index
	})
}

// ä¸Šä¼ å‡­è¯
const goToUpload = () => {
	uni.navigateTo({
		url: `/pages/task/subtask/upload?id=${subtaskId.value}`
	})
}

// é¡µé¢åŠ è½½æ—¶è·å–å­ä»»åŠ¡è¯¦æƒ…
onMounted(() => {
	// è·å–å­ä»»åŠ¡ID
	const pages = getCurrentPages()
	const currentPage = pages[pages.length - 1]
	// @ts-ignore
	subtaskId.value = parseInt(currentPage.options?.id || '0')
	
	if (subtaskId.value > 0) {
		loadSubtaskDetail()
	}
})
</script>

<style>
</style>
