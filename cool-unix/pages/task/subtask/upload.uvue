<template>
	<view class="flex flex-col h-full bg-[#f5f5f5]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="flex items-center justify-between px-4 py-3 bg-white">
			<view class="flex items-center" @click="goBack">
				<text class="text-6">â†</text>
				<text class="text-4 ml-2">ä¸Šä¼ å‡­è¯</text>
			</view>
		</view>

		<!-- å†…å®¹åŒºåŸŸ -->
		<scroll-view class="flex-1" scroll-y>
			<view class="px-4 py-4">
				<!-- ä»»åŠ¡ä¿¡æ¯ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-2">{{ taskInfo.title }}</text>
					<text class="text-3.5 text-[#646a73]">{{ taskInfo.description }}</text>
					
					<view class="flex items-center justify-between mt-3 pt-3 border-t border-[#e5e5e5]">
						<view>
							<text class="text-3 text-[#999]">ä½£é‡‘</text>
							<text class="text-5 font-bold text-[#ff3b30] ml-1">Â¥{{ taskInfo.commission }}</text>
						</view>
						<view>
							<text class="text-3 text-[#999]">å‰©ä½™æ—¶é—´</text>
							<text class="text-4 font-bold text-[#ff9500] ml-1">{{ taskInfo.remainTime }}</text>
						</view>
					</view>
				</view>

				<!-- å‡­è¯è¦æ±‚ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">å‡­è¯è¦æ±‚</text>
					
					<view class="mb-3">
						<text class="text-3.5 text-[#646a73] mb-2">éœ€è¦ä¸Šä¼ çš„å‡­è¯ç±»å‹</text>
						<view class="flex flex-wrap mt-2">
							<view 
								v-for="(item, index) in taskInfo.proofTypes" 
								:key="index"
								class="bg-[#f0f9ff] px-2 py-1 rounded mr-2 mb-2"
							>
								<text class="text-3 text-[#07c160]">{{ item }}</text>
							</view>
						</view>
					</view>

					<view v-if="taskInfo.specialRequirement" class="bg-[#fff9e6] rounded-2 p-3">
						<text class="text-3 text-[#ed6a0c] font-bold">ç‰¹æ®Šè¦æ±‚</text>
						<text class="text-3.5 text-[#646a73] mt-1">{{ taskInfo.specialRequirement }}</text>
					</view>
				</view>

				<!-- ä¸Šä¼ å›¾ç‰‡ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">ä¸Šä¼ å›¾ç‰‡ <text class="text-[#ff3b30]">*</text></text>
					
					<view class="flex flex-wrap">
						<view 
							v-for="(img, index) in uploadedImages" 
							:key="index"
							class="w-24 h-24 rounded-2 mr-2 mb-2 overflow-hidden relative"
						>
							<image :src="img" class="w-full h-full" mode="aspectFill" />
							<view 
								@click="removeImage(index)"
								class="absolute top-1 right-1 w-6 h-6 bg-black/50 rounded-full flex items-center justify-center"
							>
								<text class="text-3 text-white">Ã—</text>
							</view>
						</view>
						
						<view 
							v-if="uploadedImages.length < 9"
							@click="chooseImage"
							class="w-24 h-24 border-2 border-dashed border-[#e5e5e5] rounded-2 flex flex-col items-center justify-center bg-[#fafafa]"
						>
							<text class="text-8 text-[#c8c9cc]">+</text>
							<text class="text-3 text-[#c8c9cc] mt-1">{{ uploadedImages.length }}/9</text>
						</view>
					</view>

					<text class="text-3 text-[#999] mt-2">â€¢ æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡</text>
					<text class="text-3 text-[#999] mt-1">â€¢ è¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°å¯è§</text>
				</view>

				<!-- æ–‡å­—è¯´æ˜ -->
				<view class="bg-white rounded-2 p-4 mb-3">
					<text class="text-4 font-bold text-[#1f2329] mb-3">æ–‡å­—è¯´æ˜</text>
					
					<textarea 
						v-model="proofNote"
						class="border border-[#e5e5e5] rounded-2 px-3 py-2.5 text-4"
						placeholder="è¯·è¡¥å……è¯´æ˜ä»»åŠ¡å®Œæˆæƒ…å†µï¼ˆé€‰å¡«ï¼‰"
						placeholder-class="text-[#c8c9cc]"
						:maxlength="200"
						:show-confirm-bar="false"
						style="height: 100px;"
					/>
					<text class="text-3 text-[#999] mt-1">{{ proofNote.length }}/200</text>
				</view>

				<!-- æ¸©é¦¨æç¤º -->
				<view class="bg-[#fff9e6] rounded-2 p-4 mb-3">
					<text class="text-3.5 text-[#ed6a0c] font-bold mb-2">ğŸ’¡ æ¸©é¦¨æç¤º</text>
					<text class="text-3.5 text-[#646a73] mt-2">â€¢ è¯·æŒ‰è¦æ±‚ä¸Šä¼ çœŸå®æœ‰æ•ˆçš„å‡­è¯</text>
					<text class="text-3.5 text-[#646a73] mt-1">â€¢ ä¸Šä¼ è™šå‡å‡­è¯å°†è¢«å°å·å¤„ç†</text>
					<text class="text-3.5 text-[#646a73] mt-1">â€¢ æäº¤åç­‰å¾…å•†æˆ·ç¡®è®¤</text>
					<text class="text-3.5 text-[#646a73] mt-1">â€¢ ç¡®è®¤é€šè¿‡åä½£é‡‘è‡ªåŠ¨åˆ°è´¦</text>
				</view>
			</view>
		</scroll-view>

		<!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
		<view class="bg-white px-4 py-3 border-t border-[#e5e5e5]">
			<button 
				@click="submitProof"
				:class="['w-full rounded-full py-3', canSubmit ? 'bg-[#07c160] text-white' : 'bg-[#e5e5e5] text-[#999]']"
				:disabled="!canSubmit"
			>
				<text class="text-4">æäº¤å‡­è¯</text>
			</button>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, computed, onMounted } from 'vue'
import { getSubTaskDetail, uploadProof } from '@/services/task'

// å­ä»»åŠ¡ID
const subtaskId = ref(0)

// ä»»åŠ¡ä¿¡æ¯
const taskInfo = ref({
	title: 'ç¾å›¢å¤–å–è®¢å•äº’åŠ©',
	description: 'éœ€è¦å¸®å¿™å®Œæˆç¾å›¢å¤–å–è®¢å•ï¼Œè¦æ±‚çœŸå®ä¸‹å•å¹¶ä¸Šä¼ æˆªå›¾',
	commission: '15.00',
	remainTime: '23å°æ—¶30åˆ†',
	proofTypes: ['è®¢å•æˆªå›¾', 'èŠå¤©è®°å½•'],
	specialRequirement: 'è¯·åœ¨ä¸‹å•å30åˆ†é’Ÿå†…ä¸Šä¼ æˆªå›¾'
})

// å·²ä¸Šä¼ çš„å›¾ç‰‡
const uploadedImages = ref<string[]>([])

// æ–‡å­—è¯´æ˜
const proofNote = ref('')

// åˆ¤æ–­æ˜¯å¦å¯ä»¥æäº¤
const canSubmit = computed(() => {
	return uploadedImages.value.length > 0
})

// åŠ è½½ä»»åŠ¡ä¿¡æ¯
const loadTaskInfo = async () => {
	try {
		const res = await getSubTaskDetail(subtaskId.value)
		if (res.code === 0) {
			taskInfo.value = res.data
		}
	} catch (error) {
		console.log('åŠ è½½ä»»åŠ¡ä¿¡æ¯å¤±è´¥', error)
	}
}

// é€‰æ‹©å›¾ç‰‡
const chooseImage = () => {
	const remainCount = 9 - uploadedImages.value.length
	
	uni.chooseImage({
		count: remainCount,
		sizeType: ['compressed'],
		sourceType: ['album', 'camera'],
		success: (res) => {
			const tempFilePaths = res.tempFilePaths
			
			// è¿™é‡Œåº”è¯¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œæš‚æ—¶ç›´æ¥ä½¿ç”¨æœ¬åœ°è·¯å¾„
			uploadedImages.value = uploadedImages.value.concat(tempFilePaths)
			
			// TODO: å®é™…é¡¹ç›®ä¸­åº”è¯¥ä¸Šä¼ åˆ°æœåŠ¡å™¨
			// uploadFiles(tempFilePaths).then(urls => {
			//   uploadedImages.value = uploadedImages.value.concat(urls)
			// })
		}
	})
}

// ç§»é™¤å›¾ç‰‡
const removeImage = (index: number) => {
	uploadedImages.value.splice(index, 1)
}

// æäº¤å‡­è¯
const submitProof = async () => {
	if (!canSubmit.value) return
	
	try {
		uni.showLoading({ title: 'æäº¤ä¸­...' })
		
		const res = await uploadProof({
			subtaskId: subtaskId.value,
			images: uploadedImages.value,
			note: proofNote.value
		})
		
		uni.hideLoading()
		
		if (res.code === 0) {
			uni.showToast({
				title: 'æäº¤æˆåŠŸ',
				icon: 'success'
			})
			
			// è¿”å›ä¸Šä¸€é¡µ
			setTimeout(() => {
				uni.navigateBack()
			}, 1500)
		} else {
			uni.showToast({
				title: res.msg || 'æäº¤å¤±è´¥',
				icon: 'none'
			})
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•',
			icon: 'none'
		})
	}
}

// è¿”å›
const goBack = () => {
	if (uploadedImages.value.length > 0 || proofNote.value) {
		uni.showModal({
			title: 'æç¤º',
			content: 'ç¡®å®šè¦æ”¾å¼ƒå½“å‰ç¼–è¾‘çš„å†…å®¹å—ï¼Ÿ',
			success: (res) => {
				if (res.confirm) {
					uni.navigateBack()
				}
			}
		})
	} else {
		uni.navigateBack()
	}
}

// é¡µé¢åŠ è½½æ—¶è·å–ä»»åŠ¡ä¿¡æ¯
onMounted(() => {
	// è·å–å­ä»»åŠ¡ID
	const pages = getCurrentPages()
	const currentPage = pages[pages.length - 1]
	// @ts-ignore
	subtaskId.value = parseInt(currentPage.options?.id || '0')
	
	if (subtaskId.value > 0) {
		loadTaskInfo()
	}
})
</script>
