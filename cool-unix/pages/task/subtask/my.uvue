<template>
	<view class="flex flex-col h-screen bg-[#f5f7fa]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<cl-topbar title="æˆ‘æ¥çš„ä»»åŠ¡" :show-back="true" background-color="#ffffff" color="#1f2329" safe-area-top></cl-topbar>

		<!-- æ ‡ç­¾æ  -->
		<view class="bg-white px-[32rpx] py-[24rpx] mb-[16rpx]">
			<view class="flex flex-row">
				<view 
					v-for="(tab, index) in tabs" 
					:key="index"
					@click="selectTab(tab.value)"
					class="flex-1 flex flex-col items-center justify-center"
				>
					<text :class="['text-[30rpx]', currentTab === tab.value ? 'text-[#07c160] font-bold' : 'text-[#646a73]']">
						{{ tab.label }}
					</text>
					<view v-if="currentTab === tab.value" class="w-[64rpx] h-[4rpx] bg-[#07c160] rounded-full mt-[16rpx]"></view>
				</view>
			</view>
		</view>

		<!-- å­ä»»åŠ¡åˆ—è¡¨ -->
		<scroll-view class="flex-1 h-0" scroll-y @scrolltolower="loadMore">
			<view class="px-[32rpx] py-[16rpx] flex flex-col gap-[24rpx]">
				<view 
					v-for="(task, index) in subtaskList" 
					:key="index"
					@click="goToDetail(task.id)"
					class="bg-white rounded-[24rpx] p-[32rpx]"
				>
					<!-- ä»»åŠ¡å¤´éƒ¨ -->
					<view class="flex flex-row items-center justify-between mb-[24rpx]">
						<text class="text-[26rpx] text-[#999999]">{{ task.createTime }}</text>
						<view :class="['px-[16rpx] py-[8rpx] rounded-[8rpx]', getStatusColor(task.status)]">
							<text class="text-[24rpx] text-white">{{ getStatusText(task.status) }}</text>
						</view>
					</view>

					<!-- ä»»åŠ¡ä¿¡æ¯ -->
					<view class="mb-[24rpx]">
						<text class="text-[34rpx] font-bold text-[#1f2329] block">{{ task.title }}</text>
						<text class="text-[28rpx] text-[#646a73] mt-[16rpx] block leading-relaxed">{{ task.description }}</text>
					</view>

					<!-- ä»»åŠ¡æ ‡ç­¾ -->
					<view class="flex flex-row flex-wrap mb-[24rpx] gap-[16rpx]">
						<view class="bg-[#f0f9ff] px-[16rpx] py-[8rpx] rounded-[8rpx]">
							<text class="text-[24rpx] text-[#07c160]">{{ task.category }}</text>
						</view>
						<view class="bg-[#fff9e6] px-[16rpx] py-[8rpx] rounded-[8rpx]">
							<text class="text-[24rpx] text-[#ed6a0c]">{{ task.platform }}</text>
						</view>
						<view class="bg-[#f5f5f5] px-[16rpx] py-[8rpx] rounded-[8rpx]">
							<text class="text-[24rpx] text-[#646a73]">ç¼–å·ï¼š{{ task.subtaskNo }}</text>
						</view>
					</view>

					<!-- ä»»åŠ¡æ•°æ® -->
					<view class="flex flex-row items-center justify-between border-t-[2rpx] border-[#e5e5e5] pt-[24rpx]">
						<view class="flex-1 flex flex-row items-baseline">
							<text class="text-[24rpx] text-[#999999]">ä½£é‡‘</text>
							<text class="text-[36rpx] font-bold text-[#ff3b30] ml-[8rpx]">Â¥{{ task.commission }}</text>
						</view>
						<view class="flex-1 flex flex-row items-baseline">
							<text class="text-[24rpx] text-[#999999]">å‰©ä½™æ—¶é—´</text>
							<text class="text-[30rpx] font-bold text-[#ff9500] ml-[8rpx]">{{ task.remainTime }}</text>
						</view>
						<view class="flex-1 flex justify-end">
							<button 
								v-if="task.canUpload"
								@click.stop="goToUpload(task.id)"
								class="bg-[#07c160] text-white rounded-full px-[32rpx] h-[64rpx] flex items-center justify-center m-0"
							>
								<text class="text-[26rpx]">ä¸Šä¼ å‡­è¯</text>
							</button>
						</view>
					</view>
				</view>

				<!-- åŠ è½½æ›´å¤š -->
				<view v-if="loading" class="flex justify-center py-[32rpx]">
					<text class="text-[26rpx] text-[#999999]">åŠ è½½ä¸­...</text>
				</view>
				<view v-if="!hasMore && subtaskList.length > 0" class="flex justify-center py-[32rpx]">
					<text class="text-[26rpx] text-[#999999]">æ²¡æœ‰æ›´å¤šäº†</text>
				</view>
				<view v-if="subtaskList.length === 0 && !loading" class="flex flex-col items-center justify-center py-[160rpx] gap-[24rpx]">
					<text class="text-[80rpx]">ğŸ“‹</text>
					<text class="text-[32rpx] text-[#999999]">æš‚æ— ä»»åŠ¡</text>
				</view>
			</view>
		</scroll-view>
	</view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { getMySubTasks } from '@/services/task'

// å½“å‰æ ‡ç­¾
const currentTab = ref('all')

// æ ‡ç­¾åˆ—è¡¨
const tabs = [
	{ label: 'å…¨éƒ¨', value: 'all' },
	{ label: 'è¿›è¡Œä¸­', value: 'ongoing' },
	{ label: 'å·²å®Œæˆ', value: 'completed' },
	{ label: 'å·²å–æ¶ˆ', value: 'cancelled' }
]

// å­ä»»åŠ¡åˆ—è¡¨
const subtaskList = ref([])

// åŠ è½½çŠ¶æ€
const loading = ref(false)
const hasMore = ref(true)
const page = ref(1)

// é€‰æ‹©æ ‡ç­¾
const selectTab = (value: string) => {
	currentTab.value = value
	page.value = 1
	subtaskList.value = []
	loadSubtaskList()
}

// åŠ è½½å­ä»»åŠ¡åˆ—è¡¨
const loadSubtaskList = async () => {
	if (loading.value) return
	
	try {
		loading.value = true
		
		const res = await getMySubTasks({
			status: currentTab.value,
			page: page.value,
			pageSize: 10
		})
		
		loading.value = false
		
		if (res.code === 0) {
			if (page.value === 1) {
				subtaskList.value = res.data.list
			} else {
				subtaskList.value = subtaskList.value.concat(res.data.list)
			}
			hasMore.value = res.data.hasMore
		}
	} catch (error) {
		loading.value = false
		console.log('åŠ è½½å­ä»»åŠ¡åˆ—è¡¨å¤±è´¥', error)
	}
}

// åŠ è½½æ›´å¤š
const loadMore = () => {
	if (!loading.value && hasMore.value) {
		page.value++
		loadSubtaskList()
	}
}

// è·å–çŠ¶æ€æ–‡æœ¬
const getStatusText = (status: string): string => {
	const statusMap = {
		ongoing: 'è¿›è¡Œä¸­',
		completed: 'å·²å®Œæˆ',
		cancelled: 'å·²å–æ¶ˆ',
		timeout: 'å·²è¶…æ—¶'
	}
	return statusMap[status] || 'æœªçŸ¥'
}

// è·å–çŠ¶æ€é¢œè‰²
const getStatusColor = (status: string): string => {
	const colorMap = {
		ongoing: 'bg-[#ff9500]',
		completed: 'bg-[#07c160]',
		cancelled: 'bg-[#ff3b30]',
		timeout: 'bg-[#999]'
	}
	return colorMap[status] || 'bg-[#999]'
}

// è¿›å…¥å­ä»»åŠ¡è¯¦æƒ…
const goToDetail = (id: number) => {
	uni.navigateTo({
		url: `/pages/task/subtask/detail?id=${id}`
	})
}

// ä¸Šä¼ å‡­è¯
const goToUpload = (id: number) => {
	uni.navigateTo({
		url: `/pages/task/subtask/upload?id=${id}`
	})
}

// é¡µé¢åŠ è½½æ—¶è·å–å­ä»»åŠ¡åˆ—è¡¨
onMounted(() => {
	loadSubtaskList()
})
</script>

<style>
</style>
