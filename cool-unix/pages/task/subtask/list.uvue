<template>
	<view class="flex flex-col h-full bg-[#f5f5f5]">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="flex items-center justify-between px-4 py-3 bg-white">
			<view class="flex items-center" @click="goBack">
				<text class="text-6">â†</text>
				<text class="text-4 ml-2">å¯æ¥å­ä»»åŠ¡</text>
			</view>
		</view>

		<!-- ç­›é€‰æ  -->
		<view class="bg-white px-4 py-3 mb-2">
			<view class="flex items-center justify-between">
				<text class="text-4 text-[#1f2329]">å…± {{ totalCount }} ä¸ªå¯æ¥ä»»åŠ¡</text>
				<view @click="showFilterDialog = true" class="flex items-center">
					<text class="text-3.5 text-[#07c160]">ç­›é€‰</text>
					<text class="text-4 text-[#07c160] ml-1">âš™</text>
				</view>
			</view>
		</view>

		<!-- å­ä»»åŠ¡åˆ—è¡¨ -->
		<scroll-view class="flex-1" scroll-y @scrolltolower="loadMore">
			<view class="px-4 py-2">
				<view 
					v-for="(task, index) in subtaskList" 
					:key="index"
					@click="goToDetail(task.id)"
					class="bg-white rounded-2 p-4 mb-3"
				>
					<!-- ä»»åŠ¡å¤´éƒ¨ -->
					<view class="flex items-center justify-between mb-3">
						<view class="flex items-center">
							<view class="bg-[#f0f9ff] px-2 py-1 rounded mr-2">
								<text class="text-3 text-[#07c160]">{{ task.category }}</text>
							</view>
							<view class="bg-[#fff9e6] px-2 py-1 rounded">
								<text class="text-3 text-[#ed6a0c]">{{ task.platform }}</text>
							</view>
						</view>
						<text class="text-3 text-[#999]">{{ task.createTime }}</text>
					</view>

					<!-- ä»»åŠ¡ä¿¡æ¯ -->
					<view class="mb-3">
						<text class="text-4.5 font-bold text-[#1f2329]">{{ task.title }}</text>
						<text class="text-3.5 text-[#646a73] mt-2">{{ task.description }}</text>
					</view>

					<!-- ä»»åŠ¡è¦æ±‚ -->
					<view class="flex flex-wrap mb-3">
						<view class="flex items-center mr-3 mb-2">
							<text class="text-3 text-[#999]">â° {{ task.timeLimit }}å°æ—¶</text>
						</view>
						<view class="flex items-center mr-3 mb-2">
							<text class="text-3 text-[#999]">ğŸ“¸ {{ task.proofCount }}å¼ å‡­è¯</text>
						</view>
					</view>

					<!-- ä»»åŠ¡æ•°æ® -->
					<view class="flex items-center justify-between border-t border-[#e5e5e5] pt-3">
						<view>
							<text class="text-3 text-[#999]">ä½£é‡‘</text>
							<text class="text-6 font-bold text-[#ff3b30] ml-1">Â¥{{ task.commission }}</text>
						</view>
						<button 
							@click.stop="receiveTask(task.id)"
							class="bg-[#07c160] text-white rounded-full px-6 py-2"
						>
							<text class="text-3.5">ç«‹å³æ¥å•</text>
						</button>
					</view>
				</view>

				<!-- åŠ è½½æ›´å¤š -->
				<view v-if="loading" class="flex justify-center py-4">
					<text class="text-3.5 text-[#999]">åŠ è½½ä¸­...</text>
				</view>
				<view v-if="!hasMore && subtaskList.length > 0" class="flex justify-center py-4">
					<text class="text-3.5 text-[#999]">æ²¡æœ‰æ›´å¤šäº†</text>
				</view>
				<view v-if="subtaskList.length === 0 && !loading" class="flex flex-col items-center justify-center py-20">
					<text class="text-10 mb-3">ğŸ“‹</text>
					<text class="text-4 text-[#999]">æš‚æ— å¯æ¥ä»»åŠ¡</text>
				</view>
			</view>
		</scroll-view>

		<!-- ç­›é€‰å¯¹è¯æ¡† -->
		<view v-if="showFilterDialog" class="fixed inset-0 bg-black/50 flex items-end" @click="showFilterDialog = false">
			<view class="bg-white w-full rounded-t-3 p-4" @click.stop>
				<text class="text-4 font-bold text-[#1f2329] mb-4">ç­›é€‰æ¡ä»¶</text>
				
				<view class="mb-4">
					<text class="text-3.5 text-[#646a73] mb-2">ä»»åŠ¡ç±»ç›®</text>
					<view class="flex flex-wrap mt-2">
						<view 
							v-for="(item, index) in categories" 
							:key="index"
							@click="filter.category = item"
							:class="['border rounded-full px-4 py-2 mr-2 mb-2', filter.category === item ? 'border-[#07c160] bg-[#f0f9ff]' : 'border-[#e5e5e5]']"
						>
							<text :class="['text-3.5', filter.category === item ? 'text-[#07c160]' : 'text-[#646a73]']">{{ item }}</text>
						</view>
					</view>
				</view>

				<view class="mb-4">
					<text class="text-3.5 text-[#646a73] mb-2">ä½£é‡‘èŒƒå›´</text>
					<view class="flex flex-wrap mt-2">
						<view 
							v-for="(item, index) in commissionRanges" 
							:key="index"
							@click="filter.commissionRange = item.value"
							:class="['border rounded-full px-4 py-2 mr-2 mb-2', filter.commissionRange === item.value ? 'border-[#07c160] bg-[#f0f9ff]' : 'border-[#e5e5e5]']"
						>
							<text :class="['text-3.5', filter.commissionRange === item.value ? 'text-[#07c160]' : 'text-[#646a73]']">{{ item.label }}</text>
						</view>
					</view>
				</view>

				<view class="flex">
					<button 
						@click="resetFilter"
						class="flex-1 bg-[#f5f5f5] text-[#646a73] rounded-full py-3 mr-2"
					>
						<text class="text-4">é‡ç½®</text>
					</button>
					<button 
						@click="applyFilter"
						class="flex-1 bg-[#07c160] text-white rounded-full py-3"
					>
						<text class="text-4">ç¡®å®š</text>
					</button>
				</view>
			</view>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { getAvailableSubTasks, acceptSubTask } from '@/services/task'

// ä»»åŠ¡IDï¼ˆå¯é€‰ï¼‰
const taskId = ref(0)

// æ€»æ•°é‡
const totalCount = ref(0)

// å­ä»»åŠ¡åˆ—è¡¨
const subtaskList = ref([])

// åŠ è½½çŠ¶æ€
const loading = ref(false)
const hasMore = ref(true)
const page = ref(1)

// æ˜¾ç¤ºç­›é€‰å¯¹è¯æ¡†
const showFilterDialog = ref(false)

// ç­›é€‰æ¡ä»¶
const filter = ref({
	category: 'å…¨éƒ¨',
	commissionRange: 'all'
})

// åˆ†ç±»åˆ—è¡¨
const categories = ['å…¨éƒ¨', 'ç”µå•†', 'å¤–å–', 'å‡ºè¡Œ', 'ç”Ÿæ´»', 'å…¶ä»–']

// ä½£é‡‘èŒƒå›´
const commissionRanges = [
	{ label: 'å…¨éƒ¨', value: 'all' },
	{ label: '10å…ƒä»¥ä¸‹', value: '0-10' },
	{ label: '10-20å…ƒ', value: '10-20' },
	{ label: '20-50å…ƒ', value: '20-50' },
	{ label: '50å…ƒä»¥ä¸Š', value: '50-' }
]

// åŠ è½½å­ä»»åŠ¡åˆ—è¡¨
const loadSubtaskList = async () => {
	if (loading.value) return
	
	try {
		loading.value = true
		
		const res = await getAvailableSubTasks({
			taskId: taskId.value,
			category: filter.value.category === 'å…¨éƒ¨' ? '' : filter.value.category,
			commissionRange: filter.value.commissionRange,
			page: page.value,
			pageSize: 10
		})
		
		loading.value = false
		
		if (res.code === 0) {
			if (page.value === 1) {
				subtaskList.value = res.data.list
			} else {
				subtaskList.value = subtaskList.value.concat(res.data.list)
			}
			totalCount.value = res.data.total
			hasMore.value = res.data.hasMore
		}
	} catch (error) {
		loading.value = false
		console.log('åŠ è½½å­ä»»åŠ¡åˆ—è¡¨å¤±è´¥', error)
	}
}

// åŠ è½½æ›´å¤š
const loadMore = () => {
	if (!loading.value && hasMore.value) {
		page.value++
		loadSubtaskList()
	}
}

// æ¥å•
const receiveTask = async (id: number) => {
	try {
		uni.showLoading({ title: 'æ¥å•ä¸­...' })
		
		const res = await acceptSubTask(id)
		
		uni.hideLoading()
		
		if (res.code === 0) {
			uni.showToast({
				title: 'æ¥å•æˆåŠŸ',
				icon: 'success'
			})
			
			// è·³è½¬åˆ°å­ä»»åŠ¡è¯¦æƒ…
			setTimeout(() => {
				uni.navigateTo({
					url: `/pages/task/subtask/detail?id=${id}`
				})
			}, 1500)
		} else {
			uni.showToast({
				title: res.msg || 'æ¥å•å¤±è´¥',
				icon: 'none'
			})
		}
	} catch (error) {
		uni.hideLoading()
		uni.showToast({
			title: 'æ¥å•å¤±è´¥',
			icon: 'none'
		})
	}
}

// é‡ç½®ç­›é€‰
const resetFilter = () => {
	filter.value = {
		category: 'å…¨éƒ¨',
		commissionRange: 'all'
	}
}

// åº”ç”¨ç­›é€‰
const applyFilter = () => {
	showFilterDialog.value = false
	page.value = 1
	subtaskList.value = []
	loadSubtaskList()
}

// è¿›å…¥å­ä»»åŠ¡è¯¦æƒ…
const goToDetail = (id: number) => {
	uni.navigateTo({
		url: `/pages/task/subtask/detail?id=${id}`
	})
}

// è¿”å›
const goBack = () => {
	uni.navigateBack()
}

// é¡µé¢åŠ è½½æ—¶è·å–å­ä»»åŠ¡åˆ—è¡¨
onMounted(() => {
	// è·å–ä»»åŠ¡IDï¼ˆå¯é€‰ï¼‰
	const pages = getCurrentPages()
	const currentPage = pages[pages.length - 1]
	// @ts-ignore
	taskId.value = parseInt(currentPage.options?.taskId || '0')
	
	loadSubtaskList()
})
</script>
