<template>
	<view class="page-container">
		<!-- é¡¶éƒ¨å¯¼èˆª -->
		<view class="top-bar">
			<text class="title">æ—ºé“ºé›†</text>
			<view class="actions">
				<text class="icon">ğŸ“·</text>
				<text class="icon">ğŸ””</text>
			</view>
		</view>

		<!-- ä½™é¢å¡ç‰‡ -->
		<view class="balance-card">
			<view class="balance-row">
				<view class="balance-item">
					<text class="amount-large">Â¥{{ formatMoney(statistics.wallet.balance) }}</text>
					<text class="label">å¯ç”¨ä½™é¢</text>
				</view>
				<view class="balance-item">
					<text class="amount-medium">Â¥{{ formatMoney(statistics.wallet.frozen) }}</text>
					<text class="label">å†»ç»“é‡‘é¢</text>
				</view>
				<view class="balance-item">
					<text class="amount-medium">Â¥{{ formatMoney(statistics.wallet.pending) }}</text>
					<text class="label">å¾…ç»“ç®—</text>
				</view>
			</view>

			<!-- å¿«æ·å…¥å£ -->
			<view class="quick-actions">
				<view class="action-item" @tap="goToPage('/pages/merchant/register')">
					<view class="action-icon">
						<text class="emoji">ğŸ“„</text>
					</view>
					<text class="action-label">è¿›ä»¶</text>
				</view>
				<view class="action-item" @tap="goToPage('/pages/task/create')">
					<view class="action-icon">
						<text class="emoji">ğŸ“¢</text>
					</view>
					<text class="action-label">å‘å¸ƒä»»åŠ¡</text>
				</view>
				<view class="action-item" @tap="goToPage('/pages/wallet/recharge')">
					<view class="action-icon">
						<text class="emoji">â•</text>
					</view>
					<text class="action-label">å……å€¼</text>
				</view>
				<view class="action-item" @tap="goToPage('/pages/wallet/withdraw')">
					<view class="action-icon">
						<text class="emoji">ğŸ’³</text>
					</view>
					<text class="action-label">æç°</text>
				</view>
				<view class="action-item" @tap="goToPage('/pages/promo/invite')">
					<view class="action-icon">
						<text class="emoji">ğŸ‘¥</text>
					</view>
					<text class="action-label">é‚€è¯·</text>
				</view>
			</view>
		</view>

		<!-- å¾…åŠäº‹é¡¹ -->
		<view class="section">
			<text class="section-title">å¾…åŠäº‹é¡¹</text>
			<view class="todo-row">
				<view class="todo-card">
					<text class="todo-number primary">{{ statistics.todo.pending_merchant }}</text>
					<text class="todo-label">å¾…å®¡æ ¸è¿›ä»¶</text>
				</view>
				<view class="todo-card">
					<text class="todo-number warning">{{ statistics.todo.pending_task }}</text>
					<text class="todo-label">å¾…éªŒæ”¶ä»»åŠ¡</text>
				</view>
				<view class="todo-card">
					<text class="todo-number danger">{{ statistics.todo.pending_withdraw }}</text>
					<text class="todo-label">å¾…å¤„ç†æç°</text>
				</view>
			</view>
		</view>

		<!-- ä»Šæ—¥æ•°æ® -->
		<view class="section">
			<view class="data-card">
				<text class="section-title">ä»Šæ—¥æ•°æ®</text>
				<view class="data-row">
					<view class="data-item bg-blue">
						<text class="data-number primary">{{ statistics.today.accepted }}</text>
						<text class="data-label">å·²æ¥ä»»åŠ¡</text>
					</view>
					<view class="data-item bg-green">
						<text class="data-number success">{{ statistics.today.completed }}</text>
						<text class="data-label">å·²å®Œæˆ</text>
					</view>
					<view class="data-item bg-yellow">
						<text class="data-number warning">Â¥{{ formatMoney(statistics.today.income) }}</text>
						<text class="data-label">ä»Šæ—¥æ”¶å…¥</text>
					</view>
				</view>
			</view>
		</view>

		<!-- å¹³å°åŠ¨æ€ -->
		<view class="section news-section">
			<view class="news-card">
				<view class="news-header">
					<text class="section-title">å¹³å°åŠ¨æ€</text>
					<text class="more-link">æŸ¥çœ‹æ›´å¤š ></text>
				</view>
				<view class="news-list">
					<view class="news-item" v-for="(item, index) in statistics.news" :key="index">
						<view class="dot" :class="item.type"></view>
						<view class="news-content">
							<text class="news-title">{{ item.title }}</text>
							<text class="news-date">{{ formatDate(item.createtime) }}</text>
						</view>
					</view>
				</view>
			</view>
		</view>

		<!-- åº•éƒ¨å¯¼èˆªæ  -->
		<view class="tabbar">
			<view class="tab-item active" @tap="goToPage('/pages/index/home')">
				<text class="tab-icon">ğŸ </text>
				<text class="tab-label active">é¦–é¡µ</text>
			</view>
			<view class="tab-item" @tap="goToPage('/pages/task/index')">
				<text class="tab-icon">ğŸ“‹</text>
				<text class="tab-label">ä»»åŠ¡</text>
			</view>
			<view class="tab-item" @tap="goToPage('/pages/promo/index')">
				<text class="tab-icon">ğŸ‘¥</text>
				<text class="tab-label">æ¨å¹¿</text>
			</view>
			<view class="tab-item" @tap="goToPage('/pages/merchant/index')">
				<text class="tab-icon">ï¿½</text>
				<text class="tab-label">æˆ‘çš„</text>
			</view>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue';
import { getStatistics } from '@/services/index';

// å®šä¹‰ç»„ä»¶é€‰é¡¹
defineOptions({
	name: 'PageHomeSimple'
});

// ç»Ÿè®¡æ•°æ®
const statistics = ref({
	wallet: {
		balance: 0,
		frozen: 0,
		pending: 0
	},
	todo: {
		pending_merchant: 0,
		pending_task: 0,
		pending_withdraw: 0
	},
	today: {
		accepted: 0,
		completed: 0,
		income: 0
	},
	news: [] as any[]
});

// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadStatistics() {
	try {
		const data = await getStatistics();
		statistics.value = data;
	} catch (err: any) {
		console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥', err);
		uni.showToast({
			title: err.message || 'åŠ è½½å¤±è´¥',
			icon: 'none'
		});
	}
}

// æ ¼å¼åŒ–é‡‘é¢
function formatMoney(amount: number): string {
	return amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(timestamp: number): string {
	const date = new Date(timestamp * 1000);
	const year = date.getFullYear();
	const month = String(date.getMonth() + 1).padStart(2, '0');
	const day = String(date.getDate()).padStart(2, '0');
	return `${year}-${month}-${day}`;
}

// é¡µé¢è·³è½¬
function goToPage(url: string) {
	uni.navigateTo({
		url: url
	});
}

// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
onMounted(() => {
	loadStatistics();
});
</script>

<style>
.page-container {
	display: flex;
	flex-direction: column;
	background-color: #f5f7fa;
	min-height: 100vh;
	padding-bottom: 120rpx;
}

/* é¡¶éƒ¨å¯¼èˆª */
.top-bar {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	align-items: center;
	height: 112rpx; /* 56px */
	background-color: #0052d9;
	padding: 0 32rpx; /* 16px */
}

.title {
	font-size: 36rpx; /* 18px */
	font-weight: 600;
	color: #ffffff;
	font-family: 'Inter', sans-serif;
}

.actions {
	display: flex;
	flex-direction: row;
	gap: 32rpx; /* 16px */
}

.icon {
	font-size: 48rpx;
	color: #ffffff;
}

/* ä½™é¢å¡ç‰‡ */
.balance-card {
	background-color: #0052d9;
	padding: 40rpx 32rpx 48rpx 32rpx; /* 20px 16px 24px 16px */
	display: flex;
	flex-direction: column;
	gap: 32rpx; /* 16px */
}

.balance-row {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
}

.balance-item {
	display: flex;
	flex-direction: column;
	align-items: center;
}

.amount-large {
	font-size: 48rpx;
	font-weight: 700;
	color: #ffffff;
}

.amount-medium {
	font-size: 32rpx;
	font-weight: 600;
	color: #ffffff;
}

.label {
	font-size: 24rpx;
	color: rgba(255, 255, 255, 0.7);
	margin-top: 8rpx;
}

/* å¿«æ·å…¥å£ */
.quick-actions {
	display: flex;
	flex-direction: row;
	justify-content: space-around;
	/* Removed margin-top as it is handled by balance-card gap */
}

.action-item {
	display: flex;
	flex-direction: column;
	align-items: center;
}

.action-icon {
	width: 88rpx;
	height: 88rpx;
	background-color: rgba(255, 255, 255, 0.2);
	border-radius: 50%;
	display: flex;
	align-items: center;
	justify-content: center;
}

.emoji {
	font-size: 44rpx;
}

.action-label {
	font-size: 24rpx;
	color: #ffffff;
	margin-top: 12rpx;
}

/* é€šç”¨åŒºå— */
.section {
	padding: 32rpx 32rpx 0 32rpx; /* 16px 16px 0 16px */
	display: flex;
	flex-direction: column;
	gap: 24rpx; /* 12px */
}

.section-title {
	font-size: 32rpx; /* 16px */
	font-weight: 600;
	color: #1f2329;
}

/* å¾…åŠäº‹é¡¹ */
.todo-row {
	display: flex;
	flex-direction: row;
	gap: 24rpx; /* 12px */
}

.todo-card {
	flex: 1;
	background-color: #ffffff;
	border-radius: 24rpx; /* 12px */
	padding: 32rpx; /* 16px */
	display: flex;
	flex-direction: column;
	align-items: center;
}

.todo-number {
	font-size: 56rpx;
	font-weight: 700;
}

.todo-number.primary {
	color: #0052d9;
}

.todo-number.warning {
	color: #faad14;
}

.todo-number.danger {
	color: #e34d59;
}

.todo-label {
	font-size: 26rpx;
	color: #646a73;
	margin-top: 16rpx;
}

/* ä»Šæ—¥æ•°æ® */
.data-card {
	background-color: #ffffff;
	border-radius: 24rpx; /* 12px */
	padding: 32rpx; /* 16px */
}

.data-row {
	display: flex;
	flex-direction: row;
	gap: 16rpx; /* 8px? Design says gap 12 for cards, checking data-row specifically */
	margin-top: 24rpx;
}

.data-item {
	flex: 1;
	border-radius: 16rpx;
	padding: 24rpx;
	display: flex;
	flex-direction: column;
	align-items: center;
}

.data-item.bg-blue {
	background-color: #f8f9ff;
}

.data-item.bg-green {
	background-color: #f0f9f4;
}

.data-item.bg-yellow {
	background-color: #fff8e1;
}

.data-number {
	font-size: 40rpx;
	font-weight: 700;
}

.data-number.primary {
	color: #0052d9;
}

.data-number.success {
	color: #00b578;
}

.data-number.warning {
	color: #faad14;
}

.data-label {
	font-size: 24rpx;
	color: #646a73;
	margin-top: 8rpx;
}

/* å¹³å°åŠ¨æ€ */
.news-section {
	padding-bottom: 160rpx;
}

.news-card {
	background-color: #ffffff;
	border-radius: 24rpx; /* 12px */
	padding: 32rpx; /* 16px */
}

.news-header {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
	align-items: center;
}

.more-link {
	font-size: 26rpx;
	color: #0052d9;
}

.news-list {
	margin-top: 24rpx;
	display: flex;
	flex-direction: column;
	gap: 24rpx;
}

.news-item {
	display: flex;
	flex-direction: row;
	gap: 24rpx;
}

.dot {
	width: 12rpx;
	height: 12rpx;
	border-radius: 50%;
	margin-top: 12rpx;
}

.dot.primary {
	background-color: #0052d9;
}

.dot.success {
	background-color: #00b578;
}

.dot.warning {
	background-color: #faad14;
}

.news-content {
	flex: 1;
	display: flex;
	flex-direction: column;
}

.news-title {
	font-size: 28rpx;
	color: #1f2329;
}

.news-date {
	font-size: 24rpx;
	color: #9aa0a6;
	margin-top: 8rpx;
}

/* åº•éƒ¨å¯¼èˆªæ  */
.tabbar {
	position: fixed;
	bottom: 0;
	left: 0;
	right: 0;
	height: 112rpx; /* 56px */
	background-color: #ffffff;
	border-top: 1px solid #e5e6eb;
	display: flex;
	flex-direction: row;
	justify-content: space-around;
	padding-bottom: env(safe-area-inset-bottom);
}

.tab-item {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	flex: 1;
}

.tab-icon {
	font-size: 48rpx;
}

.tab-label {
	font-size: 20rpx;
	color: #646a73;
	margin-top: 4rpx;
}

.tab-label.active {
	color: #0052d9;
}
</style>
