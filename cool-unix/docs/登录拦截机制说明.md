# 登录拦截机制说明

## 概述

前端已实现完整的登录全局拦截机制，当接口返回 401（未登录）或 403（权限不足）时，会自动处理并跳转到相应页面。

## 实现方案

### 1. HTTP 拦截器（`.cool/service/index.ts`）

#### 拦截位置
在 `request()` 函数的响应处理中实现了两层拦截：

**第一层：HTTP 状态码拦截**
```typescript
// 401 无权限（HTTP状态码）
if (res.statusCode == 401) {
    user.logout();
    reject({ message: t("无权限") } as Response);
}
```

**第二层：业务状态码拦截**
```typescript
// 解析响应数据中的 code
const { code, message, data } = parse<Response>(res.data ?? { code: 0 })!;

switch (code) {
    case 1000:
        resolve(data);
        break;
    // 401 未登录或token失效
    case 401:
        user.logout();
        reject({ message: message || t("请登录后操作"), code } as Response);
        break;
    // 403 权限不足
    case 403:
        reject({ message: message || t("权限不足"), code } as Response);
        break;
    default:
        reject({ message, code } as Response);
        break;
}
```

### 2. Token 自动刷新机制

#### 刷新流程
1. 请求前检查 token 是否过期
2. 如果 token 过期但 refreshToken 未过期，自动刷新
3. 刷新成功后，执行队列中的请求
4. 如果 refreshToken 也过期，直接退出登录

```typescript
// 判断token是否过期
if (storage.isExpired("token")) {
    // 判断refreshToken是否过期
    if (storage.isExpired("refreshToken")) {
        // 刷新token也过期，直接退出登录
        user.logout();
        return;
    }

    // 如果当前没有在刷新token，则发起刷新
    if (!isRefreshing) {
        isRefreshing = true;
        user.refreshToken()
            .then((token) => {
                // 刷新成功后，执行队列中的请求
                requests.forEach((cb) => cb(token));
                requests = [];
                isRefreshing = false;
            })
            .catch((err) => {
                reject(err);
                user.logout();
            });
    }

    // 将当前请求加入队列，等待token刷新后再执行
    new Promise((resolve) => {
        requests.push((token: string) => {
            Authorization = token;
            next();
            resolve(true);
        });
    });
    return;
}
```

### 3. 用户登出处理（`.cool/store/user.ts`）

```typescript
/**
 * 退出登录，清除所有信息并跳转到登录页
 */
logout() {
    this.clear();
    router.login();
}

/**
 * 清除本地所有用户信息和token
 */
clear() {
    storage.remove("userInfo");
    storage.remove("token");
    storage.remove("refreshToken");
    this.token = null;
    this.remove();
}
```

### 4. 路由跳转（`.cool/router/index.ts`）

```typescript
/**
 * 跳转到登录页（防抖处理，防止重复跳转）
 */
login = debounce(() => {
    if (!this.isLoginPage(this.path())) {
        this.push({
            path: "/pages/user/login",
            mode: "reLaunch"
        });
    }
}, 300);
```

## 后端接口规范

### 返回格式

**成功响应**
```json
{
  "code": 1000,
  "msg": "操作成功",
  "data": {}
}
```

**未登录响应**
```json
{
  "code": 401,
  "msg": "请登录后操作",
  "data": null
}
```

**权限不足响应**
```json
{
  "code": 403,
  "msg": "权限不足",
  "data": null
}
```

### 状态码定义

| 状态码 | 说明 | 前端处理 |
|--------|------|----------|
| 1000 | 成功 | 正常返回数据 |
| 401 | 未登录/Token失效 | 清除本地数据，跳转登录页 |
| 403 | 权限不足 | 提示错误信息，不跳转 |
| 其他 | 业务错误 | 提示错误信息 |

## 使用示例

### 1. 普通接口调用

```typescript
import { request } from "@/.cool/service";

// 自动处理登录拦截
request({
    url: "/api/task/list",
    method: "GET",
    data: {
        page: 1,
        pageSize: 10
    }
})
.then(res => {
    // 处理成功响应
    console.log(res);
})
.catch(err => {
    // 如果是401，会自动跳转登录页
    // 这里只需要处理其他错误
    console.error(err.message);
});
```

### 2. 忽略 Token 校验的接口

在 `config/index.ts` 中配置：

```typescript
// 忽略 token 校验的接口路径
export const ignoreTokens: string[] = [
    "/api/user/login",
    "/api/user/register",
    "/api/common/*"
];
```

### 3. 登录后回调

```typescript
import { router } from "@/.cool/router";

// 注册登录后回调
router.afterLogin(() => {
    console.log("用户登录成功");
    // 可以在这里刷新数据、重新请求等
});

// 或者监听全局事件
uni.$on("afterLogin", () => {
    console.log("用户登录成功");
});
```

## 流程图

```
用户请求接口
    ↓
检查 token 是否过期
    ↓
├─ 未过期 → 发起请求
│       ↓
│   收到响应
│       ↓
│   ├─ HTTP 401 → 退出登录 → 跳转登录页
│   ├─ code 401 → 退出登录 → 跳转登录页
│   ├─ code 403 → 提示权限不足
│   ├─ code 1000 → 返回数据
│   └─ 其他 → 提示错误
│
└─ 已过期
    ↓
检查 refreshToken 是否过期
    ↓
├─ 未过期 → 刷新 token
│       ↓
│   ├─ 成功 → 重新发起请求
│   └─ 失败 → 退出登录 → 跳转登录页
│
└─ 已过期 → 退出登录 → 跳转登录页
```

## 特性说明

### 1. 防抖处理
登录页跳转使用了防抖处理（300ms），防止短时间内多个接口同时返回 401 导致重复跳转。

### 2. 请求队列
Token 刷新期间，所有需要 token 的请求会被加入队列，等待刷新完成后统一执行。

### 3. 自动清理
退出登录时会自动清除：
- 用户信息（userInfo）
- 访问令牌（token）
- 刷新令牌（refreshToken）
- 路由参数（router-params）

### 4. 智能跳转
- 如果当前已在登录页，不会重复跳转
- 使用 `reLaunch` 模式，清空页面栈
- 登录成功后自动返回之前的页面

## 测试建议

### 1. Token 过期测试
```typescript
// 手动设置 token 过期
storage.set("token", "expired_token", -1);

// 发起请求，应该自动刷新 token
request({ url: "/api/user/info" });
```

### 2. 未登录测试
```typescript
// 清除 token
storage.remove("token");
storage.remove("refreshToken");

// 发起请求，应该跳转到登录页
request({ url: "/api/user/info" });
```

### 3. 权限不足测试
```typescript
// 访问无权限的接口
request({ url: "/api/admin/users" })
    .catch(err => {
        // 应该收到 403 错误，但不跳转登录页
        console.log(err.code); // 403
    });
```

## 注意事项

1. **后端接口必须返回正确的状态码**
   - 未登录返回 `code: 401`
   - 权限不足返回 `code: 403`
   - 成功返回 `code: 1000`

2. **Token 过期时间设置**
   - 前端会提前 5 秒判定 token 过期
   - 建议后端 token 有效期设置为 2 小时
   - refreshToken 有效期设置为 7 天

3. **登录页路径配置**
   - 默认登录页：`/pages/user/login`
   - 如需修改，在 `router.defaultPath()` 中配置

4. **多端兼容**
   - 已兼容 H5、App、小程序
   - 使用 uni-app 标准 API

## 更新日志

### v2.0 - 2026-02-04
- ✅ 添加业务状态码 401 拦截
- ✅ 添加业务状态码 403 拦截
- ✅ 优化错误提示信息
- ✅ 完善文档说明

### v1.0 - 初始版本
- ✅ HTTP 状态码 401 拦截
- ✅ Token 自动刷新机制
- ✅ 请求队列管理
- ✅ 防抖跳转处理

---

**文档版本**：v2.0  
**更新时间**：2026-02-04  
**维护人员**：前端开发团队
